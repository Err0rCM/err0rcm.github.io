<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#000000"><meta name="author" content="Err0r"><meta name="copyright" content="Err0r"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale） | Err0r</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#000000"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    <!-- hexo-inject:begin --><!-- hexo-inject:end -->const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"err0r.top","root":"/","title":"浅伴独蓝的小站","version":"1.6.1","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"想要搜些什么？","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="Err0r" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）本篇文章最后更新于2021.2.25转载请注明来源：https:&#x2F;&#x2F;err0r.top&#x2F;article&#x2F;CTFD&#x2F; 前言ctfd可以说是如今最方便的ctf靶场搭建平台，支持各种插件与二次开发，赵师傅早前写了一款插件ctf-whale非常方便，但本人在搭建的过程中遇到了不少问题，经过不断研究终于完成，特此记录，以防后期忘记，">
<meta property="og:type" content="article">
<meta property="og:title" content="CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）">
<meta property="og:url" content="https://err0r.top/article/CTFD/index.html">
<meta property="og:site_name" content="Err0r">
<meta property="og:description" content="CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）本篇文章最后更新于2021.2.25转载请注明来源：https:&#x2F;&#x2F;err0r.top&#x2F;article&#x2F;CTFD&#x2F; 前言ctfd可以说是如今最方便的ctf靶场搭建平台，支持各种插件与二次开发，赵师傅早前写了一款插件ctf-whale非常方便，但本人在搭建的过程中遇到了不少问题，经过不断研究终于完成，特此记录，以防后期忘记，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233032375.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/202010172331132.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233234439.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233300241.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233329640.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233350699.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233413853.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233431163.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017234359215.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017234428683.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017234344822.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017234457228.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233701655.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017233922648.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017234241273.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/20201017234315447.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/99216164-ee25b080-280f-11eb-95a9-2c2a17895068.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/image-20210225153426310.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/image-20210225163134408.png">
<meta property="og:image" content="https://err0r.top/article/CTFD/image-20210225163821673.png">
<meta property="article:published_time" content="2020-10-17T09:49:25.000Z">
<meta property="article:modified_time" content="2021-04-03T06:58:52.467Z">
<meta property="article:author" content="Err0r">
<meta property="article:tag" content="CTFd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://err0r.top/article/CTFD/20201017233032375.png"><script src="/js/ui/mode.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Err0r"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Err0r"></a><div class="site-author-name"><a href="/about/">Err0r</a></div><a class="site-name" href="/about/site.html">Err0r</a><sub class="site-subtitle">gyy</sub><div class="site-desciption">gugugu</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">37</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" title="QQ MTkwNjk2ODc2NA==" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Err0rCM" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/8408670" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:err0rcm@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.now.sh/" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们|友情链接" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-open-arm-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CTFD%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E9%9D%B6%E6%9C%BA%E7%9A%84%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0%EF%BC%88docker%EF%BC%9Actfd-ctf-whale%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AF%87%E6%96%87%E7%AB%A0%E6%9C%80%E5%90%8E%E6%9B%B4%E6%96%B0%E4%BA%8E2021-2-25"><span class="toc-number">1.1.</span> <span class="toc-text">本篇文章最后更新于2021.2.25</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.2.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E8%B0%83%EF%BC%81"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">强调！</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%89%8D%E5%87%86%E5%A4%87"><span class="toc-number">1.3.</span> <span class="toc-text">事前准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.</span> <span class="toc-text">安装步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-docker%E9%9B%86%E7%BE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.docker集群设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%94%BE%E5%85%A5ctfd-whale"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.放入ctfd-whale</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85frps%EF%BC%88%E8%BF%99%E9%87%8C%E6%9C%89%E5%85%B6%E4%BB%96%E6%95%99%E7%A8%8B%E5%86%99%E7%9A%84%E6%98%AF%E4%B8%8D%E5%AF%B9%E7%9A%84%EF%BC%89"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.安装frps（这里有其他教程写的是不对的）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AEctfd"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.配置ctfd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%85%8D%E7%BD%AEDockerfile"><span class="toc-number">1.4.5.</span> <span class="toc-text">5.配置Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%87%86%E5%A4%87%E5%AE%8C%E6%AF%95"><span class="toc-number">1.4.6.</span> <span class="toc-text">6.准备完毕</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AECTFD"><span class="toc-number">1.4.7.</span> <span class="toc-text">配置CTFD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEdocker%E7%BD%91%E7%BB%9C"><span class="toc-number">1.4.8.</span> <span class="toc-text">设置docker网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E6%B3%A8%E6%84%8F"><span class="toc-number">1.4.9.</span> <span class="toc-text">坑点注意</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#docker%E5%AE%B9%E5%99%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.9.0.0.1.</span> <span class="toc-text">docker容器无法启动问题</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#frp%E7%AB%AF%E5%8F%A3%E6%97%A0%E6%B3%95%E6%98%A0%E5%B0%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.9.0.0.2.</span> <span class="toc-text">frp端口无法映射问题</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2021-2-25-%E6%9B%B4%E6%96%B0"><span class="toc-number">1.5.</span> <span class="toc-text">2021.2.25 更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.5.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://err0r.top/article/CTFD/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Err0r"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Err0r"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2020-10-17 17:49:25" itemprop="dateCreated datePublished" datetime="2020-10-17T17:49:25+08:00">2020-10-17</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-04-03 14:58:52" itemprop="dateModified" datetime="2021-04-03T14:58:52+08:00">2021-04-03</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">4.3k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">20m</span></span></span><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span id="busuanzi_value_page_pv"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="评论数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-chat-3-line"></use></svg> <span class="waline-comment-count" id="/article/CTFD/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/" style="--text-color:dimgray" itemprop="url" rel="index"><span itemprop="text">杂谈笔记</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%9D%82%E8%B0%88%E7%AC%94%E8%AE%B0/%E8%8F%9C%E9%B8%A1%E6%95%99%E7%A8%8B/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">菜鸡教程</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#000000;"><h1 id="CTFD支持动态靶机的搭建笔记（docker：ctfd-ctf-whale）"><a href="#CTFD支持动态靶机的搭建笔记（docker：ctfd-ctf-whale）" class="headerlink" title="CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）"></a>CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）</h1><h2 id="本篇文章最后更新于2021-2-25"><a href="#本篇文章最后更新于2021-2-25" class="headerlink" title="本篇文章最后更新于2021.2.25"></a>本篇文章最后更新于2021.2.25</h2><p>转载请注明来源：<a href="https://err0r.top/article/CTFD/">https://err0r.top/article/CTFD/</a></p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ctfd可以说是如今最方便的ctf靶场搭建平台，支持各种插件与二次开发，<a target="_blank" rel="noopener" href="https://www.zhaoj.in/">赵师傅</a>早前写了一款插件ctf-whale非常方便，但本人在搭建的过程中遇到了不少问题，经过不断研究终于完成，特此记录，以防后期忘记，也供大家交流学习。<br>赵师傅开发的插件是为了适合 <a target="_blank" rel="noopener" href="https://buuoj.cn/">buu</a> 的架构,本篇文章采用完整流程+填坑讲解的格式。</p>
<p>我修改了一份CTFd，已上传github：<a target="_blank" rel="noopener" href="https://github.com/Err0rCM/CTFd_with_CTFd-whale">https://github.com/Err0rCM/CTFd_with_CTFd-whale</a> ，启动后仍需按照教程后半部分配置，省去前半部分时间，如有问题请提issue或者从头自行配置。</p>
<h4 id="强调！"><a href="#强调！" class="headerlink" title="强调！"></a>强调！</h4><p>由于当时国内git clone实在太慢，因为本人未配好代理，所以采用的方法是科学上网下载zip解压的方式，可自行百度git clong与Download zip的区别。本篇文章是用本地下载zip解压上传的方式完成<strong>在服务器上</strong>搭建</p>
<p>如果阅读中操作出现问题请自行百度，翻到文末查看坑点讲解或者查看其它搭建文章</p>
<p>这里感谢赵师傅zhaoj，fjh1997等前辈写的文章指导，读者遇到问题或有不足或缺陷的地方请私信我添加改正</p>
<h2 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h2><p><strong>注意</strong>：本机为CentOS7<br>要求：</p>
<ol>
<li>已安装基础环境，熟悉linux基本操作</li>
<li>已安装好 Docker 和 Docker-Compose，并且启用 Docker Swarm，完成换源等操作</li>
<li>会<em>科学上网</em></li>
<li>有绝对的耐心</li>
</ol>
<p>需求：</p>
<ol>
<li>下载赵师傅改写的ctfd，赵师傅已经完成了镜像换源等操作</li>
</ol>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;glzjin&#x2F;CTFd.git -&gt;赵师傅仓库</code></pre>

<ol start="2">
<li>下载frp</li>
</ol>
<pre class="language-none"><code class="language-none">wget https:&#x2F;&#x2F;github.com&#x2F;fatedier&#x2F;frp&#x2F;releases&#x2F;download&#x2F;v0.29.0&#x2F;frp_0.29.0_linux_amd64.tar.gz

tar -zxvf frp_0.29.0_linux_amd64.tar.gz</code></pre>
<p>也可以直接访问链接下载然后解压上传</p>
<ol start="3">
<li>下载ctf-whale</li>
</ol>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;glzjin&#x2F;CTFd-Whale</code></pre>

<ol start="4">
<li>下载docker的frps<br>这里在赵师傅仓库里扒拉发现的<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;glzjin&#x2F;Frp-Docker-For-CTFd-Whale</code></pre>

</li>
</ol>
<p>以上除ctfd解压后请确保字母小写，并只有一级文件夹</p>
<hr>
<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><h3 id="1-docker集群设置"><a href="#1-docker集群设置" class="headerlink" title="1.docker集群设置"></a>1.docker集群设置</h3><p>输入命令</p>
<pre class="language-none"><code class="language-none">docker swarm init

docker node ls

docker node update --label-add name&#x3D;linux-1 &lt;节点 ID&gt;</code></pre>

<img src="/article/CTFD/20201017233032375.png" class="" title="docker集群设置" loading="lazy">

<p>具体原理等可以查看其它ctfd搭建文章，文末会贴出，这里不做过多阐述</p>
<h3 id="2-放入ctfd-whale"><a href="#2-放入ctfd-whale" class="headerlink" title="2.放入ctfd-whale"></a>2.放入ctfd-whale</h3><p>将解压的ctfd-whale改小写后放入/CTFd/CTFd/plugins</p>
<h3 id="3-安装frps（这里有其他教程写的是不对的）"><a href="#3-安装frps（这里有其他教程写的是不对的）" class="headerlink" title="3.安装frps（这里有其他教程写的是不对的）"></a>3.安装frps（这里有其他教程写的是不对的）</h3><p>这里注意下，frp<strong>不是</strong>装在服务器机子上的，简单来说，frps与frpc都是在docker里的。（大坑在这里）<br>frpc是在ctfd里的，frps是在docker机里的</p>
<p>上传赵师傅的Frp-Docker-For-CTFd-Whale，进入目录后运行<code>docker-compose up -d</code>即可，然后<code>docker ps</code>可看到frps的容器运行中</p>
<img src="/article/CTFD/202010172331132.png" class="" title="frps" loading="lazy">

<p>这里看到frps有28000-28100，这是在<strong>Frp-Docker-For-CTFd-Whale里的docker-compose.yml</strong>，可更改配置后compose</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">frps</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> glzjin/frp<span class="token punctuation">:</span>latest
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./frp<span class="token punctuation">:</span>/conf/
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /usr/local/bin/frps
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> /conf/frps.ini
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"28000-28100:28000-28100"</span>     <span class="token comment">#可更改开放端口</span>
      <span class="token punctuation">-</span> <span class="token string">"6490:6490"</span>    <span class="token comment">#此处必须与frps.ini配置一致</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
</code></pre>

<p>再看一下/frp/frps.ini</p>
<pre class="language-none"><code class="language-none">[common]
bind_port &#x3D; 6490
token &#x3D; randomme</code></pre>


<h3 id="4-配置ctfd"><a href="#4-配置ctfd" class="headerlink" title="4.配置ctfd"></a>4.配置ctfd</h3><p>直接上<strong>ctfd的docker-compose.yml</strong>配置</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2.2'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">ctfd-nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token number">1.17</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx/http.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf   <span class="token comment">#这里注意</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> root
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token comment">#- "85:80"     #我将这里注释掉了，这里通过nginx转发感觉速度访问速度会变慢，可能因为我的配置问题，多次尝试之后直接开8000端口访问不会对服务造成影响</span>
      <span class="token punctuation">-</span> <span class="token string">"443:443"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">internal</span><span class="token punctuation">:</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ctfd
    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'1.00'</span>  <span class="token comment">#可改</span>
    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 150M     <span class="token comment">#可改</span>
  <span class="token key atrule">ctfd</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">user</span><span class="token punctuation">:</span> root
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8000:8000"</span>     <span class="token comment">#这里原本没开端口，直接打开访问网站速度会加快</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> UPLOAD_FOLDER=/var/uploads
      <span class="token punctuation">-</span> DATABASE_URL=mysql+pymysql<span class="token punctuation">:</span>//root<span class="token punctuation">:</span>ctfd@db/ctfd
      <span class="token punctuation">-</span> REDIS_URL=redis<span class="token punctuation">:</span>//cache<span class="token punctuation">:</span><span class="token number">6379</span>
      <span class="token punctuation">-</span> WORKERS=1
      <span class="token punctuation">-</span> LOG_FOLDER=/var/log/CTFd
      <span class="token punctuation">-</span> ACCESS_LOG=<span class="token punctuation">-</span>
      <span class="token punctuation">-</span> ERROR_LOG=<span class="token punctuation">-</span>
      <span class="token punctuation">-</span> REVERSE_PROXY=true
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .data/CTFd/logs<span class="token punctuation">:</span>/var/log/CTFd
      <span class="token punctuation">-</span> .data/CTFd/uploads<span class="token punctuation">:</span>/var/uploads
      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/opt/CTFd<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock     <span class="token comment">#这里是添加的</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">internal</span><span class="token punctuation">:</span>
        <span class="token key atrule">frp</span><span class="token punctuation">:</span>
            <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 172.1.0.2
    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'1.00'</span>     <span class="token comment">#可改</span>
    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 450M     <span class="token comment">#可改</span>

  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">:</span><span class="token number">10.4</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=ctfd
      <span class="token punctuation">-</span> MYSQL_USER=ctfd
      <span class="token punctuation">-</span> MYSQL_PASSWORD=ctfd
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .data/mysql<span class="token punctuation">:</span>/var/lib/mysql
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
        <span class="token key atrule">internal</span><span class="token punctuation">:</span>
    <span class="token comment"># This command is required to set important mariadb defaults</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>mysqld<span class="token punctuation">,</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4<span class="token punctuation">,</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_unicode_ci<span class="token punctuation">,</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>wait_timeout=28800<span class="token punctuation">,</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>log<span class="token punctuation">-</span>warnings=0<span class="token punctuation">]</span>
    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'1.00'</span>     <span class="token comment">#可改</span>
    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 750M     <span class="token comment">#可改</span>

  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span><span class="token number">4</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .data/redis<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
        <span class="token key atrule">internal</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'1.00'</span>     <span class="token comment">#可改</span>
    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 450M     <span class="token comment">#可改</span>

  <span class="token key atrule">frpc</span><span class="token punctuation">:</span>    
    <span class="token key atrule">image</span><span class="token punctuation">:</span> glzjin/frp<span class="token punctuation">:</span>latest     <span class="token comment">#赵师傅tql</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./frpc<span class="token punctuation">:</span>/conf/     <span class="token comment">#这里注意</span>
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /usr/local/bin/frpc
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> /conf/frpc.ini
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
        <span class="token key atrule">frp</span><span class="token punctuation">:</span>
            <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 172.1.0.3  <span class="token comment">#记住此处</span>
        <span class="token key atrule">frp-containers</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'1.00'</span>     <span class="token comment">#可改</span>
    <span class="token key atrule">mem_limit</span><span class="token punctuation">:</span> 250M     <span class="token comment">#可改</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span>
        <span class="token key atrule">internal</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">frp</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
        <span class="token key atrule">ipam</span><span class="token punctuation">:</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">subnet</span><span class="token punctuation">:</span> 172.1.0.0/16
    <span class="token key atrule">frp-containers</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay
        <span class="token key atrule">internal</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">ipam</span><span class="token punctuation">:</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">subnet</span><span class="token punctuation">:</span> 172.2.0.0/16
</code></pre>


<p>然后<strong>注意！注意！注意！</strong></p>
<p>在docker-compose.yml同目录下建nginx文件夹，即与第一个#这里注意相应，然后建<code>http.conf</code>文件写入以下内容</p>
<p><strong>2021年2月25日更新</strong>目前最新版本的CTFd已经有此配置了，不需要再另加了。</p>
<p>转载请注明来源：<a href="https://err0r.top/article/CTFD/">https://err0r.top/article/CTFD/</a></p>
<pre class="language-none"><code class="language-none">worker_processes 4;
events &#123;
  worker_connections 1024;
&#125;
http &#123;
  # Configuration containing list of application servers
  upstream app_servers &#123;
    server ctfd:8000;
  &#125;
  server &#123;
    listen 80;
    client_max_body_size 4G;
    # Handle Server Sent Events for Notifications
    location &#x2F;events &#123;
      proxy_pass http:&#x2F;&#x2F;app_servers;
      proxy_set_header Connection &#39;&#39;;
      proxy_http_version 1.1;
      chunked_transfer_encoding off;
      proxy_buffering off;
      proxy_cache off;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $server_name;
    &#125;
    # Proxy connections to the application servers
    location &#x2F; &#123;
      proxy_pass http:&#x2F;&#x2F;app_servers;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $server_name;
    &#125;
  &#125;
&#125;
</code></pre>



<p>在docker-compose.yml同目录下建frpc文件夹，即与第二个#这里注意相应，然后进入解压的/frp_0.29.0_linux_amd64文件夹，或直接上传，将</p>
<pre class="language-none"><code class="language-none">frpc
frpc.ini
frpc_full.ini
LICENSE
</code></pre>


<p>放入frpc文件夹<br>接着配置frpc.ini，直接上配置</p>
<pre class="language-none"><code class="language-none">[common]
token &#x3D; randomme
server_addr &#x3D; 172.1.0.4
server_port &#x3D; 6490     #此处必须与frpc.ini配置一致
pool_count &#x3D; 200
tls_enable &#x3D; true

admin_addr &#x3D; 172.1.0.3 #一定要加！！与后面相应
admin_port &#x3D; 7400
</code></pre>

<p>此处非常重要，之前本人在这里踩了好多次坑。</p>
<h3 id="5-配置Dockerfile"><a href="#5-配置Dockerfile" class="headerlink" title="5.配置Dockerfile"></a>5.配置Dockerfile</h3><p>还是直接上配置，<strong>Dockerfile</strong>.注意，最新版本的CTFd已经更换了Dockerfile的写法，可以参考一下apt换源</p>
<pre class="language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM python:3.7-alpine  #如果出现问题可尝试更换python，一般不需要
RUN sed -i &#39;s&#x2F;dl-cdn.alpinelinux.org&#x2F;mirrors.ustc.edu.cn&#x2F;g&#39; &#x2F;etc&#x2F;apk&#x2F;repositories &amp;&amp; \
    apk update &amp;&amp; \
    apk add linux-headers libffi-dev gcc make musl-dev py-pip mysql-client git openssl-dev   #这里注意1
RUN adduser -D -u 1001 -s &#x2F;bin&#x2F;bash ctfd

WORKDIR &#x2F;opt&#x2F;CTFd
RUN mkdir -p &#x2F;opt&#x2F;CTFd &#x2F;var&#x2F;log&#x2F;CTFd &#x2F;var&#x2F;uploads

COPY requirements.txt .

RUN pip install -r requirements.txt -i https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;pypi&#x2F;web&#x2F;simple&#x2F;   #这里注意2

COPY . &#x2F;opt&#x2F;CTFd

RUN for d in CTFd&#x2F;plugins&#x2F;*; do \
      if [ -f &quot;$d&#x2F;requirements.txt&quot; ]; then \
        pip install -r $d&#x2F;requirements.txt -i https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;pypi&#x2F;web&#x2F;simple&#x2F; ; \
      fi; \
    done; #同样注意2

RUN chmod +x &#x2F;opt&#x2F;CTFd&#x2F;docker-entrypoint.sh
RUN chown -R 1001:1001 &#x2F;opt&#x2F;CTFd
RUN chown -R 1001:1001 &#x2F;var&#x2F;log&#x2F;CTFd &#x2F;var&#x2F;uploads

USER 1001
EXPOSE 8000
ENTRYPOINT [&quot;&#x2F;opt&#x2F;CTFd&#x2F;docker-entrypoint.sh&quot;]
</code></pre>

<p>注意点：</p>
<ol>
<li>第一处的镜像源可百度更换其它源，例如</li>
</ol>
<p><code>sed -i &#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39; /etc/apk/repositories</code><br>注意如果出现问题检查下最后有没有<code>&amp;&amp; \</code></p>
<ol start="2">
<li>python版本一般不需要换</li>
<li>RUN第三行我将python和python-dev删掉了，如果要加上则会报错<code>python requires by world</code>之类的，请加上<code>python2</code>或<code>python3</code>，<code>python2-dev</code>或<code>python3-dev</code>.即可解决。删掉后没有发现对服务有什么影响</li>
<li>所有<code>-i &quot;url&quot;</code>都是指定源，如果下载失败则可更换源再试</li>
<li>第二处注意即我更换了源，因为之前看其他教程下载失败了</li>
</ol>
<h3 id="6-准备完毕"><a href="#6-准备完毕" class="headerlink" title="6.准备完毕"></a>6.准备完毕</h3><p>运行<code>docker-compose build</code><br>静待完成</p>
<img src="/article/CTFD/20201017233234439.png" class="" title="build" loading="lazy">


<p>然后运行<code>docker-compose up -d</code></p>
<img src="/article/CTFD/20201017233300241.png" class="" title="up" loading="lazy">


<p>如图所示，有WARNING即为在集群网络类，是正常情况<br>运行<code>docker ps</code>查看容器情况</p>
<img src="/article/CTFD/20201017233329640.png" class="" title="ps" loading="lazy">


<p>访问 <a target="_blank" rel="noopener" href="http://ip:8000/">http://ip:8000</a> 即可访问ctfd</p>
<h3 id="配置CTFD"><a href="#配置CTFD" class="headerlink" title="配置CTFD"></a>配置CTFD</h3><p>进入后随便设置，然后进Admin Panel进行设置</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>Docker API URL</td>
<td>unix://var/run/docker.sock</td>
</tr>
<tr>
<td>Frp API IP</td>
<td>frpc的ip配置</td>
</tr>
<tr>
<td>Frp API Port</td>
<td>frpc的端口配置</td>
</tr>
<tr>
<td>Frp Http Domain Suffix</td>
<td>Docker API URL to connect（可填None）</td>
</tr>
<tr>
<td>Frp Http Port</td>
<td>80</td>
</tr>
<tr>
<td>Frp Direct IP Address</td>
<td>你的公网ip，本机即为127.0.0.1</td>
</tr>
<tr>
<td>Frp Direct Minimum Port</td>
<td>与之前frps最小端口呼应</td>
</tr>
<tr>
<td>Frp Direct Minimum Port</td>
<td>与之前frps最大端口呼应</td>
</tr>
<tr>
<td>Max Container Count</td>
<td>不超过最大-最小</td>
</tr>
<tr>
<td>Max Renewal Times</td>
<td>最大实例延时次数</td>
</tr>
<tr>
<td>Frp config template</td>
<td>填入frps的配置，只需填[common]</td>
</tr>
<tr>
<td>Docker Auto Connect Containers</td>
<td>ctfd_frpc_1</td>
</tr>
<tr>
<td>Docker Dns Setting</td>
<td>可填机器内DNS，没有可填个外网DNS</td>
</tr>
<tr>
<td>Docker Swarm Nodes</td>
<td>linux-1   与前面swarm集群呼应</td>
</tr>
<tr>
<td>Docker Multi-Container Network Subnet</td>
<td>内网题大子网ip配置/CIDR</td>
</tr>
<tr>
<td>Docker Multi-Container Network Subnet New Prefix</td>
<td>每个内网题实例的CIDR</td>
</tr>
<tr>
<td>Docker Container Timeout</td>
<td>单位为秒</td>
</tr>
</tbody></table>
<p>最后附上我的配置图片</p>
<img src="/article/CTFD/20201017233350699.png" class="" title="配置1" loading="lazy">

<img src="/article/CTFD/20201017233413853.png" class="" title="配置2" loading="lazy">

<img src="/article/CTFD/20201017233431163.png" class="" title="配置3" loading="lazy">


<h3 id="设置docker网络"><a href="#设置docker网络" class="headerlink" title="设置docker网络"></a>设置docker网络</h3><p>这个时候运行<code>docker ps</code><br>发现frpc在无限重启，因为我们还没有配置网络<br>运行<code>docker network ls</code></p>
<img src="/article/CTFD/20201017234359215.png" class="" title="容器" loading="lazy">


<p>显示ctfd_frp-containers</p>
<p>运行<code>docker network inspect ctfd_frp</code></p>
<img src="/article/CTFD/20201017234428683.png" class="" title="ctfd_frp" loading="lazy">


<p>这个是docker-compose里compose后创建的网络，我们将frps加入此网络，例如我的frp容器id为12345，则运行<code>docker network connect ctfd_frp 12345&lt;即frp容器id&gt;</code>。再运行<code>docker network inspect ctfd_frp</code>，如下<img src="/article/CTFD/20201017234344822.png" class="" title="在这里插入图片描述" loading="lazy"></p>
<p>这里可以看到ip与我们之前设置的相应。</p>
<p>此时运行<code>docker restart ctfd_frpc_1 frp_frps_1</code></p>
<p>然后<code>docker ps</code></p>
<p>最终如下<img src="/article/CTFD/20201017234457228.png" class="" title="ps" loading="lazy"></p>
<p>成功完成。</p>
<p>最后设置道题目选择（我做了汉化）</p>
<img src="/article/CTFD/20201017233701655.png" class="" title="题目1" loading="lazy">


<img src="/article/CTFD/20201017233922648.png" class="" title="题目2" loading="lazy">

<img src="/article/CTFD/20201017234241273.png" class="" title="在这里插入图片描述" loading="lazy">

<p><code>docker ps</code>里可以看到容器成功启动，地址正常访问</p>
<h3 id="坑点注意"><a href="#坑点注意" class="headerlink" title="坑点注意"></a>坑点注意</h3><ol>
<li>如果frpc重复出现retrying，请返回检查docker-compose.yml。找到frpc设置，检查ip设置是否正确。再检查ctfd的Admin Panel里ctfd-whale设置是否正确。</li>
<li>如果出现安装某个文件失败问题，请更换源，很多都是源里没有指定文件造成的。可以自行访问一下网站，查看一下要下载的文件名，再进行配置。</li>
<li>似乎docker和系统的版本会有影响，本机为CentOS7.4 64位，腾讯云，docker配置如下</li>
</ol>
<img src="/article/CTFD/20201017234315447.png" class="" title="版本" loading="lazy">


<ol start="4">
<li><p>python的问题，上面提到的，可以删除，是因为没有指定版本的原因，也可以指定版本再下载</p>
</li>
<li><p>ctfd运行<code>docker-compose up -d</code>后有可能提示docker-entrypoint.sh没有权限，手动加个权限即可。在CTFd文件夹下运行<code>chmod a+x docker-entrypoint.sh</code>（docker-compose.yml里其实写了加权限，但是最后并没有加上去？）</p>
</li>
<li><p>如果docker容器无法启动或者frp端口无法映射可以进容器检查 </p>
<p>确保docker api填写正确，如docker-compose.yml中写的unix:///var/run/docker.sock<br>你也可以使用端口形式的api如<a target="_blank" rel="noopener" href="https://success.docker.com/article/how-do-i-enable-the-remote-api-for-dockerd">官方示例</a>：可以用IP：端口指定API</p>
<h6 id="docker容器无法启动问题"><a href="#docker容器无法启动问题" class="headerlink" title="docker容器无法启动问题"></a>docker容器无法启动问题</h6><p>进入容器检查：</p>
<pre class="language-none"><code class="language-none">docker exec -it &lt;ctfd容器id&gt; sh
&#x2F;opt&#x2F;CTFd# python
&gt;&gt;&gt;import docker
&gt;&gt;&gt;client&#x3D;docker.DockerClient(base_url&#x3D;&quot;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock&quot;)
&gt;&gt;&gt;client.images.list()</code></pre>

<p> 如果api正确会列出所有镜像 </p>
<h6 id="frp端口无法映射问题"><a href="#frp端口无法映射问题" class="headerlink" title="frp端口无法映射问题"></a>frp端口无法映射问题</h6><p>进入容器检查：</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;其实检查可以顺便检查一下上面的，因为都在ctfd容器内
docker exec -it &lt;ctfd容器id&gt; sh
&#x2F;opt&#x2F;CTFd# python
&gt;&gt;&gt;import requests
&gt;&gt;&gt;requests.get(&quot;http:&#x2F;&#x2F;172.1.0.3:7400&#x2F;api&#x2F;reload&quot;)&#x2F;&#x2F;即frp api的地址

返回
&lt;Response [200]&gt; #表示成功</code></pre>

<p>如果frpc还是出现如下问题</p>
<pre class="language-none"><code class="language-none">requests.exceptions.ConnectionError: HTTPConnectionPool(host&#x3D;&#39;172.1.0.3&#39;, port&#x3D;7400): Max retries exceeded with url: &#x2F;api&#x2F;reload (Caused by NewConnectionError(&#39;&lt;urllib3.connection.HTTPConnection object at 0x7f8df919f850&gt;: Failed to establish a new connection: [Errno 111] Connection refused&#39;))
</code></pre>

<p>则重新配置frpc。编辑/CTFd/frpc/frpc.ini</p>
<pre class="language-none"><code class="language-none">[common]
token &#x3D; randomme
server_addr &#x3D; 172.1.0.4
server_port &#x3D; 6490
pool_count &#x3D; 200
tls_enable &#x3D; true

admin_addr &#x3D; 172.1.0.3 #这里千万千万别忘加，之前要被搞气死
admin_port &#x3D; 7400</code></pre>

<p>然后运行<code>docker restart ctfd_frpc_1</code>（这里再看frpc.ini会发现内容更新了，admin配置没了，不用担心）</p>
<p>再进容器检查<code>requests.get(&quot;http://172.1.0.3:7400/api/reload&quot;)</code>应该就可以了<code>&lt;Response [200]&gt;</code></p>
</li>
</ol>
<ol start="7">
<li><p>遇事不决请重启</p>
</li>
<li><p>如果发现frp端口冲突，请检查本地frpc或者frps服务，frp是在docker上<strong>不是在本地</strong>的！</p>
<pre class="language-none"><code class="language-none">systemctl stop frpc
systemctl stop frps</code></pre>



</li>
</ol>
<ol start="9">
<li><p>活用查看log</p>
<pre class="language-none"><code class="language-none">docker logs &lt;ctfd容器id&gt;
docker logs &lt;frp容器id&gt;</code></pre>
</li>
<li><p>如果修改了任意配置，请跟着修改<strong>系列配置</strong>，很多就是因为漏改造成的</p>
</li>
</ol>
<p>11.docker ps显示正常但是无法访问</p>
<p> 可以使用 <code>docker logs ctfd_ctfd_1</code> 查看输出，如果发现输出类似： </p>
<pre class="language-none"><code class="language-none">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;tzlocal&#x2F;unix.py:158: UserWarning: Can not find any timezone configuration, defaulting to UTC.
  warnings.warn(&#39;Can not find any timezone configuration, defaulting to UTC.&#39;)
Starting CTFd
&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;importlib&#x2F;_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected 144 from C header, got 152 from PyObject
  return f(*args, **kwds)
&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;importlib&#x2F;_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected 144 from C header, got 152 from PyObject
  return f(*args, **kwds)
&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;importlib&#x2F;_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected 144 from C header, got 152 from PyObject
  return f(*args, **kwds)
[2020-10-11 12:31:30 +0000] [1] [INFO] Starting gunicorn 19.9.0
[2020-10-11 12:31:30 +0000] [1] [INFO] Listening at: http:&#x2F;&#x2F;0.0.0.0:8000 (1)
[2020-10-11 12:31:30 +0000] [1] [INFO] Using worker: gevent
[2020-10-11 12:31:30 +0000] [21] [INFO] Booting worker with pid: 21
[2020-10-11 12:31:31 +0000] [23] [INFO] Booting worker with pid: 23
[2020-10-11 12:31:32 +0000] [25] [INFO] Booting worker with pid: 25
[2020-10-11 12:31:34 +0000] [27] [INFO] Booting worker with pid: 27
[2020-10-11 12:31:35 +0000] [29] [INFO] Booting worker with pid: 29
[2020-10-11 12:31:36 +0000] [31] [INFO] Booting worker with pid: 31
[2020-10-11 12:31:37 +0000] [33] [INFO] Booting worker with pid: 33
[2020-10-11 12:31:39 +0000] [35] [INFO] Booting worker with pid: 35
[2020-10-11 12:31:40 +0000] [37] [INFO] Booting worker with pid: 37(一直在加)
</code></pre>

<p> 则问题为<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/64105616/greenlet-runtime-error-and-deployed-app-in-docker-keeps-booting-all-the-workers">这篇文章中所提到的问题</a>，只需要删除 <code>requirements.txt</code> 中的 <code>gevent</code> 版本号即可，结果类似下面这样 </p>
<pre class="language-none"><code class="language-none">&#x2F;requirements.txt
...
redis&#x3D;&#x3D;3.3.11
datafreeze&#x3D;&#x3D;0.1.0
gevent
python-dotenv&#x3D;&#x3D;0.10.3
flask-restplus&#x3D;&#x3D;0.13.0
...</code></pre>

<p> 然后 <code>docker-compose down</code> 再启动 <code>docker-compose up -d --build</code> 不出意外应该就能解决问题 </p>
<p>(更新)12.出现如下问题可参考<a target="_blank" rel="noopener" href="https://github.com/glzjin/CTFd-Whale/issues/20">此issue</a>提出的问题，在ctfd的docker-compose.yml添加<code>/var/run/docker.sock:/var/run/docker.sock</code></p>
<img src="/article/CTFD/99216164-ee25b080-280f-11eb-95a9-2c2a17895068.png" class="" title="image" loading="lazy">

<p>如下</p>
<img src="/article/CTFD/image-20210225153426310.png" class="" title="image-20210225153426310" loading="lazy">

<h2 id="2021-2-25-更新"><a href="#2021-2-25-更新" class="headerlink" title="2021.2.25 更新"></a>2021.2.25 更新</h2><p>最新的CTFd改了部分代码，由于兼容性问题，需要重新编辑一些东西，例如<code>Dockerfile</code></p>
<pre class="language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM python:3.7-slim-buster
WORKDIR &#x2F;opt&#x2F;CTFd
RUN mkdir -p &#x2F;opt&#x2F;CTFd &#x2F;var&#x2F;log&#x2F;CTFd &#x2F;var&#x2F;uploads

# hadolint ignore&#x3D;DL3008
RUN echo &#39;deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \
 deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \
 deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \
 deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster main non-free contrib \
 deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-updates main non-free contrib \
 deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; buster-backports main non-free contrib \
 deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib \
 deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; buster&#x2F;updates main non-free contrib&#39;&gt; &#x2F;etc&#x2F;apt&#x2F;sources.list &amp;&amp; \
    apt-get update \
    &amp;&amp; apt-get install -y --no-install-recommends \
        build-essential \
        default-mysql-client \
        python3-dev \
        libffi-dev \
        libssl-dev \
        git \
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;*

COPY requirements.txt &#x2F;opt&#x2F;CTFd&#x2F;

RUN pip install -r requirements.txt -i http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple&#x2F; --no-cache-dir

COPY . &#x2F;opt&#x2F;CTFd

# hadolint ignore&#x3D;SC2086
RUN for d in CTFd&#x2F;plugins&#x2F;*; do \
        if [ -f &quot;$d&#x2F;requirements.txt&quot; ]; then \
            pip install -r $d&#x2F;requirements.txt -i http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple&#x2F; --no-cache-dir; \
        fi; \
    done;

RUN adduser \
    --disabled-login \
    -u 1001 \
    --gecos &quot;&quot; \
    --shell &#x2F;bin&#x2F;bash \
    ctfd
RUN chmod +x &#x2F;opt&#x2F;CTFd&#x2F;docker-entrypoint.sh \
    &amp;&amp; chown -R 1001:1001 &#x2F;opt&#x2F;CTFd &#x2F;var&#x2F;log&#x2F;CTFd &#x2F;var&#x2F;uploads

USER 1001
EXPOSE 8000
ENTRYPOINT [&quot;&#x2F;opt&#x2F;CTFd&#x2F;docker-entrypoint.sh&quot;]</code></pre>

<p>其他pip源</p>
<pre class="language-none"><code class="language-none">清华：https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;simple&#x2F;
中国科技大学 https:&#x2F;&#x2F;pypi.mirrors.ustc.edu.cn&#x2F;simple&#x2F;
华中理工大学：http:&#x2F;&#x2F;pypi.hustunique.com&#x2F;
山东理工大学：http:&#x2F;&#x2F;pypi.sdutlinux.org&#x2F;
豆瓣：http:&#x2F;&#x2F;pypi.douban.com&#x2F;simple&#x2F;</code></pre>

<img src="/article/CTFD/image-20210225163134408.png" class="" title="image-20210225163134408" loading="lazy">

<img src="/article/CTFD/image-20210225163821673.png" class="" title="image-20210225163821673" loading="lazy">

<p><strong>我整合了一下CTFd+ctfd-whale+frpc+frps，可以参考一下，<a target="_blank" rel="noopener" href="https://github.com/Err0rCM/CTFd_with_CTFd-whale">已上传github</a></strong></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p> <a target="_blank" rel="noopener" href="https://www.zhaoj.in/read-6333.html">CTFd-Whale 推荐部署实践</a>(赵师傅官方)</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fjh1997/article/details/100850756/">手把手教你如何建立一个支持ctf动态独立靶机的靶场（ctfd+ctfd-whale）</a></p>
<p> <a target="_blank" rel="noopener" href="https://vaala.cat/2020/09/21/ctfd%E4%BD%BF%E7%94%A8ctfd-whale%E5%8A%A8%E6%80%81%E9%9D%B6%E6%9C%BA%E6%8F%92%E4%BB%B6%E6%90%AD%E5%BB%BA%E9%9D%B6%E5%9C%BA%E6%8C%87%E5%8D%97/">ctfd使用ctfd-whale动态靶机插件搭建靶场指南</a></p>
<p>转载请注明来源：<a href="https://err0r.top/article/CTFD/">https://err0r.top/article/CTFD/</a></p>
<p>如果有问题请私信联系我，不足之处敬请谅解</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">如果觉得我的文章对你有帮助，可以请俺喝冰阔落</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/alipay.jpg"><img loading="lazy" src="/images/alipay.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/qq.jpg"><img loading="lazy" src="/images/qq.jpg" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wechat.jpg"><img loading="lazy" src="/images/wechat.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Err0r</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://err0r.top/article/CTFD/" title="CTFD支持动态靶机的搭建笔记（docker：ctfd+ctf-whale）">https://err0r.top/article/CTFD/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/article/Buuoj-WEB-Write-up/" rel="prev" title="Buuoj WEB Write-up"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Buuoj WEB Write-up</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/article/0XGame-WEB-Write-up/" rel="next" title="0XGame WEB Write-up"><span class="post-nav-text">0XGame WEB Write-up</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>若您想及时得到回复提醒，建议私发邮件联系。</span><br><span>评论请遵守评论公德，博主会不定时检查评论并进行回复。</span><br></div><div id="waline"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js", () => {
  const walineConfig = {"enable":true,"serverURL":"https://comments-err0rcm.vercel.app","comment":true,"visitor":false,"el":"#waline","lang":"zh-CN"}
  walineConfig.path = "/article/CTFD/"
  new Waline(walineConfig)
}, window.Waline);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备20028116号-1</a></div><div class="copyright"><span>&copy; 2020 – 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Err0r</span></div><div class="live_time"><span>本博客已在各种灾难中运行了</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2020-10-20T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div><div id="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" title="总访客量"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="总访问量"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg></span><span id="busuanzi_value_site_pv"></span></span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="想要搜些什么？" value=""></div><div id="local-search-result"></div></div><script>const date = new Date();
const today = (date.getMonth() + 1) + "-" + date.getDate()
const mourn_days = ["4-4","9-18","12-13"]
if (mourn_days.includes(today)) {
  document.documentElement.style.filter = "grayscale(1)";
}</script></div><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>